/** 
 * 优惠券兑换
 * @param userId 用户ID
 * @param body 请求内容， { code: xxx }
 * @return 操作结果
 */
@PostMapping("exchange") public Object exchange(@LoginUser Integer userId,@RequestBody String body){
  if (userId == null) {
    return ResponseUtil.unlogin();
  }
  String code=JacksonUtil.parseString(body,"code");
  if (code == null) {
    return ResponseUtil.badArgument();
  }
  LitemallCoupon coupon=couponService.findByCode(code);
  if (coupon == null) {
    return ResponseUtil.fail(WxResponseCode.COUPON_CODE_INVALID,"优惠券不正确");
  }
  Integer couponId=coupon.getId();
  Integer total=coupon.getTotal();
  Integer totalCoupons=couponUserService.countCoupon(couponId);
  if ((total != 0) && (totalCoupons >= total)) {
    return ResponseUtil.fail(WxResponseCode.COUPON_EXCEED_LIMIT,"优惠券已兑换");
  }
  Integer limit=coupon.getLimit().intValue();
  Integer userCounpons=couponUserService.countUserAndCoupon(userId,couponId);
  if ((limit != 0) && (userCounpons >= limit)) {
    return ResponseUtil.fail(WxResponseCode.COUPON_EXCEED_LIMIT,"优惠券已兑换");
  }
  Short type=coupon.getType();
  if (type.equals(CouponConstant.TYPE_REGISTER)) {
    return ResponseUtil.fail(WxResponseCode.COUPON_RECEIVE_FAIL,"新用户优惠券自动发送");
  }
 else   if (type.equals(CouponConstant.TYPE_COMMON)) {
    return ResponseUtil.fail(WxResponseCode.COUPON_RECEIVE_FAIL,"优惠券只能领取，不能兑换");
  }
 else   if (!type.equals(CouponConstant.TYPE_CODE)) {
    return ResponseUtil.fail(WxResponseCode.COUPON_RECEIVE_FAIL,"优惠券类型不支持");
  }
  Short status=coupon.getStatus();
  if (status.equals(CouponConstant.STATUS_OUT)) {
    return ResponseUtil.fail(WxResponseCode.COUPON_EXCEED_LIMIT,"优惠券已兑换");
  }
 else   if (status.equals(CouponConstant.STATUS_EXPIRED)) {
    return ResponseUtil.fail(WxResponseCode.COUPON_RECEIVE_FAIL,"优惠券已经过期");
  }
  LitemallCouponUser couponUser=new LitemallCouponUser();
  couponUser.setCouponId(couponId);
  couponUser.setUserId(userId);
  Short timeType=coupon.getTimeType();
  if (timeType.equals(CouponConstant.TIME_TYPE_TIME)) {
    couponUser.setStartTime(coupon.getStartTime());
    couponUser.setEndTime(coupon.getEndTime());
  }
 else {
    LocalDateTime now=LocalDateTime.now();
    couponUser.setStartTime(now);
    couponUser.setEndTime(now.plusDays(coupon.getDays()));
  }
  couponUserService.add(couponUser);
  return ResponseUtil.ok();
}

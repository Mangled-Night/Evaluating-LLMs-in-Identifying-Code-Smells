/** 
 * 进行从xml加载到zk中加载 源文件名：SchemasLoader.java 文件版本：1.0.0 创建作者：liujun 创建日期：2016年9月15日 修改作者：liujun 修改日期：2016年9月15日 文件描述：TODO 版权所有：Copyright 2016 zjhz, Inc. All Rights Reserved.
 */
public class SchemasxmlTozkLoader extends ZkMultLoader implements NotiflyService {
  /** 
 * 日志
 * @字段说明 LOGGER
 */
  private static final Logger LOGGER=LoggerFactory.getLogger(SchemasxmlTozkLoader.class);
  /** 
 * 当前文件中的zkpath信息 
 * @字段说明 currZkPath
 */
  private final String currZkPath;
  /** 
 * schema文件的路径信息
 * @字段说明 SCHEMA_PATH
 */
  private static final String SCHEMA_PATH=ZookeeperPath.ZK_LOCAL_CFG_PATH.getKey() + "schema.xml";
  /** 
 * schema类与xml转换服务 
 * @字段说明 parseSchemaService
 */
  private ParseXmlServiceInf<Schemas> parseSchemaXmlService;
  /** 
 * 进行将schema
 * @字段说明 parseJsonSchema
 */
  private ParseJsonServiceInf<List<Schema>> parseJsonSchema=new SchemaJsonParse();
  /** 
 * 进行将dataNode
 * @字段说明 parseJsonSchema
 */
  private ParseJsonServiceInf<List<DataNode>> parseJsonDataNode=new DataNodeJsonParse();
  /** 
 * 进行将dataNode
 * @字段说明 parseJsonSchema
 */
  private ParseJsonServiceInf<List<DataHost>> parseJsonDataHost=new DataHostJsonParse();
  public SchemasxmlTozkLoader(  ZookeeperProcessListen zookeeperListen,  CuratorFramework curator,  XmlProcessBase xmlParseBase){
    this.setCurator(curator);
    String schemaPath=zookeeperListen.getBasePath();
    schemaPath=schemaPath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FOW_ZK_PATH_SCHEMA.getKey();
    currZkPath=schemaPath;
    zookeeperListen.addListen(schemaPath,this);
    this.parseSchemaXmlService=new SchemasParseXmlImpl(xmlParseBase);
  }
  @Override public boolean notiflyProcess() throws Exception {
    Schemas schema=this.parseSchemaXmlService.parseXmlToBean(SCHEMA_PATH);
    LOGGER.info("SchemasxmlTozkLoader notiflyProcessxml to zk schema Object  :" + schema);
    this.xmlTozkSchemasJson(currZkPath,schema);
    LOGGER.info("SchemasxmlTozkLoader notiflyProcess xml to zk is success");
    return true;
  }
  /** 
 * 将xml文件的信息写入到zk中 方法描述
 * @param basePath 基本路径
 * @param schema schema文件的信息
 * @throws Exception 异常信息
 * @创建日期 2016年9月17日
 */
  private void xmlTozkSchemasJson(  String basePath,  Schemas schema) throws Exception {
    String schemaStr=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SCHEMA_SCHEMA.getKey();
    String schemaValueStr=this.parseJsonSchema.parseBeanToJson(schema.getSchema());
    this.checkAndwriteString(basePath,schemaStr,schemaValueStr);
    String dataNodeStr=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SCHEMA_DATANODE.getKey();
    String dataNodeValueStr=this.parseJsonDataNode.parseBeanToJson(schema.getDataNode());
    this.checkAndwriteString(basePath,dataNodeStr,dataNodeValueStr);
    String dataHostStr=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SCHEMA_DATAHOST.getKey();
    String dataHostValueStr=this.parseJsonDataHost.parseBeanToJson(schema.getDataHost());
    this.checkAndwriteString(basePath,dataHostStr,dataHostValueStr);
  }
}

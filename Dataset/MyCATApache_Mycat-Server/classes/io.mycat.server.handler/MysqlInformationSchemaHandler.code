/** 
 * 对 PhpAdmin's 控制台操作进行支持  如：SELECT * FROM information_schema.CHARACTER_SETS 等相关语句进行模拟返回
 * @author zhuam
 */
public class MysqlInformationSchemaHandler {
  /** 
 * 写入数据包
 * @param field_count
 * @param fields
 * @param c
 */
  private static void doWrite(  int field_count,  FieldPacket[] fields,  ServerConnection c){
    ByteBuffer buffer=c.allocate();
    ResultSetHeaderPacket header=PacketUtil.getHeader(field_count);
    byte packetId=header.packetId;
    buffer=header.write(buffer,c,true);
    for (    FieldPacket field : fields) {
      field.packetId=++packetId;
      buffer=field.write(buffer,c,true);
    }
    EOFPacket eof=new EOFPacket();
    eof.packetId=++packetId;
    buffer=eof.write(buffer,c,true);
    EOFPacket lastEof=new EOFPacket();
    lastEof.packetId=++packetId;
    buffer=lastEof.write(buffer,c,true);
    c.write(buffer);
  }
  public static void handle(  String sql,  ServerConnection c){
    SchemaUtil.SchemaInfo schemaInfo=SchemaUtil.parseSchema(sql);
    if (schemaInfo != null) {
      if (schemaInfo.table.toUpperCase().equals("CHARACTER_SETS")) {
        int field_count=4;
        FieldPacket[] fields=new FieldPacket[field_count];
        fields[0]=PacketUtil.getField("CHARACTER_SET_NAME",Fields.FIELD_TYPE_VAR_STRING);
        fields[1]=PacketUtil.getField("DEFAULT_COLLATE_NAME",Fields.FIELD_TYPE_VAR_STRING);
        fields[2]=PacketUtil.getField("DESCRIPTION",Fields.FIELD_TYPE_VAR_STRING);
        fields[3]=PacketUtil.getField("MAXLEN",Fields.FIELD_TYPE_LONG);
        doWrite(field_count,fields,c);
      }
 else {
        c.write(c.writeToBuffer(OkPacket.OK,c.allocate()));
      }
    }
 else {
      c.write(c.writeToBuffer(OkPacket.OK,c.allocate()));
    }
  }
}

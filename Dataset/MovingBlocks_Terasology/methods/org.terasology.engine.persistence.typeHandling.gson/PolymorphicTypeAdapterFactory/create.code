@Override public <R>TypeAdapter<R> create(Gson gson,TypeToken<R> type){
  if (!baseClass.isAssignableFrom(type.getRawType())) {
    return null;
  }
  return new TypeAdapter<R>(){
    @SuppressWarnings("unchecked") @Override public void write(    JsonWriter out,    R value) throws IOException {
      Class<?> valueClass=value.getClass();
      String valueTypeName=valueClass.getName();
      TypeToken<?> valueType=TypeToken.get(valueClass);
      TypeAdapter<R> delegate=(TypeAdapter<R>)gson.getDelegateAdapter(PolymorphicTypeAdapterFactory.this,valueType);
      if (delegate == null) {
        throw new JsonParseException("Could not serialize " + valueClass.getName());
      }
      JsonElement jsonElement=delegate.toJsonTree(value);
      if (valueClass != baseClass) {
        JsonObject jsonObject=jsonElement.getAsJsonObject();
        JsonObject clone=new JsonObject();
        clone.add(TYPE_FIELD_NAME,new JsonPrimitive(valueTypeName));
        for (        Map.Entry<String,JsonElement> e : jsonObject.entrySet()) {
          clone.add(e.getKey(),e.getValue());
        }
        Streams.write(clone,out);
      }
 else {
        Streams.write(jsonElement,out);
      }
    }
    @SuppressWarnings("unchecked") @Override public R read(    JsonReader in) throws IOException {
      JsonElement jsonElement=Streams.parse(in);
      Class<?> valueClass;
      if (jsonElement.isJsonObject()) {
        JsonElement typeNameJsonElement=jsonElement.getAsJsonObject().remove(TYPE_FIELD_NAME);
        if (typeNameJsonElement != null) {
          String typeName=typeNameJsonElement.getAsString();
          try {
            valueClass=Class.forName(typeName);
          }
 catch (          ClassNotFoundException e) {
            throw new JsonParseException("Could not find class " + typeName);
          }
        }
 else {
          valueClass=baseClass;
        }
      }
 else {
        valueClass=baseClass;
      }
      if (!baseClass.isAssignableFrom(valueClass)) {
        throw new JsonParseException(valueClass.getName() + " does not derive from " + baseClass.getName());
      }
      TypeToken<?> valueType=TypeToken.get(valueClass);
      TypeAdapter<R> delegate=(TypeAdapter<R>)gson.getDelegateAdapter(PolymorphicTypeAdapterFactory.this,valueType);
      if (delegate == null) {
        throw new JsonParseException("Could not deserialize " + valueClass.getName());
      }
      return delegate.fromJsonTree(jsonElement);
    }
  }
;
}

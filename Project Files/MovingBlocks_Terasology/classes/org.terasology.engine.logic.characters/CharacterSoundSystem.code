@RegisterSystem(RegisterMode.ALWAYS) public class CharacterSoundSystem extends BaseComponentSystem {
  public static final long MIN_TIME=10;
  private static final Logger logger=LoggerFactory.getLogger(CharacterSoundSystem.class);
  private static final float LANDING_VOLUME_MODIFIER=0.2f;
  private static final float LANDING_VELOCITY_THRESHOLD=7;
  private static final float LANDING_VOLUME_MAX=2;
  private Random random=new FastRandom();
  @In private Time time;
  @In private WorldProvider worldProvider;
  @ReceiveEvent public void onFootstep(  FootstepEvent event,  EntityRef entity,  LocationComponent locationComponent,  CharacterSoundComponent characterSounds){
    List<StaticSound> footstepSounds=characterSounds.footstepSounds;
    Vector3i blockPos=new Vector3i(locationComponent.getLocalPosition(),RoundingMode.FLOOR);
    blockPos.y--;
    Block block=worldProvider.getBlock(blockPos);
    if (block != null) {
      if (block.getSounds() == null) {
        logger.error("Block '{}' has no sounds",block.getURI());
      }
 else       if (!block.getSounds().getStepSounds().isEmpty()) {
        footstepSounds=block.getSounds().getStepSounds();
      }
    }
    if (footstepSounds.size() > 0 && characterSounds.lastSoundTime + MIN_TIME < time.getGameTimeInMs()) {
      StaticSound sound=random.nextItem(footstepSounds);
      entity.send(new PlaySoundEvent(entity,sound,characterSounds.footstepVolume));
      characterSounds.lastSoundTime=time.getGameTimeInMs();
      entity.saveComponent(characterSounds);
    }
  }
  @ReceiveEvent public void onJump(  JumpEvent event,  EntityRef entity,  CharacterSoundComponent characterSounds){
    if (characterSounds.lastSoundTime + MIN_TIME < time.getGameTimeInMs()) {
      StaticSound sound=null;
      if (characterSounds.jumpSounds.size() > 0) {
        sound=random.nextItem(characterSounds.jumpSounds);
      }
 else       if (characterSounds.footstepSounds.size() > 0) {
        sound=random.nextItem(characterSounds.footstepSounds);
      }
      if (sound != null) {
        entity.send(new PlaySoundEvent(entity,sound,characterSounds.jumpVolume));
        characterSounds.lastSoundTime=time.getGameTimeInMs();
        entity.saveComponent(characterSounds);
      }
    }
  }
  @ReceiveEvent public void onLanded(  VerticalCollisionEvent event,  EntityRef entity,  CharacterSoundComponent characterSounds){
    Vector3f velocity=event.getVelocity();
    float soundVolumeModifier=(velocity.y * -1 - LANDING_VELOCITY_THRESHOLD) * LANDING_VOLUME_MODIFIER;
    if (soundVolumeModifier <= 0f) {
      return;
    }
    if (soundVolumeModifier > LANDING_VOLUME_MAX) {
      soundVolumeModifier=LANDING_VOLUME_MAX;
    }
    if (characterSounds.lastSoundTime + MIN_TIME < time.getGameTimeInMs()) {
      StaticSound sound=null;
      if (characterSounds.landingSounds.size() > 0) {
        sound=random.nextItem(characterSounds.landingSounds);
      }
 else       if (characterSounds.footstepSounds.size() > 0) {
        sound=random.nextItem(characterSounds.footstepSounds);
      }
      if (sound != null) {
        entity.send(new PlaySoundEvent(entity,sound,characterSounds.landingVolume * soundVolumeModifier));
        characterSounds.lastSoundTime=time.getGameTimeInMs();
        entity.saveComponent(characterSounds);
      }
    }
  }
  @ReceiveEvent public void onDeath(  DoDestroyEvent event,  EntityRef entity,  CharacterSoundComponent characterSounds){
    if (characterSounds.deathSounds.size() > 0) {
      StaticSound sound=random.nextItem(characterSounds.deathSounds);
      entity.send(new PlaySoundEvent(entity,sound,characterSounds.deathVolume));
    }
  }
  @ReceiveEvent public void onPlayerDeath(  PlayerDeathEvent event,  EntityRef character){
    CharacterSoundComponent characterSounds=character.getComponent(CharacterSoundComponent.class);
    if (characterSounds.deathSounds.size() > 0) {
      StaticSound sound=random.nextItem(characterSounds.deathSounds);
      character.send(new PlaySoundEvent(character,sound,characterSounds.deathVolume));
    }
  }
  @ReceiveEvent public void onRespawn(  OnPlayerRespawnedEvent event,  EntityRef character,  CharacterSoundComponent characterSounds){
    if (characterSounds.respawnSounds.size() > 0) {
      StaticSound sound=random.nextItem(characterSounds.respawnSounds);
      character.send(new PlaySoundEvent(character,sound,characterSounds.respawnVolume));
    }
  }
  @ReceiveEvent public void onSwimStroke(  SwimStrokeEvent event,  EntityRef entity,  CharacterSoundComponent characterSounds){
    if (characterSounds.swimSounds.size() > 0 && characterSounds.lastSoundTime + MIN_TIME < time.getGameTimeInMs()) {
      StaticSound sound=random.nextItem(characterSounds.swimSounds);
      entity.send(new PlaySoundEvent(entity,sound,characterSounds.swimmingVolume));
      characterSounds.lastSoundTime=time.getGameTimeInMs();
      entity.saveComponent(characterSounds);
    }
  }
  @ReceiveEvent public void onEnterBlock(  OnEnterBlockEvent event,  EntityRef entity,  CharacterSoundComponent characterSounds){
    if (event.getCharacterRelativePosition().y == 0 && characterSounds.lastSoundTime + MIN_TIME < time.getGameTimeInMs()) {
      boolean oldBlockIsLiquid=event.getOldBlock().isLiquid();
      boolean newBlockIsLiquid=event.getNewBlock().isLiquid();
      StaticSound sound=null;
      if (!oldBlockIsLiquid && newBlockIsLiquid) {
        sound=random.nextItem(characterSounds.enterWaterSounds);
      }
 else       if (oldBlockIsLiquid && !newBlockIsLiquid) {
        sound=random.nextItem(characterSounds.leaveWaterSounds);
      }
      if (sound != null) {
        entity.send(new PlaySoundEvent(entity,sound,characterSounds.diveVolume));
        characterSounds.lastSoundTime=time.getGameTimeInMs();
        entity.saveComponent(characterSounds);
      }
    }
  }
}

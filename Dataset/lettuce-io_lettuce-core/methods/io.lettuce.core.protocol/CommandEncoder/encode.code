@Override @SuppressWarnings("unchecked") protected void encode(ChannelHandlerContext ctx,Object msg,ByteBuf out) throws Exception {
  out.touch("CommandEncoder.encode(â€¦)");
  if (msg instanceof RedisCommand) {
    RedisCommand<?,?,?> command=(RedisCommand<?,?,?>)msg;
    encode(ctx,out,command);
  }
  if (msg instanceof Collection) {
    Collection<RedisCommand<?,?,?>> commands=(Collection<RedisCommand<?,?,?>>)msg;
    for (    RedisCommand<?,?,?> command : commands) {
      encode(ctx,out,command);
    }
  }
}
private void encode(ChannelHandlerContext ctx,ByteBuf out,RedisCommand<?,?,?> command){
  try {
    out.markWriterIndex();
    command.encode(out);
  }
 catch (  RuntimeException e) {
    out.resetWriterIndex();
    command.completeExceptionally(new EncoderException("Cannot encode command. Please close the connection as the connection state may be out of sync.",e));
  }
  if (debugEnabled) {
    logger.debug("{} writing command {}",logPrefix(ctx.channel()),command);
    if (traceEnabled) {
      logger.trace("{} Sent: {}",logPrefix(ctx.channel()),out.toString(Charset.defaultCharset()).trim());
    }
  }
}

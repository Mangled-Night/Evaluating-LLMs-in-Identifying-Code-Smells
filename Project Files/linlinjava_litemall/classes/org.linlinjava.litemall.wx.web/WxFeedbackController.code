/** 
 * 意见反馈服务
 * @author Yogeek
 * @date 2018/8/25 14:10
 */
@RestController @RequestMapping("/wx/feedback") @Validated public class WxFeedbackController {
  private final Log logger=LogFactory.getLog(WxFeedbackController.class);
  @Autowired private LitemallFeedbackService feedbackService;
  @Autowired private LitemallUserService userService;
  private Object validate(  LitemallFeedback feedback){
    String content=feedback.getContent();
    if (StringUtils.isEmpty(content)) {
      return ResponseUtil.badArgument();
    }
    String type=feedback.getFeedType();
    if (StringUtils.isEmpty(type)) {
      return ResponseUtil.badArgument();
    }
    Boolean hasPicture=feedback.getHasPicture();
    if (hasPicture == null || !hasPicture) {
      feedback.setPicUrls(new String[0]);
    }
    String mobile=feedback.getMobile();
    if (StringUtils.isEmpty(mobile)) {
      return ResponseUtil.badArgument();
    }
    if (!RegexUtil.isMobileSimple(mobile)) {
      return ResponseUtil.badArgument();
    }
    return null;
  }
  /** 
 * 添加意见反馈
 * @param userId   用户ID
 * @param feedback 意见反馈
 * @return 操作结果
 */
  @PostMapping("submit") public Object submit(  @LoginUser Integer userId,  @RequestBody LitemallFeedback feedback){
    if (userId == null) {
      return ResponseUtil.unlogin();
    }
    Object error=validate(feedback);
    if (error != null) {
      return error;
    }
    LitemallUser user=userService.findById(userId);
    String username=user.getUsername();
    feedback.setId(null);
    feedback.setUserId(userId);
    feedback.setUsername(username);
    feedback.setStatus(1);
    feedbackService.add(feedback);
    return ResponseUtil.ok();
  }
}

public abstract static class StressTestFailedException extends Exception {
  private static final long serialVersionUID=1L;
  protected StressTestFailedException(  String message){
    super(message);
  }
public static final class NotAllMessagesReceivedException extends StressTestFailedException {
    private static final long serialVersionUID=1L;
    public final Map<XMPPConnection,Map<EntityFullJid,boolean[]>> receiveMarkers;
    private NotAllMessagesReceivedException(    Map<XMPPConnection,Map<EntityFullJid,boolean[]>> receiveMarkers,    List<? extends XMPPConnection> connections){
      super("Did not receive all messages\n" + markersToString(receiveMarkers,connections).toString());
      this.receiveMarkers=receiveMarkers;
    }
    public static StringBuilder markersToString(    Map<XMPPConnection,Map<EntityFullJid,boolean[]>> receiveMarkers,    List<? extends XMPPConnection> connections){
      StringBuilder sb=new StringBuilder();
      final int connectionCount=connections.size();
      Map<EntityFullJid,Integer> connectionIds=new HashMap<>(connectionCount);
      for (int i=0; i < connectionCount; i++) {
        XMPPConnection connection=connections.get(i);
        EntityFullJid connectionAddress=connection.getUser();
        connectionIds.put(connectionAddress,i);
        sb.append(i).append(": ").append(connection).append('\n');
      }
      for (      Map.Entry<XMPPConnection,Map<EntityFullJid,boolean[]>> entry : receiveMarkers.entrySet()) {
        XMPPConnection connection=entry.getKey();
        Map<EntityFullJid,boolean[]> receiveMarkersOfThisConnection=entry.getValue();
        Integer markerToConnectionId=connectionIds.get(connection.getUser());
        for (        Map.Entry<EntityFullJid,boolean[]> receiveMarkerOfThisConnection : receiveMarkersOfThisConnection.entrySet()) {
          boolean[] marker=receiveMarkerOfThisConnection.getValue();
          int numberOfFalseMarkers=BooleansUtils.numberOf(marker,false);
          if (numberOfFalseMarkers == 0) {
            continue;
          }
          EntityFullJid markerFromAddress=receiveMarkerOfThisConnection.getKey();
          Integer markerFromConnectionId=connectionIds.get(markerFromAddress);
          sb.append(markerToConnectionId).append(" is missing ").append(numberOfFalseMarkers).append(" messages from ").append(markerFromConnectionId).append(": ");
          for (int i=0; i < marker.length; i++) {
            if (marker[i]) {
              continue;
            }
            sb.append(i).append(", ");
          }
          sb.setLength(sb.length() - 2);
          sb.append('\n');
        }
      }
      return sb;
    }
  }
public static final class ErrorsWhileSendingOrReceivingException extends StressTestFailedException {
    private static final long serialVersionUID=1L;
    public final Map<XMPPConnection,Exception> sendExceptions;
    public final Map<XMPPConnection,Exception> receiveExceptions;
    private ErrorsWhileSendingOrReceivingException(    Map<XMPPConnection,Exception> sendExceptions,    Map<XMPPConnection,Exception> receiveExceptions){
      super(createMessageFrom(sendExceptions,receiveExceptions));
      this.sendExceptions=sendExceptions;
      this.receiveExceptions=receiveExceptions;
    }
    private static String createMessageFrom(    Map<XMPPConnection,Exception> sendExceptions,    Map<XMPPConnection,Exception> receiveExceptions){
      StringBuilder sb=new StringBuilder(1024);
      sb.append("Exceptions while sending and/or receiving.");
      if (!sendExceptions.isEmpty()) {
        sb.append(" Send exxceptions: ");
        for (        Map.Entry<XMPPConnection,Exception> entry : sendExceptions.entrySet()) {
          sb.append(entry.getKey()).append(": ").append(entry.getValue()).append(';');
        }
      }
      if (!receiveExceptions.isEmpty()) {
        sb.append(" Receive exceptions: ");
        for (        Map.Entry<XMPPConnection,Exception> entry : receiveExceptions.entrySet()) {
          sb.append(entry.getKey()).append(": ").append(entry.getValue());
        }
      }
      return sb.toString();
    }
  }
}

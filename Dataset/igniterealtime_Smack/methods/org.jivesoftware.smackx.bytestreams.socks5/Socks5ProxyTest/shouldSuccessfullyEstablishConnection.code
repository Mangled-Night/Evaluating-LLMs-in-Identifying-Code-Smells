/** 
 * A Client should successfully establish a connection to the SOCKS5 proxy.
 * @throws Exception should not happen
 */
@Test public void shouldSuccessfullyEstablishConnection() throws Exception {
  Socks5Proxy proxy=new Socks5Proxy();
  proxy.start();
  try {
    assertTrue(proxy.isRunning());
    String digest=new String(new byte[]{(byte)0xAA},StandardCharsets.UTF_8);
    proxy.addTransfer(digest);
    @SuppressWarnings("resource") Socket socket=new Socket(loopbackAddress,proxy.getPort());
    OutputStream out=socket.getOutputStream();
    out.write(new byte[]{(byte)0x05,(byte)0x01,(byte)0x00});
    InputStream in=socket.getInputStream();
    assertEquals((byte)0x05,(byte)in.read());
    assertEquals((byte)0x00,(byte)in.read());
    out.write(new byte[]{(byte)0x05,(byte)0x00,(byte)0x00,(byte)0x03,(byte)0x01,(byte)0xAA,(byte)0x00,(byte)0x00});
    assertEquals((byte)0x05,(byte)in.read());
    assertEquals((byte)0x00,(byte)in.read());
    assertEquals((byte)0x00,(byte)in.read());
    assertEquals((byte)0x03,(byte)in.read());
    assertEquals((byte)0x01,(byte)in.read());
    assertEquals((byte)0xAA,(byte)in.read());
    assertEquals((byte)0x00,(byte)in.read());
    assertEquals((byte)0x00,(byte)in.read());
    Socket remoteSocket=proxy.getSocket(digest);
    try {
      proxy.removeTransfer(digest);
      OutputStream remoteOut=remoteSocket.getOutputStream();
      byte[] data=new byte[]{1,2,3,4,5};
      remoteOut.write(data);
      remoteOut.flush();
      for (int i=0; i < data.length; i++) {
        assertEquals(data[i],in.read());
      }
    }
  finally {
      remoteSocket.close();
    }
    assertEquals(-1,in.read());
  }
  finally {
    proxy.stop();
  }
}

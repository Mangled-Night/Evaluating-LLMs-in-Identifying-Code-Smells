/** 
 * Multi-nodes 1pc Commit Handle 
 */
public void executeBatchNodeCmd(SQLCtrlCommand cmdHandler){
  this.cmdHandler=cmdHandler;
  final int initCount=session.getTargetCount();
  runningCount.set(initCount);
  nodeCount=initCount;
  failed.set(false);
  faileCount.set(0);
  if (prepareCount.get() != 0) {
  }
  prepareCount.set(0);
  if (session.getXaTXID() != null) {
    coorXaStatus=TxState.TX_STARTED_STATE;
    writeRecoverLog(initCount);
  }
 else {
    coorXaStatus=-1;
  }
  int started=0;
  for (  RouteResultsetNode rrn : session.getTargetKeys()) {
    if (rrn == null) {
      LOGGER.error("null is contained in RoutResultsetNodes, source = " + session.getSource());
      continue;
    }
    final BackendConnection conn=session.getTarget(rrn);
    if (conn != null) {
      conn.setResponseHandler(this);
      if (conn instanceof MySQLConnection) {
        MySQLConnection mysqlCon=(MySQLConnection)conn;
        String xaTxId=null;
        if (session.getXaTXID() != null) {
          xaTxId=session.getXaTXID() + ",'" + mysqlCon.getSchema()+ "'";
        }
        if (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) {
          String[] cmds=new String[]{"XA END " + xaTxId,"XA PREPARE " + xaTxId};
          if (LOGGER.isDebugEnabled()) {
            LOGGER.debug("Start execute the batch cmd : " + cmds[0] + ";"+ cmds[1]+ ","+ "current connection:"+ conn.getHost()+ ":"+ conn.getPort());
          }
          mysqlCon.execBatchCmd(cmds);
        }
 else {
          cmdHandler.sendCommand(session,conn);
        }
      }
 else {
        cmdHandler.sendCommand(session,conn);
      }
      ++started;
    }
  }
  if (started < nodeCount) {
    runningCount.set(started);
    LOGGER.warn("some connection failed to execute " + (nodeCount - started));
    failed.set(true);
  }
}

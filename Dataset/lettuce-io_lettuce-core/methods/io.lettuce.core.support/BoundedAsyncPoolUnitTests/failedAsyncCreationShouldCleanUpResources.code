@Test void failedAsyncCreationShouldCleanUpResources(){
  AtomicInteger cleanups=new AtomicInteger();
  AtomicInteger creations=new AtomicInteger();
  CompletionStage<BoundedAsyncPool<String>> pool=BoundedAsyncPool.create(new AsyncObjectFactory<String>(){
    @Override public CompletableFuture<String> create(){
      if (creations.incrementAndGet() == 1) {
        return io.lettuce.core.internal.Futures.failed(new IllegalStateException());
      }
      return CompletableFuture.completedFuture("ok");
    }
    @Override public CompletableFuture<Void> destroy(    String object){
      cleanups.incrementAndGet();
      return CompletableFuture.completedFuture(null);
    }
    @Override public CompletableFuture<Boolean> validate(    String object){
      return null;
    }
  }
,BoundedPoolConfig.builder().minIdle(5).build());
  assertThatExceptionOfType(CompletionException.class).isThrownBy(pool.toCompletableFuture()::join).withCauseInstanceOf(RedisException.class).withRootCauseInstanceOf(IllegalStateException.class);
  assertThat(cleanups).hasValue(4);
}

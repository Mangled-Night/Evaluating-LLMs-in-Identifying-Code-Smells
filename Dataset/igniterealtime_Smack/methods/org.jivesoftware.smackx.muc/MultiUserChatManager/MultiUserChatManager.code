private MultiUserChatManager(XMPPConnection connection){
  super(connection);
  serviceDiscoveryManager=ServiceDiscoveryManager.getInstanceFor(connection);
  StanzaListener invitationPacketListener=new StanzaListener(){
    @Override public void processStanza(    Stanza packet){
      final Message message=(Message)packet;
      final MUCUser mucUser=MUCUser.from(message);
      if (mucUser.getInvite() != null) {
        EntityBareJid mucJid=message.getFrom().asEntityBareJidIfPossible();
        if (mucJid == null) {
          LOGGER.warning("Invite to non bare JID: '" + message.toXML() + "'");
          return;
        }
        final MultiUserChat muc=getMultiUserChat(mucJid);
        final XMPPConnection connection=connection();
        final MUCUser.Invite invite=mucUser.getInvite();
        final EntityJid from=invite.getFrom();
        final String reason=invite.getReason();
        final String password=mucUser.getPassword();
        for (        final InvitationListener listener : invitationsListeners) {
          listener.invitationReceived(connection,muc,from,reason,password,message,invite);
        }
      }
    }
  }
;
  connection.addAsyncStanzaListener(invitationPacketListener,INVITATION_FILTER);
  connection.addConnectionListener(new ConnectionListener(){
    @Override public void authenticated(    XMPPConnection connection,    boolean resumed){
      if (resumed)       return;
      if (!autoJoinOnReconnect)       return;
      final Set<EntityBareJid> mucs=getJoinedRooms();
      if (mucs.isEmpty())       return;
      Async.go(new Runnable(){
        @Override public void run(){
          final AutoJoinFailedCallback failedCallback=autoJoinFailedCallback;
          final AutoJoinSuccessCallback successCallback=autoJoinSuccessCallback;
          for (          EntityBareJid mucJid : mucs) {
            MultiUserChat muc=getMultiUserChat(mucJid);
            if (!muc.isJoined())             return;
            Resourcepart nickname=muc.getNickname();
            if (nickname == null)             return;
            try {
              muc.leave();
            }
 catch (            NotConnectedException|InterruptedException|MucNotJoinedException|NoResponseException|XMPPErrorException e) {
              if (failedCallback != null) {
                failedCallback.autoJoinFailed(muc,e);
              }
 else {
                LOGGER.log(Level.WARNING,"Could not leave room",e);
              }
              return;
            }
            try {
              muc.join(nickname);
              if (successCallback != null) {
                successCallback.autoJoinSuccess(muc,nickname);
              }
            }
 catch (            NotAMucServiceException|NoResponseException|XMPPErrorException|NotConnectedException|InterruptedException e) {
              if (failedCallback != null) {
                failedCallback.autoJoinFailed(muc,e);
              }
 else {
                LOGGER.log(Level.WARNING,"Could not leave room",e);
              }
              return;
            }
          }
        }
      }
);
    }
  }
);
}

private static class CompressingValueCodecWrapper implements RedisCodec<Object,Object> {
  private RedisCodec<Object,Object> delegate;
  private CompressionType compressionType;
  public CompressingValueCodecWrapper(  RedisCodec<Object,Object> delegate,  CompressionType compressionType){
    this.delegate=delegate;
    this.compressionType=compressionType;
  }
  @Override public Object decodeKey(  ByteBuffer bytes){
    return delegate.decodeKey(bytes);
  }
  @Override public Object decodeValue(  ByteBuffer bytes){
    try {
      return delegate.decodeValue(decompress(bytes));
    }
 catch (    IOException e) {
      throw new IllegalStateException(e);
    }
  }
  @Override public ByteBuffer encodeKey(  Object key){
    return delegate.encodeKey(key);
  }
  @Override public ByteBuffer encodeValue(  Object value){
    try {
      return compress(delegate.encodeValue(value));
    }
 catch (    IOException e) {
      throw new IllegalStateException(e);
    }
  }
  private ByteBuffer compress(  ByteBuffer source) throws IOException {
    if (source.remaining() == 0) {
      return source;
    }
    ByteArrayOutputStream outputStream=new ByteArrayOutputStream(source.remaining() / 2);
    OutputStream compressor=null;
    try {
      try (ByteBufferInputStream sourceStream=new ByteBufferInputStream(source)){
        if (compressionType == CompressionType.GZIP) {
          compressor=new GZIPOutputStream(outputStream);
        }
        if (compressionType == CompressionType.DEFLATE) {
          compressor=new DeflaterOutputStream(outputStream);
        }
        copy(sourceStream,compressor);
      }
  finally {
        if (compressor != null) {
          compressor.close();
        }
      }
      return ByteBuffer.wrap(outputStream.toByteArray());
    }
  finally {
      outputStream.close();
    }
  }
  private ByteBuffer decompress(  ByteBuffer source) throws IOException {
    if (source.remaining() == 0) {
      return source;
    }
    InputStream decompressor=null;
    ByteArrayOutputStream outputStream=new ByteArrayOutputStream(source.remaining() * 2);
    try {
      try (ByteBufferInputStream sourceStream=new ByteBufferInputStream(source)){
        if (compressionType == CompressionType.GZIP) {
          decompressor=new GZIPInputStream(sourceStream);
        }
        if (compressionType == CompressionType.DEFLATE) {
          decompressor=new InflaterInputStream(sourceStream);
        }
        copy(decompressor,outputStream);
      }
  finally {
        if (decompressor != null) {
          decompressor.close();
        }
      }
      return ByteBuffer.wrap(outputStream.toByteArray());
    }
  finally {
      outputStream.close();
    }
  }
}

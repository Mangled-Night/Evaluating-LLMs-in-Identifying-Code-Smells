public final class JingleManager extends Manager {
  private static final Logger LOGGER=Logger.getLogger(JingleManager.class.getName());
  private static final Map<XMPPConnection,JingleManager> INSTANCES=new WeakHashMap<>();
  private static final ExecutorService threadPool=Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());
  public static ExecutorService getThreadPool(){
    return threadPool;
  }
  public static synchronized JingleManager getInstanceFor(  XMPPConnection connection){
    JingleManager jingleManager=INSTANCES.get(connection);
    if (jingleManager == null) {
      jingleManager=new JingleManager(connection);
      INSTANCES.put(connection,jingleManager);
    }
    return jingleManager;
  }
  private final Map<String,JingleHandler> descriptionHandlers=new ConcurrentHashMap<>();
  private final Map<FullJidAndSessionId,JingleSessionHandler> jingleSessionHandlers=new ConcurrentHashMap<>();
  private final JingleUtil jutil;
  private JingleManager(  XMPPConnection connection){
    super(connection);
    jutil=new JingleUtil(connection);
    connection.registerIQRequestHandler(new AbstractIqRequestHandler(Jingle.ELEMENT,Jingle.NAMESPACE,IQ.Type.set,Mode.async){
      @Override public IQ handleIQRequest(      IQ iqRequest){
        final Jingle jingle=(Jingle)iqRequest;
        FullJid fullFrom=jingle.getFrom().asFullJidOrThrow();
        String sid=jingle.getSid();
        FullJidAndSessionId fullJidAndSessionId=new FullJidAndSessionId(fullFrom,sid);
        JingleSessionHandler sessionHandler=jingleSessionHandlers.get(fullJidAndSessionId);
        if (sessionHandler != null) {
          return sessionHandler.handleJingleSessionRequest(jingle);
        }
        if (jingle.getAction() == JingleAction.session_initiate) {
          JingleContent content=jingle.getContents().get(0);
          JingleContentDescription description=content.getDescription();
          JingleHandler jingleDescriptionHandler=descriptionHandlers.get(description.getNamespace());
          if (jingleDescriptionHandler == null) {
            LOGGER.log(Level.WARNING,"Unsupported Jingle application.");
            return jutil.createSessionTerminateUnsupportedApplications(fullFrom,sid);
          }
          return jingleDescriptionHandler.handleJingleRequest(jingle);
        }
        LOGGER.log(Level.WARNING,"Unknown session.");
        return jutil.createErrorUnknownSession(jingle);
      }
    }
);
    JingleTransportMethodManager transportMethodManager=JingleTransportMethodManager.getInstanceFor(connection);
    transportMethodManager.registerTransportManager(JingleIBBTransportManager.getInstanceFor(connection));
    transportMethodManager.registerTransportManager(JingleS5BTransportManager.getInstanceFor(connection));
  }
  public JingleHandler registerDescriptionHandler(  String namespace,  JingleHandler handler){
    return descriptionHandlers.put(namespace,handler);
  }
  public JingleSessionHandler registerJingleSessionHandler(  FullJid otherJid,  String sessionId,  JingleSessionHandler sessionHandler){
    FullJidAndSessionId fullJidAndSessionId=new FullJidAndSessionId(otherJid,sessionId);
    return jingleSessionHandlers.put(fullJidAndSessionId,sessionHandler);
  }
  public JingleSessionHandler unregisterJingleSessionHandler(  FullJid otherJid,  String sessionId,  JingleSessionHandler sessionHandler){
    FullJidAndSessionId fullJidAndSessionId=new FullJidAndSessionId(otherJid,sessionId);
    return jingleSessionHandlers.remove(fullJidAndSessionId);
  }
  public static String randomId(){
    return StringUtils.randomString(24);
  }
}

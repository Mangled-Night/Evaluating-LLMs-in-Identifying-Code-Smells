/** 
 * 订单退款 <p> 1. 检测当前订单是否能够退款; 2. 微信退款操作; 3. 设置订单退款确认状态； 4. 订单商品库存回库。 <p> TODO 虽然接入了微信退款API，但是从安全角度考虑，建议开发者删除这里微信退款代码，采用以下两步走步骤： 1. 管理员登录微信官方支付平台点击退款操作进行退款 2. 管理员登录litemall管理后台点击退款操作进行订单状态修改和商品库存回库
 * @param body 订单信息，{ orderId：xxx }
 * @return 订单退款操作结果
 */
@Transactional public Object refund(String body){
  Integer orderId=JacksonUtil.parseInteger(body,"orderId");
  String refundMoney=JacksonUtil.parseString(body,"refundMoney");
  if (orderId == null) {
    return ResponseUtil.badArgument();
  }
  if (StringUtils.isEmpty(refundMoney)) {
    return ResponseUtil.badArgument();
  }
  LitemallOrder order=orderService.findById(orderId);
  if (order == null) {
    return ResponseUtil.badArgument();
  }
  if (order.getActualPrice().compareTo(new BigDecimal(refundMoney)) != 0) {
    return ResponseUtil.badArgumentValue();
  }
  if (!order.getOrderStatus().equals(OrderUtil.STATUS_REFUND)) {
    return ResponseUtil.fail(ORDER_CONFIRM_NOT_ALLOWED,"订单不能确认收货");
  }
  WxPayRefundRequest wxPayRefundRequest=new WxPayRefundRequest();
  wxPayRefundRequest.setOutTradeNo(order.getOrderSn());
  wxPayRefundRequest.setOutRefundNo("refund_" + order.getOrderSn());
  Integer totalFee=order.getActualPrice().multiply(new BigDecimal(100)).intValue();
  wxPayRefundRequest.setTotalFee(totalFee);
  wxPayRefundRequest.setRefundFee(totalFee);
  WxPayRefundResult wxPayRefundResult;
  try {
    wxPayRefundResult=wxPayService.refund(wxPayRefundRequest);
  }
 catch (  WxPayException e) {
    logger.error(e.getMessage(),e);
    return ResponseUtil.fail(ORDER_REFUND_FAILED,"订单退款失败");
  }
  if (!wxPayRefundResult.getReturnCode().equals("SUCCESS")) {
    logger.warn("refund fail: " + wxPayRefundResult.getReturnMsg());
    return ResponseUtil.fail(ORDER_REFUND_FAILED,"订单退款失败");
  }
  if (!wxPayRefundResult.getResultCode().equals("SUCCESS")) {
    logger.warn("refund fail: " + wxPayRefundResult.getReturnMsg());
    return ResponseUtil.fail(ORDER_REFUND_FAILED,"订单退款失败");
  }
  LocalDateTime now=LocalDateTime.now();
  order.setOrderStatus(OrderUtil.STATUS_REFUND_CONFIRM);
  order.setEndTime(now);
  order.setRefundAmount(order.getActualPrice());
  order.setRefundType("微信退款接口");
  order.setRefundContent(wxPayRefundResult.getRefundId());
  order.setRefundTime(now);
  if (orderService.updateWithOptimisticLocker(order) == 0) {
    throw new RuntimeException("更新数据已失效");
  }
  List<LitemallOrderGoods> orderGoodsList=orderGoodsService.queryByOid(orderId);
  for (  LitemallOrderGoods orderGoods : orderGoodsList) {
    Integer productId=orderGoods.getProductId();
    Short number=orderGoods.getNumber();
    if (productService.addStock(productId,number) == 0) {
      throw new RuntimeException("商品货品库存增加失败");
    }
  }
  List<LitemallCouponUser> couponUsers=couponUserService.findByOid(orderId);
  for (  LitemallCouponUser couponUser : couponUsers) {
    couponUser.setStatus(CouponUserConstant.STATUS_USABLE);
    couponUser.setUpdateTime(LocalDateTime.now());
    couponUserService.update(couponUser);
  }
  notifyService.notifySmsTemplate(order.getMobile(),NotifyType.REFUND,new String[]{order.getOrderSn().substring(8,14)});
  logHelper.logOrderSucceed("退款","订单编号 " + order.getOrderSn());
  return ResponseUtil.ok();
}

/** 
 * Creates a new  {@link GenericObjectPool} using the {@link Supplier}. Allocated instances are wrapped and must not be returned with  {@link ObjectPool#returnObject(Object)}.
 * @param connectionSupplier must not be {@code null}.
 * @param config must not be {@code null}.
 * @param < T > connection type.
 * @return the connection pool.
 */
public static <T extends StatefulConnection<?,?>>GenericObjectPool<T> createGenericObjectPool(Supplier<T> connectionSupplier,GenericObjectPoolConfig<T> config){
  return createGenericObjectPool(connectionSupplier,config,true);
}
/** 
 * Creates a new  {@link GenericObjectPool} using the {@link Supplier}.
 * @param connectionSupplier must not be {@code null}.
 * @param config must not be {@code null}.
 * @param wrapConnections {@code false} to return direct connections that need to be returned to the pool using{@link ObjectPool#returnObject(Object)}.  {@code true} to return wrapped connection that are returned to thepool when invoking  {@link StatefulConnection#close()}.
 * @param < T > connection type.
 * @return the connection pool.
 */
@SuppressWarnings("unchecked") public static <T extends StatefulConnection<?,?>>GenericObjectPool<T> createGenericObjectPool(Supplier<T> connectionSupplier,GenericObjectPoolConfig<T> config,boolean wrapConnections){
  LettuceAssert.notNull(connectionSupplier,"Connection supplier must not be null");
  LettuceAssert.notNull(config,"GenericObjectPoolConfig must not be null");
  AtomicReference<Origin<T>> poolRef=new AtomicReference<>();
  GenericObjectPool<T> pool=new GenericObjectPool<T>(new RedisPooledObjectFactory<T>(connectionSupplier),config){
    @Override public T borrowObject() throws Exception {
      return wrapConnections ? ConnectionWrapping.wrapConnection(super.borrowObject(),poolRef.get()) : super.borrowObject();
    }
    @Override public void returnObject(    T obj){
      if (wrapConnections && obj instanceof HasTargetConnection) {
        super.returnObject((T)((HasTargetConnection)obj).getTargetConnection());
        return;
      }
      super.returnObject(obj);
    }
  }
;
  poolRef.set(new ObjectPoolWrapper<>(pool));
  return pool;
}

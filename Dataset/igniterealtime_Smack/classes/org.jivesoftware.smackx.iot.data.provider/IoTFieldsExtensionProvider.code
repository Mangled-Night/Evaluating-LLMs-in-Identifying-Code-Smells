public class IoTFieldsExtensionProvider extends ExtensionElementProvider<IoTFieldsExtension> {
  private static final Logger LOGGER=Logger.getLogger(IoTFieldsExtensionProvider.class.getName());
  @Override public IoTFieldsExtension parse(  XmlPullParser parser,  int initialDepth,  XmlEnvironment xmlEnvironment) throws IOException, XmlPullParserException, ParseException {
    int seqNr=ParserUtils.getIntegerAttributeOrThrow(parser,"seqnr","IoT data request <accepted/> without sequence number");
    boolean done=ParserUtils.getBooleanAttribute(parser,"done",false);
    List<NodeElement> nodes=new ArrayList<>();
    outerloop:     while (true) {
      final XmlPullParser.Event eventType=parser.next();
      final String name=parser.getName();
switch (eventType) {
case START_ELEMENT:
switch (name) {
case NodeElement.ELEMENT:
          NodeElement node=parseNode(parser);
        nodes.add(node);
      break;
  }
break;
case END_ELEMENT:
if (parser.getDepth() == initialDepth) {
break outerloop;
}
break;
default :
break;
}
}
return new IoTFieldsExtension(seqNr,done,nodes);
}
public NodeElement parseNode(XmlPullParser parser) throws XmlPullParserException, IOException, ParseException {
final int initialDepth=parser.getDepth();
final NodeInfo nodeInfo=NodeInfoParser.parse(parser);
List<TimestampElement> timestampElements=new ArrayList<>();
outerloop: while (true) {
final XmlPullParser.Event eventType=parser.next();
final String name=parser.getName();
switch (eventType) {
case START_ELEMENT:
switch (name) {
case TimestampElement.ELEMENT:
TimestampElement timestampElement=parseTimestampElement(parser);
timestampElements.add(timestampElement);
break;
}
break;
case END_ELEMENT:
if (parser.getDepth() == initialDepth) {
break outerloop;
}
break;
default :
break;
}
}
return new NodeElement(nodeInfo,timestampElements);
}
public TimestampElement parseTimestampElement(XmlPullParser parser) throws XmlPullParserException, IOException, ParseException {
final int initialDepth=parser.getDepth();
final String dateString=parser.getAttributeValue(null,"value");
Date date=XmppDateTime.parseDate(dateString);
List<IoTDataField> fields=new ArrayList<>();
outerloop: while (true) {
final XmlPullParser.Event eventType=parser.next();
switch (eventType) {
case START_ELEMENT:
final String name=parser.getName();
IoTDataField field=null;
final String fieldName=parser.getAttributeValue(null,"name");
final String fieldValue=parser.getAttributeValue(null,"value");
switch (name) {
case "int":
{
int value=Integer.parseInt(fieldValue);
field=new IoTDataField.IntField(fieldName,value);
}
break;
case "boolean":
{
boolean value=Boolean.parseBoolean(fieldValue);
field=new IoTDataField.BooleanField(fieldName,value);
}
break;
default :
LOGGER.warning("IoT Data field type '" + name + "' not implement yet. Ignoring.");
break;
}
if (field != null) {
fields.add(field);
}
break;
case END_ELEMENT:
if (parser.getDepth() == initialDepth) {
break outerloop;
}
break;
default :
break;
}
}
return new TimestampElement(date,fields);
}
}

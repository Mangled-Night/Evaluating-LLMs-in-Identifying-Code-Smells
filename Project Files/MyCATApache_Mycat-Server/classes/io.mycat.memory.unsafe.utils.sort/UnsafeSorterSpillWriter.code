/** 
 * Spills a list of sorted records to disk. Spill files have the following format: [# of records (int)] [[len (int)][prefix (long)][data (bytes)]...]
 */
public final class UnsafeSorterSpillWriter {
  static final int DISK_WRITE_BUFFER_SIZE=1024 * 1024;
  private byte[] writeBuffer=new byte[DISK_WRITE_BUFFER_SIZE];
  private final File file;
  private final ConnectionId conId;
  private final int numRecordsToWrite;
  private DiskRowWriter writer;
  private DataNodeFileManager diskBlockManager;
  private int numRecordsSpilled=0;
  public UnsafeSorterSpillWriter(  DataNodeDiskManager blockManager,  int fileBufferSize,  int numRecordsToWrite) throws IOException {
    this.diskBlockManager=blockManager.diskBlockManager();
    this.conId=diskBlockManager.createTempLocalBlock();
    this.file=diskBlockManager.getFile(this.conId);
    this.numRecordsToWrite=numRecordsToWrite;
    writer=blockManager.getDiskWriter(conId,file,DummySerializerInstance.INSTANCE,fileBufferSize);
    writeIntToBuffer(numRecordsToWrite,0);
    writer.write(writeBuffer,0,4);
  }
  private void writeLongToBuffer(  long v,  int offset) throws IOException {
    writeBuffer[offset + 0]=(byte)(v >>> 56);
    writeBuffer[offset + 1]=(byte)(v >>> 48);
    writeBuffer[offset + 2]=(byte)(v >>> 40);
    writeBuffer[offset + 3]=(byte)(v >>> 32);
    writeBuffer[offset + 4]=(byte)(v >>> 24);
    writeBuffer[offset + 5]=(byte)(v >>> 16);
    writeBuffer[offset + 6]=(byte)(v >>> 8);
    writeBuffer[offset + 7]=(byte)(v >>> 0);
  }
  private void writeIntToBuffer(  int v,  int offset) throws IOException {
    writeBuffer[offset + 0]=(byte)(v >>> 24);
    writeBuffer[offset + 1]=(byte)(v >>> 16);
    writeBuffer[offset + 2]=(byte)(v >>> 8);
    writeBuffer[offset + 3]=(byte)(v >>> 0);
  }
  /** 
 * Write a record to a spill file.
 * @param baseObject the base object / memory page containing the record
 * @param baseOffset the base offset which points directly to the record data.
 * @param recordLength the length of the record.
 * @param keyPrefix a sort key prefix
 */
  public void write(  Object baseObject,  long baseOffset,  int recordLength,  long keyPrefix) throws IOException {
    if (numRecordsSpilled == numRecordsToWrite) {
      throw new IllegalStateException("Number of records written exceeded numRecordsToWrite = " + numRecordsToWrite);
    }
 else {
      numRecordsSpilled++;
    }
    writeIntToBuffer(recordLength,0);
    writeLongToBuffer(keyPrefix,4);
    int dataRemaining=recordLength;
    int freeSpaceInWriteBuffer=DISK_WRITE_BUFFER_SIZE - 4 - 8;
    long recordReadPosition=baseOffset;
    while (dataRemaining > 0) {
      final int toTransfer=Math.min(freeSpaceInWriteBuffer,dataRemaining);
      Platform.copyMemory(baseObject,recordReadPosition,writeBuffer,Platform.BYTE_ARRAY_OFFSET + (DISK_WRITE_BUFFER_SIZE - freeSpaceInWriteBuffer),toTransfer);
      writer.write(writeBuffer,0,(DISK_WRITE_BUFFER_SIZE - freeSpaceInWriteBuffer) + toTransfer);
      recordReadPosition+=toTransfer;
      dataRemaining-=toTransfer;
      freeSpaceInWriteBuffer=DISK_WRITE_BUFFER_SIZE;
    }
    if (freeSpaceInWriteBuffer < DISK_WRITE_BUFFER_SIZE) {
      writer.write(writeBuffer,0,(DISK_WRITE_BUFFER_SIZE - freeSpaceInWriteBuffer));
    }
    writer.recordWritten();
  }
  public void close() throws IOException {
    writer.commitAndClose();
    writer=null;
    writeBuffer=null;
  }
  public File getFile(){
    return file;
  }
  public UnsafeSorterSpillReader getReader(  SerializerManager serializerManager) throws IOException {
    return new UnsafeSorterSpillReader(serializerManager,file,conId);
  }
}

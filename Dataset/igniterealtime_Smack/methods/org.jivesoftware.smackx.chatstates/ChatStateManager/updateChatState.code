private synchronized boolean updateChatState(Chat chat,ChatState newState){
  ChatState lastChatState=chatStates.get(chat);
  if (lastChatState != newState) {
    chatStates.put(chat,newState);
    return true;
  }
  return false;
}

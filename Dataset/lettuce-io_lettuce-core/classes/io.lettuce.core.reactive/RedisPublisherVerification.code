/** 
 * Reactive Streams TCK for  {@link io.lettuce.core.RedisPublisher}.
 * @author Mark Paluch
 */
public class RedisPublisherVerification extends PublisherVerification<String> {
  private static RedisClient client;
  private static StatefulRedisConnection<String,String> connection;
  public RedisPublisherVerification(){
    super(new TestEnvironment(1000));
  }
  @BeforeClass private static void beforeClass(){
    client=RedisClient.create(TestClientResources.get(),RedisURI.create(TestSettings.host(),TestSettings.port()));
    connection=client.connect();
    connection.sync().flushall();
  }
  @AfterClass private static void afterClass(){
    connection.close();
    FastShutdown.shutdown(client);
  }
  @Override public Publisher<String> createPublisher(  long elements){
    RedisCommands<String,String> sync=connection.sync();
    if (elements == Long.MAX_VALUE) {
      return null;
    }
    String id=UUID.randomUUID().toString();
    String key="PublisherVerification-" + id;
    for (int i=0; i < elements; i++) {
      sync.lpush(key,"element-" + i);
    }
    Supplier<Command<String,String,List<String>>> supplier=() -> {
      CommandArgs<String,String> args=new CommandArgs<>(StringCodec.UTF8).addKey(key).add(0).add(-1);
      return new Command<>(LRANGE,new ValueListOutput<>(StringCodec.UTF8),args);
    }
;
    return new TestRedisPublisher(supplier,connection,true);
  }
  @Override public long maxElementsFromPublisher(){
    return 100;
  }
  @Override public Publisher<String> createFailedPublisher(){
    return null;
  }
}

/** 
 * Process the AdHoc-Command stanza that request the execution of some action of a command. If this is the first request, this method checks, before executing the command, if: <ul> <li>The requested command exists</li> <li>The requester has permissions to execute it</li> <li>The command has more than one stage, if so, it saves the command and session ID for further use</li> </ul> <br> <br> If this is not the first request, this method checks, before executing the command, if: <ul> <li>The session ID of the request was stored</li> <li>The session life do not exceed the time out</li> <li>The action to execute is one of the available actions</li> </ul>
 * @param requestData TODO javadoc me pleasethe stanza to process.
 * @throws NotConnectedException if the XMPP connection is not connected.
 * @throws NoResponseException if there was no response from the remote entity.
 * @throws InterruptedException if the calling thread was interrupted.
 */
private IQ processAdHocCommand(AdHocCommandData requestData) throws NoResponseException, NotConnectedException, InterruptedException {
  AdHocCommandData response=new AdHocCommandData();
  response.setTo(requestData.getFrom());
  response.setStanzaId(requestData.getStanzaId());
  response.setNode(requestData.getNode());
  response.setId(requestData.getTo());
  String sessionId=requestData.getSessionID();
  String commandNode=requestData.getNode();
  if (sessionId == null) {
    if (!commands.containsKey(commandNode)) {
      return respondError(response,StanzaError.Condition.item_not_found);
    }
    sessionId=StringUtils.randomString(15);
    try {
      LocalCommand command;
      try {
        command=newInstanceOfCmd(commandNode,sessionId);
      }
 catch (      InstantiationException|IllegalAccessException|IllegalArgumentException|InvocationTargetException|NoSuchMethodException|SecurityException e) {
        StanzaError xmppError=StanzaError.getBuilder().setCondition(StanzaError.Condition.internal_server_error).setDescriptiveEnText(e.getMessage()).build();
        return respondError(response,xmppError);
      }
      response.setType(IQ.Type.result);
      command.setData(response);
      if (!command.hasPermission(requestData.getFrom())) {
        return respondError(response,StanzaError.Condition.forbidden);
      }
      Action action=requestData.getAction();
      if (action != null && action.equals(Action.unknown)) {
        return respondError(response,StanzaError.Condition.bad_request,AdHocCommand.SpecificErrorCondition.malformedAction);
      }
      if (action != null && !action.equals(Action.execute)) {
        return respondError(response,StanzaError.Condition.bad_request,AdHocCommand.SpecificErrorCondition.badAction);
      }
      command.incrementStage();
      command.execute();
      if (command.isLastStage()) {
        response.setStatus(Status.completed);
      }
 else {
        response.setStatus(Status.executing);
        executingCommands.put(sessionId,command);
        maybeWindUpSessionSweeper();
      }
      return response;
    }
 catch (    XMPPErrorException e) {
      StanzaError error=e.getStanzaError();
      if (StanzaError.Type.CANCEL.equals(error.getType())) {
        response.setStatus(Status.canceled);
        executingCommands.remove(sessionId);
      }
      return respondError(response,error);
    }
  }
 else {
    LocalCommand command=executingCommands.get(sessionId);
    if (command == null) {
      return respondError(response,StanzaError.Condition.bad_request,AdHocCommand.SpecificErrorCondition.badSessionid);
    }
    long creationStamp=command.getCreationDate();
    if (System.currentTimeMillis() - creationStamp > SESSION_TIMEOUT * 1000) {
      executingCommands.remove(sessionId);
      return respondError(response,StanzaError.Condition.not_allowed,AdHocCommand.SpecificErrorCondition.sessionExpired);
    }
synchronized (command) {
      Action action=requestData.getAction();
      if (action != null && action.equals(Action.unknown)) {
        return respondError(response,StanzaError.Condition.bad_request,AdHocCommand.SpecificErrorCondition.malformedAction);
      }
      if (action == null || Action.execute.equals(action)) {
        action=command.getExecuteAction();
      }
      if (!command.isValidAction(action)) {
        return respondError(response,StanzaError.Condition.bad_request,AdHocCommand.SpecificErrorCondition.badAction);
      }
      try {
        response.setType(IQ.Type.result);
        command.setData(response);
        if (Action.next.equals(action)) {
          command.incrementStage();
          DataForm dataForm=requestData.getForm();
          command.next(new FillableForm(dataForm));
          if (command.isLastStage()) {
            response.setStatus(Status.completed);
          }
 else {
            response.setStatus(Status.executing);
          }
        }
 else         if (Action.complete.equals(action)) {
          command.incrementStage();
          DataForm dataForm=requestData.getForm();
          command.complete(new FillableForm(dataForm));
          response.setStatus(Status.completed);
          executingCommands.remove(sessionId);
        }
 else         if (Action.prev.equals(action)) {
          command.decrementStage();
          command.prev();
        }
 else         if (Action.cancel.equals(action)) {
          command.cancel();
          response.setStatus(Status.canceled);
          executingCommands.remove(sessionId);
        }
        return response;
      }
 catch (      XMPPErrorException e) {
        StanzaError error=e.getStanzaError();
        if (StanzaError.Type.CANCEL.equals(error.getType())) {
          response.setStatus(Status.canceled);
          executingCommands.remove(sessionId);
        }
        return respondError(response,error);
      }
    }
  }
}

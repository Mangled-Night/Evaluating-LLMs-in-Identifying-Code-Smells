public class DruidSelectOracleParser extends DruidSelectParser {
  @Override public void statementParse(  SchemaConfig schema,  RouteResultset rrs,  SQLStatement stmt){
    SQLSelectStatement selectStmt=(SQLSelectStatement)stmt;
    SQLSelectQuery sqlSelectQuery=selectStmt.getSelect().getQuery();
    if (sqlSelectQuery instanceof MySqlSelectQueryBlock) {
      MySqlSelectQueryBlock mysqlSelectQuery=(MySqlSelectQueryBlock)selectStmt.getSelect().getQuery();
      SQLLimit limit=mysqlSelectQuery.getLimit();
      if (limit == null) {
        OracleStatementParser oracleParser=new OracleStatementParser(getCtx().getSql());
        SQLSelectStatement oracleStmt=(SQLSelectStatement)oracleParser.parseStatement();
        selectStmt=oracleStmt;
        SQLSelectQuery oracleSqlSelectQuery=oracleStmt.getSelect().getQuery();
        if (oracleSqlSelectQuery instanceof OracleSelectQueryBlock) {
          parseNativePageSql(oracleStmt,rrs,(OracleSelectQueryBlock)oracleSqlSelectQuery,schema);
        }
      }
      if (isNeedParseOrderAgg) {
        parseOrderAggGroupMysql(schema,selectStmt,rrs,mysqlSelectQuery);
        if ((mysqlSelectQuery.isForUpdate() || mysqlSelectQuery.isLockInShareMode()) && rrs.isAutocommit() == false) {
          rrs.setCanRunInReadDB(false);
        }
      }
    }
  }
  protected void parseOrderAggGroupOracle(  SQLStatement stmt,  RouteResultset rrs,  OracleSelectQueryBlock mysqlSelectQuery,  SchemaConfig schema){
    Map<String,String> aliaColumns=parseAggGroupCommon(schema,stmt,rrs,mysqlSelectQuery);
    SQLSelect oracleSelect=(SQLSelect)mysqlSelectQuery.getParent();
    if (oracleSelect.getOrderBy() != null) {
      List<SQLSelectOrderByItem> orderByItems=oracleSelect.getOrderBy().getItems();
      rrs.setOrderByCols(buildOrderByCols(orderByItems,aliaColumns));
    }
    isNeedParseOrderAgg=false;
  }
  protected void parseNativePageSql(  SQLStatement stmt,  RouteResultset rrs,  OracleSelectQueryBlock mysqlSelectQuery,  SchemaConfig schema){
    SQLExpr where=mysqlSelectQuery.getWhere();
    SQLTableSource from=mysqlSelectQuery.getFrom();
    if (where instanceof SQLBinaryOpExpr && from instanceof SQLSubqueryTableSource) {
      SQLBinaryOpExpr one=(SQLBinaryOpExpr)where;
      SQLExpr left=one.getLeft();
      SQLBinaryOperator operator=one.getOperator();
      if (one.getRight() instanceof SQLIntegerExpr && "rownum".equalsIgnoreCase(left.toString()) && (operator == SQLBinaryOperator.LessThanOrEqual || operator == SQLBinaryOperator.LessThan)) {
        SQLIntegerExpr right=(SQLIntegerExpr)one.getRight();
        int firstrownum=right.getNumber().intValue();
        if (operator == SQLBinaryOperator.LessThan && firstrownum != 0) {
          firstrownum=firstrownum - 1;
        }
        SQLSelectQuery subSelect=((SQLSubqueryTableSource)from).getSelect().getQuery();
        if (subSelect instanceof OracleSelectQueryBlock) {
          rrs.setLimitStart(0);
          rrs.setLimitSize(firstrownum);
          mysqlSelectQuery=(OracleSelectQueryBlock)subSelect;
          parseOrderAggGroupOracle(stmt,rrs,mysqlSelectQuery,schema);
          isNeedParseOrderAgg=false;
        }
      }
 else       if (one.getRight() instanceof SQLIntegerExpr && !"rownum".equalsIgnoreCase(left.toString()) && (operator == SQLBinaryOperator.GreaterThan || operator == SQLBinaryOperator.GreaterThanOrEqual)) {
        parseThreeLevelPageSql(stmt,rrs,schema,(SQLSubqueryTableSource)from,one,operator);
      }
 else {
        SQLSelectQuery subSelect=((SQLSubqueryTableSource)from).getSelect().getQuery();
        SQLOrderBy orderBy=null;
        if (subSelect instanceof OracleSelectQueryBlock) {
          boolean hasRowNumber=false;
          OracleSelectQueryBlock subSelectOracle=(OracleSelectQueryBlock)subSelect;
          List<SQLSelectItem> sqlSelectItems=subSelectOracle.getSelectList();
          for (          SQLSelectItem sqlSelectItem : sqlSelectItems) {
            SQLExpr sqlExpr=sqlSelectItem.getExpr();
            if (sqlExpr instanceof SQLAggregateExpr) {
              SQLAggregateExpr agg=(SQLAggregateExpr)sqlExpr;
              if ("row_number".equalsIgnoreCase(agg.getMethodName()) && agg.getOver() != null) {
                hasRowNumber=true;
                orderBy=agg.getOver().getOrderBy();
              }
            }
          }
          if (hasRowNumber) {
            if ((operator == SQLBinaryOperator.LessThan || operator == SQLBinaryOperator.LessThanOrEqual) && one.getRight() instanceof SQLIntegerExpr) {
              SQLIntegerExpr right=(SQLIntegerExpr)one.getRight();
              int firstrownum=right.getNumber().intValue();
              if (operator == SQLBinaryOperator.LessThan && firstrownum != 0) {
                firstrownum=firstrownum - 1;
              }
              if (subSelect instanceof OracleSelectQueryBlock) {
                rrs.setLimitStart(0);
                rrs.setLimitSize(firstrownum);
                mysqlSelectQuery=(OracleSelectQueryBlock)subSelect;
                if (orderBy != null) {
                  SQLSelect oracleSelect=(SQLSelect)subSelect.getParent();
                  oracleSelect.setOrderBy(orderBy);
                }
                parseOrderAggGroupOracle(stmt,rrs,mysqlSelectQuery,schema);
                isNeedParseOrderAgg=false;
              }
            }
 else             if (operator == SQLBinaryOperator.BooleanAnd && left instanceof SQLBinaryOpExpr && one.getRight() instanceof SQLBinaryOpExpr) {
              SQLBinaryOpExpr leftE=(SQLBinaryOpExpr)left;
              SQLBinaryOpExpr rightE=(SQLBinaryOpExpr)one.getRight();
              SQLBinaryOpExpr small=null;
              SQLBinaryOpExpr larger=null;
              int firstrownum=0;
              int lastrownum=0;
              if (leftE.getRight() instanceof SQLIntegerExpr && (leftE.getOperator() == SQLBinaryOperator.GreaterThan || leftE.getOperator() == SQLBinaryOperator.GreaterThanOrEqual)) {
                small=leftE;
                firstrownum=((SQLIntegerExpr)leftE.getRight()).getNumber().intValue();
                if (leftE.getOperator() == SQLBinaryOperator.GreaterThanOrEqual && firstrownum != 0) {
                  firstrownum=firstrownum - 1;
                }
              }
 else               if (leftE.getRight() instanceof SQLIntegerExpr && (leftE.getOperator() == SQLBinaryOperator.LessThan || leftE.getOperator() == SQLBinaryOperator.LessThanOrEqual)) {
                larger=leftE;
                lastrownum=((SQLIntegerExpr)leftE.getRight()).getNumber().intValue();
                if (leftE.getOperator() == SQLBinaryOperator.LessThan && lastrownum != 0) {
                  lastrownum=lastrownum - 1;
                }
              }
              if (rightE.getRight() instanceof SQLIntegerExpr && (rightE.getOperator() == SQLBinaryOperator.GreaterThan || rightE.getOperator() == SQLBinaryOperator.GreaterThanOrEqual)) {
                small=rightE;
                firstrownum=((SQLIntegerExpr)rightE.getRight()).getNumber().intValue();
                if (rightE.getOperator() == SQLBinaryOperator.GreaterThanOrEqual && firstrownum != 0) {
                  firstrownum=firstrownum - 1;
                }
              }
 else               if (rightE.getRight() instanceof SQLIntegerExpr && (rightE.getOperator() == SQLBinaryOperator.LessThan || rightE.getOperator() == SQLBinaryOperator.LessThanOrEqual)) {
                larger=rightE;
                lastrownum=((SQLIntegerExpr)rightE.getRight()).getNumber().intValue();
                if (rightE.getOperator() == SQLBinaryOperator.LessThan && lastrownum != 0) {
                  lastrownum=lastrownum - 1;
                }
              }
              if (small != null && larger != null) {
                setLimitIFChange(stmt,rrs,schema,small,firstrownum,lastrownum);
                if (orderBy != null) {
                  SQLSelect oracleSelect=(SQLSelect)subSelect.getParent();
                  oracleSelect.setOrderBy(orderBy);
                }
                parseOrderAggGroupOracle(stmt,rrs,(OracleSelectQueryBlock)subSelect,schema);
                isNeedParseOrderAgg=false;
              }
            }
          }
 else {
            parseNativeSql(stmt,rrs,mysqlSelectQuery,schema);
          }
        }
      }
    }
 else {
      parseNativeSql(stmt,rrs,mysqlSelectQuery,schema);
    }
    if (isNeedParseOrderAgg) {
      parseOrderAggGroupOracle(stmt,rrs,mysqlSelectQuery,schema);
    }
  }
  protected String getCurentDbType(){
    return JdbcConstants.ORACLE.name();
  }
  protected void parseNativeSql(  SQLStatement stmt,  RouteResultset rrs,  OracleSelectQueryBlock mysqlSelectQuery,  SchemaConfig schema){
  }
  private void parseThreeLevelPageSql(  SQLStatement stmt,  RouteResultset rrs,  SchemaConfig schema,  SQLSubqueryTableSource from,  SQLBinaryOpExpr one,  SQLBinaryOperator operator){
    SQLIntegerExpr right=(SQLIntegerExpr)one.getRight();
    int firstrownum=right.getNumber().intValue();
    if (operator == SQLBinaryOperator.GreaterThanOrEqual && firstrownum != 0) {
      firstrownum=firstrownum - 1;
    }
    SQLSelectQuery subSelect=from.getSelect().getQuery();
    if (subSelect instanceof OracleSelectQueryBlock) {
      OracleSelectQueryBlock twoSubSelect=(OracleSelectQueryBlock)subSelect;
      if (twoSubSelect.getWhere() instanceof SQLBinaryOpExpr && twoSubSelect.getFrom() instanceof SQLSubqueryTableSource) {
        SQLBinaryOpExpr twoWhere=(SQLBinaryOpExpr)twoSubSelect.getWhere();
        boolean isRowNum="rownum".equalsIgnoreCase(twoWhere.getLeft().toString());
        boolean isLess=twoWhere.getOperator() == SQLBinaryOperator.LessThanOrEqual || twoWhere.getOperator() == SQLBinaryOperator.LessThan;
        if (isRowNum && twoWhere.getRight() instanceof SQLIntegerExpr && isLess) {
          int lastrownum=((SQLIntegerExpr)twoWhere.getRight()).getNumber().intValue();
          if (operator == SQLBinaryOperator.LessThan && lastrownum != 0) {
            lastrownum=lastrownum - 1;
          }
          SQLSelectQuery finalQuery=((SQLSubqueryTableSource)twoSubSelect.getFrom()).getSelect().getQuery();
          if (finalQuery instanceof OracleSelectQueryBlock) {
            setLimitIFChange(stmt,rrs,schema,one,firstrownum,lastrownum);
            parseOrderAggGroupOracle(stmt,rrs,(OracleSelectQueryBlock)finalQuery,schema);
            isNeedParseOrderAgg=false;
          }
        }
      }
    }
  }
}

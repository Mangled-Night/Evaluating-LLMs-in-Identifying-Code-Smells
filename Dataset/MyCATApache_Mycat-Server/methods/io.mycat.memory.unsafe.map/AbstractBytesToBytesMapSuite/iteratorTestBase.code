private void iteratorTestBase(boolean destructive) throws Exception {
  final int size=4096;
  BytesToBytesMap map=new BytesToBytesMap(dataNodeMemoryManager,size / 2,PAGE_SIZE_BYTES);
  try {
    for (long i=0; i < size; i++) {
      final long[] value=new long[]{i};
      final BytesToBytesMap.Location loc=map.lookup(value,Platform.LONG_ARRAY_OFFSET,8);
      Assert.assertFalse(loc.isDefined());
      if (i % 5 == 0) {
        Assert.assertTrue(loc.append(null,Platform.LONG_ARRAY_OFFSET,0,value,Platform.LONG_ARRAY_OFFSET,8));
      }
 else {
        Assert.assertTrue(loc.append(value,Platform.LONG_ARRAY_OFFSET,8,value,Platform.LONG_ARRAY_OFFSET,8));
      }
    }
    final BitSet valuesSeen=new BitSet(size);
    final Iterator<BytesToBytesMap.Location> iter;
    if (destructive) {
      iter=map.destructiveIterator();
    }
 else {
      iter=map.iterator();
    }
    int numPages=map.getNumDataPages();
    int countFreedPages=0;
    while (iter.hasNext()) {
      final BytesToBytesMap.Location loc=iter.next();
      Assert.assertTrue(loc.isDefined());
      final long value=Platform.getLong(loc.getValueBase(),loc.getValueOffset());
      final long keyLength=loc.getKeyLength();
      if (keyLength == 0) {
        Assert.assertTrue("value " + value + " was not divisible by 5",value % 5 == 0);
      }
 else {
        final long key=Platform.getLong(loc.getKeyBase(),loc.getKeyOffset());
        Assert.assertEquals(value,key);
      }
      valuesSeen.set((int)value);
      if (destructive) {
        if (map.getNumDataPages() < numPages) {
          numPages=map.getNumDataPages();
          countFreedPages++;
        }
      }
    }
    if (destructive) {
      Assert.assertEquals(countFreedPages,numPages - 1);
    }
    Assert.assertEquals(size,valuesSeen.cardinality());
  }
  finally {
    map.free();
  }
}

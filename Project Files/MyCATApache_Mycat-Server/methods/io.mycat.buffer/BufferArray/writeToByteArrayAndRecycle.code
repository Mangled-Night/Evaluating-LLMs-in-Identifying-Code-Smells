public byte[] writeToByteArrayAndRecycle(){
  BufferArray bufferArray=this;
  try {
    int size=0;
    List<ByteBuffer> blockes=bufferArray.getWritedBlockLst();
    if (!bufferArray.getWritedBlockLst().isEmpty()) {
      for (      ByteBuffer curBuf : blockes) {
        curBuf.flip();
        size+=curBuf.remaining();
      }
    }
    ByteBuffer curBuf=bufferArray.getCurWritingBlock();
    curBuf.flip();
    if (curBuf.hasRemaining()) {
      size+=curBuf.remaining();
    }
    if (size > 0) {
      int offset=0;
      byte[] all=new byte[size];
      if (!bufferArray.getWritedBlockLst().isEmpty()) {
        for (        ByteBuffer tBuf : blockes) {
          ByteBufferUtil.arrayCopy(tBuf,0,all,offset,tBuf.remaining());
          offset+=tBuf.remaining();
          bufferPool.recycle(tBuf);
        }
      }
      ByteBuffer tBuf=bufferArray.getCurWritingBlock();
      if (tBuf.hasRemaining()) {
        ByteBufferUtil.arrayCopy(tBuf,0,all,offset,tBuf.remaining());
        bufferPool.recycle(tBuf);
      }
      return all;
    }
  }
  finally {
    bufferArray.clear();
  }
  return EMPTY;
}

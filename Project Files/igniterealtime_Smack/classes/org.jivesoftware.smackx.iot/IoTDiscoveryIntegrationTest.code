public class IoTDiscoveryIntegrationTest extends AbstractSmackIntegrationTest {
  private final IoTDiscoveryManager discoveryManagerOne;
  private final IoTDiscoveryManager discoveryManagerTwo;
  public IoTDiscoveryIntegrationTest(  SmackIntegrationTestEnvironment environment) throws NoResponseException, XMPPErrorException, NotConnectedException, InterruptedException, TestNotPossibleException {
    super(environment);
    discoveryManagerOne=IoTDiscoveryManager.getInstanceFor(conOne);
    discoveryManagerTwo=IoTDiscoveryManager.getInstanceFor(conTwo);
    checkPrerequisites(conOne);
  }
  @SmackIntegrationTest public void registerClaimAndUnregisterThing() throws XMPPErrorException, InterruptedException, SmackException {
    final String key=StringUtils.randomString(12);
    final String sn=StringUtils.randomString(12);
    final Thing thing=Thing.builder().setKey(key).setSerialNumber(sn).setManufacturer("Ignite Realtime").setModel("Smack").setVersion("0.1").build();
    registerThing(discoveryManagerOne,thing);
    IoTClaimed iotClaimed=discoveryManagerTwo.claimThing(thing.getMetaTags());
    assertEquals(conOne.getUser().asBareJid(),iotClaimed.getJid());
    discoveryManagerTwo.disownThing(iotClaimed.getJid());
    discoveryManagerOne.unregister();
  }
  static void checkPrerequisites(  XMPPConnection connection) throws NoResponseException, XMPPErrorException, NotConnectedException, InterruptedException, TestNotPossibleException {
    IoTDiscoveryManager discoveryManager=IoTDiscoveryManager.getInstanceFor(connection);
    Jid registry=discoveryManager.findRegistry();
    if (registry == null) {
      throw new TestNotPossibleException("Could not find IoT Registry");
    }
  }
  public static ThingState registerThing(  IoTDiscoveryManager iotDiscoveryManager,  Thing thing) throws XMPPErrorException, InterruptedException, SmackException.SmackMessageException, NotConnectedException, NoResponseException {
    int attempts=0;
    while (true) {
      try {
        return iotDiscoveryManager.registerThing(thing);
      }
 catch (      IoTClaimedException e) {
        iotDiscoveryManager.unregister();
      }
      if (attempts++ > 3) {
        throw new SmackException.SmackMessageException("Could no register thing");
      }
    }
  }
}

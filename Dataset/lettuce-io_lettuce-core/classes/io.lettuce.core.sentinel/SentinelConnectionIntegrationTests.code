/** 
 * @author Mark Paluch
 */
@ExtendWith(LettuceExtension.class) public class SentinelConnectionIntegrationTests extends TestSupport {
  private final RedisClient redisClient;
  private StatefulRedisSentinelConnection<String,String> connection;
  private RedisSentinelCommands<String,String> sentinel;
  private RedisSentinelAsyncCommands<String,String> sentinelAsync;
  @Inject public SentinelConnectionIntegrationTests(  RedisClient redisClient){
    this.redisClient=redisClient;
  }
  @BeforeEach void before(){
    this.connection=this.redisClient.connectSentinel(SentinelTestSettings.SENTINEL_URI);
    this.sentinel=getSyncConnection(this.connection);
    this.sentinelAsync=this.connection.async();
  }
  protected RedisSentinelCommands<String,String> getSyncConnection(  StatefulRedisSentinelConnection<String,String> connection){
    return connection.sync();
  }
  @AfterEach void after(){
    this.connection.close();
  }
  @Test void testAsync(){
    RedisFuture<List<Map<String,String>>> future=sentinelAsync.masters();
    assertThat(TestFutures.getOrTimeout(future)).isNotNull();
    assertThat(future.isDone()).isTrue();
    assertThat(future.isCancelled()).isFalse();
  }
  @Test void testFuture() throws Exception {
    RedisFuture<Map<String,String>> future=sentinelAsync.master("unknown master");
    AtomicBoolean state=new AtomicBoolean();
    future.exceptionally(throwable -> {
      state.set(true);
      return null;
    }
);
    assertThat(future.await(5,TimeUnit.SECONDS)).isTrue();
    assertThat(state.get()).isTrue();
  }
  @Test void testStatefulConnection(){
    StatefulRedisSentinelConnection<String,String> statefulConnection=sentinel.getStatefulConnection();
    assertThat(statefulConnection).isSameAs(statefulConnection.async().getStatefulConnection());
  }
  @Test void testSyncConnection(){
    StatefulRedisSentinelConnection<String,String> statefulConnection=sentinel.getStatefulConnection();
    RedisSentinelCommands<String,String> sync=statefulConnection.sync();
    assertThat(sync.ping()).isEqualTo("PONG");
  }
  @Test void testSyncAsyncConversion(){
    StatefulRedisSentinelConnection<String,String> statefulConnection=sentinel.getStatefulConnection();
    assertThat(statefulConnection.sync().getStatefulConnection()).isSameAs(statefulConnection);
    assertThat(statefulConnection.sync().getStatefulConnection().sync()).isSameAs(statefulConnection.sync());
  }
  @Test void testSyncClose(){
    StatefulRedisSentinelConnection<String,String> statefulConnection=sentinel.getStatefulConnection();
    statefulConnection.sync().getStatefulConnection().close();
    Wait.untilTrue(() -> !sentinel.isOpen()).waitOrTimeout();
    assertThat(sentinel.isOpen()).isFalse();
    assertThat(statefulConnection.isOpen()).isFalse();
  }
  @Test void testAsyncClose(){
    StatefulRedisSentinelConnection<String,String> statefulConnection=sentinel.getStatefulConnection();
    statefulConnection.async().getStatefulConnection().close();
    Wait.untilTrue(() -> !sentinel.isOpen()).waitOrTimeout();
    assertThat(sentinel.isOpen()).isFalse();
    assertThat(statefulConnection.isOpen()).isFalse();
  }
  @Test void connectToOneNode(){
    RedisSentinelCommands<String,String> connection=redisClient.connectSentinel(SentinelTestSettings.SENTINEL_URI).sync();
    assertThat(connection.ping()).isEqualTo("PONG");
    connection.getStatefulConnection().close();
  }
  @Test void connectWithByteCodec(){
    RedisSentinelCommands<byte[],byte[]> connection=redisClient.connectSentinel(new ByteArrayCodec(),SentinelTestSettings.SENTINEL_URI).sync();
    assertThat(connection.master(SentinelTestSettings.MASTER_ID.getBytes())).isNotNull();
    connection.getStatefulConnection().close();
  }
  @Test void sentinelConnectionShouldDiscardPassword(){
    RedisURI redisURI=RedisURI.Builder.sentinel(TestSettings.host(),SentinelTestSettings.MASTER_ID).withPassword("hello-world").build();
    redisClient.setOptions(ClientOptions.builder().build());
    StatefulRedisSentinelConnection<String,String> connection=redisClient.connectSentinel(redisURI);
    assertThat(connection.sync().ping()).isEqualTo("PONG");
    connection.close();
    redisClient.setOptions(ClientOptions.create());
  }
  @Test void sentinelConnectionShouldSetClientName(){
    RedisURI redisURI=RedisURI.Builder.sentinel(TestSettings.host(),SentinelTestSettings.MASTER_ID).withClientName("my-client").build();
    StatefulRedisSentinelConnection<String,String> connection=redisClient.connectSentinel(redisURI);
    assertThat(connection.sync().clientGetname()).isEqualTo(redisURI.getClientName());
    connection.close();
  }
  @Test void sentinelManagedConnectionShouldSetClientName(){
    RedisURI redisURI=RedisURI.Builder.sentinel(TestSettings.host(),SentinelTestSettings.MASTER_ID).withClientName("my-client").build();
    StatefulRedisConnection<String,String> connection=redisClient.connect(redisURI);
    assertThat(connection.sync().clientGetname()).isEqualTo(redisURI.getClientName());
    connection.sync().quit();
    assertThat(connection.sync().clientGetname()).isEqualTo(redisURI.getClientName());
    connection.close();
  }
  @Test void sentinelWithAuthentication(){
    RedisURI redisURI=RedisURI.Builder.sentinel(TestSettings.host(),26381,SentinelTestSettings.MASTER_ID,"foobared").withClientName("my-client").build();
    redisClient.setOptions(ClientOptions.builder().pingBeforeActivateConnection(true).build());
    StatefulRedisConnection<String,String> connection=redisClient.connect(redisURI);
    connection.sync().quit();
    assertThat(connection.sync().clientGetname()).isEqualTo(redisURI.getClientName());
    connection.close();
  }
}

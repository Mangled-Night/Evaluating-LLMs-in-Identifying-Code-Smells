/** 
 * Joins the workgroup queue to wait to be routed to an agent. After joining the queue, queue status events will be sent to indicate the user's position and estimated time left in the queue. Once joining the queue, there are three ways the user can leave the queue: <ul> <li>The user is routed to an agent, which triggers a GroupChat invitation. <li>The user asks to leave the queue by calling the  {@link #departQueue} method.<li>A server error occurs, or an administrator explicitly removes the user from the queue. </ul> A user cannot request to join the queue again if already in the queue. Therefore, this method will throw an IllegalStateException if the user is already in the queue.<p> Some servers may be configured to require certain meta-data in order to join the queue. In that case, the  {@link #joinQueue(FillableForm)} method should beused instead of this method so that meta-data may be passed in.<p> The server tracks the conversations that a user has with agents over time. By default, that tracking is done using the user's JID. However, this is not always possible. For example, when the user is logged in anonymously using a web client. In that case the user ID might be a randomly generated value put into a persistent cookie or a username obtained via the session. A userID can be explicitly passed in by using the  {@link #joinQueue(DataForm,Jid)} method. When specified,that userID will be used instead of the user's JID to track conversations. The server will ignore a manually specified userID if the user's connection to the server is not anonymous.
 * @throws XMPPException if an error occurred joining the queue. An error may indicatethat a connection failure occurred or that the server explicitly rejected the request to join the queue.
 * @throws SmackException if Smack detected an exceptional situation.
 * @throws InterruptedException if the calling thread was interrupted.
 */
public void joinQueue() throws XMPPException, SmackException, InterruptedException {
  joinQueue(null);
}
/** 
 * Joins the workgroup queue to wait to be routed to an agent. After joining the queue, queue status events will be sent to indicate the user's position and estimated time left in the queue. Once joining the queue, there are three ways the user can leave the queue: <ul> <li>The user is routed to an agent, which triggers a GroupChat invitation. <li>The user asks to leave the queue by calling the  {@link #departQueue} method.<li>A server error occurs, or an administrator explicitly removes the user from the queue. </ul> A user cannot request to join the queue again if already in the queue. Therefore, this method will throw an IllegalStateException if the user is already in the queue.<p> Some servers may be configured to require certain meta-data in order to join the queue.<p> The server tracks the conversations that a user has with agents over time. By default, that tracking is done using the user's JID. However, this is not always possible. For example, when the user is logged in anonymously using a web client. In that case the user ID might be a randomly generated value put into a persistent cookie or a username obtained via the session. A userID can be explicitly passed in by using the  {@link #joinQueue(DataForm,Jid)} method. When specified,that userID will be used instead of the user's JID to track conversations. The server will ignore a manually specified userID if the user's connection to the server is not anonymous.
 * @param answerForm the completed form the send for the join request.
 * @throws XMPPException if an error occurred joining the queue. An error may indicatethat a connection failure occurred or that the server explicitly rejected the request to join the queue.
 * @throws SmackException if Smack detected an exceptional situation.
 * @throws InterruptedException if the calling thread was interrupted.
 */
public void joinQueue(FillableForm answerForm) throws XMPPException, SmackException, InterruptedException {
  joinQueue(answerForm.getDataFormToSubmit(),null);
}
/** 
 * <p>Joins the workgroup queue to wait to be routed to an agent. After joining the queue, queue status events will be sent to indicate the user's position and estimated time left in the queue. Once joining the queue, there are three ways the user can leave the queue: <ul> <li>The user is routed to an agent, which triggers a GroupChat invitation. <li>The user asks to leave the queue by calling the  {@link #departQueue} method.<li>A server error occurs, or an administrator explicitly removes the user from the queue. </ul> A user cannot request to join the queue again if already in the queue. Therefore, this method will throw an IllegalStateException if the user is already in the queue.<p> Some servers may be configured to require certain meta-data in order to join the queue.<p> The server tracks the conversations that a user has with agents over time. By default, that tracking is done using the user's JID. However, this is not always possible. For example, when the user is logged in anonymously using a web client. In that case the user ID might be a randomly generated value put into a persistent cookie or a username obtained via the session. When specified, that userID will be used instead of the user's JID to track conversations. The server will ignore a manually specified userID if the user's connection to the server is not anonymous.
 * @param answerForm the completed form associated with the join request.
 * @param userID     String that represents the ID of the user when using anonymous sessionsor <code>null</code> if a userID should not be used.
 * @throws XMPPErrorException if an error occurred joining the queue. An error may indicatethat a connection failure occurred or that the server explicitly rejected the request to join the queue.
 * @throws NoResponseException if there was no response from the remote entity.
 * @throws NotConnectedException if the XMPP connection is not connected.
 * @throws InterruptedException if the calling thread was interrupted.
 */
public void joinQueue(DataForm answerForm,Jid userID) throws NoResponseException, XMPPErrorException, NotConnectedException, InterruptedException {
  if (inQueue) {
    throw new IllegalStateException("Already in queue " + workgroupJID);
  }
  JoinQueuePacket joinPacket=new JoinQueuePacket(workgroupJID,answerForm,userID);
  connection.sendIqRequestAndWaitForResponse(joinPacket);
  fireQueueJoinedEvent();
}
/** 
 * <p>Joins the workgroup queue to wait to be routed to an agent. After joining the queue, queue status events will be sent to indicate the user's position and estimated time left in the queue. Once joining the queue, there are three ways the user can leave the queue: <ul> <li>The user is routed to an agent, which triggers a GroupChat invitation. <li>The user asks to leave the queue by calling the  {@link #departQueue} method.<li>A server error occurs, or an administrator explicitly removes the user from the queue. </ul> A user cannot request to join the queue again if already in the queue. Therefore, this method will throw an IllegalStateException if the user is already in the queue.<p> Some servers may be configured to require certain meta-data in order to join the queue.<p> The server tracks the conversations that a user has with agents over time. By default, that tracking is done using the user's JID. However, this is not always possible. For example, when the user is logged in anonymously using a web client. In that case the user ID might be a randomly generated value put into a persistent cookie or a username obtained via the session. When specified, that userID will be used instead of the user's JID to track conversations. The server will ignore a manually specified userID if the user's connection to the server is not anonymous.
 * @param metadata metadata to create a dataform from.
 * @param userID   String that represents the ID of the user when using anonymous sessionsor <code>null</code> if a userID should not be used.
 * @throws XMPPException if an error occurred joining the queue. An error may indicatethat a connection failure occurred or that the server explicitly rejected the request to join the queue.
 * @throws SmackException if Smack detected an exceptional situation.
 * @throws InterruptedException if the calling thread was interrupted.
 */
public void joinQueue(Map<String,Object> metadata,Jid userID) throws XMPPException, SmackException, InterruptedException {
  if (inQueue) {
    throw new IllegalStateException("Already in queue " + workgroupJID);
  }
  DataForm.Builder form=DataForm.builder();
  Iterator<String> iter=metadata.keySet().iterator();
  while (iter.hasNext()) {
    String name=iter.next();
    String value=metadata.get(name).toString();
    TextSingleFormField.Builder field=FormField.builder(name);
    field.setValue(value);
    form.addField(field.build());
  }
  joinQueue(form.build(),userID);
}

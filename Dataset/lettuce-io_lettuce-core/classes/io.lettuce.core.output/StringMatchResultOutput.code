/** 
 * Command output for  {@code STRALGO} returning {@link StringMatchResult}.
 * @author dengliming
 * @since 6.0
 */
public class StringMatchResultOutput<K,V> extends CommandOutput<K,V,StringMatchResult> {
  private final boolean withIdx;
  private String matchString;
  private int len;
  private List<Long> positions;
  private final List<MatchedPosition> matchedPositions=new ArrayList<>();
  public StringMatchResultOutput(  RedisCodec<K,V> codec,  boolean withIdx){
    super(codec,null);
    this.withIdx=withIdx;
  }
  @Override public void set(  ByteBuffer bytes){
    if (!withIdx && matchString == null) {
      matchString=(String)codec.decodeKey(bytes);
    }
  }
  @Override public void set(  long integer){
    this.len=(int)integer;
    if (positions == null) {
      positions=new ArrayList<>();
    }
    positions.add(integer);
  }
  @Override public void complete(  int depth){
    if (depth == 2) {
      matchedPositions.add(buildMatchedString(positions));
      positions=null;
    }
    if (depth == 0) {
      output=new StringMatchResult(matchString,matchedPositions,len);
    }
  }
  private static MatchedPosition buildMatchedString(  List<Long> positions){
    if (positions == null) {
      throw new IllegalStateException("No matched positions");
    }
    int size=positions.size();
    long matchLen=size % 2 == 0 ? 0L : positions.get(size - 1);
    return new MatchedPosition(new Position(positions.get(0),positions.get(1)),new Position(positions.get(2),positions.get(3)),matchLen);
  }
}

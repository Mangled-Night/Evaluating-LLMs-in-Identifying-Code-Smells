@RegisterSystem @Share(BlockStructuralSupportRegistry.class) public class BlockStructuralSupportSystem extends BaseComponentSystem implements BlockStructuralSupportRegistry {
  @In private WorldProvider worldProvider;
  @In private BlockEntityRegistry blockEntityRegistry;
  @In private EntityManager entityManager;
  @In private PrefabManager prefabManager;
  private boolean midDestruction;
  private EntityRef gatheringEntity;
  private Set<BlockStructuralSupport> supports=Sets.newTreeSet(new Comparator<BlockStructuralSupport>(){
    @Override public int compare(    BlockStructuralSupport o1,    BlockStructuralSupport o2){
      return o1.getPriority() - o2.getPriority();
    }
  }
);
  @Override public void preBegin(){
    registerBlockStructuralSupport(new AttachSupportRequired());
    registerBlockStructuralSupport(new BlockDefSupportRequired());
    registerBlockStructuralSupport(new SideBlockSupportRequired());
  }
  @Override public void registerBlockStructuralSupport(  BlockStructuralSupport blockStructuralSupport){
    supports.add(blockStructuralSupport);
  }
  @ReceiveEvent(components=BlockComponent.class) public void checkForSupportRemoved(  OnChangedBlock event,  EntityRef entity){
    PerformanceMonitor.startActivity("StructuralCheck");
    try {
      for (      Side side : Side.values()) {
        validateSupportForBlockOnSide(event.getBlockPosition(),side);
      }
    }
  finally {
      PerformanceMonitor.endActivity();
    }
  }
  @ReceiveEvent public void preventInvalidPlacement(  PlaceBlocks placeBlocks,  EntityRef world){
    final Map<Vector3ic,Block> blocksMap=placeBlocks.getBlocks();
    for (    BlockStructuralSupport support : supports) {
      for (      Map.Entry<Vector3ic,Block> blockEntry : blocksMap.entrySet()) {
        final Vector3ic position=blockEntry.getKey();
        if (!support.isSufficientlySupported(position,Collections.unmodifiableMap(blocksMap))) {
          placeBlocks.consume();
          return;
        }
      }
    }
  }
  private void validateSupportForBlockOnSide(  Vector3i replacedBlockPosition,  Side side){
    final Vector3i blockPosition=side.getAdjacentPos(replacedBlockPosition,new Vector3i());
    if (worldProvider.isBlockRelevant(blockPosition)) {
      final Side sideReverse=side.reverse();
      for (      BlockStructuralSupport support : supports) {
        if (support.shouldBeRemovedDueToChange(blockPosition,sideReverse)) {
          blockEntityRegistry.getBlockEntityAt(blockPosition).send(new DestroyEvent(gatheringEntity,EntityRef.NULL,prefabManager.getPrefab("engine:supportRemovedDamage")));
          break;
        }
      }
    }
  }
}

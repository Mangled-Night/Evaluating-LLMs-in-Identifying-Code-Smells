@Test public void forcedSpillingWithReadIterator() throws Exception {
  final UnsafeExternalSorter sorter=newSorter();
  long[] record=new long[100];
  int recordSize=record.length * 8;
  int n=(int)pageSizeBytes / recordSize * 3;
  for (int i=0; i < n; i++) {
    record[0]=(long)i;
    sorter.insertRecord(record,Platform.LONG_ARRAY_OFFSET,recordSize,0);
  }
  assertTrue(sorter.getNumberOfAllocatedPages() >= 2);
  UnsafeExternalSorter.SpillableIterator iter=(UnsafeExternalSorter.SpillableIterator)sorter.getSortedIterator();
  int lastv=0;
  for (int i=0; i < n / 3; i++) {
    iter.hasNext();
    iter.loadNext();
    assertTrue(Platform.getLong(iter.getBaseObject(),iter.getBaseOffset()) == i);
    lastv=i;
  }
  assertTrue(iter.spill() > 0);
  assertEquals(0,iter.spill());
  assertTrue(Platform.getLong(iter.getBaseObject(),iter.getBaseOffset()) == lastv);
  for (int i=n / 3; i < n; i++) {
    iter.hasNext();
    iter.loadNext();
    assertEquals(i,Platform.getLong(iter.getBaseObject(),iter.getBaseOffset()));
  }
  sorter.cleanupResources();
  assertSpillFilesWereCleanedUp();
}

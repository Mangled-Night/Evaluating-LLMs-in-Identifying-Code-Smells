/** 
 * 付款订单的预支付会话标识 <p> 1. 检测当前订单是否能够付款 2. 微信商户平台返回支付订单ID 3. 设置订单付款状态
 * @param userId 用户ID
 * @param body   订单信息，{ orderId：xxx }
 * @return 支付订单ID
 */
@Transactional public Object prepay(Integer userId,String body,HttpServletRequest request){
  if (userId == null) {
    return ResponseUtil.unlogin();
  }
  Integer orderId=JacksonUtil.parseInteger(body,"orderId");
  if (orderId == null) {
    return ResponseUtil.badArgument();
  }
  LitemallOrder order=orderService.findById(userId,orderId);
  if (order == null) {
    return ResponseUtil.badArgumentValue();
  }
  if (!order.getUserId().equals(userId)) {
    return ResponseUtil.badArgumentValue();
  }
  OrderHandleOption handleOption=OrderUtil.build(order);
  if (!handleOption.isPay()) {
    return ResponseUtil.fail(ORDER_INVALID_OPERATION,"订单不能支付");
  }
  LitemallUser user=userService.findById(userId);
  String openid=user.getWeixinOpenid();
  if (openid == null) {
    return ResponseUtil.fail(AUTH_OPENID_UNACCESS,"订单不能支付");
  }
  WxPayMpOrderResult result=null;
  try {
    WxPayUnifiedOrderRequest orderRequest=new WxPayUnifiedOrderRequest();
    orderRequest.setOutTradeNo(order.getOrderSn());
    orderRequest.setOpenid(openid);
    orderRequest.setBody("订单：" + order.getOrderSn());
    int fee=0;
    BigDecimal actualPrice=order.getActualPrice();
    fee=actualPrice.multiply(new BigDecimal(100)).intValue();
    orderRequest.setTotalFee(fee);
    orderRequest.setSpbillCreateIp(IpUtil.getIpAddr(request));
    result=wxPayService.createOrder(orderRequest);
  }
 catch (  Exception e) {
    e.printStackTrace();
    return ResponseUtil.fail(ORDER_PAY_FAIL,"订单不能支付");
  }
  if (orderService.updateWithOptimisticLocker(order) == 0) {
    return ResponseUtil.updatedDateExpired();
  }
  return ResponseUtil.ok(result);
}

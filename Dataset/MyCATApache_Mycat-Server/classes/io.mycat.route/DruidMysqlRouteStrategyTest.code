public class DruidMysqlRouteStrategyTest extends TestCase {
  protected Map<String,SchemaConfig> schemaMap;
  protected LayerCachePool cachePool=new SimpleCachePool();
  protected RouteStrategy routeStrategy;
  public DruidMysqlRouteStrategyTest(){
    String schemaFile="/route/schema.xml";
    String ruleFile="/route/rule.xml";
    SchemaLoader schemaLoader=new XMLSchemaLoader(schemaFile,ruleFile);
    schemaMap=schemaLoader.getSchemas();
    MycatServer.getInstance().getConfig().getSchemas().putAll(schemaMap);
    RouteStrategyFactory.init();
    routeStrategy=RouteStrategyFactory.getRouteStrategy("druidparser");
  }
  protected void setUp() throws Exception {
  }
  public void testRouteInsertShort() throws Exception {
    String sql="inSErt into offer_detail (`offer_id`, gmt) values ('123',now())";
    SchemaConfig schema=schemaMap.get("cndb");
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(-1l,rrs.getLimitSize());
    Assert.assertEquals("detail_dn15",rrs.getNodes()[0].getName());
    String expect="INSERT INTO offer_detail (`offer_id`, gmt)\n" + "VALUES ('123', now())";
    Assert.assertEquals(expect,rrs.getNodes()[0].getStatement());
    sql="inSErt into offer_detail ( gmt) values (now())";
    schema=schemaMap.get("cndb");
    try {
      rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    }
 catch (    Exception e) {
      String msg="bad insert sql (sharding column:";
      Assert.assertTrue(e.getMessage().contains(msg));
    }
    sql="inSErt into offer_detail (offer_id, gmt) values (123,now())";
    schema=schemaMap.get("cndb");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(-1l,rrs.getLimitSize());
    Assert.assertEquals("detail_dn15",rrs.getNodes()[0].getName());
    Assert.assertEquals("INSERT INTO offer_detail (offer_id, gmt)\nVALUES ('123', now())",rrs.getNodes()[0].getStatement());
    sql="insert into offer(group_id,offer_id,member_id)values(234,123,'abc')";
    schema=schemaMap.get("cndb");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(-1l,rrs.getLimitSize());
    Assert.assertEquals("offer_dn12",rrs.getNodes()[0].getName());
    Assert.assertEquals("INSERT INTO offer (group_id, offer_id, member_id)\n" + "VALUES (234, 123, 'abc')",rrs.getNodes()[0].getStatement());
    sql="\n" + "  INSERT INTO \n" + "`offer` \n"+ "(`asf`,member_id) \n"+ "VALUES \n"+ "(' the articles sfroms user selection ','abc')";
    schema=schemaMap.get("cndb");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
  }
  public void testGlobalTableroute() throws Exception {
    String sql=null;
    SchemaConfig schema=schemaMap.get("TESTDB");
    RouteResultset rrs=null;
    sql="select * from company where company.name like 'aaa'";
    schema=schemaMap.get("TESTDB");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    sql="insert into company (id,name,level) values(111,'company1',3)";
    schema=schemaMap.get("TESTDB");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(3,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    sql="update company set name=name+aaa";
    schema=schemaMap.get("TESTDB");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(3,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    sql="delete from company where id = 1";
    schema=schemaMap.get("TESTDB");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(3,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    schema=schemaMap.get("TESTDB");
    sql="select * from  company A where a.sharding_id=10001 union select * from  company B where B.sharding_id =10010";
    Set<String> nodeSet=new HashSet<String>();
    for (int i=0; i < 10; i++) {
      rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
      Assert.assertEquals(false,rrs.isCacheAble());
      Assert.assertEquals(1,rrs.getNodes().length);
      nodeSet.add(rrs.getNodes()[0].getName());
    }
    Assert.assertEquals(true,nodeSet.size() > 1);
  }
  public void testMoreGlobalTableroute() throws Exception {
    String sql=null;
    SchemaConfig schema=schemaMap.get("TESTDB");
    RouteResultset rrs=null;
    sql="select * from company,area where area.company_id=company.id ";
    schema=schemaMap.get("TESTDB");
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
  }
  public void testRouteMultiTables() throws Exception {
    String sql="select * from company,customer ,orders where customer.company_id=company.id and orders.customer_id=customer.id and company.name like 'aaa' limit 10";
    SchemaConfig schema=schemaMap.get("TESTDB");
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(2,rrs.getNodes().length);
    Assert.assertEquals(true,rrs.isCacheAble());
    Assert.assertEquals(10,rrs.getLimitSize());
    Assert.assertEquals("dn1",rrs.getNodes()[0].getName());
    Assert.assertEquals("dn2",rrs.getNodes()[1].getName());
  }
  public void testRouteCache() throws Exception {
    this.cachePool.putIfAbsent("TESTDB_EMPLOYEE","88","dn2");
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select * from employee where id=88";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(null,rrs.getPrimaryKey());
    Assert.assertEquals(-1,rrs.getLimitSize());
    Assert.assertEquals("dn2",rrs.getNodes()[0].getName());
    sql="select * from employee where id=89";
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(2,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals("TESTDB_EMPLOYEE.ID",rrs.getPrimaryKey());
    Assert.assertEquals(-1,rrs.getLimitSize());
    sql="update employee  set name='aaa' where id=88";
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(null,rrs.getPrimaryKey());
    Assert.assertEquals("dn2",rrs.getNodes()[0].getName());
    sql="delete from  employee  where id=88";
    rrs=routeStrategy.route(new SystemConfig(),schema,-1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals("dn2",rrs.getNodes()[0].getName());
  }
  private static Map<String,RouteResultsetNode> getNodeMap(  RouteResultset rrs,  int expectSize){
    RouteResultsetNode[] routeNodes=rrs.getNodes();
    Assert.assertEquals(expectSize,routeNodes.length);
    Map<String,RouteResultsetNode> nodeMap=new HashMap<String,RouteResultsetNode>(expectSize,1);
    for (int i=0; i < expectSize; i++) {
      RouteResultsetNode routeNode=routeNodes[i];
      nodeMap.put(routeNode.getName(),routeNode);
    }
    Assert.assertEquals(expectSize,nodeMap.size());
    return nodeMap;
  }
private static interface NodeNameDeconstructor {
    public int getNodeIndex(    String name);
  }
private static class NodeNameAsserter implements NodeNameDeconstructor {
    private String[] expectNames;
    public NodeNameAsserter(){
    }
    public NodeNameAsserter(    String... expectNames){
      Assert.assertNotNull(expectNames);
      this.expectNames=expectNames;
    }
    protected void setNames(    String[] expectNames){
      Assert.assertNotNull(expectNames);
      this.expectNames=expectNames;
    }
    public void assertRouteNodeNames(    Collection<String> nodeNames){
      Assert.assertNotNull(nodeNames);
      Assert.assertEquals(expectNames.length,nodeNames.size());
      for (      String name : expectNames) {
        Assert.assertTrue(nodeNames.contains(name));
      }
    }
    @Override public int getNodeIndex(    String name){
      for (int i=0; i < expectNames.length; ++i) {
        if (name.equals(expectNames[i])) {
          return i;
        }
      }
      throw new NoSuchElementException("route node " + name + " dosn't exist!");
    }
  }
private static class IndexedNodeNameAsserter extends NodeNameAsserter {
    /** 
 * @param from included
 * @param to   excluded
 */
    public IndexedNodeNameAsserter(    String prefix,    int from,    int to){
      super();
      String[] names=new String[to - from];
      for (int i=0; i < names.length; ++i) {
        names[i]=prefix + (i + from);
      }
      setNames(names);
    }
  }
private static class RouteNodeAsserter {
    private NodeNameDeconstructor deconstructor;
    private SQLAsserter sqlAsserter;
    public RouteNodeAsserter(    NodeNameDeconstructor deconstructor,    SQLAsserter sqlAsserter){
      this.deconstructor=deconstructor;
      this.sqlAsserter=sqlAsserter;
    }
    public void assertNode(    RouteResultsetNode node) throws Exception {
      int nodeIndex=deconstructor.getNodeIndex(node.getName());
      sqlAsserter.assertSQL(node.getStatement(),nodeIndex);
    }
  }
private static interface SQLAsserter {
    public void assertSQL(    String sql,    int nodeIndex) throws Exception ;
  }
private static class SimpleSQLAsserter implements SQLAsserter {
    private Map<Integer,Set<String>> map=new HashMap<Integer,Set<String>>();
    public SimpleSQLAsserter addExpectSQL(    int nodeIndex,    String sql){
      Set<String> set=map.get(nodeIndex);
      if (set == null) {
        set=new HashSet<String>();
        map.put(nodeIndex,set);
      }
      set.add(sql);
      return this;
    }
    @Override public void assertSQL(    String sql,    int nodeIndex) throws Exception {
      Assert.assertNotNull(map.get(nodeIndex));
      Assert.assertTrue(map.get(nodeIndex).contains(sql));
    }
  }
  public void testroute() throws Exception {
    SchemaConfig schema=schemaMap.get("cndb");
    String sql="select * from independent where member='abc'";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Map<String,RouteResultsetNode> nodeMap=getNodeMap(rrs,128);
    IndexedNodeNameAsserter nameAsserter=new IndexedNodeNameAsserter("independent_dn",0,128);
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    SimpleSQLAsserter sqlAsserter=new SimpleSQLAsserter();
    for (int i=0; i < 128; ++i) {
      sqlAsserter.addExpectSQL(i,"select * from independent where member='abc'");
    }
    RouteNodeAsserter asserter=new RouteNodeAsserter(nameAsserter,sqlAsserter);
    for (    RouteResultsetNode node : nodeMap.values()) {
      asserter.assertNode(node);
    }
    sql="select * from cndb.independent A  where a.member='abc'";
    schema=schemaMap.get("cndb");
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    nodeMap=getNodeMap(rrs,128);
    nameAsserter=new IndexedNodeNameAsserter("independent_dn",0,128);
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    sqlAsserter=new SimpleSQLAsserter();
    for (int i=0; i < 128; ++i) {
      sqlAsserter.addExpectSQL(i,"select * from independent A  where a.member='abc'");
    }
    asserter=new RouteNodeAsserter(nameAsserter,sqlAsserter);
    for (    RouteResultsetNode node : nodeMap.values()) {
      asserter.assertNode(node);
    }
  }
  public void testERroute() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="insert into orders (id,name,customer_id) values(1,'testonly',1)";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals("dn1",rrs.getNodes()[0].getName());
    sql="insert into orders (id,name,customer_id) values(1,'testonly',2000001)";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals("dn2",rrs.getNodes()[0].getName());
    sql="update orders set id=1 ,name='aaa' , customer_id=2000001";
    String err=null;
    try {
      rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    }
 catch (    SQLNonTransientException e) {
      err=e.getMessage();
    }
    Assert.assertEquals(true,err.startsWith("Parent relevant column can't be updated ORDERS->CUSTOMER_ID"));
    sql="update orders set id=1 ,name='aaa' where customer_id=2000001";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Assert.assertEquals("dn2",rrs.getNodes()[0].getName());
    sql="update orders set id=1 ,name='aaa' where customer_id=-1";
    try {
      rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    }
 catch (    Exception e) {
      err=e.getMessage();
    }
    Assert.assertEquals(true,err.startsWith("can't find datanode for sharding column:"));
    sql="select * from orders  where customer_id=2000001";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Assert.assertEquals("dn2",rrs.getNodes()[0].getName());
    sql="delete from orders  where customer_id=2000001";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals("dn2",rrs.getNodes()[0].getName());
    sql="select name as order_name from  orders order by order_name limit 10,5";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    MySqlStatementParser parser=new MySqlStatementParser("SELECT name AS order_name FROM orders ORDER BY order_name LIMIT 0,15");
    SQLStatement statement=parser.parseStatement();
  }
  public void testDuplicatePartitionKey() throws Exception {
    String sql=null;
    SchemaConfig schema=schemaMap.get("cndb");
    RouteResultset rrs=null;
    sql="select * from cndb.offer where (offer_id, group_id ) In (123,234)";
    schema=schemaMap.get("cndb");
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Assert.assertEquals(-1l,rrs.getLimitSize());
    Assert.assertEquals(128,rrs.getNodes().length);
    for (int i=0; i < 128; i++) {
      Assert.assertEquals("select * from offer where (offer_id, group_id ) In (123,234)",rrs.getNodes()[i].getStatement());
    }
    sql="SELECT * FROM offer WHERE FALSE OR offer_id = 123 AND member_id = 123 OR member_id = 123 AND member_id = 234 OR member_id = 123 AND member_id = 345 OR member_id = 123 AND member_id = 456 OR offer_id = 234 AND group_id = 123 OR offer_id = 234 AND group_id = 234 OR offer_id = 234 AND group_id = 345 OR offer_id = 234 AND group_id = 456 OR offer_id = 345 AND group_id = 123 OR offer_id = 345 AND group_id = 234 OR offer_id = 345 AND group_id = 345 OR offer_id = 345 AND group_id = 456 OR offer_id = 456 AND group_id = 123 OR offer_id = 456 AND group_id = 234 OR offer_id = 456 AND group_id = 345 OR offer_id = 456 AND group_id = 456";
    schema=schemaMap.get("cndb");
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    getNodeMap(rrs,128);
    sql="select * from  offer where false" + " or offer_id=123 and group_id=123" + " or group_id=123 and offer_id=234"+ " or offer_id=123 and group_id=345"+ " or offer_id=123 and group_id=456  ";
    schema=schemaMap.get("cndb");
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Assert.assertEquals(-1l,rrs.getLimitSize());
  }
  public void testAddLimitToSQL() throws Exception {
    final SchemaConfig schema=schemaMap.get("TESTDB");
    String sql=null;
    RouteResultset rrs=null;
    sql="select * from orders";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Map<String,RouteResultsetNode> nodeMap=getNodeMap(rrs,2);
    NodeNameAsserter nameAsserter=new NodeNameAsserter("dn2","dn1");
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    Assert.assertEquals(schema.getDefaultMaxLimit(),rrs.getLimitSize());
    MySqlStatementParser parser=new MySqlStatementParser("SELECT * FROM orders LIMIT 100");
    SQLStatement statement=parser.parseStatement();
    Assert.assertEquals(statement.toString(),rrs.getNodes()[0].getStatement());
    sql="select * from goods";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(schema.getDefaultMaxLimit(),rrs.getLimitSize());
    parser=new MySqlStatementParser("SELECT * FROM goods LIMIT 100");
    statement=parser.parseStatement();
    Assert.assertEquals(statement.toString(),rrs.getNodes()[0].getStatement());
    sql="select * from goods limit 2 ,3";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals("select * from goods limit 2 ,3",rrs.getNodes()[0].getStatement());
    sql="select * from notpartionTable limit 2 ,3";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals(3,rrs.getLimitSize());
    Assert.assertEquals("select * from notpartionTable limit 2 ,3",rrs.getNodes()[0].getStatement());
  }
  public void testModifySQLLimit() throws Exception {
    final SchemaConfig schema=schemaMap.get("TESTDB");
    String sql=null;
    RouteResultset rrs=null;
    sql="select * from orders limit 2,3";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Map<String,RouteResultsetNode> nodeMap=getNodeMap(rrs,2);
    NodeNameAsserter nameAsserter=new NodeNameAsserter("dn2","dn1");
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    Assert.assertEquals(3,rrs.getLimitSize());
    MySqlStatementParser parser=new MySqlStatementParser("SELECT * FROM orders LIMIT 0,5");
    SQLStatement statement=parser.parseStatement();
    Assert.assertEquals(statement.toString(),rrs.getNodes()[0].getStatement());
    sql="select * from customer where id=10000 limit 2,3";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    nodeMap=getNodeMap(rrs,1);
    nameAsserter=new NodeNameAsserter("dn1");
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    Assert.assertEquals(3,rrs.getLimitSize());
    Assert.assertEquals("select * from customer where id=10000 limit 2,3",rrs.getNodes()[0].getStatement());
  }
  public void testGroupLimit() throws Exception {
    final SchemaConfig schema=schemaMap.get("cndb");
    String sql=null;
    RouteResultset rrs=null;
    sql="select count(*) from (select * from(select * from offer_detail where offer_id='123' or offer_id='234' limit 88)offer  where offer.member_id='abc' limit 60) w " + " where w.member_id ='pavarotti17' limit 99";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    Map<String,RouteResultsetNode> nodeMap=getNodeMap(rrs,2);
    NodeNameAsserter nameAsserter=new NodeNameAsserter("detail_dn29","detail_dn15");
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    sql="select count(*) from (select * from(select max(id) from offer_detail where offer_id='123' or offer_id='234' limit 88)offer  where offer.member_id='abc' limit 60) w " + " where w.member_id ='pavarotti17' limit 99";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    nodeMap=getNodeMap(rrs,2);
    nameAsserter=new NodeNameAsserter("detail_dn29","detail_dn15");
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    sql="select * from (select * from(select max(id) from offer_detail where offer_id='123' or offer_id='234' limit 88)offer  where offer.member_id='abc' limit 60) w " + " where w.member_id ='pavarotti17' limit 99";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    nodeMap=getNodeMap(rrs,2);
    nameAsserter=new NodeNameAsserter("detail_dn29","detail_dn15");
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
    sql="select * from (select count(*) from(select * from offer_detail where offer_id='123' or offer_id='234' limit 88)offer  where offer.member_id='abc' limit 60) w " + " where w.member_id ='pavarotti17' limit 99";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(true,rrs.isCacheAble());
    nodeMap=getNodeMap(rrs,2);
    nameAsserter=new NodeNameAsserter("detail_dn29","detail_dn15");
    nameAsserter.assertRouteNodeNames(nodeMap.keySet());
  }
  public void testConfigSchema() throws Exception {
    try {
      SchemaConfig schema=schemaMap.get("config");
      String sql="select * from offer where offer_id=1";
      routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
      Assert.assertFalse(true);
    }
 catch (    Exception e) {
      Assert.assertEquals("route rule for table OFFER is required: select * from offer where offer_id=1",e.getMessage());
    }
    try {
      SchemaConfig schema=schemaMap.get("config");
      String sql="select * from offer where col11111=1";
      routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
      Assert.assertFalse(true);
    }
 catch (    Exception e) {
    }
    try {
      SchemaConfig schema=schemaMap.get("config");
      String sql="select * from offer ";
      routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
      Assert.assertFalse(true);
    }
 catch (    Exception e) {
    }
  }
  public void testIgnoreSchema() throws Exception {
    SchemaConfig schema=schemaMap.get("ignoreSchemaTest");
    String sql="select * from offer where offer_id=1";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals("cndb_dn",rrs.getNodes()[0].getName());
    Assert.assertEquals(sql,rrs.getNodes()[0].getStatement());
    sql="select * from ignoreSchemaTest.offer1 where ignoreSchemaTest.offer1.offer_id=1";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals("select * from offer1 where offer1.offer_id=1",rrs.getNodes()[0].getStatement());
    sql="select * from ignoreSchemaTest2.offer where ignoreSchemaTest2.offer.offer_id=1";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals(sql,rrs.getNodes()[0].getStatement(),sql);
    sql="select * from ignoreSchemaTest2.offer a,offer b  where ignoreSchemaTest2.offer.offer_id=1";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals("select * from ignoreSchemaTest2.offer a,offer b  where ignoreSchemaTest2.offer.offer_id=1",rrs.getNodes()[0].getStatement());
  }
  public void testGlobalTableSingleNodeLimit() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select * from globalsn";
    RouteResultset rrs=null;
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(100L,rrs.getLimitSize());
  }
  /** 
 * select 1 select 1 union all select 2
 * @throws Exception
 */
  public void testSelectNoTable() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select 1";
    RouteResultset rrs=null;
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    sql="select 1 union select 2";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
  }
  /** 
 * 支持insert into ... values (),()... 不支持insert into ... select...
 * @throws Exception
 */
  public void testBatchInsert() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    RouteResultset rrs=null;
    String sql="insert into orders (id,name,customer_id) values(1,'testonly',1),(2,'testonly',2000001)";
    try {
      rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    }
 catch (    Exception e) {
      Assert.assertEquals("ChildTable multi insert not provided",e.getMessage());
    }
    sql="insert into employee (id,name,customer_id) select id,name,customer_id from customer";
    try {
      rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    }
 catch (    Exception e) {
      Assert.assertEquals("TODO:insert into .... select .... not supported!",e.getMessage());
    }
    sql="insert into employee (id,name,sharding_id) values(1,'testonly',10000),(2,'testonly','10010')";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(2,rrs.getNodes().length);
    Assert.assertEquals(false,rrs.isCacheAble());
    Assert.assertEquals("dn1",rrs.getNodes()[0].getName());
    Assert.assertEquals("dn2",rrs.getNodes()[1].getName());
    String node1Sql=formatSql("insert into employee (id,name,sharding_id) values(1,'testonly','10000')");
    String node2Sql=formatSql("insert into employee (id,name,sharding_id) values(2,'testonly','10010')");
    RouteResultsetNode[] nodes=rrs.getNodes();
    Assert.assertEquals(node1Sql,nodes[0].getStatement());
    Assert.assertEquals(node2Sql,nodes[1].getStatement());
  }
  /** 
 * insert ... on duplicate key ... update...
 * @throws Exception
 */
  public void testInsertOnDuplicateKey() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="insert into employee (id,name,sharding_id) values(1,'testonly',10000) on duplicate key update name='nihao'";
    RouteResultset rrs=null;
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals("dn1",rrs.getNodes()[0].getName());
    sql="insert into employee (id,name,sharding_id) values(1,'testonly',10000) " + "on duplicate key update name=VALUES(name),id = VALUES(id)";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertEquals("dn1",rrs.getNodes()[0].getName());
    sql="insert into employee (id,name,sharding_id) values(1,'testonly',10000) " + "on duplicate key update name=VALUES(name),id = VALUES(id),sharding_id = VALUES(sharding_id)";
    try {
      rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    }
 catch (    Exception e) {
      Assert.assertEquals("Sharding column can't be updated: EMPLOYEE -> SHARDING_ID",e.getMessage());
    }
  }
  /** 
 * 测试函数COUNT
 * @throws Exception
 */
  @Test public void testAggregateExpr() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select id, name, count(name) from employee group by name;";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getMergeCols().containsKey("count2"));
    sql="select id, name, count(name) as c from employee group by name;";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getMergeCols().containsKey("c"));
    sql="select id, name, count(name) c from employee group by name;";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getMergeCols().containsKey("c"));
  }
  /** 
 * 测试between语句的路由
 * @throws Exception
 */
  @Test public void testBetweenExpr() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select * from customer where id between 1 and 5;";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 1);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn1"));
    sql="select * from customer where id between 1 and 2000001;";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 2);
    sql="select * from customer where id between 2000001 and 3000001;";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 1);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn2"));
    sql="delete from customer where id between 2000001 and 3000001;";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 1);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn2"));
    sql="update customer set name='newName' where id between 2000001 and 3000001;";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 1);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn2"));
  }
  /** 
 * 测试or语句的路由
 * @throws Exception
 */
  @Test public void testOr() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select * from customer where sharding_id=10000 or 1=1;";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 2);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn1"));
    Assert.assertTrue(rrs.getNodes()[1].getName().equals("dn2"));
    sql="select * from customer where sharding_id = 10000 or sharding_id = 10010";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn1"));
    Assert.assertTrue(rrs.getNodes()[1].getName().equals("dn2"));
    sql="select * from customer where sharding_id = 10000 or user_id = 'wangwu'";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn1"));
    Assert.assertTrue(rrs.getNodes()[1].getName().equals("dn2"));
    sql="select * from customer where sharding_id = 10000 and (user_id = 'zhangsan' or user_id='lisi')";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn1"));
    sql="select * from customer where (user_id = 'zhangsan' or user_id='lisi') and sharding_id = 10000";
    RouteResultset rrs2=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs2.getNodes()[0].getName().equals(rrs.getNodes()[0].getName()));
  }
  /** 
 * 测试父子表，查询子表的语句路由到多个节点
 * @throws Exception
 */
  @Test public void testERRouteMutiNode() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select * from orders where customer_id in(1,2000001);";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 2);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn1"));
    Assert.assertTrue(rrs.getNodes()[1].getName().equals("dn2"));
  }
  /** 
 * 测试多层or语句
 * @throws Exception
 */
  @Test public void testMultiLevelOr() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select id from travelrecord " + " where id = 1 and ( fee=3 or days=5 or (traveldate = '2015-05-04 00:00:07.375' " + " and (user_id=2 or fee=days or fee = 0))) and name = 'zhangsan'";
    RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 1);
    sql="select id from travelrecord " + " where id = 1 and ( fee=3 or days=5 or (traveldate = '2015-05-04 00:00:07.375' " + " and (user_id=2 or fee=days or fee = 0))) and name = 'zhangsan' or id = 2000001";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 2);
    sql="select id from travelrecord " + " where id = 1 and ( fee=3 or days=5 or (traveldate = '2015-05-04 00:00:07.375' " + " and (user_id=2 or fee=days or fee = 0))) and name = 'zhangsan' or id = 2000001 or id = 4000001";
    rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
    Assert.assertTrue(rrs.getNodes().length == 3);
  }
  /** 
 * 测试 global table 的or语句
 * @throws Exception
 */
  @Test public void testGlobalTableOr() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    String sql="select id from company where 1 = 1 and name ='company1' or name = 'company2'";
    for (int i=0; i < 20; i++) {
      RouteResultset rrs=routeStrategy.route(new SystemConfig(),schema,ServerParse.SELECT,sql,null,null,cachePool);
      Assert.assertTrue(rrs.getNodes().length == 1);
    }
  }
  /** 
 * 测试别名路由
 * @throws Exception
 */
  public void testAlias() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    RouteResultset rrs=null;
    String sql="update company a set name = '' where a.id = 1;";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(3,rrs.getNodes().length);
    sql="update travelrecord a set name = '' where a.id = 1;";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    sql="select * from travelrecord A where a.id = 1;";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
  }
  /** 
 * 测试"schema.table"
 * @throws Exception
 */
  public void testSchemaTable() throws Exception {
    SchemaConfig schema=schemaMap.get("schema_table_test");
    RouteResultset rrs=null;
    String sql="select * from schema_table_test.offer   where id = 1;";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn1"));
    sql="select * from noExistSchema.offer a where a.id = 1;";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn2"));
    sql="select * from noExistSchema.offer  where id = 1;";
    rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    Assert.assertEquals(1,rrs.getNodes().length);
    Assert.assertTrue(rrs.getNodes()[0].getName().equals("dn2"));
    schema=schemaMap.get("TESTDB");
    sql="select * from schema_table_test.offer   where id = 1;";
    try {
      rrs=routeStrategy.route(new SystemConfig(),schema,1,sql,null,null,cachePool);
    }
 catch (    Exception e) {
      Assert.assertTrue(e.getMessage().contains("can't find table define in schema SCHEMA_TABLE_TEST.OFFER alias：schema_table_test.offer, schema:TESTDB"));
    }
  }
  private String formatSql(  String sql){
    MySqlStatementParser parser=new MySqlStatementParser(sql);
    SQLStatement stmt=parser.parseStatement();
    return stmt.toString();
  }
}

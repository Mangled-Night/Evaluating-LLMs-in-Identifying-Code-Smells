/** 
 * Test for InBandBytestreamRequest.
 * @author Henning Staib
 */
public class InBandBytestreamRequestTest extends SmackTestSuite {
  private static final Jid initiatorJID=JidTestUtil.DUMMY_AT_EXAMPLE_ORG_SLASH_DUMMYRESOURCE;
  private static final Jid targetJID=JidTestUtil.FULL_JID_1_RESOURCE_1;
  private String sessionID="session_id";
  private XMPPConnection connection;
  private InBandBytestreamManager byteStreamManager;
  private Open initBytestream;
  /** 
 * Initialize fields used in the tests.
 */
  @BeforeEach public void setup(){
    connection=mock(XMPPConnection.class);
    byteStreamManager=InBandBytestreamManager.getByteStreamManager(connection);
    initBytestream=new Open(sessionID,4096);
    initBytestream.setFrom(initiatorJID);
    initBytestream.setTo(targetJID);
  }
  /** 
 * Test reject() method.
 * @throws NotConnectedException if the XMPP connection is not connected.
 * @throws InterruptedException if the calling thread was interrupted.
 */
  @Test public void shouldReplyWithErrorIfRequestIsRejected() throws NotConnectedException, InterruptedException {
    InBandBytestreamRequest ibbRequest=new InBandBytestreamRequest(byteStreamManager,initBytestream);
    ibbRequest.reject();
    ArgumentCaptor<IQ> argument=ArgumentCaptor.forClass(IQ.class);
    verify(connection).sendStanza(argument.capture());
    assertEquals(initiatorJID,argument.getValue().getTo());
    assertEquals(IQ.Type.error,argument.getValue().getType());
    assertEquals(StanzaError.Condition.not_acceptable,argument.getValue().getError().getCondition());
  }
  /** 
 * Test accept() method.
 * @throws Exception should not happen
 */
  @Test public void shouldReturnSessionIfRequestIsAccepted() throws Exception {
    InBandBytestreamRequest ibbRequest=new InBandBytestreamRequest(byteStreamManager,initBytestream);
    InBandBytestreamSession session=ibbRequest.accept();
    ArgumentCaptor<IQ> argument=ArgumentCaptor.forClass(IQ.class);
    verify(connection).sendStanza(argument.capture());
    assertEquals(initiatorJID,argument.getValue().getTo());
    assertEquals(IQ.Type.result,argument.getValue().getType());
    assertNotNull(session);
    assertNotNull(session.getInputStream());
    assertNotNull(session.getOutputStream());
  }
}

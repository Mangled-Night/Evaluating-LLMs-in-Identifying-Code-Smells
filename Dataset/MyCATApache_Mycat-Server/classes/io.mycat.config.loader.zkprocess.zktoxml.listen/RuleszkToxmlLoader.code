/** 
 * 进行rule的文件从zk中加载 源文件名：RuleszkToxmlLoader.java 文件版本：1.0.0 创建作者：liujun 创建日期：2016年9月15日 修改作者：liujun 修改日期：2016年9月15日 文件描述：TODO 版权所有：Copyright 2016 zjhz, Inc. All Rights Reserved.
 */
public class RuleszkToxmlLoader extends ZkMultLoader implements NotiflyService {
  /** 
 * 日志
 * @字段说明 LOGGER
 */
  private static final Logger LOGGER=LoggerFactory.getLogger(RuleszkToxmlLoader.class);
  /** 
 * 当前文件中的zkpath信息 
 * @字段说明 currZkPath
 */
  private final String currZkPath;
  /** 
 * 写入本地的文件路径
 * @字段说明 WRITEPATH
 */
  private static final String WRITEPATH="rule.xml";
  /** 
 * Rules的xml的转换信息
 * @字段说明 parseRulesXMl
 */
  private ParseXmlServiceInf<Rules> parseRulesXMl;
  /** 
 * 表的路由信息
 * @字段说明 parseJsonService
 */
  private ParseJsonServiceInf<List<TableRule>> parseJsonTableRuleService=new TableRuleJsonParse();
  /** 
 * 表对应的字段信息
 * @字段说明 parseJsonFunctionService
 */
  private ParseJsonServiceInf<List<Function>> parseJsonFunctionService=new FunctionJsonParse();
  /** 
 * zk的监控路径信息
 * @字段说明 zookeeperListen
 */
  private ZookeeperProcessListen zookeeperListen;
  public RuleszkToxmlLoader(  ZookeeperProcessListen zookeeperListen,  CuratorFramework curator,  XmlProcessBase xmlParseBase){
    this.setCurator(curator);
    this.zookeeperListen=zookeeperListen;
    String RulesPath=zookeeperListen.getBasePath();
    RulesPath=RulesPath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_RULE.getKey();
    currZkPath=RulesPath;
    zookeeperListen.addListen(RulesPath,this);
    parseRulesXMl=new RuleParseXmlImpl(xmlParseBase);
  }
  @Override public boolean notiflyProcess() throws Exception {
    DiretoryInf RulesDirectory=new ZkDirectoryImpl(currZkPath,null);
    this.getTreeDirectory(currZkPath,ZookeeperPath.FLOW_ZK_PATH_RULE.getKey(),RulesDirectory);
    ZkDirectoryImpl zkDirectory=(ZkDirectoryImpl)RulesDirectory.getSubordinateInfo().get(0);
    Rules Rules=this.zktoRulesBean(zkDirectory);
    LOGGER.info("RuleszkToxmlLoader notiflyProcess zk to object  zk Rules Object  :" + Rules);
    writeMapFileAddFunction(Rules.getFunction());
    LOGGER.info("RuleszkToxmlLoader notiflyProcess write mapFile is success ");
    String path=RuleszkToxmlLoader.class.getClassLoader().getResource(ZookeeperPath.ZK_LOCAL_WRITE_PATH.getKey()).getPath();
    path=new File(path).getPath() + File.separator;
    path=path + WRITEPATH;
    LOGGER.info("RuleszkToxmlLoader notiflyProcess zk to object writePath :" + path);
    this.parseRulesXMl.parseToXmlWrite(Rules,path,"rule");
    LOGGER.info("RuleszkToxmlLoader notiflyProcess zk to object zk Rules      write :" + path + " is success");
    if (MycatServer.getInstance().getProcessors() != null)     ReloadConfig.reload();
    return true;
  }
  /** 
 * 将zk上面的信息转换为javabean对象 方法描述
 * @param zkDirectory
 * @return
 * @创建日期 2016年9月17日
 */
  private Rules zktoRulesBean(  DiretoryInf zkDirectory){
    Rules Rules=new Rules();
    DataInf RulesZkData=this.getZkData(zkDirectory,ZookeeperPath.FLOW_ZK_PATH_RULE_TABLERULE.getKey());
    List<TableRule> tableRuleData=parseJsonTableRuleService.parseJsonToBean(RulesZkData.getDataValue());
    Rules.setTableRule(tableRuleData);
    String watchPath=ZookeeperPath.FLOW_ZK_PATH_RULE.getKey();
    watchPath=watchPath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_RULE_TABLERULE.getKey();
    this.zookeeperListen.watchPath(currZkPath,watchPath);
    DataInf functionZkData=this.getZkData(zkDirectory,ZookeeperPath.FLOW_ZK_PATH_RULE_FUNCTION.getKey());
    List<Function> functionList=parseJsonFunctionService.parseJsonToBean(functionZkData.getDataValue());
    Rules.setFunction(functionList);
    String functionWatchPath=ZookeeperPath.FLOW_ZK_PATH_RULE.getKey();
    functionWatchPath=functionWatchPath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_RULE_FUNCTION.getKey();
    this.zookeeperListen.watchPath(currZkPath,functionWatchPath);
    return Rules;
  }
  /** 
 * 读取序列配制文件便利店   方法描述
 * @param functionList
 * @创建日期 2016年9月18日
 */
  private void writeMapFileAddFunction(  List<Function> functionList){
    List<Property> tempData=new ArrayList<>();
    List<Property> writeData=new ArrayList<>();
    for (    Function function : functionList) {
      List<Property> proList=function.getProperty();
      if (null != proList && !proList.isEmpty()) {
        for (        Property property : proList) {
          if (ParseParamEnum.ZK_PATH_RULE_MAPFILE_NAME.getKey().equals(property.getName())) {
            tempData.add(property);
          }
        }
        if (!tempData.isEmpty()) {
          for (          Property property : tempData) {
            for (            Property prozkdownload : proList) {
              if (property.getValue().equals(prozkdownload.getName())) {
                writeData.add(prozkdownload);
              }
            }
          }
        }
        if (!writeData.isEmpty()) {
          for (          Property writeMsg : writeData) {
            this.writeMapFile(writeMsg.getName(),writeMsg.getValue());
          }
        }
        proList.removeAll(writeData);
        tempData.clear();
        writeData.clear();
      }
    }
  }
  /** 
 * 读取 mapFile文件的信息 方法描述
 * @param name 名称信息
 * @return
 * @创建日期 2016年9月18日
 */
  private void writeMapFile(  String name,  String value){
    String path=RuleszkToxmlLoader.class.getClassLoader().getResource(ZookeeperPath.ZK_LOCAL_WRITE_PATH.getKey()).getPath();
    checkNotNull(path,"write Map file curr Path :" + path + " is null! must is not null");
    path=new File(path).getPath() + File.separator;
    path+=name;
    try {
      Files.write(value.getBytes(),new File(path));
    }
 catch (    IOException e1) {
      e1.printStackTrace();
    }
  }
}

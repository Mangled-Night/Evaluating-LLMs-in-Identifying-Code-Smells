/** 
 * 按SQL表名进行计算
 * @author zhuam
 */
public class TableStatAnalyzer implements QueryResultListener {
  private static final Logger LOGGER=LoggerFactory.getLogger(TableStatAnalyzer.class);
  private Map<String,TableStat> tableStatMap=new ConcurrentHashMap<>();
  private ReentrantLock lock=new ReentrantLock();
  private SQLParser sqlParser=new SQLParser();
  private final static TableStatAnalyzer instance=new TableStatAnalyzer();
  private TableStatAnalyzer(){
  }
  public static TableStatAnalyzer getInstance(){
    return instance;
  }
  @Override public void onQueryResult(  QueryResult queryResult){
    int sqlType=queryResult.getSqlType();
    String sql=queryResult.getSql();
switch (sqlType) {
case ServerParse.SELECT:
case ServerParse.UPDATE:
case ServerParse.INSERT:
case ServerParse.DELETE:
case ServerParse.REPLACE:
      String masterTable=null;
    List<String> relaTables=new ArrayList<String>();
  List<String> tables=sqlParser.parseTableNames(sql);
for (int i=0; i < tables.size(); i++) {
  String table=tables.get(i);
  if (i == 0) {
    masterTable=table;
  }
 else {
    relaTables.add(table);
  }
}
if (masterTable != null) {
TableStat tableStat=getTableStat(masterTable);
tableStat.update(sqlType,sql,queryResult.getStartTime(),queryResult.getEndTime(),relaTables);
}
break;
}
}
private TableStat getTableStat(String tableName){
TableStat userStat=tableStatMap.get(tableName);
if (userStat == null) {
if (lock.tryLock()) {
try {
userStat=new TableStat(tableName);
tableStatMap.put(tableName,userStat);
}
  finally {
lock.unlock();
}
}
 else {
while (userStat == null) {
userStat=tableStatMap.get(tableName);
}
}
}
return userStat;
}
public Map<String,TableStat> getTableStatMap(){
Map<String,TableStat> map=new LinkedHashMap<String,TableStat>(tableStatMap.size());
map.putAll(tableStatMap);
return map;
}
/** 
 * 获取 table 访问排序统计
 */
public List<TableStat> getTableStats(boolean isClear){
SortedSet<TableStat> tableStatSortedSet=new TreeSet<>(tableStatMap.values());
List<TableStat> list=new ArrayList<>(tableStatSortedSet);
return list;
}
public void ClearTable(){
tableStatMap.clear();
}
/** 
 * 解析 table name
 */
private static class SQLParser {
private SQLStatement parseStmt(String sql){
SQLStatementParser statParser=SQLParserUtils.createSQLStatementParser(sql,"mysql");
SQLStatement stmt=statParser.parseStatement();
return stmt;
}
/** 
 * 去掉库名、去掉``
 * @param tableName
 * @return
 */
private String fixName(String tableName){
if (tableName != null) {
tableName=tableName.replace("`","");
int dotIdx=tableName.indexOf(".");
if (dotIdx > 0) {
tableName=tableName.substring(1 + dotIdx).trim();
}
}
return tableName;
}
/** 
 * 解析 SQL table name
 */
public List<String> parseTableNames(String sql){
final List<String> tables=new ArrayList<String>();
try {
SQLStatement stmt=parseStmt(sql);
if (stmt instanceof SQLReplaceStatement) {
String table=((SQLReplaceStatement)stmt).getTableName().getSimpleName();
tables.add(fixName(table));
}
 else if (stmt instanceof SQLInsertStatement) {
String table=((SQLInsertStatement)stmt).getTableName().getSimpleName();
tables.add(fixName(table));
}
 else if (stmt instanceof SQLUpdateStatement) {
String table=((SQLUpdateStatement)stmt).getTableName().getSimpleName();
tables.add(fixName(table));
}
 else if (stmt instanceof SQLDeleteStatement) {
((SQLDeleteStatement)stmt).getTableSource().accept(new SQLASTVisitorAdapter(){
public boolean visit(SQLExprTableSource x){
  tables.add(fixName(x.toString()));
  return super.visit(x);
}
}
);
if (((SQLDeleteStatement)stmt).getFrom() != null) {
((SQLDeleteStatement)stmt).getFrom().accept(new SQLASTVisitorAdapter(){
  public boolean visit(  SQLExprTableSource x){
    if (tables.contains(x.getAlias())) {
      tables.remove(x.getAlias());
      tables.add(fixName(x.toString()));
    }
    return super.visit(x);
  }
}
);
}
}
 else if (stmt instanceof SQLSelectStatement) {
DbType dbType=((SQLSelectStatement)stmt).getDbType();
if (DbType.mysql.equals(dbType)) {
stmt.accept(new MySqlASTVisitorAdapter(){
  public boolean visit(  SQLExprTableSource x){
    tables.add(fixName(x.toString()));
    return super.visit(x);
  }
}
);
}
 else {
stmt.accept(new SQLASTVisitorAdapter(){
  public boolean visit(  SQLExprTableSource x){
    tables.add(fixName(x.toString()));
    return super.visit(x);
  }
}
);
}
}
}
 catch (Exception e) {
LOGGER.error("TableStatAnalyzer err:" + sql,e);
}
return tables;
}
}
}

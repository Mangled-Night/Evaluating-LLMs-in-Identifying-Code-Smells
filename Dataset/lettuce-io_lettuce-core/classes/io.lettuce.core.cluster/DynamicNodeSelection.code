/** 
 * Dynamic selection of nodes.
 * @param < API > API type.
 * @param < CMD > Command command interface type to invoke multi-node operations.
 * @param < K > Key type.
 * @param < V > Value type.
 * @author Mark Paluch
 */
class DynamicNodeSelection<API,CMD,K,V> extends AbstractNodeSelection<API,CMD,K,V> {
  private final ClusterDistributionChannelWriter writer;
  private final Predicate<RedisClusterNode> selector;
  private final ConnectionIntent connectionIntent;
  private final Function<StatefulRedisConnection<K,V>,API> apiExtractor;
  public DynamicNodeSelection(  ClusterDistributionChannelWriter writer,  Predicate<RedisClusterNode> selector,  ConnectionIntent connectionIntent,  Function<StatefulRedisConnection<K,V>,API> apiExtractor){
    this.selector=selector;
    this.connectionIntent=connectionIntent;
    this.writer=writer;
    this.apiExtractor=apiExtractor;
  }
  @Override protected CompletableFuture<StatefulRedisConnection<K,V>> getConnection(  RedisClusterNode redisClusterNode){
    RedisURI uri=redisClusterNode.getUri();
    AsyncClusterConnectionProvider async=(AsyncClusterConnectionProvider)writer.getClusterConnectionProvider();
    return async.getConnectionAsync(connectionIntent,uri.getHost(),uri.getPort());
  }
  @Override protected CompletableFuture<API> getApi(  RedisClusterNode redisClusterNode){
    return getConnection(redisClusterNode).thenApply(apiExtractor);
  }
  @Override protected List<RedisClusterNode> nodes(){
    return writer.getPartitions().stream().filter(selector).collect(Collectors.toList());
  }
}

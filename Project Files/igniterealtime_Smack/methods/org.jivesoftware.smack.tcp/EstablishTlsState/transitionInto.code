@Override public StateTransitionResult.AttemptResult transitionInto(WalkStateGraphContext walkStateGraphContext) throws IOException, InterruptedException, SmackException, XMPPException {
  connectionInternal.sendAndWaitForResponse(StartTls.INSTANCE,TlsProceed.class,TlsFailure.class);
  SmackTlsContext smackTlsContext=connectionInternal.getSmackTlsContext();
  tlsState=new TlsState(smackTlsContext);
  connectionInternal.addXmppInputOutputFilter(tlsState);
  channelSelectedCallbackLock.lock();
  try {
    pendingOutputFilterData=true;
    tlsState.engine.beginHandshake();
    tlsState.handshakeStatus=TlsHandshakeStatus.initiated;
  }
  finally {
    channelSelectedCallbackLock.unlock();
  }
  connectionInternal.setInterestOps(selectionKey,SelectionKey.OP_WRITE | SelectionKey.OP_READ);
  try {
    tlsState.waitForHandshakeFinished();
  }
 catch (  CertificateException e) {
    throw new SmackCertificateException(e);
  }
  connectionInternal.newStreamOpenWaitForFeaturesSequence("stream features after TLS established");
  return new TlsEstablishedResult(tlsState.engine);
}

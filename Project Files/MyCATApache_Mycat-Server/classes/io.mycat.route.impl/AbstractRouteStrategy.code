public abstract class AbstractRouteStrategy implements RouteStrategy {
  private static final Logger LOGGER=LoggerFactory.getLogger(AbstractRouteStrategy.class);
  @Override public RouteResultset route(  SystemConfig sysConfig,  SchemaConfig schema,  int sqlType,  String origSQL,  String charset,  ServerConnection sc,  LayerCachePool cachePool) throws SQLNonTransientException {
    if (schema.isCheckSQLSchema()) {
      origSQL=RouterUtil.removeSchema(origSQL,schema.getName());
    }
    if (beforeRouteProcess(schema,sqlType,origSQL,sc)) {
      return null;
    }
    String stmt=MycatServer.getInstance().getSqlInterceptor().interceptSQL(origSQL,sqlType);
    if (!origSQL.equals(stmt) && LOGGER.isDebugEnabled()) {
      LOGGER.debug("sql intercepted to " + stmt + " from "+ origSQL);
    }
    RouteResultset rrs=new RouteResultset(stmt,sqlType);
    if (LOGGER.isDebugEnabled() && origSQL.startsWith(LoadData.loadDataHint)) {
      rrs.setCacheAble(false);
    }
    if (sc != null) {
      rrs.setAutocommit(sc.isAutocommit());
    }
    if (ServerParse.DDL == sqlType) {
      return RouterUtil.routeToDDLNode(rrs,sqlType,stmt,schema);
    }
    if (schema.isNoSharding() && ServerParse.SHOW != sqlType) {
      rrs=RouterUtil.routeToSingleNode(rrs,schema.getDataNode(),stmt);
    }
 else {
      RouteResultset returnedSet=routeSystemInfo(schema,sqlType,stmt,rrs);
      if (returnedSet == null) {
        rrs=routeNormalSqlWithAST(schema,stmt,rrs,charset,cachePool,sqlType,sc);
      }
    }
    if (rrs.getSqlType() == ServerParse.INSERT && rrs.getTables() != null && rrs.getTables().size() != 0) {
      List<String> tables=rrs.getTables();
      boolean isAutoIncrement=false;
      for (      String tableName : tables) {
        if (schema.getTables() != null && schema.getTables().get(tableName) != null) {
          TableConfig tableConfig=schema.getTables().get(tableName);
          if (tableConfig.isAutoIncrement()) {
            isAutoIncrement=true;
          }
        }
      }
      rrs.setAutoIncrement(isAutoIncrement);
    }
    return rrs;
  }
  /** 
 * 路由之前必要的处理 主要是全局序列号插入，还有子表插入
 */
  private boolean beforeRouteProcess(  SchemaConfig schema,  int sqlType,  String origSQL,  ServerConnection sc) throws SQLNonTransientException {
    return RouterUtil.processWithMycatSeq(schema,sqlType,origSQL,sc) || (sqlType == ServerParse.INSERT && RouterUtil.processERChildTable(schema,origSQL,sc)) || (sqlType == ServerParse.INSERT && RouterUtil.processInsert(schema,sqlType,origSQL,sc));
  }
  /** 
 * 通过解析AST语法树类来寻找路由
 */
  public abstract RouteResultset routeNormalSqlWithAST(  SchemaConfig schema,  String stmt,  RouteResultset rrs,  String charset,  LayerCachePool cachePool,  int sqlType,  ServerConnection sc) throws SQLNonTransientException ;
  /** 
 * 路由信息指令, 如 SHOW、SELECT@@、DESCRIBE
 */
  public abstract RouteResultset routeSystemInfo(  SchemaConfig schema,  int sqlType,  String stmt,  RouteResultset rrs) throws SQLSyntaxErrorException ;
  /** 
 * 解析 Show 之类的语句
 */
  public abstract RouteResultset analyseShowSQL(  SchemaConfig schema,  RouteResultset rrs,  String stmt) throws SQLNonTransientException ;
}

public class FormFieldRegistry {
  private static final Logger LOGGER=Logger.getLogger(FormFieldRegistry.class.getName());
  private static final Map<String,Map<String,FormField.Type>> REGISTRY=new HashMap<>();
  private static final Map<String,FormField.Type> CLARK_NOTATION_FIELD_REGISTRY=new ConcurrentHashMap<>();
  private static final Map<String,FormField.Type> LOOKASIDE_FIELD_REGISTRY=new ConcurrentHashMap<>();
  @SuppressWarnings("ReferenceEquality") public static void register(  DataForm dataForm){
    if (dataForm.getType() != DataForm.Type.form) {
      throw new IllegalArgumentException();
    }
    String formType=null;
    TextSingleFormField hiddenFormTypeField=dataForm.getHiddenFormTypeField();
    if (hiddenFormTypeField != null) {
      formType=hiddenFormTypeField.getValue();
    }
    for (    FormField formField : dataForm.getFields()) {
      if (formField == hiddenFormTypeField) {
        continue;
      }
      FormField.Type type=formField.getType();
      if (type == FormField.Type.fixed) {
        continue;
      }
      String fieldName=formField.getFieldName();
      register(formType,fieldName,type);
    }
  }
  public static void register(  String formType,  FormField.Type fieldType,  String... fieldNames){
    for (    String fieldName : fieldNames) {
      register(formType,fieldName,fieldType);
    }
  }
  public static void register(  String formType,  String fieldName,  FormField.Type fieldType){
    StringUtils.requireNotNullNorEmpty(fieldName,"fieldName must be provided");
    Objects.requireNonNull(fieldType);
    if (formType == null) {
      if (XmlUtil.isClarkNotation(fieldName)) {
        CLARK_NOTATION_FIELD_REGISTRY.put(fieldName,fieldType);
      }
      return;
    }
    FormField.Type previousType;
synchronized (REGISTRY) {
      Map<String,FormField.Type> fieldNameToType=REGISTRY.get(formType);
      if (fieldNameToType == null) {
        fieldNameToType=new HashMap<>();
        REGISTRY.put(formType,fieldNameToType);
      }
 else {
        previousType=fieldNameToType.get(fieldName);
        if (previousType != null && previousType != fieldType) {
          throw new IllegalArgumentException();
        }
      }
      previousType=fieldNameToType.put(fieldName,fieldType);
    }
    if (previousType != null && fieldType != previousType) {
      LOGGER.warning("Form field registry inconsitency detected: Registered field '" + fieldName + "' of type "+ fieldType+ " but previous type was "+ previousType);
    }
  }
  public static FormField.Type lookup(  String formType,  String fieldName){
    if (formType == null) {
      if (XmlUtil.isClarkNotation(fieldName)) {
        return CLARK_NOTATION_FIELD_REGISTRY.get(fieldName);
      }
      return LOOKASIDE_FIELD_REGISTRY.get(fieldName);
    }
synchronized (REGISTRY) {
      Map<String,FormField.Type> fieldNameToTypeMap=REGISTRY.get(formType);
      if (fieldNameToTypeMap != null) {
        FormField.Type type=fieldNameToTypeMap.get(fieldName);
        if (type != null) {
          return type;
        }
      }
    }
    return null;
  }
  public static synchronized FormField.Type lookup(  String fieldName){
    return lookup(null,fieldName);
  }
  public static void addLookasideFieldRegistryEntry(  String fieldName,  FormField.Type formFieldType){
    LOOKASIDE_FIELD_REGISTRY.put(fieldName,formFieldType);
  }
}

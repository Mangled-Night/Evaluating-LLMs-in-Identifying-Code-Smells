public ModuleEnvironment loadEnvironment(Set<Module> modules,boolean asPrimary){
  Set<Module> finalModules=Sets.newLinkedHashSet(modules);
  finalModules.add(engineModule);
  ModuleEnvironment newEnvironment;
  boolean permissiveSecurityEnabled=Boolean.parseBoolean(System.getProperty(SystemConfig.PERMISSIVE_SECURITY_ENABLED_PROPERTY));
  if (permissiveSecurityEnabled) {
    newEnvironment=new ModuleEnvironment(finalModules,wrappingPermissionProviderFactory);
  }
 else {
    newEnvironment=new ModuleEnvironment(finalModules,permissionProviderFactory);
  }
  if (asPrimary) {
    environment=newEnvironment;
  }
  return newEnvironment;
}

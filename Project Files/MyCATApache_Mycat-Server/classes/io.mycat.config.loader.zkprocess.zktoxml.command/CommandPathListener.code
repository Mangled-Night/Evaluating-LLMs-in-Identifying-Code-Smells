/** 
 * zk命令监听器
 * @author kk
 * @date 2017年1月18日
 * @version 0.0.1
 */
public class CommandPathListener implements PathChildrenCacheListener {
  private static final Logger LOGGER=LoggerFactory.getLogger(CommandPathListener.class);
  @Override public void childEvent(  CuratorFramework client,  PathChildrenCacheEvent event) throws Exception {
switch (event.getType()) {
case CHILD_ADDED:
      String path=event.getData().getPath();
    String basePath=ZKUtils.getZKBasePath() + ZKHandler.ZK_NODE_PATH + "/";
  String node=path.substring(basePath.length());
if (node.equals(ZkConfig.getInstance().getValue(ZkParamCfg.ZK_CFG_MYID))) {
  if (ZKHandler.RELOAD_FROM_ZK.equals(new String(client.getData().forPath(path)))) {
    ZktoXmlMain.ZKLISTENER.notifly(ZkNofiflyCfg.ZK_NOTIFLY_LOAD_ALL.getKey());
    reload(path);
    client.delete().forPath(event.getData().getPath());
    LOGGER.info("CommandPathListener path:" + path + " reload success");
  }
}
break;
case CHILD_UPDATED:
break;
case CHILD_REMOVED:
break;
default :
break;
}
}
public void reload(final String path){
if (!NIOProcessor.backends_old.isEmpty()) {
return;
}
final ReentrantLock lock=MycatServer.getInstance().getConfig().getLock();
lock.lock();
try {
ListenableFuture<Boolean> listenableFuture=MycatServer.getInstance().getListeningExecutorService().submit(new Callable<Boolean>(){
@Override public Boolean call() throws Exception {
return ReloadConfig.reload_all();
}
}
);
Futures.addCallback(listenableFuture,new FutureCallback<Boolean>(){
@Override public void onSuccess(Boolean result){
LOGGER.info("CommandPathListener path:" + path + " reload success");
}
@Override public void onFailure(Throwable t){
LOGGER.error("CommandPathListener path:" + path + " reload error",t);
}
}
,MycatServer.getInstance().getListeningExecutorService());
}
  finally {
lock.unlock();
}
}
}

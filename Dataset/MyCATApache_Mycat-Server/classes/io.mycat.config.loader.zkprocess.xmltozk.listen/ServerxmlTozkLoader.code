/** 
 * 进行从server.xml加载到zk中加载 源文件名：SchemasLoader.java 文件版本：1.0.0 创建作者：liujun 创建日期：2016年9月15日 修改作者：liujun 修改日期：2016年9月15日 文件描述：TODO 版权所有：Copyright 2016 zjhz, Inc. All Rights Reserved.
 */
public class ServerxmlTozkLoader extends ZkMultLoader implements NotiflyService {
  /** 
 * 日志
 * @字段说明 LOGGER
 */
  private static final Logger LOGGER=LoggerFactory.getLogger(ServerxmlTozkLoader.class);
  /** 
 * 当前文件中的zkpath信息 
 * @字段说明 currZkPath
 */
  private final String currZkPath;
  /** 
 * server文件的路径信息
 * @字段说明 SCHEMA_PATH
 */
  private static final String SERVER_PATH=ZookeeperPath.ZK_LOCAL_CFG_PATH.getKey() + "server.xml";
  /** 
 * index_to_charset文件的路径信息
 * @字段说明 SCHEMA_PATH
 */
  private static final String INDEX_TOCHARSET_PATH="index_to_charset.properties";
  /** 
 * server的xml的转换信息
 * @字段说明 parseServerXMl
 */
  private ParseXmlServiceInf<Server> parseServerXMl;
  /** 
 * system信息
 * @字段说明 parseJsonSchema
 */
  private ParseJsonServiceInf<System> parseJsonSystem=new SystemJsonParse();
  /** 
 * system信息
 * @字段说明 parseJsonSchema
 */
  private ParseJsonServiceInf<List<User>> parseJsonUser=new UserJsonParse();
  public ServerxmlTozkLoader(  ZookeeperProcessListen zookeeperListen,  CuratorFramework curator,  XmlProcessBase xmlParseBase){
    this.setCurator(curator);
    String schemaPath=zookeeperListen.getBasePath();
    schemaPath=schemaPath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SERVER.getKey();
    currZkPath=schemaPath;
    zookeeperListen.addListen(schemaPath,this);
    parseServerXMl=new ServerParseXmlImpl(xmlParseBase);
  }
  @Override public boolean notiflyProcess() throws Exception {
    Server server=this.parseServerXMl.parseXmlToBean(SERVER_PATH);
    LOGGER.info("ServerxmlTozkLoader notiflyProcessxml to zk server Object  :" + server);
    this.xmlTozkServerJson(currZkPath,server);
    this.writeClusterNode(currZkPath);
    String charSetValue=readProperties(INDEX_TOCHARSET_PATH);
    this.checkAndwriteString(currZkPath,INDEX_TOCHARSET_PATH,charSetValue);
    LOGGER.info("ServerxmlTozkLoader notiflyProcess xml to zk is success");
    return true;
  }
  /** 
 * 写入集群节点的信息 方法描述
 * @throws Exception
 * @创建日期 2016年9月17日
 */
  private void writeClusterNode(  String basePath) throws Exception {
    String[] zkNodes=ZkConfig.getInstance().getValue(ZkParamCfg.ZK_CFG_CLUSTER_NODES).split(ZkParamCfg.ZK_CFG_CLUSTER_NODES_SEPARATE.getKey());
    if (null != zkNodes && zkNodes.length > 0) {
      for (      String node : zkNodes) {
        String nodePath=ZookeeperPath.ZK_LOCAL_CFG_PATH.getKey() + "server-" + node+ ".xml";
        Server serverNode=this.parseServerXMl.parseXmlToBean(nodePath);
        LOGGER.info("ServerxmlTozkLoader writeClusterNode to zk server Object  :" + serverNode);
        if (null != serverNode) {
          this.xmlTozkClusterNodeJson(basePath,node,serverNode);
          LOGGER.info("ServerxmlTozkLoader writeClusterNode xml to zk is success");
        }
      }
    }
  }
  /** 
 * 将xml文件的信息写入到zk中 方法描述
 * @param basePath 基本路径
 * @param schema schema文件的信息
 * @throws Exception 异常信息
 * @创建日期 2016年9月17日
 */
  private void xmlTozkServerJson(  String basePath,  Server server) throws Exception {
    String defaultSystem=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SERVER_DEFAULT.getKey();
    String defaultSystemValue=this.parseJsonSystem.parseBeanToJson(server.getSystem());
    this.checkAndwriteString(basePath,defaultSystem,defaultSystemValue);
    String userStr=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SERVER_USER.getKey();
    String userValueStr=this.parseJsonUser.parseBeanToJson(server.getUser());
    this.checkAndwriteString(basePath,userStr,userValueStr);
  }
  /** 
 * 将xml文件的信息写入到zk中 方法描述
 * @param basePath 基本路径
 * @param schema schema文件的信息
 * @throws Exception 异常信息
 * @创建日期 2016年9月17日
 */
  private void xmlTozkClusterNodeJson(  String basePath,  String node,  Server server) throws Exception {
    basePath=basePath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SERVER_CLUSTER.getKey();
    String clusterSystemValue=this.parseJsonSystem.parseBeanToJson(server.getSystem());
    this.checkAndwriteString(basePath,node,clusterSystemValue);
  }
  /** 
 * 读取 properties配制文件的信息 方法描述
 * @param name 名称信息
 * @return
 * @创建日期 2016年9月18日
 */
  private String readProperties(  String name){
    String path=ZookeeperPath.ZK_LOCAL_CFG_PATH.getKey() + name;
    InputStream input=SequenceTozkLoader.class.getResourceAsStream(path);
    if (null != input) {
      StringBuilder mapFileStr=new StringBuilder();
      byte[] buffers=new byte[256];
      try {
        int readIndex=-1;
        while ((readIndex=input.read(buffers)) != -1) {
          mapFileStr.append(new String(buffers,0,readIndex));
        }
      }
 catch (      IOException e) {
        e.printStackTrace();
        LOGGER.error("SequenceTozkLoader readMapFile IOException",e);
      }
 finally {
        IOUtils.close(input);
      }
      return mapFileStr.toString();
    }
    return null;
  }
}

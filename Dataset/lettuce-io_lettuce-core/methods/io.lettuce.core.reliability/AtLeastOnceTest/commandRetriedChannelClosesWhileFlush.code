@Test void commandRetriedChannelClosesWhileFlush(){
  assumeTrue(Version.identify().get("netty-transport").artifactVersion().startsWith("4.0.2"));
  StatefulRedisConnection<String,String> connection=client.connect();
  RedisCommands<String,String> sync=connection.sync();
  RedisCommands<String,String> verificationConnection=client.connect().sync();
  RedisChannelWriter channelWriter=ConnectionTestUtil.getChannelWriter(connection);
  sync.set(key,"1");
  assertThat(verificationConnection.get(key)).isEqualTo("1");
  final CountDownLatch block=new CountDownLatch(1);
  ConnectionWatchdog connectionWatchdog=ConnectionTestUtil.getConnectionWatchdog(sync.getStatefulConnection());
  AsyncCommand<String,String,Object> command=getBlockOnEncodeCommand(block);
  channelWriter.write(command);
  connectionWatchdog.setReconnectSuspended(true);
  Channel channel=ConnectionTestUtil.getChannel(sync.getStatefulConnection());
  channel.unsafe().disconnect(channel.newPromise());
  assertThat(channel.isOpen()).isFalse();
  assertThat(command.isCancelled()).isFalse();
  assertThat(command.isDone()).isFalse();
  block.countDown();
  assertThat(command.await(2,TimeUnit.SECONDS)).isFalse();
  connectionWatchdog.setReconnectSuspended(false);
  connectionWatchdog.scheduleReconnect();
  assertThat(command.await(2,TimeUnit.SECONDS)).isTrue();
  assertThat(command.isCancelled()).isFalse();
  assertThat(command.isDone()).isTrue();
  assertThat(verificationConnection.get(key)).isEqualTo("2");
  assertThat(ConnectionTestUtil.getStack(sync.getStatefulConnection())).isEmpty();
  assertThat(ConnectionTestUtil.getCommandBuffer(sync.getStatefulConnection())).isEmpty();
  sync.getStatefulConnection().close();
  verificationConnection.getStatefulConnection().close();
}

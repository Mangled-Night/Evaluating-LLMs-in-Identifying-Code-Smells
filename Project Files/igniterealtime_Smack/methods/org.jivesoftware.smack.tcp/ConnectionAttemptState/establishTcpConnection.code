StateTransitionResult.Failure establishTcpConnection() throws InterruptedException {
  RemoteConnectionEndpoint.InetSocketAddressCoupling<Rfc6120TcpRemoteConnectionEndpoint> address=nextAddress();
  establishTcpConnection(address);
synchronized (this) {
    while (!connected && connectionException == null) {
      final long now=System.currentTimeMillis();
      if (now >= deadline) {
        return new StateTransitionResult.FailureCausedByTimeout("Timeout waiting to establish connection");
      }
      wait(deadline - now);
    }
  }
  if (connected) {
    assert connectionException == null;
    return null;
  }
  return new StateTransitionResult.FailureCausedByException<Exception>(connectionException);
}
private void establishTcpConnection(RemoteConnectionEndpoint.InetSocketAddressCoupling<Rfc6120TcpRemoteConnectionEndpoint> address){
  TcpHostEvent.ConnectingToHostEvent connectingToHostEvent=new TcpHostEvent.ConnectingToHostEvent(establishingTcpConnectionState,address);
  connectionInternal.invokeConnectionStateMachineListener(connectingToHostEvent);
  final InetSocketAddress inetSocketAddress=address.getInetSocketAddress();
  deadline=System.currentTimeMillis() + connectionInternal.connection.getReplyTimeout();
  try {
    connected=socketChannel.connect(inetSocketAddress);
  }
 catch (  IOException e) {
    onIOExceptionWhenEstablishingTcpConnection(e,address);
    return;
  }
  if (connected) {
    TcpHostEvent.ConnectedToHostEvent connectedToHostEvent=new TcpHostEvent.ConnectedToHostEvent(establishingTcpConnectionState,address,true);
    connectionInternal.invokeConnectionStateMachineListener(connectedToHostEvent);
synchronized (this) {
      notifyAll();
    }
    return;
  }
  try {
    connectionInternal.registerWithSelector(socketChannel,SelectionKey.OP_CONNECT,(selectedChannel,selectedSelectionKey) -> {
      SocketChannel selectedSocketChannel=(SocketChannel)selectedChannel;
      boolean finishConnected;
      try {
        finishConnected=selectedSocketChannel.finishConnect();
      }
 catch (      IOException e) {
        Async.go(() -> onIOExceptionWhenEstablishingTcpConnection(e,address));
        return;
      }
      if (!finishConnected) {
        Async.go(() -> onIOExceptionWhenEstablishingTcpConnection(new IOException("finishConnect() failed"),address));
        return;
      }
      TcpHostEvent.ConnectedToHostEvent connectedToHostEvent=new TcpHostEvent.ConnectedToHostEvent(establishingTcpConnectionState,address,false);
      connectionInternal.invokeConnectionStateMachineListener(connectedToHostEvent);
      connected=true;
synchronized (ConnectionAttemptState.this) {
        notifyAll();
      }
    }
);
  }
 catch (  ClosedChannelException e) {
    onIOExceptionWhenEstablishingTcpConnection(e,address);
  }
}

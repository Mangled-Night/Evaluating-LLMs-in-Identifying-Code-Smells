/** 
 * 申请售后
 * @param userId   用户ID
 * @param aftersale 用户售后信息
 * @return 操作结果
 */
@PostMapping("submit") public Object submit(@LoginUser Integer userId,@RequestBody LitemallAftersale aftersale){
  if (userId == null) {
    return ResponseUtil.unlogin();
  }
  Object error=validate(aftersale);
  if (error != null) {
    return error;
  }
  Integer orderId=aftersale.getOrderId();
  if (orderId == null) {
    return ResponseUtil.badArgument();
  }
  LitemallOrder order=orderService.findById(userId,orderId);
  if (order == null) {
    return ResponseUtil.badArgumentValue();
  }
  if (!OrderUtil.isConfirmStatus(order) && !OrderUtil.isAutoConfirmStatus(order)) {
    return ResponseUtil.fail(WxResponseCode.AFTERSALE_UNALLOWED,"不能申请售后");
  }
  BigDecimal amount=order.getActualPrice().subtract(order.getFreightPrice());
  if (aftersale.getAmount().compareTo(amount) > 0) {
    return ResponseUtil.fail(WxResponseCode.AFTERSALE_INVALID_AMOUNT,"退款金额不正确");
  }
  Short afterStatus=order.getAftersaleStatus();
  if (afterStatus.equals(AftersaleConstant.STATUS_RECEPT) || afterStatus.equals(AftersaleConstant.STATUS_REFUND)) {
    return ResponseUtil.fail(WxResponseCode.AFTERSALE_INVALID_AMOUNT,"已申请售后");
  }
  aftersaleService.deleteByOrderId(userId,orderId);
  aftersale.setStatus(AftersaleConstant.STATUS_REQUEST);
  aftersale.setAftersaleSn(aftersaleService.generateAftersaleSn(userId));
  aftersale.setUserId(userId);
  aftersaleService.add(aftersale);
  orderService.updateAftersaleStatus(orderId,AftersaleConstant.STATUS_REQUEST);
  return ResponseUtil.ok();
}

/** 
 * Invoking  {@link Socks5BytestreamManager#establishSession(org.jxmpp.jid.Jid,String)} should fail if thetarget does not accept a SOCKS5 Bytestream. See <a href="http://xmpp.org/extensions/xep-0065.html#usecase-alternate">XEP-0065 Section 5.2 A2</a>
 * @throws InterruptedException if the calling thread was interrupted.
 * @throws SmackException if Smack detected an exceptional situation.
 * @throws XMPPException if an XMPP protocol error was received.
 * @throws IOException if an I/O error occurred.
 */
@Test public void shouldFailIfTargetDoesNotAcceptSocks5Bytestream() throws SmackException, InterruptedException, IOException, XMPPException {
  final Protocol protocol=new Protocol();
  final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,initiatorJID);
  final String sessionID="session_id_shouldFailIfTargetDoesNotAcceptSocks5Bytestream";
  Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
  byteStreamManager.setAnnounceLocalStreamHost(false);
  DiscoverInfoBuilder discoverInfo=Socks5PacketUtils.createDiscoverInfo(targetJID,initiatorJID);
  discoverInfo.addFeature(Bytestream.NAMESPACE);
  protocol.addResponse(discoverInfo.build(),Verification.correspondingSenderReceiver,Verification.requestTypeGET);
  DiscoverItems discoverItems=Socks5PacketUtils.createDiscoverItems(xmppServer,initiatorJID);
  Item item=new Item(proxyJID);
  discoverItems.addItem(item);
  protocol.addResponse(discoverItems,Verification.correspondingSenderReceiver,Verification.requestTypeGET);
  DiscoverInfoBuilder proxyInfo=Socks5PacketUtils.createDiscoverInfo(proxyJID,initiatorJID);
  Identity identity=new Identity("proxy",proxyJID.toString(),"bytestreams");
  proxyInfo.addIdentity(identity);
  protocol.addResponse(proxyInfo.build(),Verification.correspondingSenderReceiver,Verification.requestTypeGET);
  Bytestream streamHostInfo=Socks5PacketUtils.createBytestreamResponse(proxyJID,initiatorJID);
  streamHostInfo.addStreamHost(proxyJID,proxyAddress,7778);
  protocol.addResponse(streamHostInfo,Verification.correspondingSenderReceiver,Verification.requestTypeGET);
  StanzaError stanzaError=StanzaError.getBuilder(StanzaError.Condition.not_acceptable).build();
  IQ rejectPacket=new ErrorIQ(stanzaError);
  rejectPacket.setFrom(targetJID);
  rejectPacket.setTo(initiatorJID);
  protocol.addResponse(rejectPacket,Verification.correspondingSenderReceiver,Verification.requestTypeSET);
  XMPPErrorException e=assertThrows(XMPPErrorException.class,() -> {
    byteStreamManager.establishSession(targetJID,sessionID);
  }
);
  protocol.verifyAll();
  assertEquals(rejectPacket.getError(),e.getStanzaError());
}

/** 
 * System to render registered BlockSelections. <br><br> This system is not currently thread-safe.
 */
@RegisterSystem(RegisterMode.CLIENT) public class BlockSelectionRenderSystem extends BaseComponentSystem implements RenderSystem {
  @In private EntityManager entityManager;
  /** 
 * This map will contain one reusable selection renderer per texture width/height pair. This should be a reasonable compromise between no caching and caching too many renderers. While it is possible that the number of cached renderers could grow out of control over time, in practice most textures should be a standard size.
 */
  private Map<Vector2i,BlockSelectionRenderer> cachedBlockSelectionRendererByTextureDimensionsMap=new HashMap<>();
  @Override public void renderOverlay(){
    for (    EntityRef entity : entityManager.getEntitiesWith(BlockSelectionComponent.class)) {
      BlockSelectionComponent blockSelectionComponent=entity.getComponent(BlockSelectionComponent.class);
      if (blockSelectionComponent.shouldRender) {
        Texture texture=blockSelectionComponent.texture;
        if (null == texture) {
          texture=Assets.getTexture("engine:selection").get();
        }
        Vector2i textureDimensions=new Vector2i(texture.getWidth(),texture.getHeight());
        BlockSelectionRenderer selectionRenderer=cachedBlockSelectionRendererByTextureDimensionsMap.get(textureDimensions);
        if (null == selectionRenderer) {
          selectionRenderer=new BlockSelectionRenderer(texture);
          cachedBlockSelectionRendererByTextureDimensionsMap.put(textureDimensions,selectionRenderer);
        }
 else {
          selectionRenderer.setEffectsTexture(texture);
        }
        renderOverlayForOneBlockSelection(blockSelectionComponent,selectionRenderer);
      }
    }
  }
  private void renderOverlayForOneBlockSelection(  BlockSelectionComponent blockSelectionComponent,  BlockSelectionRenderer selectionRenderer){
    selectionRenderer.beginRenderOverlay();
    if (blockSelectionComponent.currentSelection == null) {
      if (blockSelectionComponent.startPosition != null) {
        selectionRenderer.renderMark(blockSelectionComponent.startPosition);
      }
    }
 else {
      for (      Vector3ic pos : blockSelectionComponent.currentSelection) {
        selectionRenderer.renderMark(pos);
      }
    }
    selectionRenderer.endRenderOverlay();
  }
}

/** 
 * Downloads module meta-info from a given URL.
 */
public class ModuleListDownloader implements Callable<ModuleRegistry> {
  private static final Logger logger=LoggerFactory.getLogger(ModuleListDownloader.class);
  private final ModuleMetadataJsonAdapter metaReader=new ModuleMetadataJsonAdapter();
  private final String serverAddress;
  private final Gson gson=new Gson();
  ModuleListDownloader(  String serverAddress){
    this.serverAddress=serverAddress;
    for (    RemoteModuleExtension ext : RemoteModuleExtension.values()) {
      metaReader.registerExtension(ext.getKey(),ext.getValueType());
    }
  }
  @Override public ModuleRegistry call() throws IOException {
    logger.info("Downloading modules ..");
    TableModuleRegistry modules=new TableModuleRegistry();
    URL url=new URL("http",serverAddress,"/modules/list/latest");
    try (InputStreamReader reader=new InputStreamReader(url.openStream(),TerasologyConstants.CHARSET)){
      logger.info("Parsing content ..");
      JsonArray jsonArray=gson.fromJson(reader,JsonArray.class);
      for (      JsonElement jObject : jsonArray) {
        String json=gson.toJson(jObject);
        ModuleMetadata meta=metaReader.read(new StringReader(json));
        logger.debug("Read module {} - {}",meta.getId(),meta.getVersion());
        modules.add(new Module(meta,new EmptyFileSource(),Collections.emptyList(),new Reflections(),(c) -> false));
      }
      int count=modules.size();
      logger.info(String.format("Retrieved %d %s",count,(count == 1) ? "entry" : "entries"));
    }
     return modules;
  }
}

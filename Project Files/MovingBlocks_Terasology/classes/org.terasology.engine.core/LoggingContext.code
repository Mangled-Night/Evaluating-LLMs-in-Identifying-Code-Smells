/** 
 * Configures the underlying logback logging framework.
 */
public final class LoggingContext {
  /** 
 * The identifier for the initialization phase
 */
  public static final String INIT_PHASE="init";
  /** 
 * The identifier for the menu phase
 */
  public static final String MENU="menu";
  /** 
 * The variable name for the discriminator in the sifting appender
 */
  private static final String PHASE_KEY="phase";
  /** 
 * The variable name for the log file root folder as defined in logback.xml
 */
  private static final String LOG_FILE_FOLDER="logFileFolder";
  /** 
 * The format of the log folder timestamps
 */
  private static final DateFormat TIMESTAMP_FORMAT=new SimpleDateFormat("yyyy-MM-dd_HH-mm-ss");
  private static Path loggingPath=Paths.get(".");
  private LoggingContext(){
  }
  public static void initialize(  Path logFileFolder){
    TerasologyVersion terasologyVersion=TerasologyVersion.getInstance();
    String logFileDir=TIMESTAMP_FORMAT.format(new Date());
    if (!terasologyVersion.getengineVersion().equals("")) {
      logFileDir+="_" + terasologyVersion.getengineVersion();
    }
    if (!terasologyVersion.getBuildNumber().equals("")) {
      logFileDir+="_" + terasologyVersion.getBuildNumber();
    }
    loggingPath=logFileFolder.resolve(logFileDir).normalize();
    String pathString=loggingPath.toString();
    System.setProperty(LOG_FILE_FOLDER,pathString);
    try {
      deleteLogFiles(logFileFolder,Duration.ofDays(5).getSeconds());
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
  }
  public static Path getLoggingPath(){
    return loggingPath;
  }
  private static void deleteLogFiles(  final Path rootPath,  final long maxAgeInSecs) throws IOException {
    Files.walkFileTree(rootPath,new SimpleFileVisitor<Path>(){
      @Override public FileVisitResult preVisitDirectory(      Path path,      BasicFileAttributes attrs){
        if (path.equals(rootPath)) {
          return FileVisitResult.CONTINUE;
        }
        String relPath=rootPath.relativize(path).getName(0).toString();
        try {
          Date folderDate=TIMESTAMP_FORMAT.parse(relPath);
          long ageInSecs=folderDate.toInstant().until(Instant.now(),ChronoUnit.SECONDS);
          return ageInSecs > maxAgeInSecs ? FileVisitResult.CONTINUE : FileVisitResult.SKIP_SUBTREE;
        }
 catch (        ParseException e) {
          return FileVisitResult.SKIP_SUBTREE;
        }
      }
      @Override public FileVisitResult visitFile(      Path file,      BasicFileAttributes attrs){
        if (file.toString().endsWith(".log")) {
          try {
            Files.delete(file);
          }
 catch (          IOException e) {
            System.err.println("Could not delete log file: " + file);
          }
        }
        return FileVisitResult.CONTINUE;
      }
      @Override public FileVisitResult postVisitDirectory(      Path path,      IOException exc){
        if (path.toFile().list().length == 0) {
          try {
            Files.delete(path);
          }
 catch (          IOException e) {
            System.err.println("Could not delete empty folder: " + path);
          }
        }
        return FileVisitResult.CONTINUE;
      }
    }
);
  }
  public static void setGameState(  GameState state){
    String phase=state.getLoggingPhase();
    phase=phase.replaceAll("\\s","_");
    MDC.put(PHASE_KEY,phase);
  }
}

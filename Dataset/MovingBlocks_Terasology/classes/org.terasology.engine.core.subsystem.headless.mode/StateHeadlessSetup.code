/** 
 * The class is game selection menu replacement for the headless server.
 */
public class StateHeadlessSetup extends AbstractState {
  private static final Logger logger=LoggerFactory.getLogger(StateHeadlessSetup.class);
  protected boolean strictModuleRequirements;
  private final NetworkMode networkMode;
  public StateHeadlessSetup(){
    this(NetworkMode.LISTEN_SERVER);
  }
  public StateHeadlessSetup(  NetworkMode networkMode){
    this.networkMode=networkMode;
  }
  @Override public void init(  GameEngine gameEngine){
    context=gameEngine.createChildContext();
    initEntityAndComponentManagers(true);
    createLocalPlayer(context);
    GameManifest gameManifest;
    List<GameInfo> savedGames=GameProvider.getSavedGames();
    if (savedGames.size() > 0) {
      gameManifest=savedGames.get(0).getManifest();
    }
 else {
      gameManifest=createGameManifest();
    }
    Config config=context.get(Config.class);
    WorldInfo worldInfo=gameManifest.getWorldInfo(TerasologyConstants.MAIN_WORLD);
    config.getUniverseConfig().addWorldManager(worldInfo);
    config.getUniverseConfig().setSpawnWorldTitle(worldInfo.getTitle());
    config.getUniverseConfig().setUniverseSeed(gameManifest.getSeed());
    gameEngine.changeState(new StateLoading(gameManifest,networkMode));
  }
  public GameManifest createGameManifest(){
    GameManifest gameManifest=new GameManifest();
    Config config=context.get(Config.class);
    ModuleManager moduleManager=context.get(ModuleManager.class);
    for (    Name moduleName : config.getDefaultModSelection().listModules()) {
      Module module=moduleManager.getRegistry().getLatestModuleVersion(moduleName);
      if (module != null) {
        gameManifest.addModule(module.getId(),module.getVersion());
      }
 else       if (strictModuleRequirements) {
        throw new RuntimeException("ModuleRegistry has no latest version for module " + moduleName);
      }
 else {
        logger.warn("ModuleRegistry has no latest version for module {}",moduleName);
      }
    }
    WorldGenerationConfig worldGenConfig=config.getWorldGeneration();
    if (!worldGenConfig.getDefaultGenerator().isValid()) {
      for (      Name moduleName : config.getDefaultModSelection().listModules()) {
        Module module=moduleManager.getRegistry().getLatestModuleVersion(moduleName);
        if (StandardModuleExtension.isGameplayModule(module)) {
          SimpleUri defaultWorldGenerator=StandardModuleExtension.getDefaultWorldGenerator(module);
          worldGenConfig.setDefaultGenerator(defaultWorldGenerator);
          break;
        }
      }
    }
    SimpleUri worldGeneratorUri=worldGenConfig.getDefaultGenerator();
    gameManifest.setTitle(worldGenConfig.getWorldTitle());
    gameManifest.setSeed(worldGenConfig.getDefaultSeed());
    WorldInfo worldInfo=new WorldInfo(TerasologyConstants.MAIN_WORLD,worldGenConfig.getWorldTitle(),gameManifest.getSeed(),(long)(WorldTime.DAY_LENGTH * WorldTime.NOON_OFFSET),worldGeneratorUri);
    gameManifest.addWorld(worldInfo);
    return gameManifest;
  }
  @Override public void handleInput(  float delta){
  }
  @Override public void update(  float delta){
    eventSystem.process();
  }
  @Override public void render(){
  }
  @Override public boolean isHibernationAllowed(){
    return true;
  }
  @Override public String getLoggingPhase(){
    return LoggingContext.INIT_PHASE;
  }
}

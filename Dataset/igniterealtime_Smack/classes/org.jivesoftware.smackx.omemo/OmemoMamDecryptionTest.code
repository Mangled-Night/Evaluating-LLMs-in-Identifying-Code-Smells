/** 
 * This test sends a message from Alice to Bob, while Bob has automatic decryption disabled. Then Bob fetches his Mam archive and decrypts the result.
 */
public class OmemoMamDecryptionTest extends AbstractTwoUsersOmemoIntegrationTest {
  public OmemoMamDecryptionTest(  SmackIntegrationTestEnvironment environment) throws XMPPException.XMPPErrorException, SmackException.NotConnectedException, InterruptedException, SmackException.NoResponseException, TestNotPossibleException {
    super(environment);
    MamManager bobsMamManager=MamManager.getInstanceFor(conTwo);
    if (!bobsMamManager.isSupported()) {
      throw new TestNotPossibleException("Test is not possible, because MAM is not supported on the server.");
    }
  }
  @SmackIntegrationTest public void mamDecryptionTest() throws XMPPException.XMPPErrorException, SmackException.NotLoggedInException, SmackException.NotConnectedException, InterruptedException, SmackException.NoResponseException, CryptoFailedException, UndecidedOmemoIdentityException, IOException {
    MamManager bobsMamManager=MamManager.getInstanceFor(bob.getConnection());
    bobsMamManager.enableMamForAllMessages();
    bobsMamManager.setDefaultBehavior(MamPrefsIQ.DefaultBehavior.always);
    bob.stopStanzaAndPEPListeners();
    String body="This message will be stored in MAM!";
    OmemoMessage.Sent encrypted=alice.encrypt(bob.getOwnJid(),body);
    XMPPConnection alicesConnection=alice.getConnection();
    MessageBuilder messageBuilder=alicesConnection.getStanzaFactory().buildMessageStanza();
    alicesConnection.sendStanza(encrypted.buildMessage(messageBuilder,bob.getOwnJid()));
    MamManager.MamQuery query=bobsMamManager.queryArchive(MamManager.MamQueryArgs.builder().limitResultsToJid(alice.getOwnJid()).build());
    assertEquals(1,query.getMessageCount());
    List<MessageOrOmemoMessage> decryptedMamQuery=bob.decryptMamQueryResult(query);
    assertEquals(1,decryptedMamQuery.size());
    assertEquals(body,decryptedMamQuery.get(decryptedMamQuery.size() - 1).getOmemoMessage().getBody());
  }
}

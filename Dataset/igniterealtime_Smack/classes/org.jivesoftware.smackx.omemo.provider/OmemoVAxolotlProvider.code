/** 
 * Smack ExtensionProvider that parses incoming OMEMO Message element into OmemoMessageElement objects.
 * @author Paul Schaub
 */
public class OmemoVAxolotlProvider extends ExtensionElementProvider<OmemoElement_VAxolotl> {
  @Override public OmemoElement_VAxolotl parse(  XmlPullParser parser,  int initialDepth,  XmlEnvironment xmlEnvironment) throws XmlPullParserException, IOException {
    int sid=-1;
    ArrayList<OmemoKeyElement> keys=new ArrayList<>();
    byte[] iv=null;
    byte[] payload=null;
    outerloop:     while (true) {
      XmlPullParser.Event tag=parser.next();
switch (tag) {
case START_ELEMENT:
        String name=parser.getName();
switch (name) {
case OmemoHeaderElement.ELEMENT:
        for (int i=0; i < parser.getAttributeCount(); i++) {
          if (parser.getAttributeName(i).equals(OmemoHeaderElement.ATTR_SID)) {
            sid=Integer.parseInt(parser.getAttributeValue(i));
          }
        }
      break;
case OmemoKeyElement.ELEMENT:
    boolean prekey=false;
  int rid=-1;
for (int i=0; i < parser.getAttributeCount(); i++) {
  if (parser.getAttributeName(i).equals(OmemoKeyElement.ATTR_PREKEY)) {
    prekey=Boolean.parseBoolean(parser.getAttributeValue(i));
  }
 else   if (parser.getAttributeName(i).equals(OmemoKeyElement.ATTR_RID)) {
    rid=Integer.parseInt(parser.getAttributeValue(i));
  }
}
keys.add(new OmemoKeyElement(Base64.decode(parser.nextText()),rid,prekey));
break;
case OmemoHeaderElement.ATTR_IV:
iv=Base64.decode(parser.nextText());
break;
case ATTR_PAYLOAD:
payload=Base64.decode(parser.nextText());
break;
}
break;
case END_ELEMENT:
if (parser.getDepth() == initialDepth) {
break outerloop;
}
break;
default :
break;
}
}
OmemoHeaderElement_VAxolotl header=new OmemoHeaderElement_VAxolotl(sid,keys,iv);
return new OmemoElement_VAxolotl(header,payload);
}
}

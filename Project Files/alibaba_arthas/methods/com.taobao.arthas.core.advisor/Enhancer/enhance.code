/** 
 * 对象增强
 * @param inst              inst
 * @param adviceId          通知ID
 * @param isTracing         可跟踪方法调用
 * @param skipJDKTrace      是否忽略对JDK内部方法的跟踪
 * @param classNameMatcher  类名匹配
 * @param methodNameMatcher 方法名匹配
 * @return 增强影响范围
 * @throws UnmodifiableClassException 增强失败
 */
public synchronized EnhancerAffect enhance(final Instrumentation inst) throws UnmodifiableClassException {
  this.matchingClasses=GlobalOptions.isDisableSubClass ? SearchUtils.searchClass(inst,classNameMatcher) : SearchUtils.searchSubClass(inst,SearchUtils.searchClass(inst,classNameMatcher));
  List<Pair<Class<?>,String>> filtedList=filter(matchingClasses);
  if (!filtedList.isEmpty()) {
    for (    Pair<Class<?>,String> filted : filtedList) {
      logger.info("ignore class: {}, reason: {}",filted.getFirst().getName(),filted.getSecond());
    }
  }
  logger.info("enhance matched classes: {}",matchingClasses);
  affect.setTransformer(this);
  try {
    ArthasBootstrap.getInstance().getTransformerManager().addTransformer(this,isTracing);
    if (GlobalOptions.isBatchReTransform) {
      final int size=matchingClasses.size();
      final Class<?>[] classArray=new Class<?>[size];
      arraycopy(matchingClasses.toArray(),0,classArray,0,size);
      if (classArray.length > 0) {
        inst.retransformClasses(classArray);
        logger.info("Success to batch transform classes: " + Arrays.toString(classArray));
      }
    }
 else {
      for (      Class<?> clazz : matchingClasses) {
        try {
          inst.retransformClasses(clazz);
          logger.info("Success to transform class: " + clazz);
        }
 catch (        Throwable t) {
          logger.warn("retransform {} failed.",clazz,t);
          if (t instanceof UnmodifiableClassException) {
            throw (UnmodifiableClassException)t;
          }
 else           if (t instanceof RuntimeException) {
            throw (RuntimeException)t;
          }
 else {
            throw new RuntimeException(t);
          }
        }
      }
    }
  }
 catch (  Throwable e) {
    logger.error("Enhancer error, matchingClasses: {}",matchingClasses,e);
    affect.setThrowable(e);
  }
  return affect;
}
private static void enhance(Instrumentation inst,Set<Class<?>> classes) throws UnmodifiableClassException {
  int size=classes.size();
  Class<?>[] classArray=new Class<?>[size];
  arraycopy(classes.toArray(),0,classArray,0,size);
  if (classArray.length > 0) {
    inst.retransformClasses(classArray);
  }
}

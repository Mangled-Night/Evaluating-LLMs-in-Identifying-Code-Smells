/** 
 * A pipeline that requests  {@link org.terasology.engine.network.ServerInfoMessage} before it auto-disconnects. This is similarto  {@link TerasologyClientPipelineFactory}.
 */
public class InfoRequestPipelineFactory extends ChannelInitializer<Channel> {
  private final Context parentContext;
  public InfoRequestPipelineFactory(  Context parentContext){
    this.parentContext=parentContext;
  }
  @Override protected void initChannel(  Channel ch){
    var context=new ContextImpl(parentContext);
    context.put(JoinStatusImpl.class,new JoinStatusImpl());
    ChannelPipeline p=ch.pipeline();
    p.addLast(MetricRecordingHandler.NAME,new MetricRecordingHandler());
    p.addLast("inflateDecoder",new Lz4FrameDecoder());
    p.addLast("lengthFrameDecoder",new LengthFieldBasedFrameDecoder(8388608,0,3,0,3));
    p.addLast("protobufDecoder",new ProtobufDecoder(NetData.NetMessage.getDefaultInstance()));
    p.addLast("deflateEncoder",new Lz4FrameEncoder(true));
    p.addLast("frameLengthEncoder",new LengthFieldPrepender(3));
    p.addLast("protobufEncoder",new ProtobufEncoder());
    p.addLast("authenticationHandler",createWithConstructorInjection(ClientHandshakeHandler.class,context));
    p.addLast("connectionHandler",new ServerInfoRequestHandler());
  }
}

/** 
 * @author beiwei30 on 29/11/2016.
 */
public abstract class EnhancerCommand extends AnnotatedCommand {
  private static final Logger logger=LoggerFactory.getLogger(EnhancerCommand.class);
  protected static final List<String> EMPTY=Collections.emptyList();
  public static final String[] EXPRESS_EXAMPLES={"params","returnObj","throwExp","target","clazz","method","{params,returnObj}","params[0]"};
  private String excludeClassPattern;
  protected Matcher classNameMatcher;
  protected Matcher classNameExcludeMatcher;
  protected Matcher methodNameMatcher;
  protected long listenerId;
  protected boolean verbose;
  @Option(longName="exclude-class-pattern") @Description("exclude class name pattern, use either '.' or '/' as separator") public void setExcludeClassPattern(  String excludeClassPattern){
    this.excludeClassPattern=excludeClassPattern;
  }
  @Option(longName="listenerId") @Description("The special listenerId") public void setListenerId(  long listenerId){
    this.listenerId=listenerId;
  }
  @Option(shortName="v",longName="verbose",flag=true) @Description("Enables print verbose information, default value false.") public void setVerbosee(  boolean verbose){
    this.verbose=verbose;
  }
  /** 
 * 类名匹配
 * @return 获取类名匹配
 */
  protected abstract Matcher getClassNameMatcher();
  /** 
 * 排除类名匹配
 */
  protected abstract Matcher getClassNameExcludeMatcher();
  /** 
 * 方法名匹配
 * @return 获取方法名匹配
 */
  protected abstract Matcher getMethodNameMatcher();
  /** 
 * 获取监听器
 * @return 返回监听器
 */
  protected abstract AdviceListener getAdviceListener(  CommandProcess process);
  AdviceListener getAdviceListenerWithId(  CommandProcess process){
    if (listenerId != 0) {
      AdviceListener listener=AdviceWeaver.listener(listenerId);
      if (listener != null) {
        return listener;
      }
    }
    return getAdviceListener(process);
  }
  @Override public void process(  final CommandProcess process){
    process.interruptHandler(new CommandInterruptHandler(process));
    process.stdinHandler(new QExitHandler(process));
    enhance(process);
  }
  @Override public void complete(  Completion completion){
    int argumentIndex=CompletionUtils.detectArgumentIndex(completion);
    if (argumentIndex == 1) {
      if (!CompletionUtils.completeClassName(completion)) {
        super.complete(completion);
      }
      return;
    }
 else     if (argumentIndex == 2) {
      if (!CompletionUtils.completeMethodName(completion)) {
        super.complete(completion);
      }
      return;
    }
 else     if (argumentIndex == 3) {
      completeArgument3(completion);
      return;
    }
    super.complete(completion);
  }
  protected void enhance(  CommandProcess process){
    Session session=process.session();
    if (!session.tryLock()) {
      String msg="someone else is enhancing classes, pls. wait.";
      process.appendResult(new EnhancerModel(null,false,msg));
      process.end(-1,msg);
      return;
    }
    EnhancerAffect effect=null;
    int lock=session.getLock();
    try {
      Instrumentation inst=session.getInstrumentation();
      AdviceListener listener=getAdviceListenerWithId(process);
      if (listener == null) {
        logger.error("advice listener is null");
        String msg="advice listener is null, check arthas log";
        process.appendResult(new EnhancerModel(effect,false,msg));
        process.end(-1,msg);
        return;
      }
      boolean skipJDKTrace=false;
      if (listener instanceof AbstractTraceAdviceListener) {
        skipJDKTrace=((AbstractTraceAdviceListener)listener).getCommand().isSkipJDKTrace();
      }
      Enhancer enhancer=new Enhancer(listener,listener instanceof InvokeTraceable,skipJDKTrace,getClassNameMatcher(),getClassNameExcludeMatcher(),getMethodNameMatcher());
      process.register(listener,enhancer);
      effect=enhancer.enhance(inst);
      if (effect.getThrowable() != null) {
        String msg="error happens when enhancing class: " + effect.getThrowable().getMessage();
        process.appendResult(new EnhancerModel(effect,false,msg));
        process.end(1,msg + ", check arthas log: " + LogUtil.loggingFile());
        return;
      }
      if (effect.cCnt() == 0 || effect.mCnt() == 0) {
        process.appendResult(new EnhancerModel(effect,false,"No class or method is affected"));
        String smCommand=Ansi.ansi().fg(Ansi.Color.GREEN).a("sm CLASS_NAME METHOD_NAME").reset().toString();
        String optionsCommand=Ansi.ansi().fg(Ansi.Color.GREEN).a("options unsafe true").reset().toString();
        String javaPackage=Ansi.ansi().fg(Ansi.Color.GREEN).a("java.*").reset().toString();
        String resetCommand=Ansi.ansi().fg(Ansi.Color.GREEN).a("reset CLASS_NAME").reset().toString();
        String logStr=Ansi.ansi().fg(Ansi.Color.GREEN).a(LogUtil.loggingFile()).reset().toString();
        String issueStr=Ansi.ansi().fg(Ansi.Color.GREEN).a("https://github.com/alibaba/arthas/issues/47").reset().toString();
        String msg="No class or method is affected, try:\n" + "1. Execute `" + smCommand + "` to make sure the method you are tracing actually exists (it might be in your parent class).\n"+ "2. Execute `"+ optionsCommand+ "`, if you want to enhance the classes under the `"+ javaPackage+ "` package.\n"+ "3. Execute `"+ resetCommand+ "` and try again, your method body might be too large.\n"+ "4. Match the constructor, use `<init>`, for example: `watch demo.MathGame <init>`\n"+ "5. Check arthas log: "+ logStr+ "\n"+ "6. Visit "+ issueStr+ " for more details.";
        process.end(-1,msg);
        return;
      }
      if (session.getLock() == lock) {
        if (process.isForeground()) {
          process.echoTips(Constants.Q_OR_CTRL_C_ABORT_MSG + "\n");
        }
      }
      process.appendResult(new EnhancerModel(effect,true));
    }
 catch (    Throwable e) {
      String msg="error happens when enhancing class: " + e.getMessage();
      logger.error(msg,e);
      process.appendResult(new EnhancerModel(effect,false,msg));
      process.end(-1,msg);
    }
 finally {
      if (session.getLock() == lock) {
        process.session().unLock();
      }
    }
  }
  protected void completeArgument3(  Completion completion){
    super.complete(completion);
  }
  public String getExcludeClassPattern(){
    return excludeClassPattern;
  }
}

@RestController @RequestMapping("/admin/aftersale") @Validated public class AdminAftersaleController {
  private final Log logger=LogFactory.getLog(AdminAftersaleController.class);
  @Autowired private LitemallAftersaleService aftersaleService;
  @Autowired private LitemallOrderService orderService;
  @Autowired private LitemallOrderGoodsService orderGoodsService;
  @Autowired private LitemallGoodsProductService goodsProductService;
  @Autowired private LogHelper logHelper;
  @Autowired private WxPayService wxPayService;
  @Autowired private NotifyService notifyService;
  @RequiresPermissions("admin:aftersale:list") @RequiresPermissionsDesc(menu={"商城管理","售后管理"},button="查询") @GetMapping("/list") public Object list(  Integer orderId,  String aftersaleSn,  Short status,  @RequestParam(defaultValue="1") Integer page,  @RequestParam(defaultValue="10") Integer limit,  @Sort @RequestParam(defaultValue="add_time") String sort,  @Order @RequestParam(defaultValue="desc") String order){
    List<LitemallAftersale> aftersaleList=aftersaleService.querySelective(orderId,aftersaleSn,status,page,limit,sort,order);
    return ResponseUtil.okList(aftersaleList);
  }
  @RequiresPermissions("admin:aftersale:recept") @RequiresPermissionsDesc(menu={"商城管理","售后管理"},button="审核通过") @PostMapping("/recept") public Object recept(  @RequestBody LitemallAftersale aftersale){
    Integer id=aftersale.getId();
    LitemallAftersale aftersaleOne=aftersaleService.findById(id);
    if (aftersaleOne == null) {
      return ResponseUtil.fail(AdminResponseCode.AFTERSALE_NOT_ALLOWED,"售后不存在");
    }
    Short status=aftersaleOne.getStatus();
    if (!status.equals(AftersaleConstant.STATUS_REQUEST)) {
      return ResponseUtil.fail(AdminResponseCode.AFTERSALE_NOT_ALLOWED,"售后不能进行审核通过操作");
    }
    aftersaleOne.setStatus(AftersaleConstant.STATUS_RECEPT);
    aftersaleOne.setHandleTime(LocalDateTime.now());
    aftersaleService.updateById(aftersaleOne);
    orderService.updateAftersaleStatus(aftersaleOne.getOrderId(),AftersaleConstant.STATUS_RECEPT);
    return ResponseUtil.ok();
  }
  @RequiresPermissions("admin:aftersale:batch-recept") @RequiresPermissionsDesc(menu={"商城管理","售后管理"},button="批量通过") @PostMapping("/batch-recept") public Object batchRecept(  @RequestBody String body){
    List<Integer> ids=JacksonUtil.parseIntegerList(body,"ids");
    for (    Integer id : ids) {
      LitemallAftersale aftersale=aftersaleService.findById(id);
      if (aftersale == null) {
        continue;
      }
      Short status=aftersale.getStatus();
      if (!status.equals(AftersaleConstant.STATUS_REQUEST)) {
        continue;
      }
      aftersale.setStatus(AftersaleConstant.STATUS_RECEPT);
      aftersale.setHandleTime(LocalDateTime.now());
      aftersaleService.updateById(aftersale);
      orderService.updateAftersaleStatus(aftersale.getOrderId(),AftersaleConstant.STATUS_RECEPT);
    }
    return ResponseUtil.ok();
  }
  @RequiresPermissions("admin:aftersale:reject") @RequiresPermissionsDesc(menu={"商城管理","售后管理"},button="审核拒绝") @PostMapping("/reject") public Object reject(  @RequestBody LitemallAftersale aftersale){
    Integer id=aftersale.getId();
    LitemallAftersale aftersaleOne=aftersaleService.findById(id);
    if (aftersaleOne == null) {
      return ResponseUtil.badArgumentValue();
    }
    Short status=aftersaleOne.getStatus();
    if (!status.equals(AftersaleConstant.STATUS_REQUEST)) {
      return ResponseUtil.fail(AdminResponseCode.AFTERSALE_NOT_ALLOWED,"售后不能进行审核拒绝操作");
    }
    aftersaleOne.setStatus(AftersaleConstant.STATUS_REJECT);
    aftersaleOne.setHandleTime(LocalDateTime.now());
    aftersaleService.updateById(aftersaleOne);
    orderService.updateAftersaleStatus(aftersaleOne.getOrderId(),AftersaleConstant.STATUS_REJECT);
    return ResponseUtil.ok();
  }
  @RequiresPermissions("admin:aftersale:batch-reject") @RequiresPermissionsDesc(menu={"商城管理","售后管理"},button="批量拒绝") @PostMapping("/batch-reject") public Object batchReject(  @RequestBody String body){
    List<Integer> ids=JacksonUtil.parseIntegerList(body,"ids");
    for (    Integer id : ids) {
      LitemallAftersale aftersale=aftersaleService.findById(id);
      if (aftersale == null) {
        continue;
      }
      Short status=aftersale.getStatus();
      if (!status.equals(AftersaleConstant.STATUS_REQUEST)) {
        continue;
      }
      aftersale.setStatus(AftersaleConstant.STATUS_REJECT);
      aftersale.setHandleTime(LocalDateTime.now());
      aftersaleService.updateById(aftersale);
      orderService.updateAftersaleStatus(aftersale.getOrderId(),AftersaleConstant.STATUS_REJECT);
    }
    return ResponseUtil.ok();
  }
  @RequiresPermissions("admin:aftersale:refund") @RequiresPermissionsDesc(menu={"商城管理","售后管理"},button="退款") @PostMapping("/refund") public Object refund(  @RequestBody LitemallAftersale aftersale){
    Integer id=aftersale.getId();
    LitemallAftersale aftersaleOne=aftersaleService.findById(id);
    if (aftersaleOne == null) {
      return ResponseUtil.badArgumentValue();
    }
    if (!aftersaleOne.getStatus().equals(AftersaleConstant.STATUS_RECEPT)) {
      return ResponseUtil.fail(AdminResponseCode.AFTERSALE_NOT_ALLOWED,"售后不能进行退款操作");
    }
    Integer orderId=aftersaleOne.getOrderId();
    LitemallOrder order=orderService.findById(orderId);
    WxPayRefundRequest wxPayRefundRequest=new WxPayRefundRequest();
    wxPayRefundRequest.setOutTradeNo(order.getOrderSn());
    wxPayRefundRequest.setOutRefundNo("refund_" + order.getOrderSn());
    Integer totalFee=aftersaleOne.getAmount().multiply(new BigDecimal(100)).intValue();
    wxPayRefundRequest.setTotalFee(order.getActualPrice().multiply(new BigDecimal(100)).intValue());
    wxPayRefundRequest.setRefundFee(totalFee);
    WxPayRefundResult wxPayRefundResult;
    try {
      wxPayRefundResult=wxPayService.refund(wxPayRefundRequest);
    }
 catch (    WxPayException e) {
      logger.error(e.getMessage(),e);
      return ResponseUtil.fail(ORDER_REFUND_FAILED,"订单退款失败");
    }
    if (!wxPayRefundResult.getReturnCode().equals("SUCCESS")) {
      logger.warn("refund fail: " + wxPayRefundResult.getReturnMsg());
      return ResponseUtil.fail(ORDER_REFUND_FAILED,"订单退款失败");
    }
    if (!wxPayRefundResult.getResultCode().equals("SUCCESS")) {
      logger.warn("refund fail: " + wxPayRefundResult.getReturnMsg());
      return ResponseUtil.fail(ORDER_REFUND_FAILED,"订单退款失败");
    }
    aftersaleOne.setStatus(AftersaleConstant.STATUS_REFUND);
    aftersaleOne.setHandleTime(LocalDateTime.now());
    aftersaleService.updateById(aftersaleOne);
    orderService.updateAftersaleStatus(orderId,AftersaleConstant.STATUS_REFUND);
    if (aftersale.getType().equals(AftersaleConstant.TYPE_GOODS_REQUIRED)) {
      List<LitemallOrderGoods> orderGoodsList=orderGoodsService.queryByOid(orderId);
      for (      LitemallOrderGoods orderGoods : orderGoodsList) {
        Integer productId=orderGoods.getProductId();
        Short number=orderGoods.getNumber();
        goodsProductService.addStock(productId,number);
      }
    }
    notifyService.notifySmsTemplate(order.getMobile(),NotifyType.REFUND,new String[]{order.getOrderSn().substring(8,14)});
    logHelper.logOrderSucceed("退款","订单编号 " + order.getOrderSn() + " 售后编号 "+ aftersale.getAftersaleSn());
    return ResponseUtil.ok();
  }
}

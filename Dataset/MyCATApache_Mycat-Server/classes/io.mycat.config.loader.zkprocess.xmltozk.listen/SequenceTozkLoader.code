/** 
 * 进行从sequence加载到zk中加载 源文件名：SchemasLoader.java 文件版本：1.0.0 创建作者：liujun 创建日期：2016年9月15日 修改作者：liujun 修改日期：2016年9月15日 文件描述：TODO 版权所有：Copyright 2016 zjhz, Inc. All Rights Reserved.
 */
public class SequenceTozkLoader extends ZkMultLoader implements NotiflyService {
  /** 
 * 日志
 * @字段说明 LOGGER
 */
  private static final Logger LOGGER=LoggerFactory.getLogger(SequenceTozkLoader.class);
  /** 
 * 当前文件中的zkpath信息 
 * @字段说明 currZkPath
 */
  private final String currZkPath;
  /** 
 * 后缀名
 * @字段说明 PROPERTIES_SUFFIX
 */
  private static final String PROPERTIES_SUFFIX=".properties";
  /** 
 * 序列配制信息
 * @字段说明 PROPERTIES_SEQUENCE_CONF
 */
  private static final String PROPERTIES_SEQUENCE_CONF="sequence_conf";
  /** 
 * db序列配制信息
 * @字段说明 PROPERTIES_SEQUENCE_CONF
 */
  private static final String PROPERTIES_SEQUENCE_DB_CONF="sequence_db_conf";
  /** 
 * 分布式的序列配制
 * @字段说明 PROPERTIES_SEQUENCE_CONF
 */
  private static final String PROPERTIES_SEQUENCE_DISTRIBUTED_CONF="sequence_distributed_conf";
  /** 
 * 时间的序列配制
 * @字段说明 PROPERTIES_SEQUENCE_CONF
 */
  private static final String PROPERTIES_SEQUENCE_TIME_CONF="sequence_time_conf";
  public SequenceTozkLoader(  ZookeeperProcessListen zookeeperListen,  CuratorFramework curator,  XmlProcessBase xmlParseBase){
    this.setCurator(curator);
    String schemaPath=zookeeperListen.getBasePath();
    schemaPath=schemaPath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SEQUENCE.getKey();
    currZkPath=schemaPath;
    zookeeperListen.addListen(schemaPath,this);
  }
  @Override public boolean notiflyProcess() throws Exception {
    this.sequenceTozk(currZkPath,PROPERTIES_SEQUENCE_CONF);
    LOGGER.info("SequenceTozkLoader notiflyProcess sequence_conf to zk success");
    this.sequenceTozk(currZkPath,PROPERTIES_SEQUENCE_DB_CONF);
    LOGGER.info("SequenceTozkLoader notiflyProcess sequence_db_conf to zk success");
    this.sequenceTozk(currZkPath,PROPERTIES_SEQUENCE_DISTRIBUTED_CONF);
    LOGGER.info("SequenceTozkLoader notiflyProcess sequence_distributed_conf to zk success");
    this.sequenceTozk(currZkPath,PROPERTIES_SEQUENCE_TIME_CONF);
    LOGGER.info("SequenceTozkLoader notiflyProcess sequence_time_conf to zk success");
    LOGGER.info("SequenceTozkLoader notiflyProcess xml to zk is success");
    return true;
  }
  /** 
 * 将xml文件的信息写入到zk中 方法描述
 * @param basePath 基本路径
 * @param schema schema文件的信息
 * @throws Exception 异常信息
 * @创建日期 2016年9月17日
 */
  private void sequenceTozk(  String basePath,  String name) throws Exception {
    String commPath=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SEQUENCE_COMMON.getKey() + ZookeeperPath.ZK_SEPARATOR.getKey();
    String readFile=name + PROPERTIES_SUFFIX;
    String commSequence=this.readSequenceCfg(readFile);
    String sequenceZkPath=commPath + readFile;
    this.checkAndwriteString(basePath,sequenceZkPath,commSequence);
    String culsterPath=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_SEQUENCE_CLUSTER.getKey() + ZookeeperPath.ZK_SEPARATOR.getKey();
    String[] clusters=ZkConfig.getInstance().getValue(ZkParamCfg.ZK_CFG_CLUSTER_NODES).split(ZkParamCfg.ZK_CFG_CLUSTER_NODES_SEPARATE.getKey());
    if (null != clusters) {
      String nodeName=null;
      for (      String clusterName : clusters) {
        nodeName=name + "-" + clusterName+ PROPERTIES_SUFFIX;
        String clusterSequence=this.readSequenceCfg(nodeName);
        if (null != clusterSequence) {
          String seqclusterZkPath=culsterPath + nodeName;
          this.checkAndwriteString(basePath,seqclusterZkPath,clusterSequence);
        }
      }
    }
  }
  /** 
 * 读取 sequence配制文件的信息 方法描述
 * @param name 名称信息
 * @return
 * @创建日期 2016年9月18日
 */
  private String readSequenceCfg(  String name){
    String path=ZookeeperPath.ZK_LOCAL_CFG_PATH.getKey() + name;
    InputStream input=SequenceTozkLoader.class.getResourceAsStream(path);
    if (null != input) {
      StringBuilder mapFileStr=new StringBuilder();
      byte[] buffers=new byte[256];
      try {
        int readIndex=-1;
        while ((readIndex=input.read(buffers)) != -1) {
          mapFileStr.append(new String(buffers,0,readIndex));
        }
      }
 catch (      IOException e) {
        e.printStackTrace();
        LOGGER.error("SequenceTozkLoader readMapFile IOException",e);
      }
 finally {
        IOUtils.close(input);
      }
      return mapFileStr.toString();
    }
    return null;
  }
}

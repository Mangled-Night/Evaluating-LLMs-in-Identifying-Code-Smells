/** 
 * Convenience class for quickly starting a Netty Tty server.
 * @author <a href="mailto:julien@julienviet.com">Julien Viet</a>
 */
public class NettyWebsocketTtyBootstrap {
  private final ChannelGroup channelGroup=new DefaultChannelGroup(ImmediateEventExecutor.INSTANCE);
  private String host;
  private int port;
  private EventLoopGroup group;
  private Channel channel;
  private EventExecutorGroup workerGroup;
  private HttpSessionManager httpSessionManager;
  public NettyWebsocketTtyBootstrap(  EventExecutorGroup workerGroup,  HttpSessionManager httpSessionManager){
    this.workerGroup=workerGroup;
    this.host="localhost";
    this.port=8080;
    this.httpSessionManager=httpSessionManager;
  }
  public String getHost(){
    return host;
  }
  public NettyWebsocketTtyBootstrap setHost(  String host){
    this.host=host;
    return this;
  }
  public int getPort(){
    return port;
  }
  public NettyWebsocketTtyBootstrap setPort(  int port){
    this.port=port;
    return this;
  }
  public void start(  Consumer<TtyConnection> handler,  final Consumer<Throwable> doneHandler){
    group=new NioEventLoopGroup(new DefaultThreadFactory("arthas-NettyWebsocketTtyBootstrap",true));
    if (this.port > 0) {
      ServerBootstrap b=new ServerBootstrap();
      b.group(group).channel(NioServerSocketChannel.class).handler(new LoggingHandler(LogLevel.INFO)).childHandler(new TtyServerInitializer(channelGroup,handler,workerGroup,httpSessionManager));
      final ChannelFuture f=b.bind(host,port);
      f.addListener(new GenericFutureListener<Future<? super Void>>(){
        @Override public void operationComplete(        Future<? super Void> future) throws Exception {
          if (future.isSuccess()) {
            channel=f.channel();
            doneHandler.accept(null);
          }
 else {
            doneHandler.accept(future.cause());
          }
        }
      }
);
    }
    ServerBootstrap b2=new ServerBootstrap();
    b2.group(group).channel(LocalServerChannel.class).handler(new LoggingHandler(LogLevel.INFO)).childHandler(new LocalTtyServerInitializer(channelGroup,handler,workerGroup));
    ChannelFuture bindLocalFuture=b2.bind(new LocalAddress(ArthasConstants.NETTY_LOCAL_ADDRESS));
    if (this.port < 0) {
      bindLocalFuture.addListener(new GenericFutureListener<Future<? super Void>>(){
        @Override public void operationComplete(        Future<? super Void> future) throws Exception {
          if (future.isSuccess()) {
            doneHandler.accept(null);
          }
 else {
            doneHandler.accept(future.cause());
          }
        }
      }
);
    }
  }
  public CompletableFuture<Void> start(  Consumer<TtyConnection> handler){
    CompletableFuture<Void> fut=new CompletableFuture<Void>();
    start(handler,Helper.startedHandler(fut));
    return fut;
  }
  public void stop(  final Consumer<Throwable> doneHandler){
    if (channel != null) {
      channel.close();
    }
    channelGroup.close().addListener(new GenericFutureListener<Future<? super Void>>(){
      @Override public void operationComplete(      Future<? super Void> future) throws Exception {
        try {
          doneHandler.accept(future.cause());
        }
  finally {
          group.shutdownGracefully();
        }
      }
    }
);
  }
  public CompletableFuture<Void> stop(){
    CompletableFuture<Void> fut=new CompletableFuture<Void>();
    stop(Helper.stoppedHandler(fut));
    return fut;
  }
}

@Override protected ByteBuf allocateBuffer(ChannelHandlerContext ctx,Object msg,boolean preferDirect) throws Exception {
  if (msg instanceof Collection) {
    if (preferDirect) {
      return ctx.alloc().ioBuffer(((Collection)msg).size() * 16);
    }
 else {
      return ctx.alloc().heapBuffer(((Collection)msg).size() * 16);
    }
  }
  if (preferDirect) {
    return ctx.alloc().ioBuffer();
  }
 else {
    return ctx.alloc().heapBuffer();
  }
}

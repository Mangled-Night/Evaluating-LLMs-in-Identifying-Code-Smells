public class EntityRefTypeHandler extends TypeHandler<EntityRef> {
  private EngineEntityManager entityManager;
  public EntityRefTypeHandler(  EngineEntityManager engineEntityManager){
    this.entityManager=engineEntityManager;
  }
  @Override public PersistedData serializeNonNull(  EntityRef value,  PersistedDataSerializer serializer){
    if (value.exists() && value.isPersistent()) {
      return serializer.serialize(value.getId());
    }
    return serializer.serializeNull();
  }
  @Override public Optional<EntityRef> deserialize(  PersistedData data){
    if (data.isNumber()) {
      return Optional.ofNullable(entityManager.getEntity(data.getAsLong()));
    }
    return Optional.ofNullable(EntityRef.NULL);
  }
  private void addEntitiesFromLongArray(  List<EntityRef> result,  PersistedDataArray array){
    TLongIterator iterator=array.getAsLongArray().iterator();
    while (iterator.hasNext()) {
      long item=iterator.next();
      result.add(entityManager.getEntity(item));
    }
  }
}

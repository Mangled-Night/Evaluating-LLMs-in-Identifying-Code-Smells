/** 
 * A base class for unit test classes to inherit to run in a Terasology environment - with LWJGL set up and so forth
 */
public abstract class TerasologyTestingEnvironment {
  protected static Context context;
  private static final Logger logger=LoggerFactory.getLogger(TerasologyTestingEnvironment.class);
  private static ModuleManager moduleManager;
  private static HeadlessEnvironment env;
  protected EngineTime mockTime;
  private EngineEntityManager engineEntityManager;
  @BeforeAll public static void setupEnvironment(  @TempDir Path tempHome) throws Exception {
    PathManager.getInstance().useOverrideHomePath(tempHome);
    Bullet.init(true,false);
    env=new HeadlessEnvironment(new Name("engine"),new Name("unittest"));
    context=env.getContext();
    moduleManager=context.get(ModuleManager.class);
  }
  @BeforeEach public void setup() throws Exception {
    context.put(ModuleManager.class,moduleManager);
    RecordAndReplayCurrentStatus recordAndReplayCurrentStatus=context.get(RecordAndReplayCurrentStatus.class);
    mockTime=mock(EngineTime.class);
    context.put(Time.class,mockTime);
    NetworkSystemImpl networkSystem=new NetworkSystemImpl(mockTime,context);
    context.put(Game.class,new Game());
    context.put(NetworkSystem.class,networkSystem);
    EntitySystemSetupUtil.addReflectionBasedLibraries(context);
    EntitySystemSetupUtil.addEntityManagementRelatedClasses(context);
    engineEntityManager=context.get(EngineEntityManager.class);
    BlockManager mockBlockManager=context.get(BlockManager.class);
    ExtraBlockDataManager extraDataManager=context.get(ExtraBlockDataManager.class);
    RecordedEventStore recordedEventStore=new RecordedEventStore();
    RecordAndReplayUtils recordAndReplayUtils=new RecordAndReplayUtils();
    context.put(RecordAndReplayUtils.class,recordAndReplayUtils);
    CharacterStateEventPositionMap characterStateEventPositionMap=new CharacterStateEventPositionMap();
    context.put(CharacterStateEventPositionMap.class,characterStateEventPositionMap);
    DirectionAndOriginPosRecorderList directionAndOriginPosRecorderList=new DirectionAndOriginPosRecorderList();
    context.put(DirectionAndOriginPosRecorderList.class,directionAndOriginPosRecorderList);
    RecordAndReplaySerializer recordAndReplaySerializer=new RecordAndReplaySerializer(engineEntityManager,recordedEventStore,recordAndReplayUtils,characterStateEventPositionMap,directionAndOriginPosRecorderList,moduleManager,context.get(TypeRegistry.class));
    context.put(RecordAndReplaySerializer.class,recordAndReplaySerializer);
    Path savePath=PathManager.getInstance().getSavePath("world1");
    context.put(StorageManager.class,new ReadWriteStorageManager(savePath,moduleManager.getEnvironment(),engineEntityManager,mockBlockManager,extraDataManager,recordAndReplaySerializer,recordAndReplayUtils,recordAndReplayCurrentStatus));
    ComponentSystemManager componentSystemManager=new ComponentSystemManager(context);
    context.put(ComponentSystemManager.class,componentSystemManager);
    LoadPrefabs prefabLoadStep=new LoadPrefabs(context);
    boolean complete=false;
    prefabLoadStep.begin();
    while (!complete) {
      complete=prefabLoadStep.step();
    }
    context.get(ComponentSystemManager.class).initialise();
    context.put(Console.class,new ConsoleImpl(context));
  }
  @AfterAll public static void tearDown() throws Exception {
    if (env != null) {
      env.close();
    }
 else {
      logger.warn("TTE.env unexpectedly null during tearDown");
    }
  }
  public EngineEntityManager getEntityManager(){
    return engineEntityManager;
  }
}

/** 
 * lock tables [table] [write|read]语句解析器
 * @author songdabin
 */
public class DruidLockTableParser extends DefaultDruidParser implements DruidParser {
  @Override public void statementParse(  SchemaConfig schema,  RouteResultset rrs,  SQLStatement stmt) throws SQLNonTransientException {
    MySqlLockTableStatement lockTableStat=(MySqlLockTableStatement)stmt;
    String table=lockTableStat.getItems().get(0).getTableSource().toString().toUpperCase();
    TableConfig tableConfig=schema.getTables().get(table);
    if (tableConfig == null) {
      String msg="can't find table define of " + table + " in schema:"+ schema.getName();
      LOGGER.warn(msg);
      throw new SQLNonTransientException(msg);
    }
    LockType lockType=lockTableStat.getItems().get(0).getLockType();
    if (LockType.WRITE != lockType && LockType.READ != lockType) {
      String msg="lock type must be write or read";
      LOGGER.warn(msg);
      throw new SQLNonTransientException(msg);
    }
    List<String> dataNodes=tableConfig.getDataNodes();
    RouteResultsetNode[] nodes=new RouteResultsetNode[dataNodes.size()];
    for (int i=0; i < dataNodes.size(); i++) {
      nodes[i]=new RouteResultsetNode(dataNodes.get(i),ServerParse.LOCK,stmt.toString());
    }
    rrs.setNodes(nodes);
    rrs.setFinishedRoute(true);
  }
  @Override public void visitorParse(  SchemaConfig schema,  RouteResultset rrs,  SQLStatement stmt,  MycatSchemaStatVisitor visitor) throws SQLNonTransientException {
    String sql=rrs.getStatement();
    sql=sql.replaceAll("\n"," ").replaceAll("\t"," ");
    String[] stmts=SplitUtil.split(sql,',',true);
    if (stmts.length > 1) {
      String tmpStmt=null;
      String tmpWords[]=null;
      for (int i=1; i < stmts.length; i++) {
        tmpStmt=stmts[i];
        tmpWords=SplitUtil.split(tmpStmt,' ',true);
        if (tmpWords.length == 2 && ("READ".equalsIgnoreCase(tmpWords[1]) || "WRITE".equalsIgnoreCase(tmpWords[1]))) {
          continue;
        }
 else {
          throw new SQLNonTransientException("You have an error in your SQL syntax, don't support lock multi tables!");
        }
      }
      LOGGER.error("can't lock multi-table");
      throw new SQLNonTransientException("can't lock multi-table");
    }
  }
}

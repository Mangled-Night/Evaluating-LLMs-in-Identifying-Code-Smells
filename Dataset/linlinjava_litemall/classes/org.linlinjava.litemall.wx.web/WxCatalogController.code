/** 
 * 类目服务
 */
@RestController @RequestMapping("/wx/catalog") @Validated public class WxCatalogController {
  private final Log logger=LogFactory.getLog(WxCatalogController.class);
  @Autowired private LitemallCategoryService categoryService;
  @GetMapping("/getfirstcategory") public Object getFirstCategory(){
    List<LitemallCategory> l1CatList=categoryService.queryL1();
    return ResponseUtil.ok(l1CatList);
  }
  @GetMapping("/getsecondcategory") public Object getSecondCategory(  @NotNull Integer id){
    List<LitemallCategory> currentSubCategory=categoryService.queryByPid(id);
    return ResponseUtil.ok(currentSubCategory);
  }
  /** 
 * 分类详情
 * @param id   分类类目ID。如果分类类目ID是空，则选择第一个分类类目。 需要注意，这里分类类目是一级类目
 * @return 分类详情
 */
  @GetMapping("index") public Object index(  Integer id){
    List<LitemallCategory> l1CatList=categoryService.queryL1();
    LitemallCategory currentCategory=null;
    if (id != null) {
      currentCategory=categoryService.findById(id);
    }
 else {
      if (l1CatList.size() > 0) {
        currentCategory=l1CatList.get(0);
      }
    }
    List<LitemallCategory> currentSubCategory=null;
    if (null != currentCategory) {
      currentSubCategory=categoryService.queryByPid(currentCategory.getId());
    }
    Map<String,Object> data=new HashMap<String,Object>();
    data.put("categoryList",l1CatList);
    data.put("currentCategory",currentCategory);
    data.put("currentSubCategory",currentSubCategory);
    return ResponseUtil.ok(data);
  }
  /** 
 * 所有分类数据
 * @return 所有分类数据
 */
  @GetMapping("all") public Object queryAll(){
    if (HomeCacheManager.hasData(HomeCacheManager.CATALOG)) {
      return ResponseUtil.ok(HomeCacheManager.getCacheData(HomeCacheManager.CATALOG));
    }
    List<LitemallCategory> l1CatList=categoryService.queryL1();
    Map<Integer,List<LitemallCategory>> allList=new HashMap<>();
    List<LitemallCategory> sub;
    for (    LitemallCategory category : l1CatList) {
      sub=categoryService.queryByPid(category.getId());
      allList.put(category.getId(),sub);
    }
    LitemallCategory currentCategory=l1CatList.get(0);
    List<LitemallCategory> currentSubCategory=null;
    if (null != currentCategory) {
      currentSubCategory=categoryService.queryByPid(currentCategory.getId());
    }
    Map<String,Object> data=new HashMap<String,Object>();
    data.put("categoryList",l1CatList);
    data.put("allList",allList);
    data.put("currentCategory",currentCategory);
    data.put("currentSubCategory",currentSubCategory);
    HomeCacheManager.loadData(HomeCacheManager.CATALOG,data);
    return ResponseUtil.ok(data);
  }
  /** 
 * 当前分类栏目
 * @param id 分类类目ID
 * @return 当前分类栏目
 */
  @GetMapping("current") public Object current(  @NotNull Integer id){
    LitemallCategory currentCategory=categoryService.findById(id);
    if (currentCategory == null) {
      return ResponseUtil.badArgumentValue();
    }
    List<LitemallCategory> currentSubCategory=categoryService.queryByPid(currentCategory.getId());
    Map<String,Object> data=new HashMap<String,Object>();
    data.put("currentCategory",currentCategory);
    data.put("currentSubCategory",currentSubCategory);
    return ResponseUtil.ok(data);
  }
}

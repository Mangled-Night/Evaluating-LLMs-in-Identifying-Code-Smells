private void attachAgent(Configure configure) throws Exception {
  VirtualMachineDescriptor virtualMachineDescriptor=null;
  for (  VirtualMachineDescriptor descriptor : VirtualMachine.list()) {
    String pid=descriptor.id();
    if (pid.equals(Long.toString(configure.getJavaPid()))) {
      virtualMachineDescriptor=descriptor;
      break;
    }
  }
  VirtualMachine virtualMachine=null;
  try {
    if (null == virtualMachineDescriptor) {
      virtualMachine=VirtualMachine.attach("" + configure.getJavaPid());
    }
 else {
      virtualMachine=VirtualMachine.attach(virtualMachineDescriptor);
    }
    Properties targetSystemProperties=virtualMachine.getSystemProperties();
    String targetJavaVersion=JavaVersionUtils.javaVersionStr(targetSystemProperties);
    String currentJavaVersion=JavaVersionUtils.javaVersionStr();
    if (targetJavaVersion != null && currentJavaVersion != null) {
      if (!targetJavaVersion.equals(currentJavaVersion)) {
        AnsiLog.warn("Current VM java version: {} do not match target VM java version: {}, attach may fail.",currentJavaVersion,targetJavaVersion);
        AnsiLog.warn("Target VM JAVA_HOME is {}, arthas-boot JAVA_HOME is {}, try to set the same JAVA_HOME.",targetSystemProperties.getProperty("java.home"),System.getProperty("java.home"));
      }
    }
    String arthasAgentPath=configure.getArthasAgent();
    configure.setArthasAgent(encodeArg(arthasAgentPath));
    configure.setArthasCore(encodeArg(configure.getArthasCore()));
    try {
      virtualMachine.loadAgent(arthasAgentPath,configure.getArthasCore() + ";" + configure.toString());
    }
 catch (    IOException e) {
      if (e.getMessage() != null && e.getMessage().contains("Non-numeric value found")) {
        AnsiLog.warn(e);
        AnsiLog.warn("It seems to use the lower version of JDK to attach the higher version of JDK.");
        AnsiLog.warn("This error message can be ignored, the attach may have been successful, and it will still try to connect.");
      }
 else {
        throw e;
      }
    }
catch (    com.sun.tools.attach.AgentLoadException ex) {
      if ("0".equals(ex.getMessage())) {
        AnsiLog.warn(ex);
        AnsiLog.warn("It seems to use the higher version of JDK to attach the lower version of JDK.");
        AnsiLog.warn("This error message can be ignored, the attach may have been successful, and it will still try to connect.");
      }
 else {
        throw ex;
      }
    }
  }
  finally {
    if (null != virtualMachine) {
      virtualMachine.detach();
    }
  }
}

/** 
 * @author hengyunabc 2020-05-19
 */
public class EnhancerTest {
  @Test public void test() throws Throwable {
    Instrumentation instrumentation=ByteBuddyAgent.install();
    TestHelper.appendSpyJar(instrumentation);
    ArthasBootstrap.getInstance(instrumentation,"ip=127.0.0.1");
    AdviceListener listener=Mockito.mock(AdviceListener.class);
    EqualsMatcher<String> methodNameMatcher=new EqualsMatcher<String>("print");
    EqualsMatcher<String> classNameMatcher=new EqualsMatcher<String>(MathGame.class.getName());
    Enhancer enhancer=new Enhancer(listener,true,false,classNameMatcher,null,methodNameMatcher);
    ClassLoader inClassLoader=MathGame.class.getClassLoader();
    String className=MathGame.class.getName();
    Class<?> classBeingRedefined=MathGame.class;
    ClassNode classNode=AsmUtils.loadClass(MathGame.class);
    byte[] classfileBuffer=AsmUtils.toBytes(classNode);
    byte[] result=enhancer.transform(inClassLoader,className,classBeingRedefined,null,classfileBuffer);
    ClassNode resultClassNode1=AsmUtils.toClassNode(result);
    result=enhancer.transform(inClassLoader,className,classBeingRedefined,null,result);
    ClassNode resultClassNode2=AsmUtils.toClassNode(result);
    MethodNode resultMethodNode1=AsmUtils.findMethods(resultClassNode1.methods,"print").get(0);
    MethodNode resultMethodNode2=AsmUtils.findMethods(resultClassNode2.methods,"print").get(0);
    Assertions.assertThat(AsmUtils.findMethodInsnNode(resultMethodNode1,Type.getInternalName(SpyAPI.class),"atEnter").size()).isEqualTo(AsmUtils.findMethodInsnNode(resultMethodNode2,Type.getInternalName(SpyAPI.class),"atEnter").size());
    Assertions.assertThat(AsmUtils.findMethodInsnNode(resultMethodNode1,Type.getInternalName(SpyAPI.class),"atExceptionExit").size()).isEqualTo(AsmUtils.findMethodInsnNode(resultMethodNode2,Type.getInternalName(SpyAPI.class),"atExceptionExit").size());
    Assertions.assertThat(AsmUtils.findMethodInsnNode(resultMethodNode1,Type.getInternalName(SpyAPI.class),"atBeforeInvoke").size()).isEqualTo(AsmUtils.findMethodInsnNode(resultMethodNode2,Type.getInternalName(SpyAPI.class),"atBeforeInvoke").size());
    Assertions.assertThat(AsmUtils.findMethodInsnNode(resultMethodNode1,Type.getInternalName(SpyAPI.class),"atInvokeException").size()).isEqualTo(AsmUtils.findMethodInsnNode(resultMethodNode2,Type.getInternalName(SpyAPI.class),"atInvokeException").size());
    String string=Decompiler.decompile(result);
    System.err.println(string);
  }
}

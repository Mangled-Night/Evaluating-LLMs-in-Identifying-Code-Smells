public class BulletCompoundShape extends BulletCollisionShape implements CompoundShape {
  private final btCompoundShape compoundShape;
  private List<BulletCompoundShapeChild> childList;
  public BulletCompoundShape(){
    this(new btCompoundShape());
  }
  private BulletCompoundShape(  btCompoundShape compoundShape){
    this.compoundShape=compoundShape;
    underlyingShape=compoundShape;
    childList=new ArrayList<>();
  }
  @Override public void addChildShape(  Vector3fc origin,  Quaternionfc rotation,  float scale,  CollisionShape collisionShape){
    BulletCollisionShape bulletCollisionShape=(BulletCollisionShape)collisionShape;
    compoundShape.addChildShape(new Matrix4f().translationRotateScale(origin,rotation,scale),((BulletCollisionShape)collisionShape).underlyingShape);
    childList.add(new BulletCompoundShapeChild(origin,rotation,scale,bulletCollisionShape,compoundShape.getChildShape(compoundShape.getNumChildShapes() - 1)));
  }
  @Override public CollisionShape rotate(  Quaternionf rot){
    BulletCompoundShape shape=new BulletCompoundShape();
    for (    BulletCompoundShapeChild child : childList) {
      Matrix4f transform=new Matrix4f().rotate(rot).mul(child.transform);
      shape.compoundShape.addChildShape(transform,child.childShape.underlyingShape);
      shape.childList.add(new BulletCompoundShapeChild(transform,child.childShape,compoundShape.getChildShape(compoundShape.getNumChildShapes() - 1)));
    }
    return shape;
  }
private static final class BulletCompoundShapeChild {
    public BulletCollisionShape childShape;
    public btCollisionShape compoundShapeChild;
    private final Matrix4f transform=new Matrix4f();
    private BulletCompoundShapeChild(    Matrix4fc trans,    BulletCollisionShape childShape,    btCollisionShape compoundShapeChild){
      this.transform.set(trans);
      this.childShape=childShape;
      this.compoundShapeChild=compoundShapeChild;
    }
    private BulletCompoundShapeChild(    Vector3fc origin,    Quaternionfc rotation,    float scale,    BulletCollisionShape childShape,    btCollisionShape compoundShapeChild){
      this.transform.translationRotateScale(origin,rotation,scale);
      this.childShape=childShape;
      this.compoundShapeChild=compoundShapeChild;
    }
  }
}

private ChatManager(XMPPConnection connection){
  super(connection);
  connection.addSyncStanzaListener(new StanzaListener(){
    @Override public void processStanza(    Stanza packet){
      Message message=(Message)packet;
      Chat chat;
      if (message.getThread() == null) {
        chat=getUserChat(message.getFrom());
      }
 else {
        chat=getThreadChat(message.getThread());
      }
      if (chat == null) {
        chat=createChat(message);
      }
      if (chat == null)       return;
      deliverMessage(chat,message);
    }
  }
,packetFilter);
  INSTANCES.put(connection,this);
}

public class InitialiseRemoteWorld extends SingleStepLoadProcess {
  private final Context context;
  private final GameManifest gameManifest;
  public InitialiseRemoteWorld(  Context context,  GameManifest gameManifest){
    this.context=context;
    this.gameManifest=gameManifest;
  }
  @Override public String getMessage(){
    return "Setting up remote world...";
  }
  @Override public boolean step(){
    LocalPlayer localPlayer=new LocalPlayer();
    localPlayer.setRecordAndReplayClasses(context.get(DirectionAndOriginPosRecorderList.class),context.get(RecordAndReplayCurrentStatus.class));
    context.put(LocalPlayer.class,localPlayer);
    BlockManager blockManager=context.get(BlockManager.class);
    ExtraBlockDataManager extraDataManager=context.get(ExtraBlockDataManager.class);
    RemoteChunkProvider chunkProvider=new RemoteChunkProvider(blockManager,localPlayer);
    WorldProviderCoreImpl worldProviderCore=new WorldProviderCoreImpl(gameManifest.getWorldInfo(TerasologyConstants.MAIN_WORLD),chunkProvider,blockManager.getBlock(BlockManager.UNLOADED_ID),context);
    EntityAwareWorldProvider entityWorldProvider=new EntityAwareWorldProvider(worldProviderCore,context);
    WorldProvider worldProvider=new WorldProviderWrapper(entityWorldProvider,extraDataManager);
    context.put(WorldProvider.class,worldProvider);
    context.put(BlockEntityRegistry.class,entityWorldProvider);
    context.get(ComponentSystemManager.class).register(entityWorldProvider,"engine:BlockEntityRegistry");
    DefaultCelestialSystem celestialSystem=new DefaultCelestialSystem(new BasicCelestialModel(),context);
    context.put(CelestialSystem.class,celestialSystem);
    context.get(ComponentSystemManager.class).register(celestialSystem);
    context.put(BackdropProvider.class,new Skysphere(context));
    RenderingSubsystemFactory engineSubsystemFactory=context.get(RenderingSubsystemFactory.class);
    WorldRenderer worldRenderer=engineSubsystemFactory.createWorldRenderer(context);
    float reflectionHeight=context.get(NetworkSystem.class).getServer().getInfo().getReflectionHeight();
    worldRenderer.getActiveCamera().setReflectionHeight(reflectionHeight);
    context.put(WorldRenderer.class,worldRenderer);
    context.put(Camera.class,worldRenderer.getActiveCamera());
    context.get(NetworkSystem.class).setRemoteWorldProvider(chunkProvider);
    return true;
  }
  @Override public int getExpectedCost(){
    return 1;
  }
}

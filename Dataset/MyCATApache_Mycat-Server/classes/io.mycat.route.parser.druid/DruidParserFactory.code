/** 
 * DruidParser的工厂类
 * @author wdw
 */
public class DruidParserFactory {
  public static DruidParser create(  SchemaConfig schema,  SQLStatement statement,  SchemaStatVisitor visitor){
    DruidParser parser=null;
    if (statement instanceof SQLSelectStatement) {
      if (schema.isNeedSupportMultiDBType()) {
        parser=getDruidParserForMultiDB(schema,statement,visitor);
      }
      if (parser == null) {
        parser=new DruidSelectParser();
      }
    }
 else     if (statement instanceof MySqlInsertStatement) {
      parser=new DruidInsertParser();
    }
 else     if (statement instanceof MySqlDeleteStatement) {
      parser=new DruidDeleteParser();
    }
 else     if (statement instanceof MySqlCreateTableStatement) {
      parser=new DruidCreateTableParser();
    }
 else     if (statement instanceof MySqlUpdateStatement) {
      parser=new DruidUpdateParser();
    }
 else     if (statement instanceof SQLAlterTableStatement) {
      parser=new DruidAlterTableParser();
    }
 else     if (statement instanceof MySqlLockTableStatement) {
      parser=new DruidLockTableParser();
    }
 else {
      parser=new DefaultDruidParser();
    }
    return parser;
  }
  private static DruidParser getDruidParserForMultiDB(  SchemaConfig schema,  SQLStatement statement,  SchemaStatVisitor visitor){
    DruidParser parser=null;
    MycatSchemaStatVisitor _visitor=SchemaStatVisitorFactory.create(schema);
    List<String> tables=parseTables(statement,_visitor);
    for (    String table : tables) {
      Set<String> dbTypes=null;
      TableConfig tableConfig=schema.getTables().get(table);
      if (tableConfig == null) {
        dbTypes=new HashSet<>();
        dbTypes.add(schema.getDefaultDataNodeDbType());
      }
 else {
        dbTypes=tableConfig.getDbTypes();
      }
      if (dbTypes.contains("oracle")) {
        parser=new DruidSelectOracleParser();
        ((DruidSelectOracleParser)parser).setInvocationHandler(SqlMethodInvocationHandlerFactory.getForOracle());
        break;
      }
 else       if (dbTypes.contains("db2")) {
        parser=new DruidSelectDb2Parser();
        break;
      }
 else       if (dbTypes.contains("sqlserver")) {
        parser=new DruidSelectSqlServerParser();
        break;
      }
 else       if (dbTypes.contains("postgresql")) {
        parser=new DruidSelectPostgresqlParser();
        ((DruidSelectPostgresqlParser)parser).setInvocationHandler(SqlMethodInvocationHandlerFactory.getForPgsql());
        break;
      }
    }
    return parser;
  }
  private static List<String> parseTables(  SQLStatement stmt,  MycatSchemaStatVisitor schemaStatVisitor){
    List<String> tables=new ArrayList<>();
    stmt.accept(schemaStatVisitor);
    if (schemaStatVisitor.getAliasMap() != null) {
      for (      Map.Entry<String,String> entry : schemaStatVisitor.getAliasMap().entrySet()) {
        String key=entry.getKey();
        String value=entry.getValue();
        if (value != null && value.indexOf("`") >= 0) {
          value=value.replaceAll("`","");
        }
        if (key != null) {
          int pos=key.indexOf("`");
          if (pos > 0) {
            key=key.replaceAll("`","");
          }
          pos=key.indexOf(".");
          if (pos > 0) {
            key=key.substring(pos + 1);
          }
          tables.add(value.toUpperCase());
        }
      }
    }
    return tables;
  }
}

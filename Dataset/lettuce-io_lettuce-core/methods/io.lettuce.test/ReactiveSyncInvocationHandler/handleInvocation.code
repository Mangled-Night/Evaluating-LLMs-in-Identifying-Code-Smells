@Override @SuppressWarnings("unchecked") protected Object handleInvocation(Object proxy,Method method,Object[] args) throws Throwable {
  try {
    Object result=super.handleInvocation(proxy,method,args);
    if (result == null) {
      return result;
    }
    if (result instanceof StatefulConnection) {
      return result;
    }
    if (result instanceof Flux<?>) {
      Flux<?> flux=(Flux<?>)result;
      if (!method.getName().equals("exec") && !method.getName().equals("multi")) {
        if (connection instanceof StatefulRedisConnection && ((StatefulRedisConnection)connection).isMulti()) {
          flux.subscribe();
          return null;
        }
      }
      List<?> value=flux.collectList().block();
      if (method.getReturnType().equals(List.class)) {
        return value;
      }
      if (method.getReturnType().equals(Set.class)) {
        return LettuceSets.newHashSet(value);
      }
      if (!value.isEmpty()) {
        return value.get(0);
      }
    }
    if (result instanceof Mono<?>) {
      Mono<?> mono=(Mono<?>)result;
      if (!method.getName().equals("exec") && !method.getName().equals("multi")) {
        if (connection instanceof StatefulRedisConnection && ((StatefulRedisConnection)connection).isMulti()) {
          mono.subscribe();
          return null;
        }
      }
      return mono.block();
    }
    return result;
  }
 catch (  InvocationTargetException e) {
    throw e.getTargetException();
  }
}

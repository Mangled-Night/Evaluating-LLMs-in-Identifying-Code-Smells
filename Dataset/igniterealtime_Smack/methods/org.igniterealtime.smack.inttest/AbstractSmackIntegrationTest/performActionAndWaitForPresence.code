/** 
 * Perform action and wait until conA observes a presence form conB. <p> This method is usually used so that 'action' performs an operation that changes one entities features/nodes/capabilities, and we want to check that another connection is able to observe this change, and use that new "thing" that was added to the connection. </p> <p> Note that this method is a workaround at best and not reliable. Because it is not guaranteed that any XEP-0030 related manager, e.g. EntityCapsManager, already processed the presence when this method returns. </p> TODO: Come up with a better solution.
 * @param conA the connection to observe the presence on.
 * @param conB the connection sending the presence
 * @param action the action to perform.
 * @throws Exception in case of an exception.
 */
@SuppressWarnings("ThreadPriorityCheck") protected void performActionAndWaitForPresence(XMPPConnection conA,XMPPConnection conB,ThrowingRunnable action) throws Exception {
  final SimpleResultSyncPoint presenceReceivedSyncPoint=new SimpleResultSyncPoint();
  final StanzaListener presenceListener=new StanzaListener(){
    @Override public void processStanza(    Stanza packet){
      presenceReceivedSyncPoint.signal();
    }
  }
;
  conA.addAsyncStanzaListener(presenceListener,new AndFilter(PresenceTypeFilter.AVAILABLE,FromMatchesFilter.create(conB.getUser())));
  action.runOrThrow();
  try {
    presenceReceivedSyncPoint.waitForResult(timeout);
  }
  finally {
    conA.removeAsyncStanzaListener(presenceListener);
  }
  Thread.yield();
}

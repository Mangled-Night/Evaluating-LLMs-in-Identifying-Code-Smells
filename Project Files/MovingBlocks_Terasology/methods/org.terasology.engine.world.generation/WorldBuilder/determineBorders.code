private Map<Class<? extends WorldFacet>,Border3D> determineBorders(ListMultimap<Class<? extends WorldFacet>,FacetProvider> providerChains,List<WorldRasterizer> worldRasterizers){
  List<FacetProvider> orderedProviders=new ArrayList<>();
  for (  Class<? extends WorldFacet> facet : providerChains.keySet()) {
    for (    FacetProvider provider : providerChains.get(facet)) {
      if (!orderedProviders.contains(provider)) {
        orderedProviders.add(provider);
      }
    }
  }
  Map<Class<? extends WorldFacet>,Border3D> borders=Maps.newHashMap();
  for (  WorldRasterizer rasterizer : worldRasterizers) {
    Requires requires=rasterizer.getClass().getAnnotation(Requires.class);
    if (requires != null) {
      for (      Facet facet : requires.value()) {
        borders.put(facet.value(),new Border3D(facet.border()).maxWith(borders.get(facet.value())));
      }
    }
  }
  for (int i=orderedProviders.size() - 1; i >= 0; i--) {
    FacetProvider provider=orderedProviders.get(i);
    Border3D requiredBorder=new Border3D(0,0,0);
    Requires requires=provider.getClass().getAnnotation(Requires.class);
    Produces produces=provider.getClass().getAnnotation(Produces.class);
    Updates updates=provider.getClass().getAnnotation(Updates.class);
    if (produces != null) {
      for (      Class<? extends WorldFacet> facet : produces.value()) {
        Border3D facetBorder=borders.get(facet);
        if (facetBorder != null) {
          requiredBorder=requiredBorder.maxWith(facetBorder);
        }
      }
    }
    if (updates != null) {
      for (      Facet facet : updates.value()) {
        Border3D facetBorder=borders.get(facet.value());
        if (facetBorder != null) {
          requiredBorder=requiredBorder.maxWith(facetBorder);
        }
      }
    }
    if (updates != null) {
      for (      Facet facet : updates.value()) {
        Border3D facetBorder=requiredBorder.extendBy(new Border3D(facet.border()));
        borders.put(facet.value(),facetBorder.maxWith(borders.get(facet.value())));
      }
    }
    if (requires != null) {
      for (      Facet facet : requires.value()) {
        Border3D facetBorder=requiredBorder.extendBy(new Border3D(facet.border()));
        borders.put(facet.value(),facetBorder.maxWith(borders.get(facet.value())));
      }
    }
  }
  return borders;
}

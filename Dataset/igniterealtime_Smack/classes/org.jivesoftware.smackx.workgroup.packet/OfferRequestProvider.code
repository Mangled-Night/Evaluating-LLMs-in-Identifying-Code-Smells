/** 
 * An IQProvider for agent offer requests.
 * @author loki der quaeler
 */
public class OfferRequestProvider extends IqProvider<IQ> {
  @Override public OfferRequestPacket parse(  XmlPullParser parser,  int initialDepth,  IqData iqData,  XmlEnvironment xmlEnvironment) throws XmlPullParserException, IOException, SmackParsingException {
    XmlPullParser.Event eventType=parser.getEventType();
    String sessionID=null;
    int timeout=-1;
    OfferContent content=null;
    boolean done=false;
    Map<String,List<String>> metaData=new HashMap<>();
    if (eventType != XmlPullParser.Event.START_ELEMENT) {
    }
    Jid userJID=ParserUtils.getJidAttribute(parser);
    Jid userID=userJID;
    while (!done) {
      eventType=parser.next();
      if (eventType == XmlPullParser.Event.START_ELEMENT) {
        String elemName=parser.getName();
        if ("timeout".equals(elemName)) {
          timeout=Integer.parseInt(parser.nextText());
        }
 else         if (MetaData.ELEMENT_NAME.equals(elemName)) {
          metaData=MetaDataUtils.parseMetaData(parser);
        }
 else         if (SessionID.ELEMENT_NAME.equals(elemName)) {
          sessionID=parser.getAttributeValue("","id");
        }
 else         if (UserID.ELEMENT_NAME.equals(elemName)) {
          userID=ParserUtils.getJidAttribute(parser,"id");
        }
 else         if ("user-request".equals(elemName)) {
          content=UserRequest.getInstance();
        }
 else         if (RoomInvitation.ELEMENT_NAME.equals(elemName)) {
          RoomInvitation invitation=(RoomInvitation)PacketParserUtils.parseExtensionElement(RoomInvitation.ELEMENT_NAME,RoomInvitation.NAMESPACE,parser,xmlEnvironment);
          content=new InvitationRequest(invitation.getInviter(),invitation.getRoom(),invitation.getReason());
        }
 else         if (RoomTransfer.ELEMENT_NAME.equals(elemName)) {
          RoomTransfer transfer=(RoomTransfer)PacketParserUtils.parseExtensionElement(RoomTransfer.ELEMENT_NAME,RoomTransfer.NAMESPACE,parser,xmlEnvironment);
          content=new TransferRequest(transfer.getInviter(),transfer.getRoom(),transfer.getReason());
        }
      }
 else       if (eventType == XmlPullParser.Event.END_ELEMENT) {
        if ("offer".equals(parser.getName())) {
          done=true;
        }
      }
    }
    OfferRequestPacket offerRequest=new OfferRequestPacket(userJID,userID,timeout,metaData,sessionID,content);
    offerRequest.setType(IQ.Type.set);
    return offerRequest;
  }
public static class OfferRequestPacket extends IQ {
    public static final String ELEMENT="offer";
    public static final String NAMESPACE="http://jabber.org/protocol/workgroup";
    private final int timeout;
    private final Jid userID;
    private final Jid userJID;
    private final Map<String,List<String>> metaData;
    private final String sessionID;
    private final OfferContent content;
    public OfferRequestPacket(    Jid userJID,    Jid userID,    int timeout,    Map<String,List<String>> metaData,    String sessionID,    OfferContent content){
      super(ELEMENT,NAMESPACE);
      this.userJID=userJID;
      this.userID=userID;
      this.timeout=timeout;
      this.metaData=metaData;
      this.sessionID=sessionID;
      this.content=content;
    }
    /** 
 * Returns the userID, which is either the same as the userJID or a special value that the user provided as part of their "join queue" request.
 * @return the user ID.
 */
    public Jid getUserID(){
      return userID;
    }
    /** 
 * The JID of the user that made the "join queue" request.
 * @return the user JID.
 */
    public Jid getUserJID(){
      return userJID;
    }
    /** 
 * Returns the session ID associated with the request and ensuing chat. If the offer does not contain a session ID, <code>null</code> will be returned.
 * @return the session id associated with the request.
 */
    public String getSessionID(){
      return sessionID;
    }
    /** 
 * Returns the number of seconds the agent has to accept the offer before it times out.
 * @return the offer timeout (in seconds).
 */
    public int getTimeout(){
      return this.timeout;
    }
    public OfferContent getContent(){
      return content;
    }
    /** 
 * Returns any meta-data associated with the offer.
 * @return meta-data associated with the offer.
 */
    public Map<String,List<String>> getMetaData(){
      return this.metaData;
    }
    @Override protected IQChildElementXmlStringBuilder getIQChildElementBuilder(    IQChildElementXmlStringBuilder buf){
      buf.append(" jid=\"").append(userJID).append("\">");
      buf.append("<timeout>").append(Integer.toString(timeout)).append("</timeout>");
      if (sessionID != null) {
        buf.append('<').append(SessionID.ELEMENT_NAME);
        buf.append(" session=\"");
        buf.append(getSessionID()).append("\" xmlns=\"");
        buf.append(SessionID.NAMESPACE).append("\"/>");
      }
      if (metaData != null) {
        buf.append(MetaDataUtils.serializeMetaData(metaData));
      }
      if (userID != null) {
        buf.append('<').append(UserID.ELEMENT_NAME);
        buf.append(" id=\"");
        buf.append(userID).append("\" xmlns=\"");
        buf.append(UserID.NAMESPACE).append("\"/>");
      }
      return buf;
    }
  }
}

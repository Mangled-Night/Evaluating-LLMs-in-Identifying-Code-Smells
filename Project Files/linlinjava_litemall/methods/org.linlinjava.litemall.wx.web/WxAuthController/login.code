/** 
 * 账号登录
 * @param body    请求内容，{ username: xxx, password: xxx }
 * @param request 请求对象
 * @return 登录结果
 */
@PostMapping("login") public Object login(@RequestBody String body,HttpServletRequest request){
  String username=JacksonUtil.parseString(body,"username");
  String password=JacksonUtil.parseString(body,"password");
  if (username == null || password == null) {
    return ResponseUtil.badArgument();
  }
  List<LitemallUser> userList=userService.queryByUsername(username);
  LitemallUser user=null;
  if (userList.size() > 1) {
    return ResponseUtil.serious();
  }
 else   if (userList.size() == 0) {
    return ResponseUtil.fail(AUTH_INVALID_ACCOUNT,"账号不存在");
  }
 else {
    user=userList.get(0);
  }
  BCryptPasswordEncoder encoder=new BCryptPasswordEncoder();
  if (!encoder.matches(password,user.getPassword())) {
    return ResponseUtil.fail(AUTH_INVALID_ACCOUNT,"账号密码不对");
  }
  user.setLastLoginTime(LocalDateTime.now());
  user.setLastLoginIp(IpUtil.getIpAddr(request));
  if (userService.updateById(user) == 0) {
    return ResponseUtil.updatedDataFailed();
  }
  UserInfo userInfo=new UserInfo();
  userInfo.setNickName(username);
  userInfo.setAvatarUrl(user.getAvatar());
  String token=UserTokenManager.generateToken(user.getId());
  Map<Object,Object> result=new HashMap<Object,Object>();
  result.put("token",token);
  result.put("userInfo",userInfo);
  return ResponseUtil.ok(result);
}

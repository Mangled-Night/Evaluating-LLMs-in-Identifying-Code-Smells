final class UnsafeSorterSpillMerger {
  private int numRecords=0;
  private final PriorityQueue<UnsafeSorterIterator> priorityQueue;
  UnsafeSorterSpillMerger(  final RecordComparator recordComparator,  final PrefixComparator prefixComparator,  final int numSpills){
    final Comparator<UnsafeSorterIterator> comparator=new Comparator<UnsafeSorterIterator>(){
      @Override public int compare(      UnsafeSorterIterator left,      UnsafeSorterIterator right){
        final int prefixComparisonResult=prefixComparator.compare(left.getKeyPrefix(),right.getKeyPrefix());
        if (prefixComparisonResult == 0) {
          return recordComparator.compare(left.getBaseObject(),left.getBaseOffset(),right.getBaseObject(),right.getBaseOffset());
        }
 else {
          return prefixComparisonResult;
        }
      }
    }
;
    priorityQueue=new PriorityQueue<UnsafeSorterIterator>(numSpills,comparator);
  }
  /** 
 * Add an UnsafeSorterIterator to this merger
 */
  public void addSpillIfNotEmpty(  UnsafeSorterIterator spillReader) throws IOException {
    if (spillReader.hasNext()) {
      spillReader.loadNext();
      priorityQueue.add(spillReader);
      numRecords+=spillReader.getNumRecords();
    }
  }
  /** 
 * 非常重要的一个排序迭代器
 * @return
 * @throws IOException
 */
  public UnsafeSorterIterator getSortedIterator() throws IOException {
    return new UnsafeSorterIterator(){
      /** 
 * 当前迭代器
 */
      private UnsafeSorterIterator spillReader;
      @Override public int getNumRecords(){
        return numRecords;
      }
      @Override public boolean hasNext(){
        return !priorityQueue.isEmpty() || (spillReader != null && spillReader.hasNext());
      }
      @Override public void loadNext() throws IOException {
        if (spillReader != null) {
          if (spillReader.hasNext()) {
            spillReader.loadNext();
            priorityQueue.add(spillReader);
          }
        }
        spillReader=priorityQueue.remove();
      }
      @Override public Object getBaseObject(){
        return spillReader.getBaseObject();
      }
      @Override public long getBaseOffset(){
        return spillReader.getBaseOffset();
      }
      @Override public int getRecordLength(){
        return spillReader.getRecordLength();
      }
      @Override public long getKeyPrefix(){
        return spillReader.getKeyPrefix();
      }
    }
;
  }
}

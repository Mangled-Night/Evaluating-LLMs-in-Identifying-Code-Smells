private final class IteratorImpl implements Iterator<Component> {
  private Iterator<Component> sourceIterator;
  private Iterator<Component> addedIterator;
  private Component next;
  private IteratorImpl(){
    sourceIterator=components.iterator();
    addedIterator=componentsToAdd.values().iterator();
    next=getNext();
  }
  @Override public boolean hasNext(){
    return next != null;
  }
  @Override public Component next(){
    Component result=next;
    next=getNext();
    return result;
  }
  private Component getNext(){
    while (sourceIterator.hasNext()) {
      final Component result=sourceIterator.next();
      if (componentsToAdd.containsKey(result.getClass())) {
        throw new IllegalStateException("Requested to add component that was already defined for this entity");
      }
      if (componentsToRemove.contains(result.getClass())) {
        continue;
      }
      return result;
    }
    while (addedIterator.hasNext()) {
      final Component result=addedIterator.next();
      if (componentsToRemove.contains(result.getClass())) {
        continue;
      }
      return result;
    }
    return null;
  }
  @Override public void remove(){
    throw new UnsupportedOperationException("Remove not supported for read-only iterator");
  }
}

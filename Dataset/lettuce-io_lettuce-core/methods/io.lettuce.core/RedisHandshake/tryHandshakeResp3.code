private CompletionStage<?> tryHandshakeResp3(Channel channel){
  CompletableFuture<?> handshake=new CompletableFuture<>();
  CompletionStage<Map<String,Object>> hello=initiateHandshakeResp3(channel,connectionState.getCredentialsProvider());
  hello.whenComplete((settings,throwable) -> {
    if (throwable instanceof CompletionException) {
      throwable=throwable.getCause();
    }
    if (throwable != null) {
      if (isUnknownCommand(throwable)) {
        fallbackToResp2(channel,handshake);
      }
 else {
        handshake.completeExceptionally(throwable);
      }
    }
 else {
      handshake.complete(null);
    }
  }
);
  return handshake;
}

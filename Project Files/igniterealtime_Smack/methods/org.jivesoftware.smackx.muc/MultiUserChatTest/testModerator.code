public void testModerator(){
  final String[] answer=new String[8];
  try {
    makeRoomModerated();
    MultiUserChat muc2=new MultiUserChat(getConnection(1),room);
    muc2.join("testbot2");
    muc2.addUserStatusListener(new DefaultUserStatusListener(){
      public void voiceGranted(){
        super.voiceGranted();
        answer[0]="canSpeak";
      }
      public void voiceRevoked(){
        super.voiceRevoked();
        answer[1]="cannot speak";
      }
      public void moderatorGranted(){
        super.moderatorGranted();
        answer[4]="I'm a moderator";
      }
      public void moderatorRevoked(){
        super.moderatorRevoked();
        answer[5]="I'm not a moderator";
      }
    }
);
    MultiUserChat muc3=new MultiUserChat(getConnection(2),room);
    muc3.join("testbot3");
    muc3.addParticipantStatusListener(new DefaultParticipantStatusListener(){
      public void voiceGranted(      String participant){
        super.voiceGranted(participant);
        answer[2]=participant;
      }
      public void voiceRevoked(      String participant){
        super.voiceRevoked(participant);
        answer[3]=participant;
      }
      public void moderatorGranted(      String participant){
        super.moderatorGranted(participant);
        answer[6]=participant;
      }
      public void moderatorRevoked(      String participant){
        super.moderatorRevoked(participant);
        answer[7]=participant;
      }
    }
);
    try {
      muc2.grantModerator("testbot3");
      fail("User2 was able to grant moderator privileges");
    }
 catch (    XMPPException e) {
      XMPPError xmppError=e.getStanzaError();
      assertNotNull("No XMPPError was received granting moderator privileges",xmppError);
      assertEquals("A visitor was able to grant moderator privileges to another visitor",403,xmppError.getCode());
    }
    muc.grantModerator("testbot2");
    Thread.sleep(300);
    assertEquals("User2 didn't receive the grant voice notification","canSpeak",answer[0]);
    assertEquals("User2 didn't receive the grant moderator privileges notification","I'm a moderator",answer[4]);
    assertEquals("User3 didn't receive user2's grant voice notification",room + "/testbot2",answer[2]);
    assertEquals("User3 didn't receive user2's grant moderator privileges notification",room + "/testbot2",answer[6]);
    muc.revokeModerator("testbot2");
    Thread.sleep(300);
    assertNull("User2 received a false revoke voice notification",answer[1]);
    assertNull("User3 received a false user2's voice privileges notification",answer[3]);
    assertEquals("User2 didn't receive the revoke moderator privileges notification","I'm not a moderator",answer[5]);
    assertEquals("User3 didn't receive user2's revoke moderator privileges notification",room + "/testbot2",answer[7]);
    clearAnswer(answer);
    muc.grantModerator("testbot2");
    Thread.sleep(300);
    assertNull("User2 received a false grant voice notification",answer[0]);
    assertEquals("User2 didn't receive the grant moderator privileges notification","I'm a moderator",answer[4]);
    assertNull("User3 received a false user2's grant voice notification",answer[2]);
    assertEquals("User3 didn't receive user2's grant moderator privileges notification",room + "/testbot2",answer[6]);
    clearAnswer(answer);
    muc.revokeVoice("testbot2");
    Thread.sleep(300);
    assertEquals("User2 didn't receive the revoke voice notification","cannot speak",answer[1]);
    assertEquals("User3 didn't receive user2's revoke voice notification",room + "/testbot2",answer[3]);
    muc2.leave();
    muc3.leave();
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail(e.getMessage());
  }
}

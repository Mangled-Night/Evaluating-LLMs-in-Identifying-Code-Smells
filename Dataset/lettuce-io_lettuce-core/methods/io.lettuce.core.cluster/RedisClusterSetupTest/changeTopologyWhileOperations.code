@Test public void changeTopologyWhileOperations() throws Exception {
  ClusterSetup.setup2Masters(clusterHelper);
  ClusterTopologyRefreshOptions clusterTopologyRefreshOptions=ClusterTopologyRefreshOptions.builder().enableAllAdaptiveRefreshTriggers().build();
  clusterClient.setOptions(ClusterClientOptions.builder().topologyRefreshOptions(clusterTopologyRefreshOptions).build());
  StatefulRedisClusterConnection<String,String> connection=clusterClient.connect();
  RedisAdvancedClusterCommands<String,String> sync=connection.sync();
  RedisAdvancedClusterAsyncCommands<String,String> async=connection.async();
  Partitions partitions=connection.getPartitions();
  assertThat(partitions.getPartitionBySlot(0).getSlots().size()).isEqualTo(12000);
  assertThat(partitions.getPartitionBySlot(16380).getSlots().size()).isEqualTo(4384);
  assertRoutedExecution(async);
  sync.del("A");
  sync.del("t");
  sync.del("p");
  shiftAllSlotsToNode1();
  assertRoutedExecution(async);
  Wait.untilTrue(() -> {
    if (clusterClient.getPartitions().size() == 2) {
      for (      RedisClusterNode redisClusterNode : clusterClient.getPartitions()) {
        if (redisClusterNode.getSlots().size() > 16380) {
          return true;
        }
      }
    }
    return false;
  }
).waitOrTimeout();
  assertThat(partitions.getPartitionBySlot(0).getSlots().size()).isEqualTo(16384);
  assertThat(sync.get("A")).isEqualTo("value");
  assertThat(sync.get("t")).isEqualTo("value");
  assertThat(sync.get("p")).isEqualTo("value");
  async.getStatefulConnection().close();
}

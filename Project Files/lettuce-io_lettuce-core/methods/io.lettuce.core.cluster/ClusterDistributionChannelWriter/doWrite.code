private <K,V,T>RedisCommand<K,V,T> doWrite(RedisCommand<K,V,T> command){
  if (command instanceof ClusterCommand && !command.isDone()) {
    ClusterCommand<K,V,T> clusterCommand=(ClusterCommand<K,V,T>)command;
    if (clusterCommand.isMoved() || clusterCommand.isAsk()) {
      HostAndPort target;
      boolean asking;
      ByteBuffer firstEncodedKey=clusterCommand.getArgs().getFirstEncodedKey();
      String keyAsString=null;
      int slot=-1;
      if (firstEncodedKey != null) {
        firstEncodedKey.mark();
        keyAsString=StringCodec.UTF8.decodeKey(firstEncodedKey);
        firstEncodedKey.reset();
        slot=getSlot(firstEncodedKey);
      }
      if (clusterCommand.isMoved()) {
        target=getMoveTarget(clusterCommand.getError());
        clusterEventListener.onMovedRedirection();
        asking=false;
        publish(new MovedRedirectionEvent(clusterCommand.getType().name(),keyAsString,slot,clusterCommand.getError()));
      }
 else {
        target=getAskTarget(clusterCommand.getError());
        asking=true;
        clusterEventListener.onAskRedirection();
        publish(new AskRedirectionEvent(clusterCommand.getType().name(),keyAsString,slot,clusterCommand.getError()));
      }
      command.getOutput().setError((String)null);
      CompletableFuture<StatefulRedisConnection<K,V>> connectFuture=asyncClusterConnectionProvider.getConnectionAsync(ConnectionIntent.WRITE,target.getHostText(),target.getPort());
      if (isSuccessfullyCompleted(connectFuture)) {
        writeCommand(command,asking,connectFuture.join(),null);
      }
 else {
        connectFuture.whenComplete((connection,throwable) -> writeCommand(command,asking,connection,throwable));
      }
      return command;
    }
  }
  ClusterCommand<K,V,T> commandToSend=getCommandToSend(command);
  CommandArgs<K,V> args=command.getArgs();
  if (args != null && !CommandType.CLIENT.equals(commandToSend.getType())) {
    ByteBuffer encodedKey=args.getFirstEncodedKey();
    if (encodedKey != null) {
      int hash=getSlot(encodedKey);
      ConnectionIntent connectionIntent=getIntent(command.getType());
      CompletableFuture<StatefulRedisConnection<K,V>> connectFuture=((AsyncClusterConnectionProvider)clusterConnectionProvider).getConnectionAsync(connectionIntent,hash);
      if (isSuccessfullyCompleted(connectFuture)) {
        writeCommand(commandToSend,false,connectFuture.join(),null);
      }
 else {
        connectFuture.whenComplete((connection,throwable) -> writeCommand(commandToSend,false,connection,throwable));
      }
      return commandToSend;
    }
  }
  writeCommand(commandToSend,defaultWriter);
  return commandToSend;
}

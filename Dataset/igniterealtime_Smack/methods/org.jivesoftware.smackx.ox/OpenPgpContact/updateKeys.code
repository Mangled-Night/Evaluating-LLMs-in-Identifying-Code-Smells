/** 
 * Update the contacts keys by consulting the users PubSub nodes. This method fetches the users metadata node and then tries to fetch any announced keys.
 * @param connection our {@link XMPPConnection}.
 * @throws InterruptedException In case the thread gets interrupted.
 * @throws SmackException.NotConnectedException in case the connection is not connected.
 * @throws SmackException.NoResponseException in case the server doesn't respond.
 * @throws XMPPException.XMPPErrorException in case of an XMPP protocol error.
 * @throws PubSubException.NotALeafNodeException in case the metadata node is not a {@link LeafNode}.
 * @throws PubSubException.NotAPubSubNodeException in case the metadata node is not a PubSub node.
 * @throws IOException IO is brittle.
 */
public void updateKeys(XMPPConnection connection) throws InterruptedException, SmackException.NotConnectedException, SmackException.NoResponseException, XMPPException.XMPPErrorException, PubSubException.NotALeafNodeException, PubSubException.NotAPubSubNodeException, IOException {
  PublicKeysListElement metadata=OpenPgpPubSubUtil.fetchPubkeysList(connection,getJid());
  if (metadata == null) {
    return;
  }
  updateKeys(connection,metadata);
}
/** 
 * Update the contacts keys using a prefetched  {@link PublicKeysListElement}.
 * @param connection our {@link XMPPConnection}.
 * @param metadata pre-fetched OX metadata node of the contact.
 * @throws InterruptedException in case the thread gets interrupted.
 * @throws SmackException.NotConnectedException in case the connection is not connected.
 * @throws SmackException.NoResponseException in case the server doesn't respond.
 * @throws IOException IO is dangerous.
 */
public void updateKeys(XMPPConnection connection,PublicKeysListElement metadata) throws InterruptedException, SmackException.NotConnectedException, SmackException.NoResponseException, IOException {
  Map<OpenPgpV4Fingerprint,Date> fingerprintsAndDates=new HashMap<>();
  for (  OpenPgpV4Fingerprint fingerprint : metadata.getMetadata().keySet()) {
    fingerprintsAndDates.put(fingerprint,metadata.getMetadata().get(fingerprint).getDate());
  }
  store.setAnnouncedFingerprintsOf(getJid(),fingerprintsAndDates);
  Map<OpenPgpV4Fingerprint,Date> fetchDates=store.getPublicKeyFetchDates(getJid());
  for (  OpenPgpV4Fingerprint fingerprint : metadata.getMetadata().keySet()) {
    Date fetchDate=fetchDates.get(fingerprint);
    if (fetchDate != null && fingerprintsAndDates.get(fingerprint) != null && fetchDate.after(fingerprintsAndDates.get(fingerprint))) {
      LOGGER.log(Level.FINE,"Skip key " + Long.toHexString(fingerprint.getKeyId()) + " as we already have the most recent version. "+ "Last announced: "+ fingerprintsAndDates.get(fingerprint).toString()+ " Last fetched: "+ fetchDate.toString());
      continue;
    }
    try {
      PubkeyElement key=OpenPgpPubSubUtil.fetchPubkey(connection,getJid(),fingerprint);
      unfetchableKeys.remove(fingerprint);
      fetchDates.put(fingerprint,new Date());
      if (key == null) {
        LOGGER.log(Level.WARNING,"Public key " + Long.toHexString(fingerprint.getKeyId()) + " can not be imported: Is null");
        unfetchableKeys.put(fingerprint,new NullPointerException("Public key is null."));
        continue;
      }
      PGPPublicKeyRing keyRing=new PGPPublicKeyRing(Base64.decode(key.getDataElement().getB64Data()),new BcKeyFingerprintCalculator());
      store.importPublicKey(getJid(),keyRing);
    }
 catch (    PubSubException.NotAPubSubNodeException|PubSubException.NotALeafNodeException|XMPPException.XMPPErrorException e) {
      LOGGER.log(Level.WARNING,"Error fetching public key " + Long.toHexString(fingerprint.getKeyId()),e);
      unfetchableKeys.put(fingerprint,e);
    }
catch (    PGPException|IOException e) {
      LOGGER.log(Level.WARNING,"Public key " + Long.toHexString(fingerprint.getKeyId()) + " can not be imported.",e);
      unfetchableKeys.put(fingerprint,e);
    }
catch (    MissingUserIdOnKeyException e) {
      LOGGER.log(Level.WARNING,"Public key " + Long.toHexString(fingerprint.getKeyId()) + " is missing the user-id \"xmpp:"+ getJid()+ "\". Refuse to import it.",e);
      unfetchableKeys.put(fingerprint,e);
    }
  }
  store.setPublicKeyFetchDates(getJid(),fetchDates);
}

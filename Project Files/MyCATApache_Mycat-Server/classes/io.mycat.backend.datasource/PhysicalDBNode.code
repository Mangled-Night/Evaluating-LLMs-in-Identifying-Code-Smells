public class PhysicalDBNode {
  protected static final Logger LOGGER=LoggerFactory.getLogger(PhysicalDBNode.class);
  protected final String name;
  protected final String database;
  protected final PhysicalDBPool dbPool;
  public PhysicalDBNode(  String hostName,  String database,  PhysicalDBPool dbPool){
    this.name=hostName;
    this.database=database;
    this.dbPool=dbPool;
  }
  public String getName(){
    return name;
  }
  public PhysicalDBPool getDbPool(){
    return dbPool;
  }
  public String getDatabase(){
    return database;
  }
  /** 
 * get connection from the same datasource
 * @param exitsCon
 * @throws Exception
 */
  public void getConnectionFromSameSource(  String schema,  boolean autocommit,  BackendConnection exitsCon,  ResponseHandler handler,  Object attachment) throws Exception {
    PhysicalDatasource ds=this.dbPool.findDatasouce(exitsCon);
    if (ds == null) {
      throw new RuntimeException("can't find existing connection,maybe fininshed " + exitsCon);
    }
 else {
      ds.getConnection(schema,autocommit,handler,attachment);
    }
  }
  private void checkRequest(  String schema){
    if (schema != null && !schema.equals(this.database)) {
      throw new RuntimeException("invalid param ,connection request db is :" + schema + " and datanode db is "+ this.database);
    }
    if (!dbPool.isInitSuccess()) {
      dbPool.init(dbPool.activedIndex);
    }
  }
  public void getConnection(  String schema,  boolean autoCommit,  RouteResultsetNode rrs,  ResponseHandler handler,  Object attachment) throws Exception {
    checkRequest(schema);
    boolean needMaster=!autoCommit && MycatServer.getInstance().getConfig().getSystem().isStrictTxIsolation();
    if (needMaster && rrs.getRunOnSlave() == null) {
      rrs.setRunOnSlave(false);
    }
    if (dbPool.isInitSuccess()) {
      LOGGER.debug("rrs.getRunOnSlave() " + rrs.getRunOnSlaveDebugInfo());
      if (rrs.getRunOnSlave() != null) {
        if (rrs.getRunOnSlave()) {
          LOGGER.debug("rrs.isHasBlanceFlag() " + rrs.isHasBlanceFlag());
          if (rrs.isHasBlanceFlag()) {
            dbPool.getReadBanlanceCon(schema,autoCommit,handler,attachment,this.database);
          }
 else {
            LOGGER.debug("rrs.isHasBlanceFlag()" + rrs.isHasBlanceFlag());
            if (!dbPool.getReadCon(schema,autoCommit,handler,attachment,this.database)) {
              LOGGER.warn("Do not have slave connection to use, use master connection instead.");
              PhysicalDatasource writeSource=dbPool.getSource();
              writeSource.setWriteCount();
              writeSource.getConnection(schema,autoCommit,handler,attachment);
              rrs.setRunOnSlave(false);
              rrs.setCanRunInReadDB(false);
            }
          }
        }
 else {
          LOGGER.debug("rrs.getRunOnSlave() " + rrs.getRunOnSlaveDebugInfo());
          PhysicalDatasource writeSource=dbPool.getSource();
          writeSource.setWriteCount();
          writeSource.getConnection(schema,autoCommit,handler,attachment);
          rrs.setCanRunInReadDB(false);
        }
      }
 else {
        LOGGER.debug("rrs.getRunOnSlave() " + rrs.getRunOnSlaveDebugInfo());
        if (rrs.canRunnINReadDB(autoCommit)) {
          dbPool.getRWBanlanceCon(schema,autoCommit,handler,attachment,this.database);
        }
 else {
          PhysicalDatasource writeSource=dbPool.getSource();
          writeSource.setWriteCount();
          writeSource.getConnection(schema,autoCommit,handler,attachment);
        }
      }
    }
 else {
      throw new IllegalArgumentException("Invalid DataSource:" + dbPool.getActivedIndex());
    }
  }
}

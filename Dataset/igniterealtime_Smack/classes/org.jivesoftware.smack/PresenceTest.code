/** 
 * Ensure that the server is delivering messages to the correct client based on the client's presence priority.
 * @author Gaston Dombiak
 */
public class PresenceTest extends SmackTestCase {
  public PresenceTest(  String arg0){
    super(arg0);
  }
  /** 
 * XMPPConnection(0) will send messages to the bareJID of XMPPConnection(1) where the user of XMPPConnection(1) has logged from two different places with different presence priorities.
 */
  public void testMessageToHighestPriority(){
    XMPPTCPConnection conn=null;
    try {
      conn=createConnection();
      conn.connect();
      conn.login(getUsername(1),getUsername(1),"OtherPlace");
      getConnection(1).sendStanza(new Presence(Presence.Type.available,null,1,Presence.Mode.available));
      conn.sendStanza(new Presence(Presence.Type.available,null,2,Presence.Mode.available));
      Thread.sleep(150);
      Chat chat0=getConnection(0).getChatManager().createChat(getBareJID(1),null);
      Chat chat1=getConnection(1).getChatManager().createChat(getBareJID(0),chat0.getThreadID(),null);
      Chat chat2=conn.getChatManager().createChat(getBareJID(0),chat0.getThreadID(),null);
      chat0.sendMessage("Hello");
      getConnection(1).sendStanza(new Presence(Presence.Type.available,null,2,Presence.Mode.available));
      conn.sendStanza(new Presence(Presence.Type.available,null,1,Presence.Mode.available));
      Thread.sleep(150);
      chat0.sendMessage("Hello");
      conn.disconnect();
      Thread.sleep(150);
      chat0.sendMessage("Hello");
      getConnection(1).sendStanza(new Presence(Presence.Type.available,null,2,Presence.Mode.available));
      conn=createConnection();
      conn.connect();
      conn.login(getUsername(1),getPassword(1),"OtherPlace");
      conn.sendStanza(new Presence(Presence.Type.available,null,1,Presence.Mode.available));
      chat2=conn.getChatManager().createChat(getBareJID(0),chat0.getThreadID(),null);
      Thread.sleep(150);
      chat0.sendMessage("Hello");
      getConnection(1).sendStanza(new Presence(Presence.Type.available,null,1,Presence.Mode.available));
      conn.sendStanza(new Presence(Presence.Type.available,null,2,Presence.Mode.available));
      Thread.sleep(150);
      chat0.sendMessage("Hello");
    }
 catch (    Exception e) {
      e.printStackTrace();
      fail(e.getMessage());
    }
 finally {
      if (conn != null) {
        conn.disconnect();
      }
    }
  }
  /** 
 * User1 logs from 2 resources but only one is available. User0 sends a message to the full JID of the unavailable resource. User1 in the not available resource should receive the message. TODO Fix this in Wildfire but before check if XMPP spec requests this feature
 */
  public void testNotAvailablePresence() throws XMPPException {
    getConnection(1).sendStanza(new Presence(Presence.Type.unavailable));
    XMPPTCPConnection conn=createConnection();
    conn.connect();
    conn.login(getUsername(1),getPassword(1),"OtherPlace");
    Chat chat0=getConnection(0).getChatManager().createChat(getFullJID(1),null);
    Chat chat1=getConnection(1).getChatManager().createChat(getBareJID(0),chat0.getThreadID(),null);
    chat0.sendMessage("Hello");
    conn.disconnect();
  }
  /** 
 * User1 is connected from 2 resources. User1 adds User0 to his roster. Ensure that presences are correctly retrieved for User1. User1 logs off from one resource and ensure that presences are still correct for User1.
 */
  public void testMultipleResources() throws Exception {
    ConnectionConfiguration connectionConfiguration=new ConnectionConfiguration(getHost(),getPort(),getXMPPServiceDomain());
    XMPPTCPConnection conn4=new XMPPConnection(connectionConfiguration);
    conn4.connect();
    conn4.login(getUsername(1),getPassword(1),"Home");
    Roster roster=getConnection(0).getRoster();
    roster.createEntry(getBareJID(1),"gato1",null);
    long initial=System.currentTimeMillis();
    while (System.currentTimeMillis() - initial < 2000 && (!roster.getPresence(getBareJID(1)).isAvailable())) {
      Thread.sleep(100);
    }
    Presence presence=roster.getPresence(getBareJID(1));
    assertTrue("Returned an offline Presence for an existing user",presence.isAvailable());
    presence=roster.getPresenceResource(getBareJID(1) + "/Home");
    assertTrue("Returned an offline Presence for Home resource",presence.isAvailable());
    presence=roster.getPresenceResource(getFullJID(1));
    assertTrue("Returned an offline Presence for Smack resource",presence.isAvailable());
    Iterator<Presence> presences=roster.getPresences(getBareJID(1));
    assertTrue("Returned an offline Presence for an existing user",presence.isAvailable());
    assertNotNull("No presence was found for user1",presences);
    assertTrue("No presence was found for user1",presences.hasNext());
    presences.next();
    assertTrue("Only one presence was found for user1",presences.hasNext());
    conn4.disconnect();
    Thread.sleep(700);
    presence=roster.getPresence(getBareJID(1));
    assertTrue("Returned a null Presence for an existing user",presence.isAvailable());
    presence=roster.getPresenceResource(getFullJID(1));
    assertTrue("Returned a null Presence for Smack resource",presence.isAvailable());
    presence=roster.getPresenceResource(getBareJID(1) + "/Home");
    assertTrue("Returned a Presence for no longer connected resource",!presence.isAvailable());
    presences=roster.getPresences(getBareJID(1));
    assertNotNull("No presence was found for user1",presences);
    Presence value=presences.next();
    assertTrue("No presence was found for user1",value.isAvailable());
    assertFalse("More than one presence was found for user1",presences.hasNext());
  }
  /** 
 * User1 logs in, then sets offline presence information (presence with status text). User2 logs in and checks to see if offline presence is returned.
 * @throws Exception if an exception occurs.
 */
  public void testOfflineStatusPresence() throws Exception {
    Roster roster=getConnection(0).getRoster();
    roster.createEntry(getBareJID(1),"gato1",null);
    long initial=System.currentTimeMillis();
    while (System.currentTimeMillis() - initial < 2000 && (roster.getPresence(getBareJID(1)).getType().equals(Presence.Type.unavailable))) {
      Thread.sleep(100);
    }
    Presence offlinePresence=new Presence(Presence.Type.unavailable);
    offlinePresence.setStatus("Offline test");
    getConnection(1).disconnect(offlinePresence);
    Thread.sleep(500);
    Presence presence=getConnection(0).getRoster().getPresence(getBareJID(1));
    assertEquals("Offline presence status not received.","Offline test",presence.getStatus());
    getConnection(0).disconnect();
    XMPPTCPConnection con0=getConnection(0);
    con0.connect();
    con0.login(getUsername(0),getUsername(0));
    Thread.sleep(500);
    presence=con0.getRoster().getPresence(getBareJID(1));
    assertTrue("Offline presence status not received after logout.","Offline test".equals(presence.getStatus()));
  }
  protected int getMaxConnections(){
    return 2;
  }
}

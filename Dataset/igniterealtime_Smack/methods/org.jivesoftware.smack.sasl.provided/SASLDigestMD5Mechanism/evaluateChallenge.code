@Override protected byte[] evaluateChallenge(byte[] challenge) throws SmackSaslException {
  if (challenge.length == 0) {
    throw new SmackSaslException("Initial challenge has zero length");
  }
  String challengeString=new String(challenge,StandardCharsets.UTF_8);
  String[] challengeParts=challengeString.split(",");
  byte[] response=null;
switch (state) {
case INITIAL:
    for (    String part : challengeParts) {
      String[] keyValue=part.split("=",2);
      String key=keyValue[0];
      key=key.replaceFirst("^\\s+","");
      String value=keyValue[1];
      if ("nonce".equals(key)) {
        if (nonce != null) {
          throw new SmackSaslException("Nonce value present multiple times");
        }
        nonce=value.replace("\"","");
      }
 else       if ("qop".equals(key)) {
        value=value.replace("\"","");
        if (!value.equals("auth")) {
          throw new SmackSaslException("Unsupported qop operation: " + value);
        }
      }
    }
  if (nonce == null) {
    throw new SmackSaslException("nonce value not present in initial challenge");
  }
byte[] a1FirstPart=MD5.bytes(authenticationId + ':' + serviceName+ ':'+ password);
cnonce=StringUtils.randomString(32);
byte[] a1=ByteUtils.concat(a1FirstPart,toBytes(':' + nonce + ':'+ cnonce));
digestUri="xmpp/" + serviceName;
hex_hashed_a1=StringUtils.encodeHex(MD5.bytes(a1));
String responseValue=calcResponse(DigestType.ClientResponse);
String authzid;
if (authorizationId == null) {
authzid="";
}
 else {
authzid=",authzid=\"" + authorizationId + '"';
}
String saslString="username=\"" + quoteBackslash(authenticationId) + '"'+ authzid+ ",realm=\""+ serviceName+ '"'+ ",nonce=\""+ nonce+ '"'+ ",cnonce=\""+ cnonce+ '"'+ ",nc="+ INITAL_NONCE+ ",qop=auth"+ ",digest-uri=\""+ digestUri+ '"'+ ",response="+ responseValue+ ",charset=utf-8";
response=toBytes(saslString);
state=State.RESPONSE_SENT;
break;
case RESPONSE_SENT:
if (verifyServerResponse) {
String serverResponse=null;
for (String part : challengeParts) {
String[] keyValue=part.split("=");
assert keyValue.length == 2;
String key=keyValue[0];
String value=keyValue[1];
if ("rspauth".equals(key)) {
serverResponse=value;
break;
}
}
if (serverResponse == null) {
throw new SmackSaslException("No server response received while performing " + NAME + " authentication");
}
String expectedServerResponse=calcResponse(DigestType.ServerResponse);
if (!serverResponse.equals(expectedServerResponse)) {
throw new SmackSaslException("Invalid server response  while performing " + NAME + " authentication");
}
}
state=State.VALID_SERVER_RESPONSE;
break;
default :
throw new IllegalStateException();
}
return response;
}

private class BufferIterator implements Iterator<T> {
  private int index;
  private int prevIndex=-1;
  @Override public boolean hasNext(){
    return index < occupancy;
  }
  @Override public T next(){
    if (index >= occupancy) {
      throw new NoSuchElementException();
    }
    prevIndex=index;
    return get(index++);
  }
  @Override public void remove(){
    if (prevIndex >= 0) {
      CircularBuffer.this.remove(prevIndex);
      index=prevIndex;
      prevIndex=-1;
    }
 else {
      throw new IllegalStateException();
    }
  }
}

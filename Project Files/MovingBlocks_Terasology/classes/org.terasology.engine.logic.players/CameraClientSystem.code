/** 
 * This is a system that creates and maintains a client side entity for the camera. <p> Entity Creation Flow: - ClientComponent for the local player added or changed - If Camera does not exist, create "engine:camera" entity - Save the ClientComponent with the new camera attached <p> Reset Camera Event Flow: - ResetCameraEvent - Camera entity on the ClientComponent is destroyed and set to EntityRef.NULL - ClientComponent is saved <p> Auto Mount Camera Flow: - ClientComponent or AutoMountCameraComponent for the local player added or changed - The local player's camera entity (created from above steps) is location linked to the Gaze Entity
 */
@RegisterSystem(RegisterMode.CLIENT) public class CameraClientSystem extends BaseComponentSystem {
  @In LocalPlayer localPlayer;
  @In EntityManager entityManager;
  @ReceiveEvent public void ensureCameraEntityCreatedOnChangedClientComponent(  OnChangedComponent event,  EntityRef client,  ClientComponent clientComponent){
    if (localPlayer.getClientEntity().equals(client)) {
      ensureCameraEntityCreated();
    }
  }
  @ReceiveEvent public void ensureCameraEntityCreatedOnActivateClientComponent(  OnActivatedComponent event,  EntityRef client,  ClientComponent clientComponent){
    if (localPlayer.getClientEntity().equals(client)) {
      ensureCameraEntityCreated();
    }
  }
  private void ensureCameraEntityCreated(){
    if (!localPlayer.getCameraEntity().exists()) {
      ClientComponent clientComponent=localPlayer.getClientEntity().getComponent(ClientComponent.class);
      EntityBuilder builder=entityManager.newBuilder("engine:camera");
      builder.setPersistent(false);
      clientComponent.camera=builder.build();
      clientComponent.camera.setScope(EntityScope.GLOBAL);
      localPlayer.getClientEntity().saveComponent(clientComponent);
    }
  }
  @ReceiveEvent public void resetCameraOnCharacterSpawn(  OnPlayerSpawnedEvent event,  EntityRef character){
    if (localPlayer.getCharacterEntity().equals(character)) {
      resetCamera();
    }
  }
  @Command(shortDescription="Reset the camera position",requiredPermission=PermissionManager.NO_PERMISSION) public void resetCamera(){
    localPlayer.getClientEntity().send(new ResetCameraEvent());
  }
  @ReceiveEvent public void resetCameraForClient(  ResetCameraEvent resetCameraEvent,  EntityRef entityRef,  ClientComponent clientComponent){
    if (localPlayer.getClientEntity().equals(entityRef)) {
      clientComponent.camera.destroy();
      clientComponent.camera=EntityRef.NULL;
      localPlayer.getClientEntity().saveComponent(clientComponent);
    }
  }
  @ReceiveEvent public void mountCameraOnActivate(  OnActivatedComponent event,  EntityRef entityRef,  AutoMountCameraComponent autoMountCameraComponent,  ClientComponent clientComponent){
    if (localPlayer.getClientEntity().equals(entityRef) && clientComponent.camera.exists()) {
      mountCamera();
    }
  }
  @ReceiveEvent public void mountCameraOnChange(  OnChangedComponent event,  EntityRef entityRef,  AutoMountCameraComponent autoMountCameraComponent,  ClientComponent clientComponent){
    if (localPlayer.getClientEntity().equals(entityRef) && clientComponent.camera.exists()) {
      mountCamera();
    }
  }
  private void mountCamera(){
    ClientComponent clientComponent=localPlayer.getClientEntity().getComponent(ClientComponent.class);
    EntityRef targetEntityForCamera=GazeAuthoritySystem.getGazeEntityForCharacter(clientComponent.character);
    LocationComponent cameraLocation=clientComponent.camera.getComponent(LocationComponent.class);
    if (cameraLocation != null) {
      Location.attachChild(targetEntityForCamera,clientComponent.camera,cameraLocation.getLocalPosition(),new Quaternionf());
    }
 else {
      Location.attachChild(targetEntityForCamera,clientComponent.camera,new Vector3f(0,0,0),new Quaternionf());
    }
  }
}

/** 
 * This system adds meshes to items that have RenderItemBlockMeshComponent or RenderItemIconMeshComponent
 */
@RegisterSystem public class ItemCommonSystem extends BaseComponentSystem {
  private static Random rand=new FastRandom();
  @ReceiveEvent public void onRenderItemIconMeshActivated(  OnActivatedComponent event,  EntityRef item,  RenderItemIconMeshComponent renderItemIconMeshComponent,  ItemComponent itemComponent){
    addOrUpdateItemMeshComponent(itemComponent,item);
  }
  @ReceiveEvent public void onRenderItemIconMeshChanged(  OnChangedComponent event,  EntityRef item,  RenderItemIconMeshComponent renderItemIconMeshComponent,  ItemComponent itemComponent){
    addOrUpdateItemMeshComponent(itemComponent,item);
  }
  @ReceiveEvent public void onRenderItemBlockMeshActivated(  OnActivatedComponent event,  EntityRef item,  RenderItemBlockMeshComponent renderItemBlockMeshComponent,  BlockItemComponent blockItemComponent,  ItemComponent itemComponent){
    addOrUpdateBlockMeshComponent(blockItemComponent,item);
  }
  @ReceiveEvent public void onRenderItemBlockMeshChanged(  OnChangedComponent event,  EntityRef item,  RenderItemBlockMeshComponent renderItemBlockMeshComponent,  BlockItemComponent blockItemComponent,  ItemComponent itemComponent){
    addOrUpdateBlockMeshComponent(blockItemComponent,item);
  }
  public static void addOrUpdateItemMeshComponent(  ItemComponent itemComponent,  MutableComponentContainer entity){
    if (itemComponent != null) {
      MeshComponent meshComponent=null;
      if (entity.hasComponent(MeshComponent.class)) {
        meshComponent=entity.getComponent(MeshComponent.class);
      }
 else {
        meshComponent=new MeshComponent();
      }
      meshComponent.material=Assets.getMaterial("engine:droppedItem").get();
      if (itemComponent.icon != null) {
        meshComponent.mesh=IconMeshFactory.getIconMesh(itemComponent.icon);
      }
      entity.addOrSaveComponent(meshComponent);
    }
  }
  public static void addOrUpdateBlockMeshComponent(  BlockItemComponent blockItemComponent,  MutableComponentContainer entity){
    if (blockItemComponent != null) {
      MeshComponent meshComponent=null;
      if (entity.hasComponent(MeshComponent.class)) {
        meshComponent=entity.getComponent(MeshComponent.class);
      }
 else {
        meshComponent=new MeshComponent();
      }
      BlockFamily blockFamily=blockItemComponent.blockFamily;
      if (blockFamily == null) {
        return;
      }
      meshComponent.mesh=blockFamily.getArchetypeBlock().getMeshGenerator().getStandaloneMesh();
      meshComponent.material=Assets.getMaterial("engine:terrain").get();
      meshComponent.translucent=blockFamily.getArchetypeBlock().isTranslucent();
      float luminance=blockFamily.getArchetypeBlock().getLuminance() / 15f;
      meshComponent.selfLuminance=luminance;
      if (luminance > 0 && !entity.hasComponent(LightComponent.class)) {
        LightComponent lightComponent=entity.addComponent(new LightComponent());
        lightComponent.lightAttenuationRange*=luminance;
      }
      entity.addOrSaveComponent(meshComponent);
    }
  }
}

/** 
 * Unit tests for  {@link RedisClient}.
 * @author Mark Paluch
 */
@SuppressWarnings("unchecked") @ExtendWith(MockitoExtension.class) class RedisClientUnitTests {
  @Mock ClientResources clientResources;
  @Mock(extraInterfaces=Closeable.class) AsyncCloseable asyncCloseable;
  @Test void shutdownShouldDeferResourcesShutdown() throws Exception {
    when(clientResources.eventExecutorGroup()).thenReturn(ImmediateEventExecutor.INSTANCE);
    CompletableFuture<Void> completableFuture=new CompletableFuture<>();
    when(asyncCloseable.closeAsync()).thenReturn(completableFuture);
    RedisClient redisClient=RedisClient.create(clientResources,"redis://foo");
    Field field=AbstractRedisClient.class.getDeclaredField("sharedResources");
    field.setAccessible(true);
    field.set(redisClient,false);
    Set<AsyncCloseable> closeableResources=(Set)ReflectionTestUtils.getField(redisClient,"closeableResources");
    closeableResources.add(asyncCloseable);
    CompletableFuture<Void> future=redisClient.shutdownAsync();
    verify(asyncCloseable).closeAsync();
    verify(clientResources,never()).shutdown(anyLong(),anyLong(),any());
    assertThat(future).isNotDone();
  }
  @Test void shutdownShutsDownResourcesAfterChannels() throws Exception {
    when(clientResources.eventExecutorGroup()).thenReturn(ImmediateEventExecutor.INSTANCE);
    CompletableFuture<Void> completableFuture=new CompletableFuture<>();
    when(asyncCloseable.closeAsync()).thenReturn(completableFuture);
    RedisClient redisClient=RedisClient.create(clientResources,"redis://foo");
    Field field=AbstractRedisClient.class.getDeclaredField("sharedResources");
    field.setAccessible(true);
    field.set(redisClient,false);
    Set<AsyncCloseable> closeableResources=(Set)ReflectionTestUtils.getField(redisClient,"closeableResources");
    closeableResources.add(asyncCloseable);
    CompletableFuture<Void> future=redisClient.shutdownAsync();
    verify(asyncCloseable).closeAsync();
    verify(clientResources,never()).shutdown(anyLong(),anyLong(),any());
    completableFuture.complete(null);
    verify(clientResources).shutdown(anyLong(),anyLong(),any());
    assertThat(future).isDone();
  }
}

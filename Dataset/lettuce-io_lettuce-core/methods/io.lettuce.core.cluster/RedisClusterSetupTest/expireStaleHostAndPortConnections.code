@Test public void expireStaleHostAndPortConnections() throws Exception {
  clusterClient.setOptions(ClusterClientOptions.builder().build());
  RedisAdvancedClusterAsyncCommands<String,String> clusterConnection=clusterClient.connect().async();
  ClusterSetup.setup2Masters(clusterHelper);
  final PooledClusterConnectionProvider<String,String> clusterConnectionProvider=getPooledClusterConnectionProvider(clusterConnection);
  assertThat(clusterConnectionProvider.getConnectionCount()).isEqualTo(0);
  assertRoutedExecution(clusterConnection);
  assertThat(clusterConnectionProvider.getConnectionCount()).isEqualTo(2);
  for (  RedisClusterNode redisClusterNode : clusterClient.getPartitions()) {
    clusterConnection.getConnection(redisClusterNode.getUri().getHost(),redisClusterNode.getUri().getPort());
    clusterConnection.getConnection(redisClusterNode.getNodeId());
  }
  assertThat(clusterConnectionProvider.getConnectionCount()).isEqualTo(4);
  Partitions partitions=ClusterPartitionParser.parse(redis1.clusterNodes());
  for (  RedisClusterNode redisClusterNode : partitions.getPartitions()) {
    if (!redisClusterNode.getFlags().contains(RedisClusterNode.NodeFlag.MYSELF)) {
      redis1.clusterForget(redisClusterNode.getNodeId());
    }
  }
  partitions=ClusterPartitionParser.parse(redis2.clusterNodes());
  for (  RedisClusterNode redisClusterNode : partitions.getPartitions()) {
    if (!redisClusterNode.getFlags().contains(RedisClusterNode.NodeFlag.MYSELF)) {
      redis2.clusterForget(redisClusterNode.getNodeId());
    }
  }
  clusterClient.reloadPartitions();
  Wait.untilEquals(1,() -> clusterClient.getPartitions().size()).waitOrTimeout();
  Wait.untilEquals(2L,() -> clusterConnectionProvider.getConnectionCount()).waitOrTimeout();
  clusterConnection.getStatefulConnection().close();
}

@ApiOperation(value="登录") @RequestMapping(value="/login",method=RequestMethod.GET) public String login(HttpServletRequest request){
  Subject subject=SecurityUtils.getSubject();
  Session session=subject.getSession();
  String serverSessionId=session.getId().toString();
  String code=RedisUtil.get(ZHENG_UPMS_SERVER_SESSION_ID + "_" + serverSessionId);
  if (StringUtils.isNotBlank(code)) {
    String backurl=request.getParameter("backurl");
    String username=(String)subject.getPrincipal();
    if (StringUtils.isBlank(backurl)) {
      backurl="/";
    }
 else {
      if (backurl.contains("?")) {
        backurl+="&upms_code=" + code + "&upms_username="+ username;
      }
 else {
        backurl+="?upms_code=" + code + "&upms_username="+ username;
      }
    }
    LOGGER.debug("认证中心帐号通过，带code回跳：{}",backurl);
    return "redirect:" + backurl;
  }
  return "/sso/login.jsp";
}
@ApiOperation(value="登录") @RequestMapping(value="/login",method=RequestMethod.POST) @ResponseBody public Object login(HttpServletRequest request,HttpServletResponse response,ModelMap modelMap){
  String username=request.getParameter("username");
  String password=request.getParameter("password");
  String rememberMe=request.getParameter("rememberMe");
  if (StringUtils.isBlank(username)) {
    return new UpmsResult(UpmsResultConstant.EMPTY_USERNAME,"帐号不能为空！");
  }
  if (StringUtils.isBlank(password)) {
    return new UpmsResult(UpmsResultConstant.EMPTY_PASSWORD,"密码不能为空！");
  }
  Subject subject=SecurityUtils.getSubject();
  Session session=subject.getSession();
  String sessionId=session.getId().toString();
  String hasCode=RedisUtil.get(ZHENG_UPMS_SERVER_SESSION_ID + "_" + sessionId);
  if (StringUtils.isBlank(hasCode)) {
    UsernamePasswordToken usernamePasswordToken=new UsernamePasswordToken(username,password);
    try {
      if (BooleanUtils.toBoolean(rememberMe)) {
        usernamePasswordToken.setRememberMe(true);
      }
 else {
        usernamePasswordToken.setRememberMe(false);
      }
      subject.login(usernamePasswordToken);
    }
 catch (    UnknownAccountException e) {
      return new UpmsResult(UpmsResultConstant.INVALID_USERNAME,"帐号不存在！");
    }
catch (    IncorrectCredentialsException e) {
      return new UpmsResult(UpmsResultConstant.INVALID_PASSWORD,"密码错误！");
    }
catch (    LockedAccountException e) {
      return new UpmsResult(UpmsResultConstant.INVALID_ACCOUNT,"帐号已锁定！");
    }
    upmsSessionDao.updateStatus(sessionId,UpmsSession.OnlineStatus.on_line);
    RedisUtil.lpush(ZHENG_UPMS_SERVER_SESSION_IDS,sessionId.toString());
    String code=UUID.randomUUID().toString();
    RedisUtil.set(ZHENG_UPMS_SERVER_SESSION_ID + "_" + sessionId,code,(int)subject.getSession().getTimeout() / 1000);
    RedisUtil.set(ZHENG_UPMS_SERVER_CODE + "_" + code,code,(int)subject.getSession().getTimeout() / 1000);
  }
  String backurl=request.getParameter("backurl");
  if (StringUtils.isBlank(backurl)) {
    UpmsSystem upmsSystem=upmsSystemService.selectUpmsSystemByName(PropertiesFileUtil.getInstance().get("app.name"));
    backurl=null == upmsSystem ? "/" : upmsSystem.getBasepath();
    return new UpmsResult(UpmsResultConstant.SUCCESS,backurl);
  }
 else {
    return new UpmsResult(UpmsResultConstant.SUCCESS,backurl);
  }
}

/** 
 * show tables impl
 * @author yanglixue
 */
public class ShowFullTables {
  private static final int FIELD_COUNT=2;
  private static final ResultSetHeaderPacket header=PacketUtil.getHeader(FIELD_COUNT);
  private static final FieldPacket[] fields=new FieldPacket[FIELD_COUNT];
  private static final EOFPacket eof=new EOFPacket();
  private static final String SCHEMA_KEY="schemaName";
  /** 
 * response method.
 * @param c
 */
  public static void response(  ServerConnection c,  String stmt,  int type){
    String showSchema=SchemaUtil.parseShowTableSchema(stmt);
    if (showSchema == null) {
      showSchema=c.getSchema();
    }
    SchemaConfig schema=MycatServer.getInstance().getConfig().getSchemas().get(showSchema);
    if (schema != null) {
      String node=schema.getDataNode();
      if (!Strings.isNullOrEmpty(node)) {
        c.execute(stmt,ServerParse.SHOW);
        return;
      }
 else {
        reponseLogicTable(c,stmt);
        return;
      }
    }
 else {
      c.writeErrMessage(ErrorCode.ER_NO_DB_ERROR,"Cannot find the corresponding logic schema of Mycat");
      return;
    }
  }
  private static void reponseLogicTable(  ServerConnection c,  String stmt){
    Map<String,String> parm=buildFields(c,stmt);
    Set<String> tableSet=getTableSet(c,parm);
    int i=0;
    byte packetId=0;
    header.packetId=++packetId;
    fields[i]=PacketUtil.getField("Tables in " + parm.get(SCHEMA_KEY),Fields.FIELD_TYPE_VAR_STRING);
    fields[i].packetId=++packetId;
    fields[i + 1]=PacketUtil.getField("Table_type  ",Fields.FIELD_TYPE_VAR_STRING);
    fields[i + 1].packetId=++packetId;
    eof.packetId=++packetId;
    ByteBuffer buffer=c.allocate();
    buffer=header.write(buffer,c,true);
    for (    FieldPacket field : fields) {
      buffer=field.write(buffer,c,true);
    }
    buffer=eof.write(buffer,c,true);
    packetId=eof.packetId;
    for (    String name : tableSet) {
      RowDataPacket row=new RowDataPacket(FIELD_COUNT);
      row.add(StringUtil.encode(name,c.getCharset()));
      row.add(StringUtil.encode("BASE TABLE",c.getCharset()));
      row.packetId=++packetId;
      buffer=row.write(buffer,c,true);
    }
    EOFPacket lastEof=new EOFPacket();
    lastEof.packetId=++packetId;
    buffer=lastEof.write(buffer,c,true);
    c.write(buffer);
  }
  public static Set<String> getTableSet(  ServerConnection c,  String stmt){
    Map<String,String> parm=buildFields(c,stmt);
    return getTableSet(c,parm);
  }
  private static Set<String> getTableSet(  ServerConnection c,  Map<String,String> parm){
    TreeSet<String> tableSet=new TreeSet<String>();
    MycatConfig conf=MycatServer.getInstance().getConfig();
    Map<String,UserConfig> users=conf.getUsers();
    UserConfig user=users == null ? null : users.get(c.getUser());
    if (user != null) {
      Map<String,SchemaConfig> schemas=conf.getSchemas();
      for (      String name : schemas.keySet()) {
        if (null != parm.get(SCHEMA_KEY) && parm.get(SCHEMA_KEY).toUpperCase().equals(name.toUpperCase())) {
          if (null == parm.get("LIKE_KEY")) {
            tableSet.addAll(schemas.get(name).getTables().keySet());
          }
 else {
            String p="^" + parm.get("LIKE_KEY").replaceAll("%",".*");
            Pattern pattern=Pattern.compile(p,Pattern.CASE_INSENSITIVE);
            Matcher ma;
            for (            String tname : schemas.get(name).getTables().keySet()) {
              ma=pattern.matcher(tname);
              if (ma.matches()) {
                tableSet.add(tname);
              }
            }
          }
        }
      }
      ;
    }
    return tableSet;
  }
  /** 
 * build fields
 * @param c
 * @param stmt
 */
  private static Map<String,String> buildFields(  ServerConnection c,  String stmt){
    Map<String,String> map=new HashMap<String,String>();
    String fields[]=SchemaUtil.parseShowTable(stmt);
    if (null != fields[3] && (!"".equals(fields[3])) && (!"null".equals(fields[3]))) {
      map.put(SCHEMA_KEY,fields[3]);
    }
    if ((fields[5] == null || !"table_type".equals(fields[5])) && null != fields[8] && (!"".equals(fields[8])) && (!"null".equals(fields[8]))) {
      map.put("LIKE_KEY",fields[8]);
    }
    if (null == map.get(SCHEMA_KEY)) {
      map.put(SCHEMA_KEY,c.getSchema());
    }
    return map;
  }
}

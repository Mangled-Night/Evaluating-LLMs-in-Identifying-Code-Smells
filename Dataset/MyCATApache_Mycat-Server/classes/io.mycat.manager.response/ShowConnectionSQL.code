/** 
 * @author mycat
 */
public final class ShowConnectionSQL {
  private static final int FIELD_COUNT=7;
  private static final ResultSetHeaderPacket header=PacketUtil.getHeader(FIELD_COUNT);
  private static final FieldPacket[] fields=new FieldPacket[FIELD_COUNT];
  private static final EOFPacket eof=new EOFPacket();
static {
    int i=0;
    byte packetId=0;
    header.packetId=++packetId;
    fields[i]=PacketUtil.getField("ID",Fields.FIELD_TYPE_LONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("HOST",Fields.FIELD_TYPE_VAR_STRING);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("USER",Fields.FIELD_TYPE_VAR_STRING);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("SCHEMA",Fields.FIELD_TYPE_VAR_STRING);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("START_TIME",Fields.FIELD_TYPE_LONGLONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("EXECUTE_TIME",Fields.FIELD_TYPE_LONGLONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("SQL",Fields.FIELD_TYPE_VAR_STRING);
    fields[i++].packetId=++packetId;
    eof.packetId=++packetId;
  }
  public static void execute(  ManagerConnection c){
    ByteBuffer buffer=c.allocate();
    buffer=header.write(buffer,c,true);
    for (    FieldPacket field : fields) {
      buffer=field.write(buffer,c,true);
    }
    buffer=eof.write(buffer,c,true);
    byte packetId=eof.packetId;
    String charset=c.getCharset();
    for (    NIOProcessor p : MycatServer.getInstance().getProcessors()) {
      for (      FrontendConnection fc : p.getFrontends().values()) {
        if (!fc.isClosed()) {
          if (fc.getExecuteSql() == null) {
            continue;
          }
          if (fc instanceof ServerConnection) {
            RowDataPacket row=getRow(fc,charset);
            row.packetId=++packetId;
            buffer=row.write(buffer,c,true);
          }
        }
      }
    }
    EOFPacket lastEof=new EOFPacket();
    lastEof.packetId=++packetId;
    buffer=lastEof.write(buffer,c,true);
    c.write(buffer);
  }
  private static RowDataPacket getRow(  FrontendConnection c,  String charset){
    String executeSql=c.getExecuteSql();
    RowDataPacket row=new RowDataPacket(FIELD_COUNT);
    row.add(LongUtil.toBytes(c.getId()));
    row.add(StringUtil.encode(c.getHost(),charset));
    row.add(StringUtil.encode(c.getUser(),charset));
    row.add(StringUtil.encode(c.getSchema(),charset));
    row.add(LongUtil.toBytes(c.getLastReadTime()));
    long rt=c.getLastReadTime();
    long wt=c.getLastWriteTime();
    row.add(LongUtil.toBytes(executeSql == null ? 0 : ((wt > rt) ? (wt - rt) : (TimeUtil.currentTimeMillis() - rt))));
    row.add(StringUtil.encode(executeSql == null ? "" : executeSql,charset));
    return row;
  }
}

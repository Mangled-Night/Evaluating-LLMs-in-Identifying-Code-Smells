/** 
 * 购物车下单
 * @param userId    用户ID
 * @param cartId    购物车商品ID：如果购物车商品ID是空，则下单当前用户所有购物车商品； 如果购物车商品ID非空，则只下单当前购物车商品。
 * @param addressId 收货地址ID：如果收货地址ID是空，则查询当前用户的默认地址。
 * @param couponId  优惠券ID：如果优惠券ID是空，则自动选择合适的优惠券。
 * @return 购物车操作结果
 */
@GetMapping("checkout") public Object checkout(@LoginUser Integer userId,Integer cartId,Integer addressId,Integer couponId,Integer userCouponId,Integer grouponRulesId){
  if (userId == null) {
    return ResponseUtil.unlogin();
  }
  LitemallAddress checkedAddress=null;
  if (addressId != null && !addressId.equals(0)) {
    checkedAddress=addressService.query(userId,addressId);
  }
  if (checkedAddress == null) {
    checkedAddress=addressService.findDefault(userId);
    if (checkedAddress == null) {
      checkedAddress=new LitemallAddress();
      checkedAddress.setId(0);
      addressId=0;
    }
 else {
      addressId=checkedAddress.getId();
    }
  }
  BigDecimal grouponPrice=new BigDecimal(0.00);
  LitemallGrouponRules grouponRules=grouponRulesService.findById(grouponRulesId);
  if (grouponRules != null) {
    grouponPrice=grouponRules.getDiscount();
  }
  List<LitemallCart> checkedGoodsList=null;
  if (cartId == null || cartId.equals(0)) {
    checkedGoodsList=cartService.queryByUidAndChecked(userId);
  }
 else {
    LitemallCart cart=cartService.findById(userId,cartId);
    if (cart == null) {
      return ResponseUtil.badArgumentValue();
    }
    checkedGoodsList=new ArrayList<>(1);
    checkedGoodsList.add(cart);
  }
  BigDecimal checkedGoodsPrice=new BigDecimal(0.00);
  for (  LitemallCart cart : checkedGoodsList) {
    if (grouponRules != null && grouponRules.getGoodsId().equals(cart.getGoodsId())) {
      checkedGoodsPrice=checkedGoodsPrice.add(cart.getPrice().subtract(grouponPrice).multiply(new BigDecimal(cart.getNumber())));
    }
 else {
      checkedGoodsPrice=checkedGoodsPrice.add(cart.getPrice().multiply(new BigDecimal(cart.getNumber())));
    }
  }
  BigDecimal tmpCouponPrice=new BigDecimal(0.00);
  Integer tmpCouponId=0;
  Integer tmpUserCouponId=0;
  int tmpCouponLength=0;
  List<LitemallCouponUser> couponUserList=couponUserService.queryAll(userId);
  for (  LitemallCouponUser couponUser : couponUserList) {
    LitemallCoupon coupon=couponVerifyService.checkCoupon(userId,couponUser.getCouponId(),couponUser.getId(),checkedGoodsPrice,checkedGoodsList);
    if (coupon == null) {
      continue;
    }
    tmpCouponLength++;
    if (tmpCouponPrice.compareTo(coupon.getDiscount()) == -1) {
      tmpCouponPrice=coupon.getDiscount();
      tmpCouponId=coupon.getId();
      tmpUserCouponId=couponUser.getId();
    }
  }
  int availableCouponLength=tmpCouponLength;
  BigDecimal couponPrice=new BigDecimal(0);
  if (couponId == null || couponId.equals(-1)) {
    couponId=-1;
    userCouponId=-1;
  }
 else   if (couponId.equals(0)) {
    couponPrice=tmpCouponPrice;
    couponId=tmpCouponId;
    userCouponId=tmpUserCouponId;
  }
 else {
    LitemallCoupon coupon=couponVerifyService.checkCoupon(userId,couponId,userCouponId,checkedGoodsPrice,checkedGoodsList);
    if (coupon == null) {
      couponPrice=tmpCouponPrice;
      couponId=tmpCouponId;
      userCouponId=tmpUserCouponId;
    }
 else {
      couponPrice=coupon.getDiscount();
    }
  }
  BigDecimal freightPrice=new BigDecimal(0.00);
  if (checkedGoodsPrice.compareTo(SystemConfig.getFreightLimit()) < 0) {
    freightPrice=SystemConfig.getFreight();
  }
  BigDecimal integralPrice=new BigDecimal(0.00);
  BigDecimal orderTotalPrice=checkedGoodsPrice.add(freightPrice).subtract(couponPrice).max(new BigDecimal(0.00));
  BigDecimal actualPrice=orderTotalPrice.subtract(integralPrice);
  Map<String,Object> data=new HashMap<>();
  data.put("addressId",addressId);
  data.put("couponId",couponId);
  data.put("userCouponId",userCouponId);
  data.put("cartId",cartId);
  data.put("grouponRulesId",grouponRulesId);
  data.put("grouponPrice",grouponPrice);
  data.put("checkedAddress",checkedAddress);
  data.put("availableCouponLength",availableCouponLength);
  data.put("goodsTotalPrice",checkedGoodsPrice);
  data.put("freightPrice",freightPrice);
  data.put("couponPrice",couponPrice);
  data.put("orderTotalPrice",orderTotalPrice);
  data.put("actualPrice",actualPrice);
  data.put("checkedGoodsList",checkedGoodsList);
  return ResponseUtil.ok(data);
}

public abstract class AbstractOpenPgpTrustStore implements OpenPgpTrustStore {
  private final Map<BareJid,Map<OpenPgpV4Fingerprint,Trust>> trustCache=new HashMap<>();
  /** 
 * Read the trust record for the key with fingerprint  {@code fingerprint} of user {@code owner} from local storage.This method returns  {@link Trust#undecided} in case that no trust record has been found.
 * @param owner owner of the key
 * @param fingerprint fingerprint of the key
 * @return trust state of the key
 * @throws IOException IO is dangerous
 */
  protected abstract Trust readTrust(  BareJid owner,  OpenPgpV4Fingerprint fingerprint) throws IOException ;
  /** 
 * Write the trust record for the key with fingerprint  {@code fingerprint} of user {@code owner} to local storage.
 * @param owner owner of the key
 * @param fingerprint fingerprint of the key
 * @param trust trust state of the key
 * @throws IOException IO is dangerous
 */
  protected abstract void writeTrust(  BareJid owner,  OpenPgpV4Fingerprint fingerprint,  Trust trust) throws IOException ;
  @Override public Trust getTrust(  BareJid owner,  OpenPgpV4Fingerprint fingerprint) throws IOException {
    Trust trust;
    Map<OpenPgpV4Fingerprint,Trust> trustMap=trustCache.get(owner);
    if (trustMap != null) {
      trust=trustMap.get(fingerprint);
      if (trust != null) {
        return trust;
      }
    }
 else {
      trustMap=new HashMap<>();
      trustCache.put(owner,trustMap);
    }
    trust=readTrust(owner,fingerprint);
    trustMap.put(fingerprint,trust);
    return trust;
  }
  @Override public void setTrust(  BareJid owner,  OpenPgpV4Fingerprint fingerprint,  Trust trust) throws IOException {
    Map<OpenPgpV4Fingerprint,Trust> trustMap=trustCache.get(owner);
    if (trustMap == null) {
      trustMap=new HashMap<>();
      trustCache.put(owner,trustMap);
    }
    if (trustMap.get(fingerprint) == trust) {
      return;
    }
    trustMap.put(fingerprint,trust);
    writeTrust(owner,fingerprint,trust);
  }
}

/** 
 * Redis基础配置 Created by macro on 2020/6/19.
 */
public class BaseRedisConfig {
  @Bean public RedisTemplate<String,Object> redisTemplate(  RedisConnectionFactory redisConnectionFactory){
    RedisSerializer<Object> serializer=redisSerializer();
    RedisTemplate<String,Object> redisTemplate=new RedisTemplate<>();
    redisTemplate.setConnectionFactory(redisConnectionFactory);
    redisTemplate.setKeySerializer(new StringRedisSerializer());
    redisTemplate.setValueSerializer(serializer);
    redisTemplate.setHashKeySerializer(new StringRedisSerializer());
    redisTemplate.setHashValueSerializer(serializer);
    redisTemplate.afterPropertiesSet();
    return redisTemplate;
  }
  @Bean public RedisSerializer<Object> redisSerializer(){
    Jackson2JsonRedisSerializer<Object> serializer=new Jackson2JsonRedisSerializer<>(Object.class);
    ObjectMapper objectMapper=new ObjectMapper();
    objectMapper.setVisibility(PropertyAccessor.ALL,JsonAutoDetect.Visibility.ANY);
    objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance,ObjectMapper.DefaultTyping.NON_FINAL);
    serializer.setObjectMapper(objectMapper);
    return serializer;
  }
  @Bean public RedisCacheManager redisCacheManager(  RedisConnectionFactory redisConnectionFactory){
    RedisCacheWriter redisCacheWriter=RedisCacheWriter.nonLockingRedisCacheWriter(redisConnectionFactory);
    RedisCacheConfiguration redisCacheConfiguration=RedisCacheConfiguration.defaultCacheConfig().serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer())).entryTtl(Duration.ofDays(1));
    return new RedisCacheManager(redisCacheWriter,redisCacheConfiguration);
  }
  @Bean public RedisService redisService(){
    return new RedisServiceImpl();
  }
}

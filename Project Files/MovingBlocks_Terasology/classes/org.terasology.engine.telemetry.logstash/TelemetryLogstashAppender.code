/** 
 * This is a logback Logstash appender that enriches error logs and sent them to the Logstash in server. The constructor has the default configuration of this appender. The destination of this appender will be set when error reporting is enabled.
 */
public class TelemetryLogstashAppender extends LogstashTcpSocketAppender {
  public static final String TELEMETRY_APPENDER_NAME="LOGSTASH";
  public static final String DEFAULT_LOGSTASH_HOST="telemetry.terasology.com";
  public static final String DEFAULT_LOGSTASH_OWNER="Terasology Community";
  public static final String DEFAULT_LOGSTASH_NAME="Logstash";
  public static final int DEFAULT_LOGSTASH_PORT=9000;
  private Context gameContext;
  public TelemetryLogstashAppender(  Context context){
    this.setName(TELEMETRY_APPENDER_NAME);
    this.setContext((LoggerContext)LoggerFactory.getILoggerFactory());
    this.addErrorFilter();
    this.setDefaultEncoder();
    this.gameContext=context;
  }
  private void addErrorFilter(){
    ThresholdFilter filter=new ThresholdFilter();
    filter.setLevel("error");
    filter.start();
    this.addFilter(filter);
  }
  private void setDefaultEncoder(){
    LoggingEventCompositeJsonEncoder loggingEventCompositeJsonEncoder=new LoggingEventCompositeJsonEncoder();
    JsonProviders jsonProviders=new JsonProviders();
    jsonProviders.addProvider(new LoggingEventFormattedTimestampJsonProvider());
    jsonProviders.addProvider(new LogstashVersionJsonProvider());
    jsonProviders.addProvider(new MdcJsonProvider());
    jsonProviders.addProvider(new MessageJsonProvider());
    jsonProviders.addProvider(new LogLevelJsonProvider());
    jsonProviders.addProvider(new LoggerNameJsonProvider());
    jsonProviders.addProvider(new ThreadNameJsonProvider());
    jsonProviders.addProvider(new SystemContextJsonProvider());
    jsonProviders.addProvider(new ModulesJsonProvider());
    jsonProviders.addProvider(new UserIdJsonProvider());
    StackTraceJsonProvider stackTraceJsonProvider=new StackTraceJsonProvider();
    ShortenedThrowableConverter shortenedThrowableConverter=new ShortenedThrowableConverter();
    shortenedThrowableConverter.setMaxDepthPerThrowable(30);
    shortenedThrowableConverter.setMaxLength(2046);
    shortenedThrowableConverter.setShortenedClassNameLength(20);
    shortenedThrowableConverter.setRootCauseFirst(true);
    stackTraceJsonProvider.setThrowableConverter(shortenedThrowableConverter);
    jsonProviders.addProvider(stackTraceJsonProvider);
    loggingEventCompositeJsonEncoder.setProviders(jsonProviders);
    this.setEncoder(loggingEventCompositeJsonEncoder);
  }
  public Context getGameContext(){
    return gameContext;
  }
}

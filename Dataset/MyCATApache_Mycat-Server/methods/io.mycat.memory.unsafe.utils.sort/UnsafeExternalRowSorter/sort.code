public Iterator<UnsafeRow> sort() throws IOException {
  try {
    final UnsafeSorterIterator sortedIterator=sorter.getSortedIterator();
    if (!sortedIterator.hasNext()) {
      cleanupResources();
    }
    return new AbstractScalaRowIterator<UnsafeRow>(){
      private final int numFields=schema.length();
      private UnsafeRow row=new UnsafeRow(numFields);
      @Override public boolean hasNext(){
        return sortedIterator.hasNext();
      }
      @Override public UnsafeRow next(){
        try {
          sortedIterator.loadNext();
          row.pointTo(sortedIterator.getBaseObject(),sortedIterator.getBaseOffset(),sortedIterator.getRecordLength());
          if (!hasNext()) {
            UnsafeRow copy=row.copy();
            row=null;
            cleanupResources();
            return copy;
          }
 else {
            return row;
          }
        }
 catch (        IOException e) {
          cleanupResources();
          Platform.throwException(e);
        }
        throw new RuntimeException("Exception should have been re-thrown in next()");
      }
      @Override public void remove(){
      }
    }
;
  }
 catch (  IOException e) {
    cleanupResources();
    throw e;
  }
}
public Iterator<UnsafeRow> sort(Iterator<UnsafeRow> inputIterator) throws IOException {
  while (inputIterator.hasNext()) {
    insertRow(inputIterator.next());
  }
  return sort();
}

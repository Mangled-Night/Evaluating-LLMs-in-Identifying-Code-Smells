public static OmemoManager prepareOmemoManager(XMPPConnection connection) throws Exception {
  final OmemoManager manager=OmemoManager.getInstanceFor(connection,OmemoManager.randomDeviceId());
  manager.setTrustCallback(new EphemeralTrustCallback());
  if (connection.isAuthenticated()) {
    manager.initialize();
  }
 else {
    throw new AssertionError("Connection must be authenticated.");
  }
  return manager;
}

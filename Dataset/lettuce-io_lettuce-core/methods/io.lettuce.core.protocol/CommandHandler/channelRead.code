/** 
 * @see io.netty.channel.ChannelInboundHandlerAdapter#channelRead(io.netty.channel.ChannelHandlerContext,java.lang.Object)
 */
@Override public void channelRead(ChannelHandlerContext ctx,Object msg) throws Exception {
  ByteBuf input=(ByteBuf)msg;
  input.touch("CommandHandler.read(…)");
  if (!input.isReadable() || input.refCnt() == 0) {
    logger.warn("{} Input not readable {}, {}",logPrefix(),input.isReadable(),input.refCnt());
    return;
  }
  if (debugEnabled) {
    logger.debug("{} Received: {} bytes, {} commands in the stack",logPrefix(),input.readableBytes(),stack.size());
  }
  try {
    if (buffer.refCnt() < 1) {
      logger.warn("{} Ignoring received data for closed or abandoned connection",logPrefix());
      return;
    }
    if (debugEnabled && ctx.channel() != channel) {
      logger.debug("{} Ignoring data for a non-registered channel {}",logPrefix(),ctx.channel());
      return;
    }
    if (traceEnabled) {
      logger.trace("{} Buffer: {}",logPrefix(),input.toString(Charset.defaultCharset()).trim());
    }
    buffer.touch("CommandHandler.read(…)");
    buffer.writeBytes(input);
    decode(ctx,buffer);
  }
  finally {
    input.release();
  }
}

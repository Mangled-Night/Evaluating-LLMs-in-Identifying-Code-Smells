/** 
 * @author Mark Paluch
 */
@ExtendWith(MockitoExtension.class) @MockitoSettings(strictness=Strictness.LENIENT) class MasterReplicaChannelWriterUnitTests {
  @Mock private MasterReplicaConnectionProvider<String,String> connectionProvider;
  @Mock private ClientResources clientResources;
  @Mock private StatefulRedisConnection<String,String> connection;
  @Test void shouldReturnIntentForWriteCommand(){
    RedisCommand<String,String,String> set=new Command<>(CommandType.SET,null);
    RedisCommand<String,String,String> mset=new Command<>(CommandType.MSET,null);
    assertThat(MasterReplicaChannelWriter.getIntent(Arrays.asList(set,mset))).isEqualTo(ConnectionIntent.WRITE);
    assertThat(MasterReplicaChannelWriter.getIntent(Collections.singletonList(set))).isEqualTo(ConnectionIntent.WRITE);
  }
  @Test void shouldReturnDefaultIntentForNoCommands(){
    assertThat(MasterReplicaChannelWriter.getIntent(Collections.emptyList())).isEqualTo(ConnectionIntent.WRITE);
  }
  @Test void shouldReturnIntentForReadCommand(){
    RedisCommand<String,String,String> get=new Command<>(CommandType.GET,null);
    RedisCommand<String,String,String> mget=new Command<>(CommandType.MGET,null);
    assertThat(MasterReplicaChannelWriter.getIntent(Arrays.asList(get,mget))).isEqualTo(ConnectionIntent.READ);
    assertThat(MasterReplicaChannelWriter.getIntent(Collections.singletonList(get))).isEqualTo(ConnectionIntent.READ);
  }
  @Test void shouldReturnIntentForMixedCommands(){
    RedisCommand<String,String,String> set=new Command<>(CommandType.SET,null);
    RedisCommand<String,String,String> mget=new Command<>(CommandType.MGET,null);
    assertThat(MasterReplicaChannelWriter.getIntent(Arrays.asList(set,mget))).isEqualTo(ConnectionIntent.WRITE);
    assertThat(MasterReplicaChannelWriter.getIntent(Collections.singletonList(set))).isEqualTo(ConnectionIntent.WRITE);
  }
  @Test void shouldBindTransactionsToMaster(){
    MasterReplicaChannelWriter writer=new MasterReplicaChannelWriter(connectionProvider,clientResources);
    when(connectionProvider.getConnectionAsync(any(ConnectionIntent.class))).thenReturn(CompletableFuture.completedFuture(connection));
    writer.write(mockCommand(CommandType.MULTI));
    writer.write(mockCommand(CommandType.GET));
    writer.write(mockCommand(CommandType.EXEC));
    verify(connectionProvider,times(3)).getConnectionAsync(ConnectionIntent.WRITE);
  }
  @Test void shouldBindTransactionsToMasterInBatch(){
    MasterReplicaChannelWriter writer=new MasterReplicaChannelWriter(connectionProvider,clientResources);
    when(connectionProvider.getConnectionAsync(any(ConnectionIntent.class))).thenReturn(CompletableFuture.completedFuture(connection));
    List<Command<String,String,String>> commands=Arrays.asList(mockCommand(CommandType.MULTI),mockCommand(CommandType.GET),mockCommand(CommandType.EXEC));
    writer.write(commands);
    verify(connectionProvider).getConnectionAsync(ConnectionIntent.WRITE);
  }
  @Test void shouldDeriveIntentFromCommandTypeAfterTransaction(){
    MasterReplicaChannelWriter writer=new MasterReplicaChannelWriter(connectionProvider,clientResources);
    when(connectionProvider.getConnectionAsync(any(ConnectionIntent.class))).thenReturn(CompletableFuture.completedFuture(connection));
    writer.write(mockCommand(CommandType.MULTI));
    writer.write(mockCommand(CommandType.EXEC));
    writer.write(mockCommand(CommandType.GET));
    verify(connectionProvider,times(2)).getConnectionAsync(ConnectionIntent.WRITE);
    verify(connectionProvider).getConnectionAsync(ConnectionIntent.READ);
  }
  @Test void shouldDeriveIntentFromCommandTypeAfterDiscardedTransaction(){
    MasterReplicaChannelWriter writer=new MasterReplicaChannelWriter(connectionProvider,clientResources);
    when(connectionProvider.getConnectionAsync(any(ConnectionIntent.class))).thenReturn(CompletableFuture.completedFuture(connection));
    writer.write(mockCommand(CommandType.MULTI));
    writer.write(mockCommand(CommandType.DISCARD));
    writer.write(mockCommand(CommandType.GET));
    verify(connectionProvider,times(2)).getConnectionAsync(ConnectionIntent.WRITE);
    verify(connectionProvider).getConnectionAsync(ConnectionIntent.READ);
  }
  @Test void shouldDeriveIntentFromCommandBatchTypeAfterDiscardedTransaction(){
    MasterReplicaChannelWriter writer=new MasterReplicaChannelWriter(connectionProvider,clientResources);
    when(connectionProvider.getConnectionAsync(any(ConnectionIntent.class))).thenReturn(CompletableFuture.completedFuture(connection));
    List<Command<String,String,String>> commands=Arrays.asList(mockCommand(CommandType.MULTI),mockCommand(CommandType.EXEC));
    writer.write(commands);
    writer.write(Collections.singletonList(mockCommand(CommandType.GET)));
    verify(connectionProvider).getConnectionAsync(ConnectionIntent.WRITE);
    verify(connectionProvider).getConnectionAsync(ConnectionIntent.READ);
  }
  private static Command<String,String,String> mockCommand(  CommandType multi){
    return new Command<>(multi,new StatusOutput<>(StringCodec.UTF8));
  }
}

/** 
 * 账号注册
 * @param body    请求内容{ username: xxx, password: xxx, mobile: xxx code: xxx } 其中code是手机验证码，目前还不支持手机短信验证码
 * @param request 请求对象
 * @return 登录结果成功则 { errno: 0, errmsg: '成功', data: { token: xxx, tokenExpire: xxx, userInfo: xxx } } 失败则 { errno: XXX, errmsg: XXX }
 */
@PostMapping("register") public Object register(@RequestBody String body,HttpServletRequest request){
  String username=JacksonUtil.parseString(body,"username");
  String password=JacksonUtil.parseString(body,"password");
  String mobile=JacksonUtil.parseString(body,"mobile");
  String code=JacksonUtil.parseString(body,"code");
  String wxCode=JacksonUtil.parseString(body,"wxCode");
  if (StringUtils.isEmpty(username) || StringUtils.isEmpty(password) || StringUtils.isEmpty(mobile)|| StringUtils.isEmpty(code)) {
    return ResponseUtil.badArgument();
  }
  List<LitemallUser> userList=userService.queryByUsername(username);
  if (userList.size() > 0) {
    return ResponseUtil.fail(AUTH_NAME_REGISTERED,"用户名已注册");
  }
  userList=userService.queryByMobile(mobile);
  if (userList.size() > 0) {
    return ResponseUtil.fail(AUTH_MOBILE_REGISTERED,"手机号已注册");
  }
  if (!RegexUtil.isMobileSimple(mobile)) {
    return ResponseUtil.fail(AUTH_INVALID_MOBILE,"手机号格式不正确");
  }
  String cacheCode=CaptchaCodeManager.getCachedCaptcha(mobile);
  if (cacheCode == null || cacheCode.isEmpty() || !cacheCode.equals(code)) {
    return ResponseUtil.fail(AUTH_CAPTCHA_UNMATCH,"验证码错误");
  }
  String openId="";
  if (!StringUtils.isEmpty(wxCode)) {
    try {
      WxMaJscode2SessionResult result=this.wxService.getUserService().getSessionInfo(wxCode);
      openId=result.getOpenid();
    }
 catch (    Exception e) {
      e.printStackTrace();
      return ResponseUtil.fail(AUTH_OPENID_UNACCESS,"openid 获取失败");
    }
    userList=userService.queryByOpenid(openId);
    if (userList.size() > 1) {
      return ResponseUtil.serious();
    }
    if (userList.size() == 1) {
      LitemallUser checkUser=userList.get(0);
      String checkUsername=checkUser.getUsername();
      String checkPassword=checkUser.getPassword();
      if (!checkUsername.equals(openId) || !checkPassword.equals(openId)) {
        return ResponseUtil.fail(AUTH_OPENID_BINDED,"openid已绑定账号");
      }
    }
  }
  LitemallUser user=null;
  BCryptPasswordEncoder encoder=new BCryptPasswordEncoder();
  String encodedPassword=encoder.encode(password);
  user=new LitemallUser();
  user.setUsername(username);
  user.setPassword(encodedPassword);
  user.setMobile(mobile);
  user.setWeixinOpenid(openId);
  user.setAvatar("https://yanxuan.nosdn.127.net/80841d741d7fa3073e0ae27bf487339f.jpg?imageView&quality=90&thumbnail=64x64");
  user.setNickname(username);
  user.setGender((byte)0);
  user.setUserLevel((byte)0);
  user.setStatus((byte)0);
  user.setLastLoginTime(LocalDateTime.now());
  user.setLastLoginIp(IpUtil.getIpAddr(request));
  userService.add(user);
  couponAssignService.assignForRegister(user.getId());
  UserInfo userInfo=new UserInfo();
  userInfo.setNickName(username);
  userInfo.setAvatarUrl(user.getAvatar());
  String token=UserTokenManager.generateToken(user.getId());
  Map<Object,Object> result=new HashMap<Object,Object>();
  result.put("token",token);
  result.put("userInfo",userInfo);
  return ResponseUtil.ok(result);
}

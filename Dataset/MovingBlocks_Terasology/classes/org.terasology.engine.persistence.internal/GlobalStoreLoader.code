final class GlobalStoreLoader {
  private static final Logger logger=LoggerFactory.getLogger(GlobalStoreLoader.class);
  private ModuleEnvironment environment;
  private EngineEntityManager entityManager;
  private PrefabManager prefabManager;
  private ComponentLibrary componentLibrary;
  private EntitySerializer entitySerializer;
  private PrefabSerializer prefabSerializer;
  GlobalStoreLoader(  ModuleEnvironment environment,  EngineEntityManager entityManager,  PrefabSerializer prefabSerializer){
    this.entityManager=entityManager;
    this.prefabManager=entityManager.getPrefabManager();
    this.environment=environment;
    this.componentLibrary=entityManager.getComponentLibrary();
    this.entitySerializer=new EntitySerializer(entityManager);
    this.entitySerializer.setComponentSerializeCheck(new PersistenceComponentSerializeCheck());
    this.prefabSerializer=prefabSerializer;
  }
  public void load(  EntityData.GlobalStore globalStore){
    entityManager.clear();
    entityManager.setNextId(globalStore.getNextEntityId());
    loadComponentMapping(globalStore);
    loadMissingPrefabs(globalStore);
    for (    EntityData.Entity entityData : globalStore.getEntityList()) {
      entitySerializer.deserialize(entityData);
    }
  }
  private void loadMissingPrefabs(  EntityData.GlobalStore globalStore){
    Map<String,EntityData.Prefab> pendingPrefabs=Maps.newHashMap();
    for (    EntityData.Prefab prefabData : globalStore.getPrefabList()) {
      if (!prefabManager.exists(prefabData.getName())) {
        if (!prefabData.hasParentName()) {
          Module module=environment.get(new SimpleUri(prefabData.getName()).getModuleName());
          try (ModuleContext.ContextSpan ignored=ModuleContext.setContext(module)){
            createPrefab(prefabData);
          }
 catch (          Exception e) {
            logger.error("Failed to load prefab {}",prefabData.getName(),e);
          }
        }
 else {
          pendingPrefabs.put(prefabData.getName(),prefabData);
        }
      }
    }
    for (    EntityData.Prefab prefabData : pendingPrefabs.values()) {
      loadPrefab(prefabData,pendingPrefabs);
    }
  }
  private Prefab loadPrefab(  EntityData.Prefab prefabData,  Map<String,EntityData.Prefab> pendingPrefabs){
    Optional<Prefab> result=Assets.getPrefab(prefabData.getName());
    if (!result.isPresent()) {
      if (prefabData.hasParentName() && pendingPrefabs.containsKey(prefabData.getParentName())) {
        loadPrefab(pendingPrefabs.get(prefabData.getParentName()),pendingPrefabs);
      }
      Module module=environment.get(new SimpleUri(prefabData.getName()).getModuleName());
      try (ModuleContext.ContextSpan ignored=ModuleContext.setContext(module)){
        return createPrefab(prefabData);
      }
 catch (      Exception e) {
        logger.error("Failed to load prefab {}",prefabData.getParentName(),e);
        return null;
      }
    }
    return result.get();
  }
  private Prefab createPrefab(  EntityData.Prefab prefabData){
    PrefabData protoPrefab=prefabSerializer.deserialize(prefabData);
    return Assets.generateAsset(new ResourceUrn(prefabData.getName()),protoPrefab,Prefab.class);
  }
  private void loadComponentMapping(  EntityData.GlobalStore globalStore){
    Map<Class<? extends Component>,Integer> componentIdTable=Maps.newHashMap();
    for (int index=0; index < globalStore.getComponentClassCount(); ++index) {
      ComponentMetadata<?> componentMetadata=componentLibrary.resolve(globalStore.getComponentClass(index));
      if (componentMetadata != null) {
        componentIdTable.put(componentMetadata.getType(),index);
      }
 else {
        logger.warn("Unable to resolve component '{}'",globalStore.getComponentClass(index));
      }
    }
    prefabSerializer.setComponentIdMapping(componentIdTable);
    entitySerializer.setComponentIdMapping(componentIdTable);
  }
}

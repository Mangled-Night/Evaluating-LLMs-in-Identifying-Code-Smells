@Override public PhysicalDatasource doSelect(String hostName,ArrayList<PhysicalDatasource> okSources){
  boolean sameWeight=true;
  int length=okSources.size();
  int[] leastIndexes=new int[length];
  int leastActive=-1;
  int leastCount=0;
  int[] weights=new int[length];
  int totalWeight=0;
  int firstWeight=0;
  for (int i=0; i < length; i++) {
    PhysicalDatasource okSource=okSources.get(i);
    int active=okSource.getActiveCount();
    int weight=okSource.getConfig().getWeight();
    if (weight == 0) {
      continue;
    }
    weights[i]=weight;
    if (leastActive == -1 || active < leastActive) {
      sameWeight=true;
      leastIndexes[0]=i;
      leastActive=active;
      leastCount=1;
      totalWeight=weight;
      firstWeight=weight;
    }
 else     if (active == leastActive) {
      leastIndexes[leastCount++]=i;
      totalWeight+=weight;
      if (sameWeight && i > 0 && weight != firstWeight) {
        sameWeight=false;
      }
    }
  }
  if (leastCount == 0) {
    return okSources.get(ThreadLocalRandom.current().nextInt(okSources.size()));
  }
  if (leastCount == 1) {
    return okSources.get(leastIndexes[0]);
  }
  if (!sameWeight && totalWeight > 0) {
    int offsetWeight=ThreadLocalRandom.current().nextInt(totalWeight);
    for (int i=0; i < leastCount; i++) {
      int leastIndex=leastIndexes[i];
      offsetWeight-=weights[leastIndex];
      if (offsetWeight < 0) {
        return okSources.get(leastIndex);
      }
    }
  }
  return okSources.get(leastIndexes[ThreadLocalRandom.current().nextInt(leastCount)]);
}

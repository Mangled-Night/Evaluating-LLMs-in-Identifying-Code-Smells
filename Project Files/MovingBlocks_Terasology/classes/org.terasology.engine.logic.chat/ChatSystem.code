@RegisterSystem public class ChatSystem extends BaseComponentSystem {
  private static final Logger logger=LoggerFactory.getLogger(ChatSystem.class);
  private static final ResourceUrn CHAT_UI=new ResourceUrn("engine:chat");
  private static final ResourceUrn CONSOLE_UI=new ResourceUrn("engine:console");
  @In private EntityManager entityManager;
  @In private NUIManager nuiManager;
  private NotificationOverlay overlay;
  @Override public void initialise(){
    if (nuiManager != null) {
      overlay=nuiManager.addOverlay(NotificationOverlay.ASSET_URI,NotificationOverlay.class);
    }
  }
  @ReceiveEvent(components=ClientComponent.class) public void onToggleChat(  ChatButton event,  EntityRef entity){
    if (event.getState() == ButtonState.UP) {
      nuiManager.pushScreen(CHAT_UI);
      overlay.setVisible(false);
      event.consume();
    }
  }
  @ReceiveEvent(components=ClientComponent.class) public void onMessage(  MessageEvent event,  EntityRef entity){
    if (overlay == null) {
      return;
    }
    ClientComponent client=entity.getComponent(ClientComponent.class);
    if (client.local) {
      Message message=event.getFormattedMessage();
      if (message.getType() == CoreMessageType.CHAT || message.getType() == CoreMessageType.NOTIFICATION) {
        if (!nuiManager.isOpen(CHAT_UI) && !nuiManager.isOpen(CONSOLE_UI)) {
          overlay.setVisible(true);
        }
      }
    }
  }
  @Command(runOnServer=true,requiredPermission=PermissionManager.CHAT_PERMISSION,shortDescription="Sends a message to all other players") public String say(  @Sender EntityRef sender,  @CommandParam(value="message") String[] message){
    String messageToString=join(message," ");
    logger.debug("Received chat message from {} : '{}'",sender,messageToString);
    for (    EntityRef client : entityManager.getEntitiesWith(ClientComponent.class)) {
      client.send(new ChatMessageEvent(messageToString,sender.getComponent(ClientComponent.class).clientInfo));
    }
    return "Message sent";
  }
  private String join(  String[] words,  String sep){
    return Arrays.stream(words).collect(joining(sep));
  }
  @Command(runOnServer=true,requiredPermission=PermissionManager.CHAT_PERMISSION,shortDescription="Sends a private message to a specified user") public String whisper(  @Sender EntityRef sender,  @CommandParam(value="user",suggester=OnlineUsernameSuggester.class) String username,  @CommandParam("message") String[] message){
    String messageToString=join(message," ");
    Iterable<EntityRef> clients=entityManager.getEntitiesWith(ClientComponent.class);
    EntityRef targetClient=null;
    boolean unique=true;
    for (    EntityRef client : clients) {
      ClientComponent clientComponent=client.getComponent(ClientComponent.class);
      DisplayNameComponent displayNameComponent=clientComponent.clientInfo.getComponent(DisplayNameComponent.class);
      if (displayNameComponent == null) {
        continue;
      }
      if (displayNameComponent.name.equalsIgnoreCase(username)) {
        if (targetClient == null) {
          targetClient=client;
        }
 else {
          unique=false;
          break;
        }
      }
    }
    if (!unique) {
      targetClient=null;
      for (      EntityRef client : clients) {
        ClientComponent clientComponent=client.getComponent(ClientComponent.class);
        DisplayNameComponent displayNameComponent=clientComponent.clientInfo.getComponent(DisplayNameComponent.class);
        if (displayNameComponent == null) {
          continue;
        }
        if (displayNameComponent.name.equals(username)) {
          if (targetClient == null) {
            targetClient=client;
          }
 else {
            return FontColor.getColored("Found more users with name '" + username + "'.",ConsoleColors.ERROR);
          }
        }
      }
    }
    if (targetClient == null) {
      return FontColor.getColored("User with name '" + username + "' not found.",ConsoleColors.ERROR);
    }
    ClientComponent senderClientComponent=sender.getComponent(ClientComponent.class);
    ClientComponent targetClientComponent=targetClient.getComponent(ClientComponent.class);
    DisplayNameComponent targetDisplayNameComponent=targetClientComponent.clientInfo.getComponent(DisplayNameComponent.class);
    String targetMessage=FontColor.getColored("*whispering* ",ConsoleColors.ERROR) + FontColor.getColored(messageToString,ConsoleColors.CHAT);
    String senderMessage="You -> " + targetDisplayNameComponent.name + ": "+ FontColor.getColored(messageToString,ConsoleColors.CHAT);
    targetClient.send(new ChatMessageEvent(targetMessage,senderClientComponent.clientInfo));
    return senderMessage;
  }
}

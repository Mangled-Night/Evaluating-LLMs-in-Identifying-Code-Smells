public class IoTDataIntegrationTest extends AbstractSmackIntegrationTest {
  private final IoTDataManager iotDataManagerOne;
  private final IoTDataManager iotDataManagerTwo;
  public IoTDataIntegrationTest(  SmackIntegrationTestEnvironment environment){
    super(environment);
    iotDataManagerOne=IoTDataManager.getInstanceFor(conOne);
    iotDataManagerTwo=IoTDataManager.getInstanceFor(conTwo);
  }
  /** 
 * Connection one provides a thing, which momentary value is read out by connection two.
 * @throws Exception if an exception occurs.
 * @throws TimeoutException if there was a timeout.
 */
  @SmackIntegrationTest public void dataTest() throws Exception {
    final String key=StringUtils.randomString(12);
    final String sn=StringUtils.randomString(12);
    final int value=INSECURE_RANDOM.nextInt();
    Thing dataThing=Thing.builder().setKey(key).setSerialNumber(sn).setMomentaryReadOutRequestHandler(new ThingMomentaryReadOutRequest(){
      @Override public void momentaryReadOutRequest(      ThingMomentaryReadOutResult callback){
        IoTDataField.IntField field=new IntField(testRunId,value);
        callback.momentaryReadOut(Collections.singletonList(field));
      }
    }
).build();
    iotDataManagerOne.installThing(dataThing);
    List<IoTFieldsExtension> values;
    try {
      IntegrationTestRosterUtil.ensureBothAccountsAreSubscribedToEachOther(conOne,conTwo,timeout);
      values=iotDataManagerTwo.requestMomentaryValuesReadOut(conOne.getUser());
    }
  finally {
      iotDataManagerOne.uninstallThing(dataThing);
      IntegrationTestRosterUtil.ensureBothAccountsAreNotInEachOthersRoster(conOne,conTwo);
    }
    assertEquals(1,values.size());
    IoTFieldsExtension iotFieldsExtension=values.get(0);
    List<NodeElement> nodes=iotFieldsExtension.getNodes();
    assertEquals(1,nodes.size());
    NodeElement node=nodes.get(0);
    List<TimestampElement> timestamps=node.getTimestampElements();
    assertEquals(1,timestamps.size());
    TimestampElement timestamp=timestamps.get(0);
    List<? extends IoTDataField> fields=timestamp.getDataFields();
    assertEquals(1,fields.size());
    IoTDataField dataField=fields.get(0);
    assertTrue(dataField instanceof IoTDataField.IntField);
    IoTDataField.IntField intDataField=(IoTDataField.IntField)dataField;
    assertEquals(testRunId,intDataField.getName());
    assertEquals(value,intDataField.getValue());
  }
}

/** 
 * 将xk的信息转换为xml文件的操作 源文件名：ZktoxmlMain.java 文件版本：1.0.0 创建作者：liujun 创建日期：2016年9月20日 修改作者：liujun 修改日期：2016年9月20日 文件描述：TODO 版权所有：Copyright 2016 zjhz, Inc. All Rights Reserved.
 */
public class ZktoXmlMain {
  /** 
 * 日志
 * @字段说明 LOGGER
 */
  private static final Logger LOGGER=LoggerFactory.getLogger(ZkMultLoader.class);
  /** 
 * 加载zk监听服务
 */
  public static final ZookeeperProcessListen ZKLISTENER=new ZookeeperProcessListen();
  public static void main(  String[] args) throws Exception {
    loadZktoFile();
    System.out.println(Long.MAX_VALUE);
  }
  /** 
 * 将zk数据放到到本地 方法描述
 * @throws Exception 
 * @创建日期 2016年9月21日
 */
  public static void loadZktoFile() throws Exception {
    String custerName=ZkConfig.getInstance().getValue(ZkParamCfg.ZK_CFG_CLUSTERID);
    String basePath=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_BASE.getKey();
    basePath=basePath + ZookeeperPath.ZK_SEPARATOR.getKey() + custerName;
    ZKLISTENER.setBasePath(basePath);
    CuratorFramework zkConn=buildConnection(ZkConfig.getInstance().getValue(ZkParamCfg.ZK_CFG_URL));
    XmlProcessBase xmlProcess=new XmlProcessBase();
    new SchemaszkToxmlLoader(ZKLISTENER,zkConn,xmlProcess);
    new ServerzkToxmlLoader(ZKLISTENER,zkConn,xmlProcess);
    ZKUtils.addChildPathCache(ZKUtils.getZKBasePath() + "rules",new RuleFunctionCacheListener());
    new SequenceTopropertiesLoader(ZKLISTENER,zkConn,xmlProcess);
    new EcacheszkToxmlLoader(ZKLISTENER,zkConn,xmlProcess);
    ZKUtils.addChildPathCache(ZKUtils.getZKBasePath() + "bindata",new BinDataPathChildrenCacheListener());
    ZKUtils.addChildPathCache(ZKUtils.getZKBasePath() + "ruledata",new RuleDataPathChildrenCacheListener());
    xmlProcess.initJaxbClass();
    ZKLISTENER.notifly(ZkNofiflyCfg.ZK_NOTIFLY_LOAD_ALL.getKey());
    loadZkWatch(ZKLISTENER.getWatchPath(),zkConn,ZKLISTENER);
    createTempNode(ZKUtils.getZKBasePath() + "line",ZkConfig.getInstance().getValue(ZkParamCfg.ZK_CFG_MYID),zkConn,ZkConfig.getInstance().getValue(ZkParamCfg.MYCAT_SERVER_TYPE));
    runCommandWatch(zkConn,ZKUtils.getZKBasePath() + ZKHandler.ZK_NODE_PATH);
    MigrateTaskWatch.start();
  }
  private static void loadZkWatch(  Set<String> setPaths,  final CuratorFramework zkConn,  final ZookeeperProcessListen zkListen) throws Exception {
    if (null != setPaths && !setPaths.isEmpty()) {
      for (      String path : setPaths) {
        NodeCache node=runWatch(zkConn,path,zkListen);
        node.start();
        LOGGER.info("ZktoxmlMain loadZkWatch path:" + path + " regist success");
      }
    }
  }
  /** 
 * 进行命令的监听操作 方法描述
 * @param zkConn zk的连接信息
 * @param path 路径信息
 * @param ZKLISTENER 监控路径信息
 * @throws Exception
 * @创建日期 2016年9月20日
 */
  @SuppressWarnings("resource") private static void runCommandWatch(  final CuratorFramework zkConn,  final String path) throws Exception {
    PathChildrenCache children=new PathChildrenCache(zkConn,path,true);
    CommandPathListener commandListener=new CommandPathListener();
    children.getListenable().addListener(commandListener);
    children.start();
  }
  /** 
 * 创建临时节点测试 方法描述
 * @param parent
 * @param node
 * @param zkConn
 * @throws Exception
 * @创建日期 2016年9月20日
 */
  private static void createTempNode(  String parent,  String node,  final CuratorFramework zkConn,  String type) throws Exception {
    String path=ZKPaths.makePath(parent,node);
    zkConn.create().withMode(CreateMode.EPHEMERAL).inBackground().forPath(path,type.getBytes("UTF-8"));
  }
  /** 
 * 进行zk的watch操作 方法描述
 * @param zkConn zk的连接信息
 * @param path 路径信息
 * @param zkListen 监控路径信息
 * @throws Exception
 * @创建日期 2016年9月20日
 */
  private static NodeCache runWatch(  final CuratorFramework zkConn,  final String path,  final ZookeeperProcessListen zkListen) throws Exception {
    final NodeCache cache=new NodeCache(zkConn,path);
    NodeCacheListener listen=new NodeCacheListener(){
      @Override public void nodeChanged() throws Exception {
        LOGGER.info("ZktoxmlMain runWatch  process path  event start ");
        LOGGER.info("NodeCache changed, path is: " + cache.getCurrentData().getPath());
        String notPath=cache.getCurrentData().getPath();
        zkListen.notifly(notPath);
        LOGGER.info("ZktoxmlMain runWatch  process path  event over");
      }
    }
;
    cache.getListenable().addListener(listen);
    return cache;
  }
  private static CuratorFramework buildConnection(  String url){
    return ZKUtils.getConnection();
  }
}

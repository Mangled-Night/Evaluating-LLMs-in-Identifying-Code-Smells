/** 
 * Called by 'give' command in ItemCommands.java to attempt to put a block in the player's inventory when no item is found. Called by 'giveBulkBlock' command in BlockCommands.java to put a block in the player's inventory.
 * @return Null if not found, otherwise success or warning message
 */
public String giveBlock(@Sender EntityRef sender,@CommandParam("blockName") String uri,@CommandParam(value="quantity",required=false) Integer quantityParam,@CommandParam(value="shapeName",required=false) String shapeUriParam){
  Set<ResourceUrn> matchingUris=Assets.resolveAssetUri(uri,BlockFamilyDefinition.class);
  BlockFamily blockFamily=null;
  if (matchingUris.size() == 1) {
    Optional<BlockFamilyDefinition> def=Assets.get(matchingUris.iterator().next(),BlockFamilyDefinition.class);
    if (def.isPresent()) {
      if (def.get().isFreeform()) {
        if (shapeUriParam == null) {
          blockFamily=blockManager.getBlockFamily(new BlockUri(def.get().getUrn(),new ResourceUrn("engine:cube")));
        }
 else {
          Set<ResourceUrn> resolvedShapeUris=Assets.resolveAssetUri(shapeUriParam,BlockShape.class);
          if (resolvedShapeUris.isEmpty()) {
            return "Found block. No shape found for '" + shapeUriParam + "'";
          }
 else           if (resolvedShapeUris.size() > 1) {
            StringBuilder builder=new StringBuilder();
            builder.append("Found block. Non-unique shape name, possible matches: ");
            Iterator<ResourceUrn> shapeUris=sortItems(resolvedShapeUris).iterator();
            while (shapeUris.hasNext()) {
              builder.append(shapeUris.next().toString());
              if (shapeUris.hasNext()) {
                builder.append(", ");
              }
            }
            return builder.toString();
          }
          blockFamily=blockManager.getBlockFamily(new BlockUri(def.get().getUrn(),resolvedShapeUris.iterator().next()));
        }
      }
 else {
        blockFamily=blockManager.getBlockFamily(new BlockUri(def.get().getUrn()));
      }
    }
    if (blockFamily == null) {
      return "Block not found";
    }
    int defaultQuantity=blockFamily.getArchetypeBlock().isStackable() ? 16 : 1;
    int quantity=quantityParam != null ? quantityParam : defaultQuantity;
    return giveBlock(blockFamily,quantity,sender);
  }
 else   if (matchingUris.size() > 1) {
    StringBuilder builder=new StringBuilder();
    builder.append("Non-unique block name, possible matches: ");
    Joiner.on(", ").appendTo(builder,matchingUris);
    return builder.toString();
  }
  return null;
}
/** 
 * Actual implementation of the giveBlock command.
 * @param blockFamily the block family of the queried block
 * @param quantity the number of blocks that are queried
 */
private String giveBlock(BlockFamily blockFamily,int quantity,EntityRef client){
  if (quantity < 1) {
    return "Here, have these zero (0) blocks just like you wanted";
  }
  EntityRef playerEntity=client.getComponent(ClientComponent.class).character;
  int stackLimit=blockFamily.getArchetypeBlock().isStackable() ? 99 : 1;
  int quantityLeft;
  for (quantityLeft=quantity; quantityLeft > 0; quantityLeft=quantityLeft - stackLimit) {
    EntityRef item=blockItemFactory.newInstance(blockFamily,Math.min(quantityLeft,stackLimit));
    if (!item.exists()) {
      throw new IllegalArgumentException("Unknown block or item");
    }
    GiveItemEvent giveItemEvent=new GiveItemEvent(playerEntity);
    item.send(giveItemEvent);
    if (!giveItemEvent.isHandled()) {
      item.destroy();
      break;
    }
  }
  if (quantityLeft < 0) {
    quantityLeft=0;
  }
  return "You received " + (quantity - quantityLeft) + " blocks of "+ blockFamily.getDisplayName();
}

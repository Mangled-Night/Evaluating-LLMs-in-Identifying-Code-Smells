/** 
 * Condition leaf node. <p> Checks for specific conditions on Components of a given Entity. If componentPresent is specified, checks that the component is present. If componentAbsent is specified, checks that the component is absent. if the 'values' field is specified, checks the values <p> Returns SUCCESS if all conditions checked against are true; FAILURE if not.
 */
@BehaviorAction(name="condition") public class ConditionAction extends BaseAction {
  private static final Logger logger=LoggerFactory.getLogger(ConditionAction.class);
  protected String componentPresent;
  protected String componentAbsent;
  protected String[] values;
  @In private transient ModuleManager moduleManager;
  @In private transient ComponentLibrary componentLibrary;
  @Override public void construct(  Actor actor){
  }
  @Override public BehaviorState modify(  Actor actor,  BehaviorState result){
    try {
      if (!condition(actor)) {
        return BehaviorState.FAILURE;
      }
      return BehaviorState.SUCCESS;
    }
 catch (    ClassNotFoundException e) {
      logger.error("Class not found. " + "Does the Component specified exist?",e);
    }
catch (    NoSuchFieldException e) {
      logger.error("Field not found. " + "Does the field specified in 'values' (publicly) exist in the Component specified in 'componentPresent'?",e);
    }
catch (    IllegalAccessException e) {
      logger.error("Illegal access. " + "Do we have access to the Component in question?",e);
    }
    return BehaviorState.FAILURE;
  }
  protected boolean condition(  Actor actor) throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException {
    boolean passing=true;
    if (componentAbsent != null && actor.hasComponent(componentLibrary.resolve(componentAbsent).getType())) {
      passing=false;
    }
    if (componentPresent != null) {
      Component component=actor.getComponent(componentLibrary.resolve(componentPresent).getType());
      if (component == null) {
        passing=false;
      }
 else {
        if (values != null) {
          for (          String value : values) {
            String[] tokens=value.split(" ");
            Object fieldValue=component.getClass().getDeclaredField(tokens[1]).get(component);
            String secondValue;
switch (tokens[0]) {
case "V":
              secondValue=tokens[3];
            break;
case "F":
          secondValue=component.getClass().getDeclaredField(tokens[3]).get(component).toString();
        break;
case "N":
      secondValue="";
    break;
default :
  logger.error("Unsupported guard value type: {}",tokens[0]);
secondValue="";
}
if (fieldValue instanceof Boolean) {
switch (tokens[2]) {
case "=":
case "==":
passing=(Boolean)fieldValue == Boolean.parseBoolean(secondValue);
break;
case "!":
case "!=":
passing=(Boolean)fieldValue != Boolean.parseBoolean(secondValue);
break;
default :
logger.error("Unsupported operation for boolean values: {}",tokens[2]);
}
}
 else if (fieldValue instanceof Number) {
switch (tokens[2]) {
case "=":
case "==":
passing=(Double)fieldValue == Double.parseDouble(secondValue);
break;
case "!":
case "!=":
passing=(Double)fieldValue == Double.parseDouble(secondValue);
break;
case "<=":
passing=((Number)fieldValue).doubleValue() <= Double.parseDouble(secondValue);
break;
case ">=":
passing=((Number)fieldValue).doubleValue() >= Double.parseDouble(secondValue);
break;
case ">":
passing=((Number)fieldValue).doubleValue() > Double.parseDouble(secondValue);
break;
case "<":
passing=((Number)fieldValue).doubleValue() < Double.parseDouble(secondValue);
break;
default :
logger.error("Unsupported operation for numeric values: {}",tokens[2]);
}
}
 else if (fieldValue instanceof String) {
switch (tokens[2]) {
case "=":
case "==":
passing=fieldValue.equals(secondValue);
break;
case "!":
case "!=":
passing=!fieldValue.equals(secondValue);
break;
default :
logger.error("Unsupported operation for strings: {}",tokens[2]);
}
}
 else {
if (fieldValue == null) {
if (!tokens[2].equals("null")) {
passing=false;
}
}
 else {
switch (tokens[2]) {
case "exists":
if (fieldValue instanceof EntityRef && fieldValue == EntityRef.NULL) {
passing=false;
}
break;
case "empty":
if (fieldValue instanceof Collection) {
passing=((Collection<?>)fieldValue).isEmpty();
}
break;
case "nonEmpty":
if (fieldValue instanceof Collection) {
passing=!((Collection<?>)fieldValue).isEmpty();
}
break;
default :
logger.error("Unknown field type or operation: {} {}",fieldValue.getClass(),tokens[2]);
}
}
}
}
}
}
}
return passing;
}
}

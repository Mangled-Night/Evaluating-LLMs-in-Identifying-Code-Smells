private SN waitForResponse() throws NoResponseException, InterruptedException, FailedNonzaException {
  final long deadline=System.currentTimeMillis() + connection.getReplyTimeout();
synchronized (this) {
    while (!hasReceivedSuccessOrFailedNonza()) {
      final long now=System.currentTimeMillis();
      if (now >= deadline)       break;
      wait(deadline - now);
    }
  }
  if (!hasReceivedSuccessOrFailedNonza()) {
    throw NoResponseException.newWith(connection,"Nonza Listener");
  }
  if (failedNonza != null) {
    throw new XMPPException.FailedNonzaException(failedNonza);
  }
  assert successNonza != null;
  return successNonza;
}

@Override public List<CartPromotionItem> calcCartPromotion(List<OmsCartItem> cartItemList){
  Map<Long,List<OmsCartItem>> productCartMap=groupCartItemBySpu(cartItemList);
  List<PromotionProduct> promotionProductList=getPromotionProductList(cartItemList);
  List<CartPromotionItem> cartPromotionItemList=new ArrayList<>();
  for (  Map.Entry<Long,List<OmsCartItem>> entry : productCartMap.entrySet()) {
    Long productId=entry.getKey();
    PromotionProduct promotionProduct=getPromotionProductById(productId,promotionProductList);
    List<OmsCartItem> itemList=entry.getValue();
    Integer promotionType=promotionProduct.getPromotionType();
    if (promotionType == 1) {
      for (      OmsCartItem item : itemList) {
        CartPromotionItem cartPromotionItem=new CartPromotionItem();
        BeanUtils.copyProperties(item,cartPromotionItem);
        cartPromotionItem.setPromotionMessage("单品促销");
        PmsSkuStock skuStock=getOriginalPrice(promotionProduct,item.getProductSkuId());
        BigDecimal originalPrice=skuStock.getPrice();
        cartPromotionItem.setPrice(originalPrice);
        cartPromotionItem.setReduceAmount(originalPrice.subtract(skuStock.getPromotionPrice()));
        cartPromotionItem.setRealStock(skuStock.getStock() - skuStock.getLockStock());
        cartPromotionItem.setIntegration(promotionProduct.getGiftPoint());
        cartPromotionItem.setGrowth(promotionProduct.getGiftGrowth());
        cartPromotionItemList.add(cartPromotionItem);
      }
    }
 else     if (promotionType == 3) {
      int count=getCartItemCount(itemList);
      PmsProductLadder ladder=getProductLadder(count,promotionProduct.getProductLadderList());
      if (ladder != null) {
        for (        OmsCartItem item : itemList) {
          CartPromotionItem cartPromotionItem=new CartPromotionItem();
          BeanUtils.copyProperties(item,cartPromotionItem);
          String message=getLadderPromotionMessage(ladder);
          cartPromotionItem.setPromotionMessage(message);
          PmsSkuStock skuStock=getOriginalPrice(promotionProduct,item.getProductSkuId());
          BigDecimal originalPrice=skuStock.getPrice();
          BigDecimal reduceAmount=originalPrice.subtract(ladder.getDiscount().multiply(originalPrice));
          cartPromotionItem.setReduceAmount(reduceAmount);
          cartPromotionItem.setRealStock(skuStock.getStock() - skuStock.getLockStock());
          cartPromotionItem.setIntegration(promotionProduct.getGiftPoint());
          cartPromotionItem.setGrowth(promotionProduct.getGiftGrowth());
          cartPromotionItemList.add(cartPromotionItem);
        }
      }
 else {
        handleNoReduce(cartPromotionItemList,itemList,promotionProduct);
      }
    }
 else     if (promotionType == 4) {
      BigDecimal totalAmount=getCartItemAmount(itemList,promotionProductList);
      PmsProductFullReduction fullReduction=getProductFullReduction(totalAmount,promotionProduct.getProductFullReductionList());
      if (fullReduction != null) {
        for (        OmsCartItem item : itemList) {
          CartPromotionItem cartPromotionItem=new CartPromotionItem();
          BeanUtils.copyProperties(item,cartPromotionItem);
          String message=getFullReductionPromotionMessage(fullReduction);
          cartPromotionItem.setPromotionMessage(message);
          PmsSkuStock skuStock=getOriginalPrice(promotionProduct,item.getProductSkuId());
          BigDecimal originalPrice=skuStock.getPrice();
          BigDecimal reduceAmount=originalPrice.divide(totalAmount,RoundingMode.HALF_EVEN).multiply(fullReduction.getReducePrice());
          cartPromotionItem.setReduceAmount(reduceAmount);
          cartPromotionItem.setRealStock(skuStock.getStock() - skuStock.getLockStock());
          cartPromotionItem.setIntegration(promotionProduct.getGiftPoint());
          cartPromotionItem.setGrowth(promotionProduct.getGiftGrowth());
          cartPromotionItemList.add(cartPromotionItem);
        }
      }
 else {
        handleNoReduce(cartPromotionItemList,itemList,promotionProduct);
      }
    }
 else {
      handleNoReduce(cartPromotionItemList,itemList,promotionProduct);
    }
  }
  return cartPromotionItemList;
}

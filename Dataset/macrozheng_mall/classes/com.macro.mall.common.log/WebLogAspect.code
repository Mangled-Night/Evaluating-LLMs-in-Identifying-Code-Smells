/** 
 * 统一日志处理切面 Created by macro on 2018/4/26.
 */
@Aspect @Component @Order(1) public class WebLogAspect {
  private static final Logger LOGGER=LoggerFactory.getLogger(WebLogAspect.class);
  @Pointcut("execution(public * com.macro.mall.controller.*.*(..))||execution(public * com.macro.mall.*.controller.*.*(..))") public void webLog(){
  }
  @Before("webLog()") public void doBefore(  JoinPoint joinPoint) throws Throwable {
  }
  @AfterReturning(value="webLog()",returning="ret") public void doAfterReturning(  Object ret) throws Throwable {
  }
  @Around("webLog()") public Object doAround(  ProceedingJoinPoint joinPoint) throws Throwable {
    long startTime=System.currentTimeMillis();
    ServletRequestAttributes attributes=(ServletRequestAttributes)RequestContextHolder.getRequestAttributes();
    HttpServletRequest request=attributes.getRequest();
    WebLog webLog=new WebLog();
    Object result=joinPoint.proceed();
    Signature signature=joinPoint.getSignature();
    MethodSignature methodSignature=(MethodSignature)signature;
    Method method=methodSignature.getMethod();
    if (method.isAnnotationPresent(ApiOperation.class)) {
      ApiOperation log=method.getAnnotation(ApiOperation.class);
      webLog.setDescription(log.value());
    }
    long endTime=System.currentTimeMillis();
    String urlStr=request.getRequestURL().toString();
    webLog.setBasePath(StrUtil.removeSuffix(urlStr,URLUtil.url(urlStr).getPath()));
    webLog.setUsername(request.getRemoteUser());
    webLog.setIp(RequestUtil.getRequestIp(request));
    webLog.setMethod(request.getMethod());
    webLog.setParameter(getParameter(method,joinPoint.getArgs()));
    webLog.setResult(result);
    webLog.setSpendTime((int)(endTime - startTime));
    webLog.setStartTime(startTime);
    webLog.setUri(request.getRequestURI());
    webLog.setUrl(request.getRequestURL().toString());
    Map<String,Object> logMap=new HashMap<>();
    logMap.put("url",webLog.getUrl());
    logMap.put("method",webLog.getMethod());
    logMap.put("parameter",webLog.getParameter());
    logMap.put("spendTime",webLog.getSpendTime());
    logMap.put("description",webLog.getDescription());
    LOGGER.info(Markers.appendEntries(logMap),JSONUtil.parse(webLog).toString());
    return result;
  }
  /** 
 * 根据方法和传入的参数获取请求参数
 */
  private Object getParameter(  Method method,  Object[] args){
    List<Object> argList=new ArrayList<>();
    Parameter[] parameters=method.getParameters();
    for (int i=0; i < parameters.length; i++) {
      RequestBody requestBody=parameters[i].getAnnotation(RequestBody.class);
      if (requestBody != null) {
        argList.add(args[i]);
      }
      RequestParam requestParam=parameters[i].getAnnotation(RequestParam.class);
      if (requestParam != null) {
        Map<String,Object> map=new HashMap<>();
        String key=parameters[i].getName();
        if (!StrUtil.isEmpty(requestParam.value())) {
          key=requestParam.value();
        }
        if (args[i] != null) {
          map.put(key,args[i]);
          argList.add(map);
        }
      }
    }
    if (argList.size() == 0) {
      return null;
    }
 else     if (argList.size() == 1) {
      return argList.get(0);
    }
 else {
      return argList;
    }
  }
}

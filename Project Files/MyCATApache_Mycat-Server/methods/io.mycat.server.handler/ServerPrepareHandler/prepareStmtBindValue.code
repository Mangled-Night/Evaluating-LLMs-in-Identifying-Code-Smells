/** 
 * 组装sql语句,替换动态参数为实际参数值
 */
private String prepareStmtBindValue(PreparedStatement pstmt,BindValue[] bindValues){
  String sql=pstmt.getStatement();
  SQLStatement sqlStatement=SQLUtils.parseSingleMysqlStatement(sql);
  boolean primitiveArg=!(sqlStatement instanceof SQLSelectStatement);
  int[] paramTypes=pstmt.getParametersType();
  sqlStatement.accept(new MySqlASTVisitorAdapter(){
    @Override public boolean visit(    SQLVariantRefExpr x){
      BindValue bindValue=bindValues[x.getIndex()];
      Object o=null;
      if (bindValue.isNull) {
        SQLReplaceable parent=(SQLReplaceable)x.getParent();
        parent.replace(x,new SQLNullExpr());
        return false;
      }
 else {
        if (primitiveArg && bindValue.value instanceof byte[]) {
          SQLReplaceable parent=(SQLReplaceable)x.getParent();
          parent.replace(x,new SQLHexExpr(HexFormatUtil.bytesToHexString((byte[])bindValue.value)));
          return false;
        }
switch (paramTypes[x.getIndex()] & 0xff) {
case Fields.FIELD_TYPE_TINY:
          o=bindValue.byteBinding;
        break;
case Fields.FIELD_TYPE_SHORT:
      o=bindValue.shortBinding;
    break;
case Fields.FIELD_TYPE_LONG:
  o=bindValue.intBinding;
break;
case Fields.FIELD_TYPE_LONGLONG:
o=(bindValue.longBinding);
break;
case Fields.FIELD_TYPE_FLOAT:
o=bindValue.floatBinding;
break;
case Fields.FIELD_TYPE_DOUBLE:
o=bindValue.doubleBinding;
break;
case Fields.FIELD_TYPE_TIME:
case Fields.FIELD_TYPE_DATE:
case Fields.FIELD_TYPE_DATETIME:
case Fields.FIELD_TYPE_TIMESTAMP:
o=bindValue.value;
break;
default :
if (bindValue.value instanceof byte[]) {
SQLReplaceable parent=(SQLReplaceable)x.getParent();
byte[] bytes=(byte[])bindValue.value;
parent.replace(x,new SQLCharExpr(new String(bytes)));
return false;
}
if (bindValue.value instanceof String) {
SQLReplaceable parent=(SQLReplaceable)x.getParent();
String value=(String)bindValue.value;
parent.replace(x,new SQLCharExpr(value));
return false;
}
throw new UnsupportedOperationException("unsupport " + bindValue.value);
}
SQLReplaceable parent=(SQLReplaceable)x.getParent();
parent.replace(x,SQLExprUtils.fromJavaObject(o));
return false;
}
}
}
);
return sqlStatement.toString();
}

/** 
 * Handles entities with ChunkMeshComponents, and passes them to the rendering engine. Also handles disposing of the mesh data, assuming the mesh is never changed after being added.
 */
@RegisterSystem(RegisterMode.CLIENT) public class ChunkMeshRenderer extends BaseComponentSystem {
  private static final Logger logger=LoggerFactory.getLogger(ChunkMeshRenderer.class);
  @In private RenderableWorld renderableWorld;
  private Map<EntityRef,EntityBasedRenderableChunk> pseudoChunks=new HashMap<>();
  @Override public void initialise(){
    renderableWorld.setChunkMeshRenderer(this);
  }
  @ReceiveEvent(components={ChunkMeshComponent.class,LocationComponent.class}) public void onNewMesh(  OnActivatedComponent event,  EntityRef entity,  ChunkMeshComponent mesh){
    pseudoChunks.put(entity,new EntityBasedRenderableChunk(entity));
  }
  @ReceiveEvent(components=ChunkMeshComponent.class) public void onDestroyMesh(  BeforeDeactivateComponent event,  EntityRef entity){
    EntityBasedRenderableChunk renderableChunk=pseudoChunks.remove(entity);
    if (renderableChunk != null) {
      renderableChunk.disposeMesh();
    }
  }
  public Collection<? extends RenderableChunk> getRenderableChunks(){
    return pseudoChunks.values();
  }
  @Override public void shutdown(){
    for (    EntityBasedRenderableChunk reference : pseudoChunks.values()) {
      reference.disposeMesh();
    }
  }
}

@Override public void processStanza(Stanza stanza) throws NotConnectedException, InterruptedException {
  if (!isFromProvisioningService(stanza,true)) {
    return;
  }
  Message message=(Message)stanza;
  Unfriend unfriend=Unfriend.from(message);
  BareJid unfriendJid=unfriend.getJid();
  final XMPPConnection connection=connection();
  Roster roster=Roster.getInstanceFor(connection);
  if (!roster.isSubscribedToMyPresence(unfriendJid)) {
    LOGGER.warning("Ignoring <unfriend/> request '" + stanza + "' because "+ unfriendJid+ " is already not subscribed to our presence.");
    return;
  }
  Presence unsubscribed=connection.getStanzaFactory().buildPresenceStanza().ofType(Presence.Type.unsubscribed).to(unfriendJid).build();
  connection.sendStanza(unsubscribed);
}
@Override public void processStanza(final Stanza stanza) throws NotConnectedException, InterruptedException {
  final Message friendMessage=(Message)stanza;
  final Friend friend=Friend.from(friendMessage);
  final BareJid friendJid=friend.getFriend();
  if (isFromProvisioningService(friendMessage,false)) {
    final XMPPConnection connection=connection();
    Friend friendNotification=new Friend(connection.getUser().asBareJid());
    Message notificationMessage=connection.getStanzaFactory().buildMessageStanza().to(friendJid).addExtension(friendNotification).build();
    connection.sendStanza(notificationMessage);
  }
 else {
    BareJid bareFrom=friendMessage.getFrom().asBareJid();
    if (!friendshipDeniedCache.containsKey(bareFrom)) {
      LOGGER.log(Level.WARNING,"Ignoring friendship recommendation " + friendMessage + " because friendship to this JID was not previously denied.");
      return;
    }
    if (!bareFrom.equals(friendJid)) {
      LOGGER.log(Level.WARNING,"Ignoring friendship recommendation " + friendMessage + " because it does not recommend itself, but "+ friendJid+ '.');
      return;
    }
    sendFriendshipRequest(friendJid);
  }
}

/** 
 * Manages XHTML formatted texts within messages. A XHTMLManager provides a high level access to get and set XHTML bodies to messages, enable and disable XHTML support and check if remote XMPP clients support XHTML.
 * @author Gaston Dombiak
 */
public class XHTMLManager {
static {
    XMPPConnectionRegistry.addConnectionCreationListener(new ConnectionCreationListener(){
      @Override public void connectionCreated(      XMPPConnection connection){
        XHTMLManager.setServiceEnabled(connection,true);
      }
    }
);
  }
  /** 
 * Returns an Iterator for the XHTML bodies in the message. Returns null if the message does not contain an XHTML extension.
 * @param message an XHTML message
 * @return an Iterator for the bodies in the message or null if none.
 */
  public static List<CharSequence> getBodies(  MessageView message){
    XHTMLExtension xhtmlExtension=XHTMLExtension.from(message);
    if (xhtmlExtension != null)     return xhtmlExtension.getBodies();
 else     return null;
  }
  /** 
 * Adds an XHTML body to the message.
 * @param messageBuilder the message that will receive the XHTML body
 * @param xhtmlText the string to add as an XHTML body to the message
 */
  public static void addBody(  MessageBuilder messageBuilder,  XHTMLText xhtmlText){
    XHTMLExtension xhtmlExtension=XHTMLExtension.from(messageBuilder);
    if (xhtmlExtension == null) {
      xhtmlExtension=new XHTMLExtension();
      messageBuilder.addExtension(xhtmlExtension);
    }
    xhtmlExtension.addBody(xhtmlText.toXML());
  }
  /** 
 * Adds an XHTML body to the message.
 * @param message the message that will receive the XHTML body
 * @param xhtmlText the string to add as an XHTML body to the message
 * @deprecated use {@link #addBody(MessageBuilder,XHTMLText)} instead.
 */
  @Deprecated public static void addBody(  Message message,  XHTMLText xhtmlText){
    XHTMLExtension xhtmlExtension=XHTMLExtension.from(message);
    if (xhtmlExtension == null) {
      xhtmlExtension=new XHTMLExtension();
      message.addExtension(xhtmlExtension);
    }
    xhtmlExtension.addBody(xhtmlText.toXML());
  }
  /** 
 * Returns true if the message contains an XHTML extension.
 * @param message the message to check if contains an XHTML extension or not
 * @return a boolean indicating whether the message is an XHTML message
 */
  public static boolean isXHTMLMessage(  Message message){
    return message.getExtensionElement(XHTMLExtension.ELEMENT,XHTMLExtension.NAMESPACE) != null;
  }
  /** 
 * Enables or disables the XHTML support on a given connection.<p> Before starting to send XHTML messages to a user, check that the user can handle XHTML messages. Enable the XHTML support to indicate that this client handles XHTML messages.
 * @param connection the connection where the service will be enabled or disabled
 * @param enabled indicates if the service will be enabled or disabled
 */
  public static synchronized void setServiceEnabled(  XMPPConnection connection,  boolean enabled){
    if (isServiceEnabled(connection) == enabled)     return;
    if (enabled) {
      ServiceDiscoveryManager.getInstanceFor(connection).addFeature(XHTMLExtension.NAMESPACE);
    }
 else {
      ServiceDiscoveryManager.getInstanceFor(connection).removeFeature(XHTMLExtension.NAMESPACE);
    }
  }
  /** 
 * Returns true if the XHTML support is enabled for the given connection.
 * @param connection the connection to look for XHTML support
 * @return a boolean indicating if the XHTML support is enabled for the given connection
 */
  public static boolean isServiceEnabled(  XMPPConnection connection){
    return ServiceDiscoveryManager.getInstanceFor(connection).includesFeature(XHTMLExtension.NAMESPACE);
  }
  /** 
 * Returns true if the specified user handles XHTML messages.
 * @param connection the connection to use to perform the service discovery
 * @param userID the user to check. A fully qualified xmpp ID, e.g. jdoe@example.com
 * @return a boolean indicating whether the specified user handles XHTML messages
 * @throws XMPPErrorException if there was an XMPP error returned.
 * @throws NoResponseException if there was no response from the remote entity.
 * @throws NotConnectedException if the XMPP connection is not connected.
 * @throws InterruptedException if the calling thread was interrupted.
 */
  public static boolean isServiceEnabled(  XMPPConnection connection,  Jid userID) throws NoResponseException, XMPPErrorException, NotConnectedException, InterruptedException {
    return ServiceDiscoveryManager.getInstanceFor(connection).supportsFeature(userID,XHTMLExtension.NAMESPACE);
  }
}

abstract class HashIterator {
  int nextSegmentIndex;
  int nextTableIndex;
  HashEntry<K,V>[] currentTable;
  HashEntry<K,V> nextEntry;
  HashEntry<K,V> lastReturned;
  K currentKey;
  HashIterator(){
    nextSegmentIndex=segments.length - 1;
    nextTableIndex=-1;
    advance();
  }
  public void rewind(){
    nextSegmentIndex=segments.length - 1;
    nextTableIndex=-1;
    currentTable=null;
    nextEntry=null;
    lastReturned=null;
    currentKey=null;
    advance();
  }
  public boolean hasMoreElements(){
    return hasNext();
  }
  final void advance(){
    if (nextEntry != null && (nextEntry=nextEntry.next) != null) {
      return;
    }
    while (nextTableIndex >= 0) {
      if ((nextEntry=currentTable[nextTableIndex--]) != null) {
        return;
      }
    }
    while (nextSegmentIndex >= 0) {
      Segment<K,V> seg=segments[nextSegmentIndex--];
      if (seg.count != 0) {
        currentTable=seg.table;
        for (int j=currentTable.length - 1; j >= 0; --j) {
          if ((nextEntry=currentTable[j]) != null) {
            nextTableIndex=j - 1;
            return;
          }
        }
      }
    }
  }
  public boolean hasNext(){
    while (nextEntry != null) {
      if (nextEntry.key() != null) {
        return true;
      }
      advance();
    }
    return false;
  }
  HashEntry<K,V> nextEntry(){
    do {
      if (nextEntry == null) {
        throw new NoSuchElementException();
      }
      lastReturned=nextEntry;
      currentKey=lastReturned.key();
      advance();
    }
 while (currentKey == null);
    return lastReturned;
  }
  public void remove(){
    if (lastReturned == null) {
      throw new IllegalStateException();
    }
    ConcurrentWeakKeyHashMap.this.remove(currentKey);
    lastReturned=null;
  }
}

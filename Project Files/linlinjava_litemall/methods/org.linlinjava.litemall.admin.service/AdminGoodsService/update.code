/** 
 * 编辑商品 NOTE： 由于商品涉及到四个表，特别是litemall_goods_product表依赖litemall_goods_specification表， 这导致允许所有字段都是可编辑会带来一些问题，因此这里商品编辑功能是受限制： （1）litemall_goods表可以编辑字段； （2）litemall_goods_specification表只能编辑pic_url字段，其他操作不支持； （3）litemall_goods_product表只能编辑price, number和url字段，其他操作不支持； （4）litemall_goods_attribute表支持编辑、添加和删除操作。 NOTE2: 前后端这里使用了一个小技巧： 如果前端传来的update_time字段是空，则说明前端已经更新了某个记录，则这个记录会更新； 否则说明这个记录没有编辑过，无需更新该记录。 NOTE3: （1）购物车缓存了一些商品信息，因此需要及时更新。 目前这些字段是goods_sn, goods_name, price, pic_url。 （2）但是订单里面的商品信息则是不会更新。 如果订单是未支付订单，此时仍然以旧的价格支付。
 */
@Transactional public Object update(GoodsAllinone goodsAllinone){
  Object error=validate(goodsAllinone);
  if (error != null) {
    return error;
  }
  LitemallGoods goods=goodsAllinone.getGoods();
  LitemallGoodsAttribute[] attributes=goodsAllinone.getAttributes();
  LitemallGoodsSpecification[] specifications=goodsAllinone.getSpecifications();
  LitemallGoodsProduct[] products=goodsAllinone.getProducts();
  String url=qCodeService.createGoodShareImage(goods.getId().toString(),goods.getPicUrl(),goods.getName());
  goods.setShareUrl(url);
  BigDecimal retailPrice=new BigDecimal(Integer.MAX_VALUE);
  for (  LitemallGoodsProduct product : products) {
    BigDecimal productPrice=product.getPrice();
    if (retailPrice.compareTo(productPrice) == 1) {
      retailPrice=productPrice;
    }
  }
  goods.setRetailPrice(retailPrice);
  if (goodsService.updateById(goods) == 0) {
    throw new RuntimeException("更新数据失败");
  }
  Integer gid=goods.getId();
  for (  LitemallGoodsSpecification specification : specifications) {
    if (specification.getUpdateTime() == null) {
      specification.setSpecification(null);
      specification.setValue(null);
      specificationService.updateById(specification);
    }
  }
  for (  LitemallGoodsProduct product : products) {
    if (product.getUpdateTime() == null) {
      productService.updateById(product);
    }
  }
  for (  LitemallGoodsAttribute attribute : attributes) {
    if (attribute.getId() == null || attribute.getId().equals(0)) {
      attribute.setGoodsId(goods.getId());
      attributeService.add(attribute);
    }
 else     if (attribute.getDeleted()) {
      attributeService.deleteById(attribute.getId());
    }
 else     if (attribute.getUpdateTime() == null) {
      attributeService.updateById(attribute);
    }
  }
  for (  LitemallGoodsProduct product : products) {
    cartService.updateProduct(product.getId(),goods.getGoodsSn(),goods.getName(),product.getPrice(),product.getUrl());
  }
  return ResponseUtil.ok();
}

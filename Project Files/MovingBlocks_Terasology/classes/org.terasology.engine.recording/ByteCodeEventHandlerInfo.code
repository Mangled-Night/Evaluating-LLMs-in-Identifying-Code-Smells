private static class ByteCodeEventHandlerInfo implements EventSystemReplayImpl.EventHandlerInfo {
  private ComponentSystem handler;
  private String activity;
  private MethodAccess methodAccess;
  private int methodIndex;
  private ImmutableList<Class<? extends Component>> filterComponents;
  private ImmutableList<Class<? extends Component>> componentParams;
  private int priority;
  ByteCodeEventHandlerInfo(  ComponentSystem handler,  Method method,  int priority,  @Nullable String activity,  Collection<Class<? extends Component>> filterComponents,  Collection<Class<? extends Component>> componentParams){
    this.handler=handler;
    this.activity=activity;
    this.methodAccess=MethodAccess.get(handler.getClass());
    methodIndex=methodAccess.getIndex(method.getName(),method.getParameterTypes());
    this.filterComponents=ImmutableList.copyOf(filterComponents);
    this.componentParams=ImmutableList.copyOf(componentParams);
    this.priority=priority;
  }
  @Override public boolean isValidFor(  EntityRef entity){
    for (    Class<? extends Component> component : filterComponents) {
      if (!entity.hasComponent(component)) {
        return false;
      }
    }
    return true;
  }
  @Override public void invoke(  EntityRef entity,  Event event){
    try {
      Object[] params=new Object[2 + componentParams.size()];
      params[0]=event;
      params[1]=entity;
      for (int i=0; i < componentParams.size(); ++i) {
        params[i + 2]=entity.getComponent(componentParams.get(i));
      }
      if (activity != null) {
        PerformanceMonitor.startActivity(activity);
      }
      try {
        methodAccess.invoke(handler,methodIndex,params);
      }
  finally {
        if (activity != null) {
          PerformanceMonitor.endActivity();
        }
      }
    }
 catch (    Exception ex) {
      logger.error("Failed to invoke event",ex);
    }
  }
  @Override public int getPriority(){
    return priority;
  }
  @Override public ComponentSystem getHandler(){
    return handler;
  }
}

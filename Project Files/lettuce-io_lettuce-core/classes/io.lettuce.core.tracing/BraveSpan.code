/** 
 * Brave-specific  {@link io.lettuce.core.tracing.Tracer.Span}.
 */
static class BraveSpan extends Tracer.Span {
  private final brave.Span span;
  private final BraveTracingOptions tracingOptions;
  private final boolean includeCommandArgsInSpanTags;
  BraveSpan(  Span span,  BraveTracingOptions tracingOptions,  boolean includeCommandArgsInSpanTags){
    this.span=span;
    this.tracingOptions=tracingOptions;
    this.includeCommandArgsInSpanTags=includeCommandArgsInSpanTags;
  }
  @Override public BraveSpan start(  RedisCommand<?,?,?> command){
    span.name(command.getType().name());
    if (includeCommandArgsInSpanTags && command.getArgs() != null) {
      span.tag("redis.args",command.getArgs().toCommandString());
    }
    if (command instanceof CompleteableCommand) {
      CompleteableCommand<?> completeableCommand=(CompleteableCommand<?>)command;
      completeableCommand.onComplete((o,throwable) -> {
        if (command.getOutput() != null) {
          String error=command.getOutput().getError();
          if (error != null) {
            span.tag("error",error);
          }
 else           if (throwable != null) {
            span.tag("exception",throwable.toString());
            span.error(throwable);
          }
        }
        span.finish();
      }
);
    }
 else {
      throw new IllegalArgumentException("Command " + command + " must implement CompleteableCommand to attach Span completion to command completion");
    }
    span.start();
    this.tracingOptions.customizeSpan(command,span);
    return this;
  }
  @Override public BraveSpan name(  String name){
    span.name(name);
    return this;
  }
  @Override public BraveSpan annotate(  String value){
    span.annotate(value);
    return this;
  }
  @Override public BraveSpan tag(  String key,  String value){
    span.tag(key,value);
    return this;
  }
  @Override public BraveSpan error(  Throwable throwable){
    span.error(throwable);
    return this;
  }
  @Override public BraveSpan remoteEndpoint(  Endpoint endpoint){
    zipkin2.Endpoint zkEndpoint=BraveEndpoint.class.cast(endpoint).endpoint;
    if (zkEndpoint.serviceName() != null) {
      span.remoteServiceName(zkEndpoint.serviceName());
    }
    String ip=zkEndpoint.ipv6() != null ? zkEndpoint.ipv6() : zkEndpoint.ipv4();
    span.remoteIpAndPort(ip,zkEndpoint.portAsInt());
    return this;
  }
  @Override public void finish(){
    span.finish();
  }
  public brave.Span getSpan(){
    return span;
  }
}

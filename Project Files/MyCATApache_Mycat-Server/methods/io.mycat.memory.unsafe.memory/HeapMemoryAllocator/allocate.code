@Override public MemoryBlock allocate(long size) throws OutOfMemoryError {
  if (shouldPool(size)) {
synchronized (this) {
      final LinkedList<WeakReference<MemoryBlock>> pool=bufferPoolsBySize.get(size);
      if (pool != null) {
        while (!pool.isEmpty()) {
          final WeakReference<MemoryBlock> blockReference=pool.pop();
          final MemoryBlock memory=blockReference.get();
          if (memory != null) {
            assert (memory.size() == size);
            return memory;
          }
        }
        bufferPoolsBySize.remove(size);
      }
    }
  }
  long[] array=new long[(int)((size + 7) / 8)];
  return new MemoryBlock(array,Platform.LONG_ARRAY_OFFSET,size);
}

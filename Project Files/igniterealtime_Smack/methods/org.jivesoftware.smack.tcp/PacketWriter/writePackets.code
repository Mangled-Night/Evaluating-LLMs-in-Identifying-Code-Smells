private void writePackets(){
  try {
    while (!done()) {
      Element element=nextStreamElement();
      if (element == null) {
        continue;
      }
      final BundleAndDeferCallback localBundleAndDeferCallback=bundleAndDeferCallback;
      if (localBundleAndDeferCallback != null && isAuthenticated() && shouldBundleAndDefer) {
        shouldBundleAndDefer=false;
        final AtomicBoolean bundlingAndDeferringStopped=new AtomicBoolean();
        final int bundleAndDeferMillis=localBundleAndDeferCallback.getBundleAndDeferMillis(new BundleAndDefer(bundlingAndDeferringStopped));
        if (bundleAndDeferMillis > 0) {
          long remainingWait=bundleAndDeferMillis;
          final long waitStart=System.currentTimeMillis();
synchronized (bundlingAndDeferringStopped) {
            while (!bundlingAndDeferringStopped.get() && remainingWait > 0) {
              bundlingAndDeferringStopped.wait(remainingWait);
              remainingWait=bundleAndDeferMillis - (System.currentTimeMillis() - waitStart);
            }
          }
        }
      }
      Stanza packet=null;
      if (element instanceof Stanza) {
        packet=(Stanza)element;
      }
 else       if (element instanceof Enable) {
        unacknowledgedStanzas=new ArrayBlockingQueue<>(UNACKKNOWLEDGED_STANZAS_QUEUE_SIZE);
      }
      maybeAddToUnacknowledgedStanzas(packet);
      CharSequence elementXml=element.toXML(outgoingStreamXmlEnvironment);
      if (elementXml instanceof XmlStringBuilder) {
        try {
          ((XmlStringBuilder)elementXml).write(writer,outgoingStreamXmlEnvironment);
        }
 catch (        NullPointerException npe) {
          LOGGER.log(Level.FINE,"NPE in XmlStringBuilder of " + element.getClass() + ": "+ element,npe);
          throw npe;
        }
      }
 else {
        writer.write(elementXml.toString());
      }
      if (queue.isEmpty()) {
        writer.flush();
      }
      if (packet != null) {
        firePacketSendingListeners(packet);
      }
    }
    if (!instantShutdown) {
      try {
        while (!queue.isEmpty()) {
          Element packet=queue.remove();
          if (packet instanceof Stanza) {
            Stanza stanza=(Stanza)packet;
            maybeAddToUnacknowledgedStanzas(stanza);
          }
          writer.write(packet.toXML().toString());
        }
      }
 catch (      Exception e) {
        LOGGER.log(Level.WARNING,"Exception flushing queue during shutdown, ignore and continue",e);
      }
      try {
        writer.write("</stream:stream>");
        writer.flush();
      }
 catch (      Exception e) {
        LOGGER.log(Level.WARNING,"Exception writing closing stream element",e);
      }
      queue.clear();
    }
 else     if (instantShutdown && isSmEnabled()) {
      drainWriterQueueToUnacknowledgedStanzas();
    }
  }
 catch (  Exception e) {
    if (!(done() || queue.isShutdown())) {
      running=false;
      notifyConnectionError(e);
    }
 else {
      LOGGER.log(Level.FINE,"Ignoring Exception in writePackets()",e);
    }
  }
}

/** 
 * Utility to run a  {@link ThrowingCallable callback function} while Redis is configured with a password.
 * @author Mark Paluch
 * @author Tugdual Grall
 */
public class WithPassword {
  /** 
 * Run a  {@link ThrowingCallable callback function} while Redis is configured with a password.
 * @param client
 * @param callable
 */
  public static void run(  RedisClient client,  ThrowingCallable callable){
    StatefulRedisConnection<String,String> connection=client.connect();
    RedisCommands<String,String> commands=connection.sync();
    try {
      enableAuthentication(commands);
      commands.auth(TestSettings.password());
      try {
        callable.call();
      }
 catch (      RuntimeException e) {
        throw e;
      }
catch (      Throwable e) {
        throw new UndeclaredThrowableException(e);
      }
    }
  finally {
      disableAuthentication(commands);
      connection.close();
    }
  }
  /** 
 * Enable password authentication via  {@code requirepass}.
 * @param commands
 */
  public static void enableAuthentication(  RedisCommands<String,String> commands){
    RedisConditions conditions=RedisConditions.of(commands);
    if (conditions.hasCommand("CONFIG")) {
      commands.configSet("requirepass",TestSettings.password().toString());
    }
    if (conditions.hasCommand("ACL")) {
      Command<String,String,List<Object>> command=CliParser.parse("ACL SETUSER " + TestSettings.aclUsername() + " on >"+ TestSettings.aclPassword()+ " ~cached:* +@all");
      commands.dispatch(command.getType(),command.getOutput(),command.getArgs());
    }
  }
  /** 
 * Disable password authentication via  {@code requirepass} and optionally the {@code ACL} command.
 * @param commands
 */
  public static void disableAuthentication(  RedisCommands<String,String> commands){
    try {
      commands.auth(TestSettings.password());
    }
 catch (    Exception e) {
    }
    RedisConditions conditions=RedisConditions.of(commands);
    if (conditions.hasCommand("CONFIG")) {
      commands.configSet("requirepass","");
    }
    if (conditions.hasCommand("ACL")) {
      Command<String,String,List<Object>> command=CliParser.parse("ACL DELUSER " + TestSettings.aclUsername());
      commands.dispatch(command.getType(),command.getOutput(),command.getArgs());
      command=CliParser.parse("acl setuser default nopass");
      commands.dispatch(command.getType(),command.getOutput(),command.getArgs());
    }
  }
public interface ThrowingCallable {
    void call() throws Throwable ;
  }
}

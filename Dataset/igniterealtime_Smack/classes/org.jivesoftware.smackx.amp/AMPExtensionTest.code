public class AMPExtensionTest {
  private InputStream CORRECT_SENDING_STANZA_STREAM;
  private InputStream INCORRECT_RECEIVING_STANZA_STREAM;
  @BeforeEach public void setUp(){
    CORRECT_SENDING_STANZA_STREAM=getClass().getResourceAsStream("correct_stanza_test.xml");
    INCORRECT_RECEIVING_STANZA_STREAM=getClass().getResourceAsStream("incorrect_stanza_test.xml");
  }
  @Test public void isCorrectToXmlTransform() throws IOException {
    String correctStanza=toString(CORRECT_SENDING_STANZA_STREAM);
    AMPExtension ext=new AMPExtension();
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.alert,new AMPDeliverCondition(AMPDeliverCondition.Value.direct)));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.drop,new AMPDeliverCondition(AMPDeliverCondition.Value.forward)));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.error,new AMPDeliverCondition(AMPDeliverCondition.Value.gateway)));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.notify,new AMPDeliverCondition(AMPDeliverCondition.Value.none)));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.notify,new AMPDeliverCondition(AMPDeliverCondition.Value.stored)));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.notify,new AMPExpireAtCondition("2004-09-10T08:33:14Z")));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.notify,new AMPMatchResourceCondition(AMPMatchResourceCondition.Value.any)));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.notify,new AMPMatchResourceCondition(AMPMatchResourceCondition.Value.exact)));
    ext.addRule(new AMPExtension.Rule(AMPExtension.Action.notify,new AMPMatchResourceCondition(AMPMatchResourceCondition.Value.other)));
    assertEquals(correctStanza,ext.toXML().toString());
  }
  @Test public void isCorrectFromXmlErrorHandling() throws Exception {
    AMPExtensionProvider ampProvider=new AMPExtensionProvider();
    XmlPullParser parser=PacketParserUtils.getParserFor(INCORRECT_RECEIVING_STANZA_STREAM);
    assertEquals(AMPExtension.ELEMENT,parser.getName());
    ExtensionElement extension=ampProvider.parse(parser);
    assertTrue(extension instanceof AMPExtension);
    AMPExtension amp=(AMPExtension)extension;
    assertEquals(0,amp.getRulesCount());
    assertEquals(AMPExtension.Status.alert,amp.getStatus());
    assertEquals("bernardo@hamlet.lit/elsinore",amp.getFrom());
    assertEquals("francisco@hamlet.lit",amp.getTo());
  }
  @Test public void isCorrectFromXmlDeserialization() throws Exception {
    AMPExtensionProvider ampProvider=new AMPExtensionProvider();
    XmlPullParser parser=PacketParserUtils.getParserFor(CORRECT_SENDING_STANZA_STREAM);
    assertEquals(AMPExtension.ELEMENT,parser.getName());
    ExtensionElement extension=ampProvider.parse(parser);
    assertTrue(extension instanceof AMPExtension);
    AMPExtension amp=(AMPExtension)extension;
    assertEquals(9,amp.getRulesCount());
  }
  private static String toString(  InputStream stream) throws IOException {
    byte[] data=new byte[stream.available()];
    stream.read(data);
    stream.close();
    return new String(data,Charset.defaultCharset());
  }
}

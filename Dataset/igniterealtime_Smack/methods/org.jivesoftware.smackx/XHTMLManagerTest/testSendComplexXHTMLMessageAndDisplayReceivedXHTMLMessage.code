/** 
 * Low level API test. Test a message with two XHTML bodies and several XHTML tags. 1. User_1 will send a message with XHTML to user_2 2. User_2 will receive the message and iterate over the XHTML bodies to check if everything is fine 3. User_1 will wait several seconds for an ACK from user_2, if none is received then something is wrong
 */
public void testSendComplexXHTMLMessageAndDisplayReceivedXHTMLMessage(){
  Chat chat1=getConnection(0).getChatManager().createChat(getBareJID(1),null);
  final StanzaCollector chat2=getConnection(1).createStanzaCollector(new ThreadFilter(chat1.getThreadID()));
  Message msg=new Message();
  msg.setSubject("Any subject you want");
  msg.setBody("awesome! As Emerson once said: A foolish consistency is the hobgoblin of little minds.");
  XHTMLText xhtmlText=new XHTMLText(null,"es-ES");
  xhtmlText.appendOpenHeaderTag(1,null);
  xhtmlText.append("impresionante!");
  xhtmlText.appendCloseHeaderTag(1);
  xhtmlText.appendOpenParagraphTag(null);
  xhtmlText.append("Como Emerson dijo una vez:");
  xhtmlText.appendCloseParagraphTag();
  xhtmlText.appendOpenBlockQuoteTag(null);
  xhtmlText.appendOpenParagraphTag(null);
  xhtmlText.append("Una consistencia rid&#237;cula es el espantajo de mentes peque&#241;as.");
  xhtmlText.appendCloseParagraphTag();
  xhtmlText.appendCloseBlockQuoteTag();
  XHTMLManager.addBody(msg,xhtmlText.toString());
  xhtmlText=new XHTMLText(null,"en-US");
  xhtmlText.appendOpenHeaderTag(1,null);
  xhtmlText.append("awesome!");
  xhtmlText.appendCloseHeaderTag(1);
  xhtmlText.appendOpenParagraphTag(null);
  xhtmlText.append("As Emerson once said:");
  xhtmlText.appendCloseParagraphTag();
  xhtmlText.appendOpenBlockQuoteTag(null);
  xhtmlText.appendOpenParagraphTag(null);
  xhtmlText.append("A foolish consistency is the hobgoblin of little minds.");
  xhtmlText.appendCloseParagraphTag();
  xhtmlText.appendCloseBlockQuoteTag();
  XHTMLManager.addBody(msg,xhtmlText.toString());
  try {
    bodiesSent=2;
    bodiesReceived=0;
    chat1.sendMessage(msg);
  }
 catch (  Exception e) {
    fail("An error occurred sending the message with XHTML");
  }
  Packet packet=chat2.nextResult(2000);
  int received=0;
  Message message=(Message)packet;
  assertTrue("The received message is not an XHTML Message",XHTMLManager.isXHTMLMessage(message));
  try {
    assertTrue("Message without XHTML bodies",XHTMLManager.getBodies(message).hasNext());
    for (Iterator<String> it=XHTMLManager.getBodies(message); it.hasNext(); ) {
      received++;
      String body=it.next();
      System.out.println(body);
    }
    bodiesReceived=received;
  }
 catch (  ClassCastException e) {
    fail("ClassCastException - Most probable cause is that smack providers" + "is misconfigured");
  }
  assertEquals("Number of sent and received XHTMP bodies does not match",bodiesSent,bodiesReceived);
}

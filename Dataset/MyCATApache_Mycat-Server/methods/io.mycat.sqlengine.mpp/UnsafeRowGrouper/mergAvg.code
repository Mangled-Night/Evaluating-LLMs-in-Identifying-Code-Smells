private void mergAvg(UnsafeRow toRow) throws UnsupportedEncodingException {
  if (mergCols == null) {
    return;
  }
  for (  MergeCol merg : mergCols) {
    if (merg.mergeType == MergeCol.MERGE_AVG) {
      byte[] result=null;
      byte[] avgSum=null;
      byte[] avgCount=null;
      int type=merg.colMeta.colType;
      int avgSumIndex=merg.colMeta.avgSumIndex;
      int avgCountIndex=merg.colMeta.avgCountIndex;
switch (type) {
case ColMeta.COL_TYPE_BIT:
        avgSum=BytesTools.toBytes(toRow.getByte(avgSumIndex));
      avgCount=BytesTools.toBytes(toRow.getLong(avgCountIndex));
    break;
case ColMeta.COL_TYPE_INT:
case ColMeta.COL_TYPE_LONG:
case ColMeta.COL_TYPE_INT24:
  avgSum=BytesTools.int2Bytes(toRow.getInt(avgSumIndex));
avgCount=BytesTools.long2Bytes(toRow.getLong(avgCountIndex));
break;
case ColMeta.COL_TYPE_SHORT:
avgSum=BytesTools.short2Bytes(toRow.getShort(avgSumIndex));
avgCount=BytesTools.long2Bytes(toRow.getLong(avgCountIndex));
break;
case ColMeta.COL_TYPE_LONGLONG:
avgSum=BytesTools.long2Bytes(toRow.getLong(avgSumIndex));
avgCount=BytesTools.long2Bytes(toRow.getLong(avgCountIndex));
break;
case ColMeta.COL_TYPE_FLOAT:
avgSum=BytesTools.float2Bytes(toRow.getFloat(avgSumIndex));
avgCount=BytesTools.long2Bytes(toRow.getLong(avgCountIndex));
break;
case ColMeta.COL_TYPE_DOUBLE:
avgSum=BytesTools.double2Bytes(toRow.getDouble(avgSumIndex));
avgCount=BytesTools.long2Bytes(toRow.getLong(avgCountIndex));
break;
case ColMeta.COL_TYPE_NEWDECIMAL:
int scale=merg.colMeta.decimals;
BigDecimal sumDecimal=toRow.getDecimal(avgSumIndex,scale);
avgSum=sumDecimal == null ? null : sumDecimal.toString().getBytes();
avgCount=BytesTools.long2Bytes(toRow.getLong(avgCountIndex));
break;
default :
break;
}
result=mertFields(avgSum,avgCount,merg.colMeta.colType,merg.mergeType);
if (result != null) {
switch (type) {
case ColMeta.COL_TYPE_BIT:
toRow.setByte(avgSumIndex,result[0]);
break;
case ColMeta.COL_TYPE_INT:
case ColMeta.COL_TYPE_LONG:
case ColMeta.COL_TYPE_INT24:
toRow.setInt(avgSumIndex,BytesTools.getInt(result));
break;
case ColMeta.COL_TYPE_SHORT:
toRow.setShort(avgSumIndex,BytesTools.getShort(result));
break;
case ColMeta.COL_TYPE_LONGLONG:
toRow.setLong(avgSumIndex,BytesTools.getLong(result));
break;
case ColMeta.COL_TYPE_FLOAT:
toRow.setFloat(avgSumIndex,BytesTools.getFloat(result));
break;
case ColMeta.COL_TYPE_DOUBLE:
toRow.setDouble(avgSumIndex,ByteUtil.getDouble(result));
break;
case ColMeta.COL_TYPE_NEWDECIMAL:
toRow.updateDecimal(avgSumIndex,new BigDecimal(new String(result)));
break;
default :
break;
}
}
}
}
}

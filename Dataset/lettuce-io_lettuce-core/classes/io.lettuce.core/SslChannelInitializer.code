static class SslChannelInitializer extends io.netty.channel.ChannelInitializer<Channel> {
  private final Supplier<List<ChannelHandler>> handlers;
  private final HostAndPort hostAndPort;
  private final SslVerifyMode verifyPeer;
  private final boolean startTls;
  private final ClientResources clientResources;
  private final SslOptions sslOptions;
  public SslChannelInitializer(  Supplier<List<ChannelHandler>> handlers,  HostAndPort hostAndPort,  SslVerifyMode verifyPeer,  boolean startTls,  ClientResources clientResources,  SslOptions sslOptions){
    this.handlers=handlers;
    this.hostAndPort=hostAndPort;
    this.verifyPeer=verifyPeer;
    this.startTls=startTls;
    this.clientResources=clientResources;
    this.sslOptions=sslOptions;
  }
  ChannelHandler withHostAndPort(  HostAndPort hostAndPort){
    return new SslChannelInitializer(handlers,hostAndPort,verifyPeer,startTls,clientResources,sslOptions);
  }
  @Override protected void initChannel(  Channel channel) throws Exception {
    SSLEngine sslEngine=initializeSSLEngine(channel.alloc());
    SslHandler sslHandler=new SslHandler(sslEngine,startTls);
    Duration sslHandshakeTimeout=sslOptions.getHandshakeTimeout();
    sslHandler.setHandshakeTimeoutMillis(sslHandshakeTimeout.toMillis());
    channel.pipeline().addLast(sslHandler);
    for (    ChannelHandler handler : handlers.get()) {
      channel.pipeline().addLast(handler);
    }
    clientResources.nettyCustomizer().afterChannelInitialized(channel);
  }
  private SSLEngine initializeSSLEngine(  ByteBufAllocator alloc) throws IOException, GeneralSecurityException {
    SSLParameters sslParams=sslOptions.createSSLParameters();
    SslContextBuilder sslContextBuilder=sslOptions.createSslContextBuilder();
    if (verifyPeer == SslVerifyMode.FULL) {
      sslParams.setEndpointIdentificationAlgorithm("HTTPS");
    }
 else     if (verifyPeer == SslVerifyMode.CA) {
      sslParams.setEndpointIdentificationAlgorithm("");
    }
 else     if (verifyPeer == SslVerifyMode.NONE) {
      sslContextBuilder.trustManager(InsecureTrustManagerFactory.INSTANCE);
    }
    SslContext sslContext=sslContextBuilder.build();
    SSLEngine sslEngine=hostAndPort != null ? sslContext.newEngine(alloc,hostAndPort.getHostText(),hostAndPort.getPort()) : sslContext.newEngine(alloc);
    sslEngine.setSSLParameters(sslParams);
    return sslEngine;
  }
}

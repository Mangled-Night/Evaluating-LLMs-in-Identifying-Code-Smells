public class TargetSystem {
  private final BlockEntityRegistry blockRegistry;
  private final Physics physics;
  private EntityRef target=EntityRef.NULL;
  private EntityRef prevTarget=EntityRef.NULL;
  private Vector3i targetBlockPos;
  private CollisionGroup[] filter={StandardCollisionGroup.DEFAULT,StandardCollisionGroup.WORLD,StandardCollisionGroup.CHARACTER};
  public TargetSystem(  BlockEntityRegistry blockRegistry,  Physics physics){
    this.blockRegistry=blockRegistry;
    this.physics=physics;
  }
  /** 
 * Gets the position of the block that is currently targeted. If there is currently no target, this will return a null reference (isTargetAvailable() would have returned false in this case).
 * @return the target block position in world coordinates, a vector of 3 integers.
 */
  public Vector3ic getTargetBlockPosition(){
    return targetBlockPos;
  }
  public boolean isTargetAvailable(){
    return target.exists() || targetBlockPos != null;
  }
  public EntityRef getPreviousTarget(){
    return prevTarget;
  }
  public EntityRef getTarget(){
    return target;
  }
  public void setFilter(  CollisionGroup... filter){
    this.filter=Arrays.copyOf(filter,filter.length);
  }
  public boolean updateTarget(  Vector3f pos,  Vector3f dir,  float maxDist){
    if (targetBlockPos != null && !target.exists()) {
      target=blockRegistry.getEntityAt(targetBlockPos);
    }
    HitResult hitInfo=physics.rayTrace(pos,dir,maxDist,filter);
    EntityRef newTarget=hitInfo.getEntity();
    if (hitInfo.isWorldHit()) {
      if (targetBlockPos != null) {
        if (targetBlockPos.equals(hitInfo.getBlockPosition())) {
          return false;
        }
      }
      targetBlockPos=hitInfo.getBlockPosition();
    }
 else {
      if (target.equals(newTarget)) {
        return false;
      }
      targetBlockPos=null;
    }
    prevTarget=target;
    target=newTarget;
    LocationComponent location=target.getComponent(LocationComponent.class);
    if (location != null && targetBlockPos != null) {
      location.setLocalPosition(new Vector3f(targetBlockPos));
    }
    return true;
  }
}

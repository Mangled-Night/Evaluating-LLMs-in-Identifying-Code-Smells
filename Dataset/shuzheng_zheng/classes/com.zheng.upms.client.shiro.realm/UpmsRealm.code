/** 
 * 用户认证和授权 Created by shuzheng on 2017/1/20.
 */
public class UpmsRealm extends AuthorizingRealm {
  private static final Logger LOGGER=LoggerFactory.getLogger(UpmsRealm.class);
  @Autowired private UpmsApiService upmsApiService;
  /** 
 * 授权：验证权限时调用
 * @param principalCollection
 * @return
 */
  @Override protected AuthorizationInfo doGetAuthorizationInfo(  PrincipalCollection principalCollection){
    String username=(String)principalCollection.getPrimaryPrincipal();
    UpmsUser upmsUser=upmsApiService.selectUpmsUserByUsername(username);
    List<UpmsRole> upmsRoles=upmsApiService.selectUpmsRoleByUpmsUserId(upmsUser.getUserId());
    Set<String> roles=new HashSet<>();
    for (    UpmsRole upmsRole : upmsRoles) {
      if (StringUtils.isNotBlank(upmsRole.getName())) {
        roles.add(upmsRole.getName());
      }
    }
    List<UpmsPermission> upmsPermissions=upmsApiService.selectUpmsPermissionByUpmsUserId(upmsUser.getUserId());
    Set<String> permissions=new HashSet<>();
    for (    UpmsPermission upmsPermission : upmsPermissions) {
      if (StringUtils.isNotBlank(upmsPermission.getPermissionValue())) {
        permissions.add(upmsPermission.getPermissionValue());
      }
    }
    SimpleAuthorizationInfo simpleAuthorizationInfo=new SimpleAuthorizationInfo();
    simpleAuthorizationInfo.setStringPermissions(permissions);
    simpleAuthorizationInfo.setRoles(roles);
    return simpleAuthorizationInfo;
  }
  /** 
 * 认证：登录时调用
 * @param authenticationToken
 * @return
 * @throws AuthenticationException
 */
  @Override protected AuthenticationInfo doGetAuthenticationInfo(  AuthenticationToken authenticationToken) throws AuthenticationException {
    String username=(String)authenticationToken.getPrincipal();
    String password=new String((char[])authenticationToken.getCredentials());
    String upmsType=PropertiesFileUtil.getInstance("zheng-upms-client").get("zheng.upms.type");
    if ("client".equals(upmsType)) {
      return new SimpleAuthenticationInfo(username,password,getName());
    }
    UpmsUser upmsUser=upmsApiService.selectUpmsUserByUsername(username);
    if (null == upmsUser) {
      throw new UnknownAccountException();
    }
    if (!upmsUser.getPassword().equals(MD5Util.md5(password + upmsUser.getSalt()))) {
      throw new IncorrectCredentialsException();
    }
    if (upmsUser.getLocked() == 1) {
      throw new LockedAccountException();
    }
    return new SimpleAuthenticationInfo(username,password,getName());
  }
}

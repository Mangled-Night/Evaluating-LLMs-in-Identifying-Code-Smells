/** 
 * 数据分区工具
 * @author mycat
 */
public final class PartitionUtil {
  private static final int PARTITION_LENGTH=1024;
  private static final long AND_VALUE=PARTITION_LENGTH - 1;
  private final int[] segment=new int[PARTITION_LENGTH];
  /** 
 * <pre>
 * @param count 表示定义的分区数
 * @param length 表示对应每个分区的取值长度注意：其中count,length两个数组的长度必须是一致的。 约束：1024 = sum((count[i]*length[i])). count和length两个向量的点积恒等于1024 </pre>
 */
  public PartitionUtil(  int[] count,  int[] length){
    if (count == null || length == null || (count.length != length.length)) {
      throw new RuntimeException("error,check your scope & scopeLength definition.");
    }
    int segmentLength=0;
    for (int i=0; i < count.length; i++) {
      segmentLength+=count[i];
    }
    int[] ai=new int[segmentLength + 1];
    int index=0;
    for (int i=0; i < count.length; i++) {
      for (int j=0; j < count[i]; j++) {
        ai[++index]=ai[index - 1] + length[i];
      }
    }
    if (ai[ai.length - 1] != PARTITION_LENGTH) {
      throw new RuntimeException("error,check your partitionScope definition.");
    }
    for (int i=1; i < ai.length; i++) {
      for (int j=ai[i - 1]; j < ai[i]; j++) {
        segment[j]=(i - 1);
      }
    }
  }
  public int partition(  long hash){
    return segment[(int)(hash & AND_VALUE)];
  }
  public int partition(  String key,  int start,  int end){
    return partition(StringUtil.hash(key,start,end));
  }
}

private static FormField parseField(XmlPullParser parser,XmlEnvironment xmlEnvironment,String formType) throws XmlPullParserException, IOException, SmackParsingException {
  return parseField(parser,xmlEnvironment,formType,null);
}
private static FormField parseField(XmlPullParser parser,XmlEnvironment xmlEnvironment,String formType,DataForm.ReportedData reportedData) throws XmlPullParserException, IOException, SmackParsingException {
  final int initialDepth=parser.getDepth();
  final String fieldName=parser.getAttributeValue("var");
  final String label=parser.getAttributeValue("","label");
  FormField.Type type=null;
{
    String fieldTypeString=parser.getAttributeValue("type");
    if (fieldTypeString != null) {
      type=FormField.Type.fromString(fieldTypeString);
    }
  }
  List<FormField.Value> values=new ArrayList<>();
  List<FormField.Option> options=new ArrayList<>();
  List<FormFieldChildElement> childElements=new ArrayList<>();
  boolean required=false;
  outerloop:   while (true) {
    XmlPullParser.TagEvent eventType=parser.nextTag();
switch (eventType) {
case START_ELEMENT:
      QName qname=parser.getQName();
    if (qname.equals(FormField.Value.QNAME)) {
      FormField.Value value=parseValue(parser);
      values.add(value);
    }
 else     if (qname.equals(FormField.Option.QNAME)) {
      FormField.Option option=parseOption(parser);
      options.add(option);
    }
 else     if (qname.equals(FormField.Required.QNAME)) {
      required=true;
    }
 else {
      FormFieldChildElementProvider<?> provider=FormFieldChildElementProviderManager.getFormFieldChildElementProvider(qname);
      if (provider == null) {
        LOGGER.warning("Unknown form field child element " + qname + " ignored");
        continue;
      }
      FormFieldChildElement formFieldChildElement=provider.parse(parser,XmlEnvironment.from(parser,xmlEnvironment));
      childElements.add(formFieldChildElement);
    }
  break;
case END_ELEMENT:
if (parser.getDepth() == initialDepth) {
  break outerloop;
}
break;
}
}
if (type == null && reportedData != null) {
FormField reportedFormField=reportedData.getField(fieldName);
if (reportedFormField != null) {
type=reportedFormField.getType();
}
}
if (type == null) {
if (fieldName.equals(FormField.FORM_TYPE)) {
type=FormField.Type.hidden;
}
 else {
type=FormFieldRegistry.lookup(formType,fieldName);
if (type == null) {
FieldNameAndFormType fieldNameAndFormType=new FieldNameAndFormType(fieldName,formType);
if (!UNKNOWN_FIELDS.contains(fieldNameAndFormType)) {
LOGGER.warning("The Field '" + fieldName + "' from FORM_TYPE '"+ formType+ "' is not registered. Field type is unknown, assuming text-single.");
UNKNOWN_FIELDS.add(fieldNameAndFormType);
}
type=FormField.Type.text_single;
}
}
}
FormField.Builder<?,?> builder;
switch (type) {
case bool:
builder=parseBooleanFormField(fieldName,values);
break;
case fixed:
builder=parseSingleKindFormField(FormField.fixedBuilder(fieldName),values);
break;
case hidden:
builder=parseSingleKindFormField(FormField.hiddenBuilder(fieldName),values);
break;
case jid_multi:
JidMultiFormField.Builder jidMultiBuilder=FormField.jidMultiBuilder(fieldName);
for (FormField.Value value : values) {
jidMultiBuilder.addValue(value);
}
builder=jidMultiBuilder;
break;
case jid_single:
ensureAtMostSingleValue(type,values);
JidSingleFormField.Builder jidSingleBuilder=FormField.jidSingleBuilder(fieldName);
if (!values.isEmpty()) {
FormField.Value value=values.get(0);
jidSingleBuilder.setValue(value);
}
builder=jidSingleBuilder;
break;
case list_multi:
ListMultiFormField.Builder listMultiBuilder=FormField.listMultiBuilder(fieldName);
addOptionsToBuilder(options,listMultiBuilder);
builder=parseMultiKindFormField(listMultiBuilder,values);
break;
case list_single:
ListSingleFormField.Builder listSingleBuilder=FormField.listSingleBuilder(fieldName);
addOptionsToBuilder(options,listSingleBuilder);
builder=parseSingleKindFormField(listSingleBuilder,values);
break;
case text_multi:
builder=parseMultiKindFormField(FormField.textMultiBuilder(fieldName),values);
break;
case text_private:
builder=parseSingleKindFormField(FormField.textPrivateBuilder(fieldName),values);
break;
case text_single:
builder=parseSingleKindFormField(FormField.textSingleBuilder(fieldName),values);
break;
default :
throw new AssertionError("Unknown type " + type);
}
switch (type) {
case list_multi:
case list_single:
break;
default :
if (!options.isEmpty()) {
throw new SmackParsingException("Form fields of type " + type + " must not have options. This one had "+ options.size());
}
break;
}
if (label != null) {
builder.setLabel(label);
}
builder.setRequired(required);
builder.addFormFieldChildElements(childElements);
return builder.build();
}

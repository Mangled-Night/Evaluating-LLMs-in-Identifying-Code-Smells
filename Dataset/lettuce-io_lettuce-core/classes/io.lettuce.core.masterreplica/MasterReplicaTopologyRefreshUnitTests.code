/** 
 * @author Mark Paluch
 */
@ExtendWith(MockitoExtension.class) @MockitoSettings(strictness=Strictness.LENIENT) class MasterReplicaTopologyRefreshUnitTests {
  private static final RedisMasterReplicaNode UPSTREAM=new RedisMasterReplicaNode("localhost",1,new RedisURI(),RedisInstance.Role.UPSTREAM);
  private static final RedisMasterReplicaNode REPLICA=new RedisMasterReplicaNode("localhost",2,new RedisURI(),RedisInstance.Role.REPLICA);
  @Mock NodeConnectionFactory connectionFactory;
  @Mock StatefulRedisConnection<String,String> connection;
  @Mock RedisAsyncCommands<String,String> async;
  private ScheduledThreadPoolExecutor executorService;
  private TopologyProvider provider;
  @BeforeEach void before(){
    executorService=new ScheduledThreadPoolExecutor(1,new DefaultThreadFactory(getClass().getSimpleName(),true));
    when(connection.closeAsync()).thenReturn(CompletableFuture.completedFuture(null));
    when(connection.async()).thenReturn(async);
    when(connection.dispatch(any(RedisCommand.class))).then(invocation -> {
      RedisCommand command=invocation.getArgument(0);
      command.complete();
      return null;
    }
);
    provider=() -> Arrays.asList(UPSTREAM,REPLICA);
  }
  @AfterEach void tearDown(){
    executorService.shutdown();
  }
  @Test void shouldRetrieveTopology(){
    MasterReplicaTopologyRefresh refresh=new MasterReplicaTopologyRefresh(connectionFactory,executorService,provider);
    CompletableFuture<StatefulRedisConnection<String,String>> master=CompletableFuture.completedFuture(connection);
    CompletableFuture<StatefulRedisConnection<String,String>> replica=CompletableFuture.completedFuture(connection);
    when(connectionFactory.connectToNodeAsync(any(),any())).thenReturn((CompletableFuture)master,(CompletableFuture)replica);
    RedisURI redisURI=new RedisURI();
    redisURI.setTimeout(Duration.ofMillis(1));
    List<RedisNodeDescription> nodes=refresh.getNodes(redisURI).block();
    assertThat(nodes).hasSize(2);
  }
  @Test void shouldRetrieveTopologyWithFailedNode(){
    MasterReplicaTopologyRefresh refresh=new MasterReplicaTopologyRefresh(connectionFactory,executorService,provider);
    CompletableFuture<StatefulRedisConnection<String,String>> connected=CompletableFuture.completedFuture(connection);
    CompletableFuture<StatefulRedisConnection<String,String>> pending=new CompletableFuture<>();
    when(connectionFactory.connectToNodeAsync(any(),any())).thenReturn((CompletableFuture)connected,(CompletableFuture)pending);
    RedisURI redisURI=new RedisURI();
    redisURI.setTimeout(Duration.ofMillis(1));
    List<RedisNodeDescription> nodes=refresh.getNodes(redisURI).block();
    assertThat(nodes).hasSize(1).containsOnly(UPSTREAM);
  }
}

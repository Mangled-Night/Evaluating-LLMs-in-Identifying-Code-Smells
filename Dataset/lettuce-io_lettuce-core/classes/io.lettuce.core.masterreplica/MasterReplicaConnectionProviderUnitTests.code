/** 
 * @author Mark Paluch
 */
@ExtendWith(MockitoExtension.class) @MockitoSettings(strictness=Strictness.LENIENT) class MasterReplicaConnectionProviderUnitTests {
  private MasterReplicaConnectionProvider<String,String> sut;
  @Mock RedisClient clientMock;
  @Mock(extraInterfaces=StatefulRedisConnection.class) RedisChannelHandler<String,String> channelHandlerMock;
  private StatefulRedisConnection<String,String> nodeConnectionMock;
  @Mock RedisCommands<String,String> commandsMock;
  @BeforeEach void before(){
    nodeConnectionMock=(StatefulRedisConnection)channelHandlerMock;
    sut=new MasterReplicaConnectionProvider<>(clientMock,StringCodec.UTF8,RedisURI.create("localhost",1),Collections.emptyMap());
    sut.setKnownNodes(Arrays.asList(new RedisMasterReplicaNode("localhost",1,RedisURI.create("localhost",1),RedisInstance.Role.UPSTREAM)));
  }
  @Test void shouldCloseConnections(){
    when(channelHandlerMock.closeAsync()).thenReturn(CompletableFuture.completedFuture(null));
    when(clientMock.connectAsync(eq(StringCodec.UTF8),any())).thenReturn(ConnectionFuture.completed(null,nodeConnectionMock));
    StatefulRedisConnection<String,String> connection=sut.getConnection(ConnectionIntent.READ);
    assertThat(connection).isNotNull();
    sut.close();
    verify(channelHandlerMock).closeAsync();
  }
}

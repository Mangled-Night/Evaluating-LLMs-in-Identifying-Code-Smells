/** 
 * MySQL 验证处理器
 * @author mycat
 */
public class MySQLConnectionAuthenticator implements NIOHandler {
  private static final Logger LOGGER=LoggerFactory.getLogger(MySQLConnectionAuthenticator.class);
  private final MySQLConnection source;
  private final ResponseHandler listener;
  public MySQLConnectionAuthenticator(  MySQLConnection source,  ResponseHandler listener){
    this.source=source;
    this.listener=listener;
  }
  public void connectionError(  MySQLConnection source,  Throwable e){
    listener.connectionError(e,source);
  }
  @Override public void handle(  byte[] data){
    try {
switch (data[4]) {
case OkPacket.FIELD_COUNT:
        HandshakePacket packet=source.getHandshake();
      if (packet == null) {
        processHandShakePacket(data);
        source.authenticate();
        break;
      }
    source.setHandler(new MySQLConnectionHandler(source));
  source.setAuthenticated(true);
boolean clientCompress=Capabilities.CLIENT_COMPRESS == (Capabilities.CLIENT_COMPRESS & packet.serverCapabilities);
boolean usingCompress=MycatServer.getInstance().getConfig().getSystem().getUseCompression() == 1;
if (clientCompress && usingCompress) {
source.setSupportCompress(true);
}
if (listener != null) {
listener.connectionAcquired(source);
}
break;
case ErrorPacket.FIELD_COUNT:
ErrorPacket err=new ErrorPacket();
err.read(data);
String errMsg=new String(err.message);
LOGGER.warn("can't connect to mysql server ,errmsg:" + errMsg + " "+ source);
throw new ConnectionException(err.errno,errMsg);
case EOFPacket.FIELD_COUNT:
auth323(data[3]);
break;
default :
packet=source.getHandshake();
if (packet == null) {
processHandShakePacket(data);
source.authenticate();
break;
}
 else {
throw new RuntimeException("Unknown Packet!");
}
}
}
 catch (RuntimeException e) {
if (listener != null) {
listener.connectionError(e,source);
return;
}
throw e;
}
}
private void processHandShakePacket(byte[] data){
HandshakePacket packet=new HandshakePacket();
packet.read(data);
source.setHandshake(packet);
source.setThreadId(packet.threadId);
int charsetIndex=(packet.serverCharsetIndex & 0xff);
String charset=CharsetUtil.getCharset(charsetIndex);
if (charset != null) {
source.setCharset(charset);
}
 else {
throw new RuntimeException("Unknown charsetIndex:" + charsetIndex);
}
}
private void auth323(byte packetId){
Reply323Packet r323=new Reply323Packet();
r323.packetId=++packetId;
String pass=source.getPassword();
if (pass != null && pass.length() > 0) {
byte[] seed=source.getHandshake().seed;
r323.seed=SecurityUtil.scramble323(pass,new String(seed)).getBytes();
}
r323.write(source);
}
}

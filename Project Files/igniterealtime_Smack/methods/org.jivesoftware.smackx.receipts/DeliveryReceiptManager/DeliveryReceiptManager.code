private DeliveryReceiptManager(XMPPConnection connection){
  super(connection);
  ServiceDiscoveryManager sdm=ServiceDiscoveryManager.getInstanceFor(connection);
  sdm.addFeature(DeliveryReceipt.NAMESPACE);
  connection.addAsyncStanzaListener(new StanzaListener(){
    @Override public void processStanza(    Stanza packet) throws NotConnectedException {
      DeliveryReceipt dr=DeliveryReceipt.from((Message)packet);
      for (      ReceiptReceivedListener l : receiptReceivedListeners) {
        l.onReceiptReceived(packet.getFrom(),packet.getTo(),dr.getId(),packet);
      }
    }
  }
,MESSAGES_WITH_DELIVERY_RECEIPT);
  connection.addAsyncStanzaListener(new StanzaListener(){
    @Override public void processStanza(    Stanza packet) throws NotConnectedException, InterruptedException {
      final Jid from=packet.getFrom();
      final XMPPConnection connection=connection();
switch (autoReceiptMode) {
case disabled:
        return;
case ifIsSubscribed:
      if (!Roster.getInstanceFor(connection).isSubscribedToMyPresence(from)) {
        return;
      }
    break;
case always:
  break;
}
final Message messageWithReceiptRequest=(Message)packet;
Message ack=receiptMessageFor(messageWithReceiptRequest);
if (ack == null) {
LOGGER.warning("Received message stanza with receipt request from '" + from + "' without a stanza ID set. Message: "+ messageWithReceiptRequest);
return;
}
connection.sendStanza(ack);
}
}
,NON_ERROR_GROUPCHAT_MESSAGES_WITH_DELIVERY_RECEIPT_REQUEST);
}

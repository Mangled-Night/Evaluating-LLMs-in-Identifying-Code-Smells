public static class Body {
  String mediaType;
  BufferedInputStream bis;
  long length;
  private Body(  final String mediaType,  final byte[] body){
    this.mediaType=mediaType;
    bis=new BufferedInputStream(new ByteArrayInputStream(body));
    length=body.length;
  }
  private Body(  final String mediaType,  final InputStream body){
    this.mediaType=mediaType;
    if (body instanceof BufferedInputStream) {
      bis=(BufferedInputStream)body;
    }
 else {
      bis=new BufferedInputStream(body);
    }
    length=-1;
  }
  private static String getCharsetFromMediaType(  String mediaType){
    mediaType=mediaType.toLowerCase().replace(" ","");
    int index=mediaType.indexOf("charset=");
    if (index == -1)     return "utf-8";
    int st=index + 8;
    int end=mediaType.length();
    if (st >= end) {
      throw new IllegalArgumentException("MediaType is not correct: \"" + mediaType + "\"");
    }
    for (int i=st; i < end; i++) {
      char c=mediaType.charAt(i);
      if (c >= 'A' && c <= 'Z')       continue;
      if (c >= 'a' && c <= 'z')       continue;
      if (c >= '0' && c <= '9')       continue;
      if (c == '-' && i != 0)       continue;
      if (c == '+' && i != 0)       continue;
      if (c == ':' && i != 0)       continue;
      if (c == '_' && i != 0)       continue;
      if (c == '.' && i != 0)       continue;
      end=i;
      break;
    }
    String charset=mediaType.substring(st,end);
    return checkCharset(charset);
  }
  public static Body create(  @NonNull String mediaType,  @NonNull byte[] content){
    return new Body(mediaType,content);
  }
  public static Body form(  @NonNull final Map<String,String> form){
    return form(form,"utf-8");
  }
  public static Body form(  @NonNull final Map<String,String> form,  String charset){
    String mediaType="application/x-www-form-urlencoded;charset=" + checkCharset(charset);
    final StringBuilder sb=new StringBuilder();
    for (    String key : form.keySet()) {
      if (sb.length() > 0)       sb.append("&");
      sb.append(key).append("=").append(form.get(key));
    }
    try {
      return new Body(mediaType,sb.toString().getBytes(charset));
    }
 catch (    UnsupportedEncodingException e) {
      e.printStackTrace();
      return null;
    }
  }
  public static Body json(  @NonNull final String json){
    return json(json,"utf-8");
  }
  public static Body json(  @NonNull final String json,  String charset){
    String mediaType="application/json;charset=" + checkCharset(charset);
    try {
      return new Body(mediaType,json.getBytes(charset));
    }
 catch (    UnsupportedEncodingException e) {
      e.printStackTrace();
      return null;
    }
  }
}

@RegisterSystem public class TimeAuthoritySystem extends BaseComponentSystem implements UpdateSubscriberSystem {
  private static final float TARGET_DELTA=0.05f;
  private static final long CHECK_AUTOMATIC_TIME_DILATION_MS=500;
  @In WorldProvider worldProvider;
  @In private Time time;
  private float lastGameTimeDilationValue;
  private boolean enableAutomaticTimeDilation;
  private long lastCheckedAutomaticTimeDilation;
  @Override public void initialise(){
    lastGameTimeDilationValue=time.getGameTimeDilation();
  }
  @Override public void update(  float delta){
    if (enableAutomaticTimeDilation && lastCheckedAutomaticTimeDilation < time.getRealTimeInMs()) {
      lastCheckedAutomaticTimeDilation=time.getRealTimeInMs() + CHECK_AUTOMATIC_TIME_DILATION_MS;
      float newGameTimeDilation=Math.max(0.1f,Math.min(1f,TARGET_DELTA / time.getGameDelta()));
      float deltaGameTimeDilation=newGameTimeDilation - time.getGameTimeDilation();
      if (deltaGameTimeDilation > 0.1f) {
        time.setGameTimeDilation(time.getGameTimeDilation() + 0.1f);
      }
 else       if (deltaGameTimeDilation < -0.1f) {
        time.setGameTimeDilation(time.getGameTimeDilation() - 0.1f);
      }
    }
    if (lastGameTimeDilationValue != time.getGameTimeDilation()) {
      lastGameTimeDilationValue=time.getGameTimeDilation();
      worldProvider.getWorldEntity().send(new TimeResynchEvent(lastGameTimeDilationValue));
    }
  }
  @Command(shortDescription="Toggle automatic time dilation",requiredPermission=PermissionManager.SERVER_MANAGEMENT_PERMISSION,runOnServer=true) public String toggleAutoTimeDilation(){
    enableAutomaticTimeDilation=!enableAutomaticTimeDilation;
    if (enableAutomaticTimeDilation) {
      return "Automatic Time Dilation enabled";
    }
 else {
      return "Automatic Time Dilation disabled";
    }
  }
}

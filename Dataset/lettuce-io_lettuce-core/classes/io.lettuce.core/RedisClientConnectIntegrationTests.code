/** 
 * @author Mark Paluch
 * @author Jongyeol Choi
 */
@ExtendWith(LettuceExtension.class) class RedisClientConnectIntegrationTests extends TestSupport {
  private static final Duration EXPECTED_TIMEOUT=Duration.ofMillis(500);
  private final RedisClient client;
  @Inject RedisClientConnectIntegrationTests(  RedisClient client){
    this.client=client;
  }
  @BeforeEach void before(){
    client.setDefaultTimeout(EXPECTED_TIMEOUT);
  }
  @Test void connectClientUri(){
    StatefulRedisConnection<String,String> connection=client.connect();
    assertThat(connection.getTimeout()).isEqualTo(EXPECTED_TIMEOUT);
    connection.close();
  }
  @Test void connectCodecClientUri(){
    StatefulRedisConnection<String,String> connection=client.connect(UTF8);
    assertThat(connection.getTimeout()).isEqualTo(EXPECTED_TIMEOUT);
    connection.close();
  }
  @Test void connectOwnUri(){
    RedisURI redisURI=redis(host,port).build();
    StatefulRedisConnection<String,String> connection=client.connect(redisURI);
    assertThat(connection.getTimeout()).isEqualTo(redisURI.getTimeout());
    connection.close();
  }
  @Test void connectMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connect(new RedisURI())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectSentinelMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connect(invalidSentinel())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectCodecOwnUri(){
    RedisURI redisURI=redis(host,port).build();
    StatefulRedisConnection<String,String> connection=client.connect(UTF8,redisURI);
    assertThat(connection.getTimeout()).isEqualTo(redisURI.getTimeout());
    connection.close();
  }
  @Test void connectAsyncCodecOwnUri(){
    RedisURI redisURI=redis(host,port).build();
    ConnectionFuture<StatefulRedisConnection<String,String>> future=client.connectAsync(UTF8,redisURI);
    StatefulRedisConnection<String,String> connection=TestFutures.getOrTimeout(future.toCompletableFuture());
    assertThat(connection.getTimeout()).isEqualTo(redisURI.getTimeout());
    connection.close();
  }
  @Test void connectCodecMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connect(UTF8,new RedisURI())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectcodecSentinelMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connect(UTF8,invalidSentinel())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test @Disabled("Non-deterministic behavior. Can cause a deadlock") void shutdownSyncInRedisFutureTest(){
    RedisClient redisClient=RedisClient.create();
    StatefulRedisConnection<String,String> connection=redisClient.connect(redis(host,port).build());
    CompletableFuture<String> f=connection.async().get("key1").whenComplete((result,e) -> {
      connection.close();
      redisClient.shutdown(0,0,SECONDS);
    }
).toCompletableFuture();
    assertThatThrownBy(() -> TestFutures.awaitOrTimeout(f)).isInstanceOf(TimeoutException.class);
  }
  @Test void shutdownAsyncInRedisFutureTest(){
    RedisClient redisClient=RedisClient.create();
    StatefulRedisConnection<String,String> connection=redisClient.connect(redis(host,port).build());
    CompletableFuture<Void> f=connection.async().get("key1").thenCompose(result -> {
      connection.close();
      return redisClient.shutdownAsync(0,0,SECONDS);
    }
).toCompletableFuture();
    TestFutures.awaitOrTimeout(f);
  }
  @Test void connectPubSubClientUri(){
    StatefulRedisPubSubConnection<String,String> connection=client.connectPubSub();
    assertThat(connection.getTimeout()).isEqualTo(EXPECTED_TIMEOUT);
    connection.close();
  }
  @Test void connectPubSubCodecClientUri(){
    StatefulRedisPubSubConnection<String,String> connection=client.connectPubSub(UTF8);
    assertThat(connection.getTimeout()).isEqualTo(EXPECTED_TIMEOUT);
    connection.close();
  }
  @Test void connectPubSubOwnUri(){
    RedisURI redisURI=redis(host,port).build();
    StatefulRedisPubSubConnection<String,String> connection=client.connectPubSub(redisURI);
    assertThat(connection.getTimeout()).isEqualTo(redisURI.getTimeout());
    connection.close();
  }
  @Test void connectPubSubMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectPubSub(new RedisURI())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectPubSubSentinelMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectPubSub(invalidSentinel())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectPubSubCodecOwnUri(){
    RedisURI redisURI=redis(host,port).build();
    StatefulRedisPubSubConnection<String,String> connection=client.connectPubSub(UTF8,redisURI);
    assertThat(connection.getTimeout()).isEqualTo(redisURI.getTimeout());
    connection.close();
  }
  @Test void connectPubSubAsync(){
    RedisURI redisURI=redis(host,port).build();
    ConnectionFuture<StatefulRedisPubSubConnection<String,String>> future=client.connectPubSubAsync(UTF8,redisURI);
    StatefulRedisPubSubConnection<String,String> connection=future.join();
    assertThat(connection.getTimeout()).isEqualTo(redisURI.getTimeout());
    connection.close();
  }
  @Test void connectPubSubCodecMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectPubSub(UTF8,new RedisURI())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectPubSubCodecSentinelMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectPubSub(UTF8,invalidSentinel())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectSentinelClientUri(){
    StatefulRedisSentinelConnection<String,String> connection=client.connectSentinel();
    assertThat(connection.getTimeout()).isEqualTo(EXPECTED_TIMEOUT);
    connection.close();
  }
  @Test void connectSentinelCodecClientUri(){
    StatefulRedisSentinelConnection<String,String> connection=client.connectSentinel(UTF8);
    assertThat(connection.getTimeout()).isEqualTo(EXPECTED_TIMEOUT);
    connection.close();
  }
  @Test void connectSentinelAndMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectSentinel(new RedisURI())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectSentinelSentinelMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectSentinel(invalidSentinel())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectSentinelOwnUri(){
    RedisURI redisURI=redis(host,port).build();
    StatefulRedisSentinelConnection<String,String> connection=client.connectSentinel(redisURI);
    assertThat(connection.getTimeout()).isEqualTo(Duration.ofMinutes(1));
    connection.close();
  }
  @Test void connectSentinelCodecOwnUri(){
    RedisURI redisURI=redis(host,port).build();
    StatefulRedisSentinelConnection<String,String> connection=client.connectSentinel(UTF8,redisURI);
    assertThat(connection.getTimeout()).isEqualTo(redisURI.getTimeout());
    connection.close();
  }
  @Test void connectSentinelCodecMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectSentinel(UTF8,new RedisURI())).isInstanceOf(IllegalArgumentException.class);
  }
  @Test void connectSentinelCodecSentinelMissingHostAndSocketUri(){
    assertThatThrownBy(() -> client.connectSentinel(UTF8,invalidSentinel())).isInstanceOf(IllegalArgumentException.class);
  }
  private static RedisURI invalidSentinel(){
    RedisURI redisURI=new RedisURI();
    redisURI.getSentinels().add(new RedisURI());
    return redisURI;
  }
}

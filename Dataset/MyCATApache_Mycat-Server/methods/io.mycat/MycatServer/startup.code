public void startup() throws IOException {
  SystemConfig system=config.getSystem();
  int processorCount=system.getProcessors();
  RouteStrategyFactory.init();
  LOGGER.info(NAME + " is ready to startup ...");
  String inf="Startup processors ...,total processors:" + system.getProcessors() + ",aio thread pool size:"+ system.getProcessorExecutor()+ "    \r\n each process allocated socket buffer pool "+ " bytes ,a page size:"+ system.getBufferPoolPageSize()+ "  a page's chunk number(PageSize/ChunkSize) is:"+ (system.getBufferPoolPageSize() / system.getBufferPoolChunkSize())+ "  buffer page's number is:"+ system.getBufferPoolPageNumber();
  LOGGER.info(inf);
  LOGGER.info("sysconfig params:" + system.toString());
  ManagerConnectionFactory mf=new ManagerConnectionFactory();
  ServerConnectionFactory sf=new ServerConnectionFactory();
  SocketAcceptor manager=null;
  SocketAcceptor server=null;
  aio=(system.getUsingAIO() == 1);
  int threadPoolSize=system.getProcessorExecutor();
  processors=new NIOProcessor[processorCount];
  int bufferPoolPageSize=system.getBufferPoolPageSize();
  short bufferPoolPageNumber=system.getBufferPoolPageNumber();
  short bufferPoolChunkSize=system.getBufferPoolChunkSize();
  int socketBufferLocalPercent=system.getProcessorBufferLocalPercent();
  int bufferPoolType=system.getProcessorBufferPoolType();
switch (bufferPoolType) {
case 0:
    bufferPool=new DirectByteBufferPool(bufferPoolPageSize,bufferPoolChunkSize,bufferPoolPageNumber,system.getFrontSocketSoRcvbuf());
  totalNetWorkBufferSize=bufferPoolPageSize * bufferPoolPageNumber;
break;
case 1:
totalNetWorkBufferSize=6 * bufferPoolPageSize * bufferPoolPageNumber;
break;
case 2:
bufferPool=new NettyBufferPool(bufferPoolChunkSize);
LOGGER.info("Use Netty Buffer Pool");
break;
default :
bufferPool=new DirectByteBufferPool(bufferPoolPageSize,bufferPoolChunkSize,bufferPoolPageNumber,system.getFrontSocketSoRcvbuf());
;
totalNetWorkBufferSize=bufferPoolPageSize * bufferPoolPageNumber;
}
if (system.getUseOffHeapForMerge() == 1) {
try {
myCatMemory=new MyCatMemory(system,totalNetWorkBufferSize);
}
 catch (NoSuchFieldException e) {
LOGGER.error("NoSuchFieldException",e);
}
catch (IllegalAccessException e) {
LOGGER.error("Error",e);
}
}
businessExecutor=ExecutorUtil.create("BusinessExecutor",threadPoolSize);
sequenceExecutor=ExecutorUtil.create("SequenceExecutor",threadPoolSize);
timerExecutor=ExecutorUtil.create("Timer",system.getTimerExecutor());
listeningExecutorService=MoreExecutors.listeningDecorator(businessExecutor);
for (int i=0; i < processors.length; i++) {
processors[i]=new NIOProcessor("Processor" + i,bufferPool,businessExecutor);
}
if (aio) {
LOGGER.info("using aio network handler ");
asyncChannelGroups=new AsynchronousChannelGroup[processorCount];
connector=new AIOConnector();
for (int i=0; i < processors.length; i++) {
asyncChannelGroups[i]=AsynchronousChannelGroup.withFixedThreadPool(processorCount,new ThreadFactory(){
private int inx=1;
@Override public Thread newThread(Runnable r){
Thread th=new Thread(r);
th.setName(DirectByteBufferPool.LOCAL_BUF_THREAD_PREX + "AIO" + (inx++));
LOGGER.info("created new AIO thread " + th.getName());
return th;
}
}
);
}
manager=new AIOAcceptor(NAME + "Manager",system.getBindIp(),system.getManagerPort(),system.getServerBacklog(),mf,this.asyncChannelGroups[0]);
server=new AIOAcceptor(NAME + "Server",system.getBindIp(),system.getServerPort(),system.getServerBacklog(),sf,this.asyncChannelGroups[0]);
}
 else {
LOGGER.info("using nio network handler ");
NIOReactorPool reactorPool=new NIOReactorPool(DirectByteBufferPool.LOCAL_BUF_THREAD_PREX + "NIOREACTOR",processors.length);
connector=new NIOConnector(DirectByteBufferPool.LOCAL_BUF_THREAD_PREX + "NIOConnector",reactorPool);
((NIOConnector)connector).start();
manager=new NIOAcceptor(DirectByteBufferPool.LOCAL_BUF_THREAD_PREX + NAME + "Manager",system.getBindIp(),system.getManagerPort(),system.getServerBacklog(),mf,reactorPool);
server=new NIOAcceptor(DirectByteBufferPool.LOCAL_BUF_THREAD_PREX + NAME + "Server",system.getBindIp(),system.getServerPort(),system.getServerBacklog(),sf,reactorPool);
}
manager.start();
LOGGER.info(manager.getName() + " is started and listening on " + manager.getPort());
server.start();
LOGGER.info(server.getName() + " is started and listening on " + server.getPort());
LOGGER.info("===============================================");
Map<String,PhysicalDBPool> dataHosts=config.getDataHosts();
LOGGER.info("Initialize dataHost ...");
for (PhysicalDBPool node : dataHosts.values()) {
String index=dnIndexProperties.getProperty(node.getHostName(),"0");
if (!"0".equals(index)) {
LOGGER.info("init datahost: " + node.getHostName() + "  to use datasource index:"+ index);
}
node.init(Integer.parseInt(index));
node.startHeartbeat();
}
long dataNodeIldeCheckPeriod=system.getDataNodeIdleCheckPeriod();
heartbeatScheduler.scheduleAtFixedRate(updateTime(),0L,TIME_UPDATE_PERIOD,TimeUnit.MILLISECONDS);
heartbeatScheduler.scheduleAtFixedRate(processorCheck(),0L,system.getProcessorCheckPeriod(),TimeUnit.MILLISECONDS);
heartbeatScheduler.scheduleAtFixedRate(dataNodeConHeartBeatCheck(dataNodeIldeCheckPeriod),0L,dataNodeIldeCheckPeriod,TimeUnit.MILLISECONDS);
heartbeatScheduler.scheduleAtFixedRate(dataNodeHeartbeat(),0L,system.getDataNodeHeartbeatPeriod(),TimeUnit.MILLISECONDS);
heartbeatScheduler.scheduleAtFixedRate(dataSourceOldConsClear(),0L,DEFAULT_OLD_CONNECTION_CLEAR_PERIOD,TimeUnit.MILLISECONDS);
heartbeatScheduler.scheduleAtFixedRate(dataNodeCalcActiveCons(),0L,DEFAULT_DATANODE_CALC_ACTIVECOUNT,TimeUnit.MILLISECONDS);
scheduler.schedule(catletClassClear(),30000,TimeUnit.MILLISECONDS);
if (system.getCheckTableConsistency() == 1) {
scheduler.scheduleAtFixedRate(tableStructureCheck(),0L,system.getCheckTableConsistencyPeriod(),TimeUnit.MILLISECONDS);
}
ensureSqlstatRecycleFuture();
if (system.getUseGlobleTableCheck() == 1) {
}
scheduler.scheduleAtFixedRate(resultSetMapClear(),0L,system.getClearBigSqLResultSetMapMs(),TimeUnit.MILLISECONDS);
scheduler.scheduleAtFixedRate(xaTaskCheck(),0L,10 * 1000,TimeUnit.MILLISECONDS);
LOGGER.info("===============================================");
LOGGER.info("Perform XA recovery log ...");
CoordinatorLogEntry[] coordinatorLogEntries=getCoordinatorLogEntries();
putXARecoveryLogToMemory(coordinatorLogEntries);
performXARecoveryLog(coordinatorLogEntries);
LOGGER.info("Perform XA recovery log end...");
if (isUseZkSwitch()) {
initZkDnindex();
leaderLatch=new MycatLeaderLatch("heartbeat/leader");
try {
leaderLatch.start();
}
 catch (Exception e) {
LOGGER.error(e.getMessage(),e);
e.printStackTrace();
}
}
initRuleData();
startup.set(true);
}

/** 
 * consistancy hash, murmur hash implemented by Guava
 * @author wuzhih
 */
public class PartitionByMurmurHash extends AbstractPartitionAlgorithm implements RuleAlgorithm {
  private static final int DEFAULT_VIRTUAL_BUCKET_TIMES=160;
  private static final int DEFAULT_WEIGHT=1;
  private static final Charset DEFAULT_CHARSET=Charset.forName("UTF-8");
  private int seed;
  private int count;
  private int virtualBucketTimes=DEFAULT_VIRTUAL_BUCKET_TIMES;
  private Map<Integer,Integer> weightMap=new HashMap<>();
  private HashFunction hash;
  private SortedMap<Integer,Integer> bucketMap;
  @Override public void init(){
    try {
      bucketMap=new TreeMap<>();
      generateBucketMap();
    }
 catch (    Exception e) {
      throw new MurmurHashException(e);
    }
  }
  private void generateBucketMap(){
    hash=Hashing.murmur3_32(seed);
    for (int i=0; i < count; i++) {
      StringBuilder hashName=new StringBuilder("SHARD-").append(i);
      for (int n=0, shard=virtualBucketTimes * getWeight(i); n < shard; n++) {
        bucketMap.put(hash.hashUnencodedChars(hashName.append("-NODE-").append(n)).asInt(),i);
      }
    }
    weightMap=null;
  }
  /** 
 * 得到桶的权重，桶就是实际存储数据的DB实例 从0开始的桶编号为key，权重为值，权重默认为1。 键值必须都是整数
 * @param bucket
 * @return
 */
  private int getWeight(  int bucket){
    Integer w=weightMap.get(bucket);
    if (w == null) {
      w=DEFAULT_WEIGHT;
    }
    return w;
  }
  /** 
 * 创建murmur_hash对象的种子，默认0
 * @param seed
 */
  public void setSeed(  int seed){
    this.seed=seed;
  }
  /** 
 * 节点的数量
 * @param count
 */
  public void setCount(  int count){
    this.count=count;
  }
  /** 
 * 虚拟节点倍数，virtualBucketTimes*count就是虚拟结点数量
 * @param virtualBucketTimes
 */
  public void setVirtualBucketTimes(  int virtualBucketTimes){
    this.virtualBucketTimes=virtualBucketTimes;
  }
  /** 
 */
  public void setWeightMapFile(  String weightMapPath) throws IOException {
    Properties props=new Properties();
    try (BufferedReader reader=new BufferedReader(new InputStreamReader(this.getClass().getClassLoader().getResourceAsStream(weightMapPath),DEFAULT_CHARSET))){
      props.load(reader);
      for (      Map.Entry entry : props.entrySet()) {
        int weight=Integer.parseInt(entry.getValue().toString());
        weightMap.put(Integer.parseInt(entry.getKey().toString()),weight > 0 ? weight : 1);
      }
    }
   }
  @Override public Integer calculate(  String columnValue){
    SortedMap<Integer,Integer> tail=bucketMap.tailMap(hash.hashUnencodedChars(columnValue).asInt());
    if (tail.isEmpty()) {
      return bucketMap.get(bucketMap.firstKey());
    }
    return tail.get(tail.firstKey());
  }
  @Override public int getPartitionNum(){
    int nPartition=this.count;
    return nPartition;
  }
  private static void hashTest() throws IOException {
    PartitionByMurmurHash hash=new PartitionByMurmurHash();
    hash.count=10;
    hash.init();
    int[] bucket=new int[hash.count];
    Map<Integer,List<Integer>> hashed=new HashMap<>();
    int total=1000_0000;
    int c=0;
    for (int i=100_0000; i < total + 100_0000; i++) {
      c++;
      int h=hash.calculate(StringUtil.removeBackquote(Integer.toString(i)));
      bucket[h]++;
      List<Integer> list=hashed.get(h);
      if (list == null) {
        list=new ArrayList<>();
        hashed.put(h,list);
      }
      list.add(i);
    }
    System.out.println(c + "   " + total);
    double d=0;
    c=0;
    int idx=0;
    System.out.println("index    bucket   ratio");
    for (    int i : bucket) {
      d+=i / (double)total;
      c+=i;
      System.out.println(idx++ + "  " + i+ "   "+ (i / (double)total));
    }
    System.out.println(d + "  " + c);
    Properties props=new Properties();
    for (    Map.Entry entry : hash.bucketMap.entrySet()) {
      props.setProperty(entry.getKey().toString(),entry.getValue().toString());
    }
    ByteArrayOutputStream out=new ByteArrayOutputStream();
    props.store(out,null);
    props.clear();
    props.load(new ByteArrayInputStream(out.toByteArray()));
    System.out.println(props);
    System.out.println("****************************************************");
  }
  private static void rehashTest(  List<Integer> partition){
    PartitionByMurmurHash hash=new PartitionByMurmurHash();
    hash.count=12;
    hash.init();
    int[] bucket=new int[hash.count];
    int total=partition.size();
    int c=0;
    for (    int i : partition) {
      c++;
      int h=hash.calculate(StringUtil.removeBackquote(Integer.toString(i)));
      bucket[h]++;
    }
    System.out.println(c + "   " + total);
    c=0;
    int idx=0;
    System.out.println("index    bucket   ratio");
    for (    int i : bucket) {
      c+=i;
      System.out.println(idx++ + "  " + i+ "   "+ (i / (double)total));
    }
  }
  public static void main(  String[] args) throws IOException {
    hashTest();
  }
}

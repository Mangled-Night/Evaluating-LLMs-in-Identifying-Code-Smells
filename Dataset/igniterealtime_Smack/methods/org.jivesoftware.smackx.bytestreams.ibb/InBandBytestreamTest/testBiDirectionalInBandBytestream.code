/** 
 * An In-Band Bytestream should be successfully established using IQ stanzas. The established session should transfer data bidirectional.
 * @throws Exception should not happen
 */
public void testBiDirectionalInBandBytestream() throws Exception {
  XMPPConnection initiatorConnection=getConnection(0);
  XMPPConnection targetConnection=getConnection(1);
  Random rand=new Random();
  final byte[] data=new byte[dataSize];
  rand.nextBytes(data);
  final SynchronousQueue<byte[]> queue=new SynchronousQueue<byte[]>();
  InBandBytestreamManager targetByteStreamManager=InBandBytestreamManager.getByteStreamManager(targetConnection);
  InBandBytestreamListener incomingByteStreamListener=new InBandBytestreamListener(){
    public void incomingBytestreamRequest(    InBandBytestreamRequest request){
      try {
        InBandBytestreamSession session=request.accept();
        OutputStream outputStream=session.getOutputStream();
        outputStream.write(data);
        outputStream.flush();
        InputStream inputStream=session.getInputStream();
        byte[] receivedData=new byte[dataSize];
        int totalRead=0;
        while (totalRead < dataSize) {
          int read=inputStream.read(receivedData,totalRead,dataSize - totalRead);
          totalRead+=read;
        }
        queue.put(receivedData);
      }
 catch (      Exception e) {
        fail(e.getMessage());
      }
    }
  }
;
  targetByteStreamManager.addIncomingBytestreamListener(incomingByteStreamListener);
  InBandBytestreamManager initiatorByteStreamManager=InBandBytestreamManager.getByteStreamManager(initiatorConnection);
  InBandBytestreamSession session=initiatorByteStreamManager.establishSession(targetConnection.getUser());
  byte[] receivedData=new byte[dataSize];
  InputStream inputStream=session.getInputStream();
  int totalRead=0;
  while (totalRead < dataSize) {
    int read=inputStream.read(receivedData,totalRead,dataSize - totalRead);
    totalRead+=read;
  }
  assertEquals("sent data not equal to received data",data,receivedData);
  OutputStream outputStream=session.getOutputStream();
  outputStream.write(data);
  outputStream.flush();
  outputStream.close();
  assertEquals("received data not equal to sent data",data,queue.take());
}

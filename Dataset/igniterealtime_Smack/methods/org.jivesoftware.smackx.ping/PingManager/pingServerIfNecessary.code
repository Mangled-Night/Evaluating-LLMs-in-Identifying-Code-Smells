/** 
 * Ping the server if deemed necessary because automatic server pings are enabled ( {@link #setPingInterval(int)}) and the ping interval has expired.
 */
public void pingServerIfNecessary(){
  final XMPPConnection connection=connection();
  if (connection == null) {
    return;
  }
  if (pingInterval <= 0) {
    return;
  }
  long lastStanzaReceived=connection.getLastStanzaReceived();
  if (lastStanzaReceived > 0) {
    long now=System.currentTimeMillis();
    int deltaInSeconds=(int)((now - lastStanzaReceived) / 1000);
    if (deltaInSeconds < pingInterval) {
      maybeSchedulePingServerTask(deltaInSeconds);
      return;
    }
  }
  if (!connection.isAuthenticated()) {
    LOGGER.warning(connection + " was not authenticated");
    return;
  }
  final long minimumTimeout=TimeUnit.MINUTES.toMillis(2);
  final long connectionReplyTimeout=connection.getReplyTimeout();
  final long timeout=connectionReplyTimeout > minimumTimeout ? connectionReplyTimeout : minimumTimeout;
  SmackFuture<Boolean,Exception> pingFuture=pingAsync(connection.getXMPPServiceDomain(),timeout);
  pingFuture.onSuccess(new SuccessCallback<Boolean>(){
    @Override public void onSuccess(    Boolean result){
      maybeSchedulePingServerTask();
    }
  }
);
  pingFuture.onError(new ExceptionCallback<Exception>(){
    @Override public void processException(    Exception exception){
      long lastStanzaReceived=connection.getLastStanzaReceived();
      if (lastStanzaReceived > 0) {
        long now=System.currentTimeMillis();
        int deltaInSeconds=(int)((now - lastStanzaReceived) / 1000);
        if (deltaInSeconds < pingInterval) {
          maybeSchedulePingServerTask(deltaInSeconds);
          return;
        }
      }
      for (      PingFailedListener l : pingFailedListeners) {
        l.pingFailed();
      }
    }
  }
);
}

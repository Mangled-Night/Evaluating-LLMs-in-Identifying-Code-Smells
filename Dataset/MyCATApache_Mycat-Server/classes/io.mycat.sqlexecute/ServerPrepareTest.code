/** 
 * @author CrazyPig
 */
public class ServerPrepareTest {
  static final String JDBC_DRIVER="com.mysql.jdbc.Driver";
  static final String DB_URL="jdbc:mysql://localhost:8066/TESTDB?useServerPrepStmts=true";
  static final String USER="root";
  static final String PASS="mysql";
static {
    try {
      Class.forName("com.mysql.jdbc.Driver");
    }
 catch (    ClassNotFoundException e) {
      e.printStackTrace();
    }
  }
  /** 
 * 测试发送COM_STMT_SEND_LONG_DATA命令
 * @throws IOException 
 */
  public static void testComStmtSendLondData() throws IOException {
    Connection conn=null;
    PreparedStatement pstmt=null;
    ClassLoader classLoader=Thread.currentThread().getContextClassLoader();
    InputStream image0In=classLoader.getResourceAsStream("blob/image0.jpg");
    InputStream image1In=classLoader.getResourceAsStream("blob/image1.png");
    InputStream image2In=classLoader.getResourceAsStream("blob/image2.png");
    InputStream image3In=classLoader.getResourceAsStream("blob/image3.png");
    byte[] image0Bytes=getBytes(image0In);
    byte[] image1Bytes=getBytes(image1In);
    byte[] image2Bytes=getBytes(image2In);
    byte[] image3Bytes=getBytes(image3In);
    try {
      conn=DriverManager.getConnection(DB_URL,USER,PASS);
      pstmt=conn.prepareStatement("insert into hotnews(id, title, content, image0, image1, image2, image3) values(?,?,?,?,?,?,?)");
      pstmt.setInt(1,1314);
      pstmt.setString(2,"hotnew");
      pstmt.setBinaryStream(3,new ByteArrayInputStream("this is a content of hotnew".getBytes("UTF-8")));
      Blob image0Blob=conn.createBlob();
      Blob image1Blob=conn.createBlob();
      Blob image2Blob=conn.createBlob();
      Blob image3Blob=conn.createBlob();
      image0Blob.setBytes(1,image0Bytes);
      image1Blob.setBytes(1,image1Bytes);
      image2Blob.setBytes(1,image2Bytes);
      image3Blob.setBytes(1,image3Bytes);
      pstmt.setBlob(4,image0Blob);
      pstmt.setBlob(5,image1Blob);
      pstmt.setBlob(6,image2Blob);
      pstmt.setBlob(7,image3Blob);
      pstmt.execute();
      pstmt=conn.prepareStatement("select image0, image1, image2, image3 from hotnews where id = ?");
      pstmt.setInt(1,1314);
      ResultSet rs=pstmt.executeQuery();
      if (rs.next()) {
        InputStream _image0In=rs.getBlob(1).getBinaryStream();
        InputStream _image1In=rs.getBlob(2).getBinaryStream();
        InputStream _image2In=rs.getBlob(3).getBinaryStream();
        InputStream _image3In=rs.getBlob(4).getBinaryStream();
        Assert.assertArrayEquals(image0Bytes,getBytes(_image0In));
        Assert.assertArrayEquals(image1Bytes,getBytes(_image1In));
        Assert.assertArrayEquals(image2Bytes,getBytes(_image2In));
        Assert.assertArrayEquals(image3Bytes,getBytes(_image3In));
      }
      pstmt.close();
    }
 catch (    SQLException e) {
      e.printStackTrace();
    }
catch (    UnsupportedEncodingException e) {
      e.printStackTrace();
    }
 finally {
      if (conn != null) {
        try {
          conn.close();
        }
 catch (        SQLException e) {
          e.printStackTrace();
        }
      }
    }
  }
  private static byte[] getBytes(  InputStream in) throws IOException {
    byte[] bytes=new byte[0];
    byte[] buffer=new byte[1024];
    ByteArrayOutputStream bout=new ByteArrayOutputStream();
    int len=0;
    while ((len=in.read(buffer)) > -1) {
      bout.write(buffer,0,len);
    }
    bytes=bout.toByteArray();
    return bytes;
  }
  /** 
 * 测试发送COM_STMT_RESET命令
 */
  public static void testComStmtRest(){
    Connection conn=null;
    PreparedStatement pstmt=null;
    try {
      conn=DriverManager.getConnection(DB_URL,USER,PASS);
      pstmt=conn.prepareStatement("insert into hotnews(id, title, content) values(?,?,?)");
      pstmt.setInt(1,1314);
      pstmt.setString(2,"hotnew");
      pstmt.setBinaryStream(3,new ByteArrayInputStream("this is a content of hotnew".getBytes("UTF-8")));
      pstmt.execute();
      pstmt.clearParameters();
      pstmt.setInt(1,1315);
      pstmt.setString(2,"hotnew");
      pstmt.setBinaryStream(3,new ByteArrayInputStream("this is a new content of hotnew".getBytes("UTF-8")));
      pstmt.execute();
      pstmt.close();
    }
 catch (    SQLException e) {
      e.printStackTrace();
    }
catch (    UnsupportedEncodingException e) {
      e.printStackTrace();
    }
 finally {
      if (conn != null) {
        try {
          conn.close();
        }
 catch (        SQLException e) {
          e.printStackTrace();
        }
      }
    }
  }
  public static void simpleTest(){
    Connection conn=null;
    PreparedStatement stmt=null;
    try {
      System.out.println("Connecting to database...");
      conn=DriverManager.getConnection(DB_URL,USER,PASS);
      System.out.println("Creating statement...");
      String sql="SELECT *  FROM test  where id<?";
      stmt=conn.prepareStatement(sql);
      stmt.setInt(1,8);
      ResultSet rs=stmt.executeQuery();
      ResultSetMetaData rsmd=rs.getMetaData();
      int colCount=rsmd.getColumnCount();
      for (int i=1; i <= colCount; i++) {
        System.out.print(rsmd.getColumnName(i) + "\t");
      }
      System.out.println();
      while (rs.next()) {
        for (int i=1; i <= colCount; i++) {
          System.out.print(rs.getObject(i) + "\t");
        }
        System.out.println();
      }
      rs.close();
      stmt.close();
      conn.close();
    }
 catch (    SQLException se) {
      se.printStackTrace();
    }
catch (    Exception e) {
      e.printStackTrace();
    }
 finally {
      try {
        if (stmt != null)         stmt.close();
      }
 catch (      SQLException se2) {
      }
      try {
        if (conn != null)         conn.close();
      }
 catch (      SQLException se) {
        se.printStackTrace();
      }
    }
    System.out.println("Goodbye!");
  }
  public static void main(  String[] args){
    try {
      testComStmtSendLondData();
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
  }
  static void print(  String name,  ResultSet res) throws SQLException {
    System.out.println(name);
    ResultSetMetaData meta=res.getMetaData();
    String str="";
    for (int i=1; i <= meta.getColumnCount(); i++) {
      str+=meta.getColumnName(i) + "   ";
    }
    System.out.println("\t" + str);
    str="";
    while (res.next()) {
      for (int i=1; i <= meta.getColumnCount(); i++) {
        str+=res.getString(i) + "   ";
      }
      System.out.println("\t" + str);
      str="";
    }
  }
}

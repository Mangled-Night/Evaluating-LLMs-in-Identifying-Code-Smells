/** 
 * Test the Roster Exchange extension using the low level API
 * @author Gaston Dombiak
 */
public class RosterExchangeTest extends SmackTestCase {
  public RosterExchangeTest(  String arg0){
    super(arg0);
  }
  /** 
 * Low level API test. This is a simple test to use with an XMPP client and check if the client receives the message 1. User_1 will send his/her roster entries to user_2
 */
  public void testSendRosterEntries(){
    Chat chat1=getConnection(0).getChatManager().createChat(getBareJID(1),null);
    Message msg=new Message();
    msg.setSubject("Any subject you want");
    msg.setBody("This message contains roster items.");
    assertTrue("Roster has no entries",getConnection(0).getRoster().getEntryCount() > 0);
    RosterExchange rosterExchange=new RosterExchange(getConnection(0).getRoster());
    msg.addExtension(rosterExchange);
    try {
      chat1.sendMessage(msg);
    }
 catch (    Exception e) {
      fail("An error occurred sending the message with the roster");
    }
  }
  /** 
 * Low level API test. 1. User_1 will send his/her roster entries to user_2 2. User_2 will receive the entries and iterate over them to check if everything is fine 3. User_1 will wait several seconds for an ACK from user_2, if none is received then something is wrong
 */
  public void testSendAndReceiveRosterEntries(){
    Chat chat1=getConnection(0).getChatManager().createChat(getBareJID(1),null);
    final StanzaCollector chat2=getConnection(1).createStanzaCollector(new ThreadFilter(chat1.getThreadID()));
    Message msg=new Message();
    msg.setSubject("Any subject you want");
    msg.setBody("This message contains roster items.");
    assertTrue("Roster has no entries",getConnection(0).getRoster().getEntryCount() > 0);
    RosterExchange rosterExchange=new RosterExchange(getConnection(0).getRoster());
    msg.addExtension(rosterExchange);
    try {
      chat1.sendMessage(msg);
    }
 catch (    Exception e) {
      fail("An error occurred sending the message with the roster");
    }
    Packet packet=chat2.nextResult(2000);
    Message message=(Message)packet;
    assertNotNull("Body is null",message.getBody());
    try {
      rosterExchange=(RosterExchange)message.getExtension("x","jabber:x:roster");
      assertNotNull("Message without extension \"jabber:x:roster\"",rosterExchange);
      assertTrue("Roster without entries",rosterExchange.getRosterEntries().hasNext());
    }
 catch (    ClassCastException e) {
      fail("ClassCastException - Most probable cause is that smack providers is misconfigured");
    }
  }
  /** 
 * Low level API test. 1. User_1 will send his/her roster entries to user_2 2. User_2 will automatically add the entries that receives to his/her roster in the corresponding group 3. User_1 will wait several seconds for an ACK from user_2, if none is received then something is wrong
 */
  public void testSendAndAcceptRosterEntries(){
    Chat chat1=getConnection(0).getChatManager().createChat(getBareJID(1),null);
    final StanzaCollector chat2=getConnection(1).createStanzaCollector(new ThreadFilter(chat1.getThreadID()));
    Message msg=new Message();
    msg.setSubject("Any subject you want");
    msg.setBody("This message contains roster items.");
    assertTrue("Roster has no entries",getConnection(0).getRoster().getEntryCount() > 0);
    RosterExchange rosterExchange=new RosterExchange(getConnection(0).getRoster());
    msg.addExtension(rosterExchange);
    try {
      chat1.sendMessage(msg);
    }
 catch (    Exception e) {
      fail("An error occurred sending the message with the roster");
    }
    Packet packet=chat2.nextResult(5000);
    Message message=(Message)packet;
    assertNotNull("Body is null",message.getBody());
    try {
      rosterExchange=(RosterExchange)message.getExtension("x","jabber:x:roster");
      assertNotNull("Message without extension \"jabber:x:roster\"",rosterExchange);
      assertTrue("Roster without entries",rosterExchange.getRosterEntries().hasNext());
      for (Iterator<RemoteRosterEntry> it=rosterExchange.getRosterEntries(); it.hasNext(); ) {
        RemoteRosterEntry remoteRosterEntry=it.next();
        getConnection(1).getRoster().createEntry(remoteRosterEntry.getUser(),remoteRosterEntry.getName(),remoteRosterEntry.getGroupArrayNames());
      }
    }
 catch (    ClassCastException e) {
      fail("ClassCastException - Most probable cause is that smack providers is misconfigured");
    }
catch (    Exception e) {
      fail(e.toString());
    }
    assertTrue("Roster2 has no entries",getConnection(1).getRoster().getEntryCount() > 0);
  }
  protected void setUp() throws Exception {
    super.setUp();
    try {
      getConnection(0).getRoster().createEntry(getBareJID(2),"gato5",new String[]{"Friends, Coworker"});
      getConnection(0).getRoster().createEntry(getBareJID(3),"gato6",null);
      Thread.sleep(300);
    }
 catch (    Exception e) {
      fail(e.getMessage());
    }
  }
  protected int getMaxConnections(){
    return 4;
  }
}

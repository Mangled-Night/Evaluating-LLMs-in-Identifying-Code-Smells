private static final class NonzaResponseCallback<SN extends Nonza,FN extends Nonza> extends NonzaCallback {
  private SN successNonza;
  private FN failedNonza;
  private NonzaResponseCallback(  Class<SN> successNonzaClass,  Class<FN> failedNonzaClass,  Builder builder){
    super(builder);
    final QName successNonzaKey=XmppElementUtil.getQNameFor(successNonzaClass);
    final QName failedNonzaKey=XmppElementUtil.getQNameFor(failedNonzaClass);
    final NonzaListener<SN> successListener=new NonzaListener<SN>(){
      @Override public void accept(      SN successNonza){
        NonzaResponseCallback.this.successNonza=successNonza;
        notifyResponse();
      }
    }
;
    final ClassAndConsumer<SN> successClassAndConsumer=new ClassAndConsumer<>(successNonzaClass,successListener);
    final NonzaListener<FN> failedListener=new NonzaListener<FN>(){
      @Override public void accept(      FN failedNonza){
        NonzaResponseCallback.this.failedNonza=failedNonza;
        notifyResponse();
      }
    }
;
    final ClassAndConsumer<FN> failedClassAndConsumer=new ClassAndConsumer<>(failedNonzaClass,failedListener);
    filterAndListeners.put(successNonzaKey,successClassAndConsumer);
    filterAndListeners.put(failedNonzaKey,failedClassAndConsumer);
    install();
  }
  private void notifyResponse(){
synchronized (this) {
      notifyAll();
    }
  }
  private boolean hasReceivedSuccessOrFailedNonza(){
    return successNonza != null || failedNonza != null;
  }
  private SN waitForResponse() throws NoResponseException, InterruptedException, FailedNonzaException {
    final long deadline=System.currentTimeMillis() + connection.getReplyTimeout();
synchronized (this) {
      while (!hasReceivedSuccessOrFailedNonza()) {
        final long now=System.currentTimeMillis();
        if (now >= deadline)         break;
        wait(deadline - now);
      }
    }
    if (!hasReceivedSuccessOrFailedNonza()) {
      throw NoResponseException.newWith(connection,"Nonza Listener");
    }
    if (failedNonza != null) {
      throw new XMPPException.FailedNonzaException(failedNonza);
    }
    assert successNonza != null;
    return successNonza;
  }
}

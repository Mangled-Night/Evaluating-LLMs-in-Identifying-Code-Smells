@Test public void singleMessageSubjectTest() throws Exception {
  String defaultLanguage=Stanza.getDefaultLanguage();
  String otherLanguage=determineNonDefaultLanguage();
  String control;
  control=XMLBuilder.create("message").ns(StreamOpen.CLIENT_NAMESPACE).a("from","romeo@montague.lit/orchard").a("to","juliet@capulet.lit/balcony").a("id","zid615d9").a("type","chat").a("xml:lang",defaultLanguage).e("subject").t(defaultLanguage).asString(outputProperties);
  Message message=PacketParserUtils.parseMessage(PacketParserUtils.getParserFor(control));
  assertEquals(defaultLanguage,message.getSubject());
  assertTrue(message.getSubjectLanguages().isEmpty());
  assertEquals(defaultLanguage,message.getSubject(defaultLanguage));
  assertNull(message.getSubject(otherLanguage));
  assertXmlSimilar(control,message.toXML());
  control=XMLBuilder.create("message").ns(StreamOpen.CLIENT_NAMESPACE).a("from","romeo@montague.lit/orchard").a("to","juliet@capulet.lit/balcony").a("id","zid615d9").a("type","chat").a("xml:lang",otherLanguage).e("subject").t(otherLanguage).asString(outputProperties);
  message=PacketParserUtils.parseMessage(PacketParserUtils.getParserFor(control));
  assertEquals(otherLanguage,message.getSubject());
  assertTrue(message.getSubjectLanguages().isEmpty());
  assertEquals(otherLanguage,message.getSubject(otherLanguage));
  assertNull(message.getSubject(defaultLanguage));
  assertXmlSimilar(control,message.toXML());
  control=XMLBuilder.create("message").ns(StreamOpen.CLIENT_NAMESPACE).a("from","romeo@montague.lit/orchard").a("to","juliet@capulet.lit/balcony").a("id","zid615d9").a("type","chat").e("subject").t(defaultLanguage).asString(outputProperties);
  message=PacketParserUtils.parseMessage(PacketParserUtils.getParserFor(control));
  assertEquals(defaultLanguage,message.getSubject());
  assertTrue(message.getSubjectLanguages().isEmpty());
  assertEquals(defaultLanguage,message.getSubject(null));
  assertNull(message.getSubject(otherLanguage));
  assertXmlSimilar(control,message.toXML());
  control=XMLBuilder.create("message").ns(StreamOpen.CLIENT_NAMESPACE).a("from","romeo@montague.lit/orchard").a("to","juliet@capulet.lit/balcony").a("id","zid615d9").a("type","chat").e("subject").a("xml:lang",defaultLanguage).t(defaultLanguage).asString(outputProperties);
  message=PacketParserUtils.parseMessage(PacketParserUtils.getParserFor(control));
  assertFalse(message.getSubjectLanguages().isEmpty());
  assertEquals(defaultLanguage,message.getSubject(defaultLanguage));
  assertNull(message.getSubject(otherLanguage));
  assertXmlSimilar(control,message.toXML());
  control=XMLBuilder.create("message").ns(StreamOpen.CLIENT_NAMESPACE).a("from","romeo@montague.lit/orchard").a("to","juliet@capulet.lit/balcony").a("id","zid615d9").a("type","chat").e("subject").a("xml:lang",otherLanguage).t(otherLanguage).asString(outputProperties);
  message=PacketParserUtils.parseMessage(PacketParserUtils.getParserFor(control));
  assertNull(message.getSubject());
  assertFalse(message.getSubjectLanguages().isEmpty());
  assertTrue(message.getSubjectLanguages().contains(otherLanguage));
  assertEquals(otherLanguage,message.getSubject(otherLanguage));
  assertNull(message.getSubject(defaultLanguage));
  assertXmlSimilar(control,message.toXML());
  control=XMLBuilder.create("message").ns(StreamOpen.CLIENT_NAMESPACE).a("from","romeo@montague.lit/orchard").a("to","juliet@capulet.lit/balcony").a("id","zid615d9").a("type","chat").a("xml:lang",defaultLanguage).e("subject").a("xml:lang",otherLanguage).t(otherLanguage).asString(outputProperties);
  message=PacketParserUtils.parseMessage(PacketParserUtils.getParserFor(control));
  assertNull(message.getSubject());
  assertFalse(message.getSubjectLanguages().isEmpty());
  assertTrue(message.getSubjectLanguages().contains(otherLanguage));
  assertEquals(otherLanguage,message.getSubject(otherLanguage));
  assertNull(message.getSubject(defaultLanguage));
  assertXmlSimilar(control,message.toXML());
  control=XMLBuilder.create("message").ns(StreamOpen.CLIENT_NAMESPACE).a("from","romeo@montague.lit/orchard").a("to","juliet@capulet.lit/balcony").a("id","zid615d9").a("type","chat").a("xml:lang",otherLanguage).e("subject").a("xml:lang",defaultLanguage).t(defaultLanguage).asString(outputProperties);
  message=PacketParserUtils.parseMessage(PacketParserUtils.getParserFor(control));
  assertNull(message.getSubject());
  assertFalse(message.getSubjectLanguages().isEmpty());
  assertTrue(message.getSubjectLanguages().contains(defaultLanguage));
  assertEquals(defaultLanguage,message.getSubject(defaultLanguage));
  assertNull(message.getSubject(otherLanguage));
  assertXmlSimilar(control,message.toXML());
}

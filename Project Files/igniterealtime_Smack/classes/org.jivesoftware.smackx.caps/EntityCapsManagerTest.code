public class EntityCapsManagerTest extends SmackTestSuite {
  /** 
 * <a href="http://xmpp.org/extensions/xep-0115.html#ver-gen-complex">XEP- 0115 Complex Generation Example</a>.
 * @throws XmppStringprepException if the provided string is invalid.
 */
  @Test public void testComplexGenerationExample() throws XmppStringprepException {
    DiscoverInfo di=createComplexSamplePacket();
    CapsVersionAndHash versionAndHash=EntityCapsManager.generateVerificationString(di,StringUtils.SHA1);
    assertEquals("q07IKJEyjvHSyhy//CH0CxmKi8w=",versionAndHash.version);
  }
  @Test public void testSimpleDirectoryCacheBase32() throws IOException {
    EntityCapsManager.persistentCache=null;
    testSimpleDirectoryCache(Base32.getStringEncoder());
  }
  @Test public void testVerificationDuplicateFeatures() throws XmppStringprepException {
    DiscoverInfo di=createMalformedDiscoverInfo();
    assertTrue(di.containsDuplicateFeatures());
  }
  @Test public void testVerificationDuplicateIdentities() throws XmppStringprepException {
    DiscoverInfo di=createMalformedDiscoverInfo();
    assertTrue(di.containsDuplicateIdentities());
  }
  @SuppressWarnings("UnusedVariable") private static void testSimpleDirectoryCache(  StringEncoder<String> stringEncoder) throws IOException {
    EntityCapsPersistentCache cache=new SimpleDirectoryPersistentCache(createTempDirectory());
    EntityCapsManager.setPersistentCache(cache);
    DiscoverInfo di=createComplexSamplePacket();
    CapsVersionAndHash versionAndHash=EntityCapsManager.generateVerificationString(di,StringUtils.SHA1);
    String nodeVer=di.getNode() + "#" + versionAndHash.version;
    EntityCapsManager.addDiscoverInfoByNode(nodeVer,di);
    EntityCapsManager.clearMemoryCache();
    DiscoverInfo restored_di=EntityCapsManager.getDiscoveryInfoByNodeVer(nodeVer);
    assertNotNull(restored_di);
    assertEquals(di.toXML().toString(),restored_di.toXML().toString());
  }
  private static DataForm createSampleSoftwareInfoDataForm(){
    DataForm.Builder df=DataForm.builder(DataForm.Type.result);
{
      TextSingleFormField.Builder ff=FormField.builder("os");
      ff.setValue("Mac");
      df.addField(ff.build());
    }
{
      TextSingleFormField.Builder ff=FormField.hiddenBuilder("FORM_TYPE");
      ff.setValue("urn:xmpp:dataforms:softwareinfo");
      df.addField(ff.build());
    }
{
      TextMultiFormField.Builder ff=FormField.textMultiBuilder("ip_version");
      ff.addValue("ipv4");
      ff.addValue("ipv6");
      df.addField(ff.build());
    }
{
      TextSingleFormField.Builder ff=FormField.builder("os_version");
      ff.setValue("10.5.1");
      df.addField(ff.build());
    }
{
      TextSingleFormField.Builder ff=FormField.builder("software");
      ff.setValue("Psi");
      df.addField(ff.build());
    }
{
      TextSingleFormField.Builder ff=FormField.builder("software_version");
      ff.setValue("0.11");
      df.addField(ff.build());
    }
    return df.build();
  }
  private static DiscoverInfo createComplexSamplePacket() throws XmppStringprepException {
    DiscoverInfoBuilder di=DiscoverInfo.builder("disco1");
    di.from(JidCreate.from("benvolio@capulet.lit/230193"));
    di.to(JidCreate.from("juliet@capulet.lit/chamber"));
    di.ofType(IQ.Type.result);
    Collection<DiscoverInfo.Identity> identities=new LinkedList<DiscoverInfo.Identity>();
    DiscoverInfo.Identity i=new DiscoverInfo.Identity("client","pc","Psi 0.11","en");
    identities.add(i);
    i=new DiscoverInfo.Identity("client","pc","Ψ 0.11","el");
    identities.add(i);
    di.addIdentities(identities);
    di.addFeature("http://jabber.org/protocol/disco#items");
    di.addFeature(EntityCapsManager.NAMESPACE);
    di.addFeature("http://jabber.org/protocol/muc");
    di.addFeature("http://jabber.org/protocol/disco#info");
    DataForm softwareInfoDataForm=createSampleSoftwareInfoDataForm();
    di.addExtension(softwareInfoDataForm);
    return di.build();
  }
  private static DiscoverInfo createMalformedDiscoverInfo() throws XmppStringprepException {
    DiscoverInfoBuilder di=DiscoverInfo.builder("disco1");
    di.from("benvolio@capulet.lit/230193");
    di.to(")juliet@capulet.lit/chamber");
    di.ofType(IQ.Type.result);
    Collection<DiscoverInfo.Identity> identities=new LinkedList<DiscoverInfo.Identity>();
    DiscoverInfo.Identity i=new DiscoverInfo.Identity("client","pc","Psi 0.11","en");
    identities.add(i);
    i=new DiscoverInfo.Identity("client","pc","Ψ 0.11","el");
    identities.add(i);
    di.addIdentities(identities);
    i=new DiscoverInfo.Identity("client","pc","Ψ 0.11","el");
    identities.add(i);
    di.addIdentities(identities);
    di.addFeature("http://jabber.org/protocol/disco#items");
    di.addFeature(EntityCapsManager.NAMESPACE);
    di.addFeature("http://jabber.org/protocol/muc");
    di.addFeature("http://jabber.org/protocol/disco#info");
    di.addFeature("http://jabber.org/protocol/disco#info");
    DataForm softwareInfoDataForm=createSampleSoftwareInfoDataForm();
    di.addExtension(softwareInfoDataForm);
    DiscoverInfo discoverInfo=di.buildWithoutValidiation();
    return discoverInfo;
  }
  public static File createTempDirectory() throws IOException {
    File tmp=File.createTempFile("entity","caps");
    tmp.delete();
    tmp.mkdir();
    return tmp;
  }
}

public static KeyManager[] getKeyManagersFrom(String keystoreType,String keystorePath,CallbackHandler callbackHandler,String pkcs11Library) throws NoSuchMethodException, SecurityException, ClassNotFoundException, KeyStoreException, NoSuchProviderException, NoSuchAlgorithmException, CertificateException, IOException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, UnsupportedCallbackException, UnrecoverableKeyException {
  KeyManager[] keyManagers=null;
  KeyStore ks=null;
  PasswordCallback pcb=null;
  if ("PKCS11".equals(keystoreType)) {
    Constructor<?> c=Class.forName("sun.security.pkcs11.SunPKCS11").getConstructor(InputStream.class);
    String pkcs11Config="name = SmartCard\nlibrary = " + pkcs11Library;
    ByteArrayInputStream config=new ByteArrayInputStream(pkcs11Config.getBytes(StandardCharsets.UTF_8));
    Provider p=(Provider)c.newInstance(config);
    Security.addProvider(p);
    ks=KeyStore.getInstance("PKCS11",p);
    pcb=new PasswordCallback("PKCS11 Password: ",false);
    callbackHandler.handle(new Callback[]{pcb});
    ks.load(null,pcb.getPassword());
  }
 else   if ("Apple".equals(keystoreType)) {
    ks=KeyStore.getInstance("KeychainStore","Apple");
    ks.load(null,null);
  }
 else   if (keystoreType != null) {
    ks=KeyStore.getInstance(keystoreType);
    if (callbackHandler != null && StringUtils.isNotEmpty(keystorePath)) {
      pcb=new PasswordCallback("Keystore Password: ",false);
      callbackHandler.handle(new Callback[]{pcb});
      ks.load(new FileInputStream(keystorePath),pcb.getPassword());
    }
 else {
      InputStream stream=TLSUtils.getDefaultTruststoreStreamIfPossible();
      try {
        char[] password="changeit".toCharArray();
        try {
          ks.load(stream,password);
        }
  finally {
          CloseableUtil.maybeClose(stream);
        }
      }
 catch (      IOException e) {
        LOGGER.log(Level.FINE,"KeyStore load() threw, attempting 'jks' fallback",e);
        ks=KeyStore.getInstance("jks");
        stream=TLSUtils.getDefaultTruststoreStreamIfPossible();
        try {
          ks.load(stream,null);
        }
  finally {
          CloseableUtil.maybeClose(stream);
        }
      }
    }
  }
  if (ks != null) {
    String keyManagerFactoryAlgorithm=KeyManagerFactory.getDefaultAlgorithm();
    KeyManagerFactory kmf=KeyManagerFactory.getInstance(keyManagerFactoryAlgorithm);
    if (kmf != null) {
      if (pcb == null) {
        kmf.init(ks,null);
      }
 else {
        kmf.init(ks,pcb.getPassword());
        pcb.clearPassword();
      }
      keyManagers=kmf.getKeyManagers();
    }
  }
  return keyManagers;
}

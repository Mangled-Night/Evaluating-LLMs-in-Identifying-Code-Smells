public class TaskMemoryManagerSuite {
  @Test public void leakedPageMemoryIsDetected(){
    final DataNodeMemoryManager manager=new DataNodeMemoryManager(new ResultMergeMemoryManager(new MycatPropertyConf().set("mycat.memory.offHeap.enabled","false").set("mycat.memory.offHeap.size","32768"),1,Long.MAX_VALUE),0);
    manager.allocatePage(4096,null);
    Assert.assertEquals(4096,manager.getMemoryConsumptionForThisConnection());
    Assert.assertEquals(4096,manager.cleanUpAllAllocatedMemory());
  }
  @Test public void encodePageNumberAndOffsetOffHeap(){
    final MycatPropertyConf conf=new MycatPropertyConf().set("mycat.memory.offHeap.enabled","true").set("mycat.memory.offHeap.size","1000");
    final DataNodeMemoryManager manager=new DataNodeMemoryManager(new TestMemoryManager(conf),0);
    final MemoryBlock dataPage=manager.allocatePage(256,null);
    final long offset=((1L << DataNodeMemoryManager.OFFSET_BITS) + 10);
    final long encodedAddress=manager.encodePageNumberAndOffset(dataPage,offset);
    Assert.assertEquals(null,manager.getPage(encodedAddress));
    Assert.assertEquals(offset,manager.getOffsetInPage(encodedAddress));
  }
  @Test public void encodePageNumberAndOffsetOnHeap(){
    final DataNodeMemoryManager manager=new DataNodeMemoryManager(new TestMemoryManager(new MycatPropertyConf().set("mycat.memory.offHeap.enabled","false")),0);
    final MemoryBlock dataPage=manager.allocatePage(256,null);
    final long encodedAddress=manager.encodePageNumberAndOffset(dataPage,64);
    Assert.assertEquals(dataPage.getBaseObject(),manager.getPage(encodedAddress));
    Assert.assertEquals(64,manager.getOffsetInPage(encodedAddress));
  }
  @Test public void cooperativeSpilling() throws InterruptedException {
    final TestMemoryManager memoryManager=new TestMemoryManager(new MycatPropertyConf());
    memoryManager.limit(100);
    final DataNodeMemoryManager manager=new DataNodeMemoryManager(memoryManager,0);
    TestMemoryConsumer c1=new TestMemoryConsumer(manager);
    TestMemoryConsumer c2=new TestMemoryConsumer(manager);
    c1.use(100);
    Assert.assertEquals(100,c1.getUsed());
    c2.use(100);
    Assert.assertEquals(100,c2.getUsed());
    Assert.assertEquals(0,c1.getUsed());
    c1.use(100);
    Assert.assertEquals(100,c1.getUsed());
    Assert.assertEquals(0,c2.getUsed());
    c1.use(50);
    Assert.assertEquals(50,c1.getUsed());
    Assert.assertEquals(0,c2.getUsed());
    c2.use(50);
    Assert.assertEquals(50,c1.getUsed());
    Assert.assertEquals(50,c2.getUsed());
    c1.use(100);
    Assert.assertEquals(100,c1.getUsed());
    Assert.assertEquals(0,c2.getUsed());
    c1.free(20);
    Assert.assertEquals(80,c1.getUsed());
    c2.use(10);
    Assert.assertEquals(80,c1.getUsed());
    Assert.assertEquals(10,c2.getUsed());
    c2.use(100);
    Assert.assertEquals(100,c2.getUsed());
    Assert.assertEquals(0,c1.getUsed());
    c1.free(0);
    c2.free(100);
    Assert.assertEquals(0,manager.cleanUpAllAllocatedMemory());
  }
  @Test public void offHeapConfigurationBackwardsCompatibility(){
    final MycatPropertyConf conf=new MycatPropertyConf().set("mycat.memory.offHeap.enabled","true").set("mycat.memory.offHeap.size","1000");
    final DataNodeMemoryManager manager=new DataNodeMemoryManager(new TestMemoryManager(conf),0);
    Assert.assertSame(MemoryMode.OFF_HEAP,manager.tungstenMemoryMode);
  }
}

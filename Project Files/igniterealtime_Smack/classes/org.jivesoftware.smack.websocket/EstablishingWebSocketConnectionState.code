final class EstablishingWebSocketConnectionState extends State.AbstractTransport {
  EstablishingWebSocketConnectionState(  StateDescriptor stateDescriptor,  ModularXmppClientToServerConnectionInternal connectionInternal){
    super(websocketTransport,stateDescriptor,connectionInternal);
  }
  @Override public AttemptResult transitionInto(  WalkStateGraphContext walkStateGraphContext) throws InterruptedException, NoResponseException, NotConnectedException, SmackException, XMPPException {
    final WebSocketFactory webSocketFactory;
    if (moduleDescriptor.webSocketFactory != null) {
      webSocketFactory=moduleDescriptor.webSocketFactory;
    }
 else {
      webSocketFactory=WebSocketFactoryService::createWebSocket;
    }
    WebSocketConnectionAttemptState connectionAttemptState=new WebSocketConnectionAttemptState(connectionInternal,discoveredWebSocketEndpoints,webSocketFactory);
    StateTransitionResult.Failure failure=connectionAttemptState.establishWebSocketConnection();
    if (failure != null) {
      return failure;
    }
    websocket=connectionAttemptState.getConnectedWebSocket();
    connectionInternal.setTransport(websocketTransport);
    connectionInternal.newStreamOpenWaitForFeaturesSequence("stream features after initial connection");
    return new WebSocketConnectedResult(websocket.getEndpoint());
  }
}

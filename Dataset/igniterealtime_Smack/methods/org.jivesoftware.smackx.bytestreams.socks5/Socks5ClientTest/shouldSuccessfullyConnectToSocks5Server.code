/** 
 * The SOCKS5 client should successfully connect to the SOCKS5 server.
 * @throws Exception should not happen
 */
@Test public void shouldSuccessfullyConnectToSocks5Server() throws Exception {
  Thread serverThread=new Thread(){
    @Override public void run(){
      StreamHost streamHost=new StreamHost(proxyJID,serverAddress,serverPort);
      Socks5Client socks5Client=new Socks5Client(streamHost,digest);
      try {
        Socket socket=socks5Client.getSocket(10000);
        assertNotNull(socket);
        socket.getOutputStream().write(123);
        socket.close();
      }
 catch (      Exception e) {
        fail(e.getMessage());
      }
    }
  }
;
  serverThread.start();
  Socket socket=serverSocket.accept();
  DataInputStream in=new DataInputStream(socket.getInputStream());
  DataOutputStream out=new DataOutputStream(socket.getOutputStream());
  assertEquals((byte)0x05,(byte)in.read());
  assertEquals((byte)0x01,(byte)in.read());
  assertEquals((byte)0x00,(byte)in.read());
  out.write(new byte[]{(byte)0x05,(byte)0x00});
  out.flush();
  byte[] address=digest.getBytes(StandardCharsets.UTF_8);
  assertEquals((byte)0x05,(byte)in.read());
  assertEquals((byte)0x01,(byte)in.read());
  assertEquals((byte)0x00,(byte)in.read());
  assertEquals((byte)0x03,(byte)in.read());
  assertEquals(address.length,(byte)in.read());
  for (int i=0; i < address.length; i++) {
    assertEquals(address[i],(byte)in.read());
  }
  assertEquals((byte)0x00,(byte)in.read());
  assertEquals((byte)0x00,(byte)in.read());
  out.write(new byte[]{(byte)0x05,(byte)0x00,(byte)0x00,(byte)0x03});
  out.write(address.length);
  out.write(address);
  out.write(new byte[]{(byte)0x00,(byte)0x00});
  out.flush();
  serverThread.join();
  assertEquals(123,in.read());
  assertEquals(-1,in.read());
}

public HttpResponse handle(ChannelHandlerContext ctx,FullHttpRequest request) throws Exception {
  ApiResponse result;
  String requestBody=null;
  String requestId=null;
  try {
    HttpMethod method=request.method();
    if (HttpMethod.POST.equals(method)) {
      requestBody=getBody(request);
      ApiRequest apiRequest=parseRequest(requestBody);
      requestId=apiRequest.getRequestId();
      result=processRequest(ctx,apiRequest);
    }
 else {
      result=createResponse(ApiState.REFUSED,"Unsupported http method: " + method.name());
    }
  }
 catch (  Throwable e) {
    result=createResponse(ApiState.FAILED,"Process request error: " + e.getMessage());
    logger.error("arthas process http api request error: " + request.uri() + ", request body: "+ requestBody,e);
  }
  if (result == null) {
    result=createResponse(ApiState.FAILED,"The request was not processed");
  }
  result.setRequestId(requestId);
  ByteBuf content=null;
  char[] charsBuf=null;
  byte[] bytesBuf=null;
  try {
    content=byteBufPool.poll(2000,TimeUnit.MILLISECONDS);
    if (content == null) {
      throw new ApiException("get response content buf failure");
    }
    charsBuf=charsBufPool.poll();
    bytesBuf=bytesPool.poll();
    if (charsBuf == null || bytesBuf == null) {
      throw new ApiException("get json buf failure");
    }
    JsonUtils.setSerializeWriterBufThreadLocal(charsBuf,bytesBuf);
    DefaultFullHttpResponse response=new DefaultFullHttpResponse(request.protocolVersion(),HttpResponseStatus.OK,content.retain());
    response.headers().set(HttpHeaderNames.CONTENT_TYPE,"application/json; charset=utf-8");
    writeResult(response,result);
    return response;
  }
 catch (  Exception e) {
    if (content != null) {
      content.release();
      byteBufPool.offer(content);
    }
    throw e;
  }
 finally {
    JsonUtils.setSerializeWriterBufThreadLocal(null,null);
    if (charsBuf != null) {
      charsBufPool.offer(charsBuf);
    }
    if (bytesBuf != null) {
      bytesPool.offer(bytesBuf);
    }
  }
}

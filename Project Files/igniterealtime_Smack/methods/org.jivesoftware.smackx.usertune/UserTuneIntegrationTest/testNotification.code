/** 
 * Verifies that a notification is sent when a publication is received, assuming that notification filtering has been adjusted to allow for the notification to be delivered.
 * @throws Exception if the test fails
 */
@SmackIntegrationTest public void testNotification() throws Exception {
  URI uri=new URI("http://www.yesworld.com/lyrics/Fragile.html#9");
  UserTuneElement.Builder builder=UserTuneElement.getBuilder();
  UserTuneElement data=builder.setArtist("Yes").setLength(686).setRating(8).setSource("Yessongs").setTitle("Heart of the Sunrise").setTrack("3").setUri(uri).build();
  IntegrationTestRosterUtil.ensureBothAccountsAreSubscribedToEachOther(conOne,conTwo,timeout);
  final SimpleResultSyncPoint userTuneReceived=new SimpleResultSyncPoint();
  final PepEventListener<UserTuneElement> userTuneListener=(jid,userTune,id,message) -> {
    if (userTune.equals(data)) {
      userTuneReceived.signal();
    }
  }
;
  try {
    registerListenerAndWait(utm2,ServiceDiscoveryManager.getInstanceFor(conTwo),userTuneListener);
    utm1.publishUserTune(data);
    Object result=userTuneReceived.waitForResult(timeout);
    Assertions.assertNotNull(result,"Expected to receive a PEP notification, but did not.");
  }
  finally {
    unregisterListener(utm2,userTuneListener);
  }
}

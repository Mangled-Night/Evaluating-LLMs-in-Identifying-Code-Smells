/** 
 * Autojoin bookmarked Multi-User Chat conferences.
 * @see <a href="http://xmpp.org/extensions/xep-0048.html">XEP-48: Bookmarks</a>
 */
public final class MucBookmarkAutojoinManager extends Manager {
  private static final Logger LOGGER=Logger.getLogger(MucBookmarkAutojoinManager.class.getName());
  private static final Map<XMPPConnection,MucBookmarkAutojoinManager> INSTANCES=new WeakHashMap<>();
  private static boolean autojoinEnabledDefault=false;
static {
    XMPPConnectionRegistry.addConnectionCreationListener(new ConnectionCreationListener(){
      @Override public void connectionCreated(      XMPPConnection connection){
        getInstanceFor(connection);
      }
    }
);
  }
  public static void setAutojoinPerDefault(  boolean autojoin){
    autojoinEnabledDefault=autojoin;
  }
  public static synchronized MucBookmarkAutojoinManager getInstanceFor(  XMPPConnection connection){
    MucBookmarkAutojoinManager mbam=INSTANCES.get(connection);
    if (mbam == null) {
      mbam=new MucBookmarkAutojoinManager(connection);
      INSTANCES.put(connection,mbam);
    }
    return mbam;
  }
  private final MultiUserChatManager multiUserChatManager;
  private final BookmarkManager bookmarkManager;
  private boolean autojoinEnabled=autojoinEnabledDefault;
  private MucBookmarkAutojoinManager(  XMPPConnection connection){
    super(connection);
    multiUserChatManager=MultiUserChatManager.getInstanceFor(connection);
    bookmarkManager=BookmarkManager.getBookmarkManager(connection);
    connection.addConnectionListener(new ConnectionListener(){
      @Override public void authenticated(      XMPPConnection connection,      boolean resumed){
        if (!autojoinEnabled) {
          return;
        }
        autojoinBookmarkedConferences();
      }
    }
);
  }
  public void setAutojoinEnabled(  boolean autojoin){
    autojoinEnabled=autojoin;
  }
  public void autojoinBookmarkedConferences(){
    List<BookmarkedConference> bookmarkedConferences;
    try {
      bookmarkedConferences=bookmarkManager.getBookmarkedConferences();
    }
 catch (    NotConnectedException|InterruptedException e) {
      LOGGER.log(Level.FINER,"Could not get MUC bookmarks",e);
      return;
    }
catch (    NoResponseException|XMPPErrorException e) {
      LOGGER.log(Level.WARNING,"Could not get MUC bookmarks",e);
      return;
    }
    final XMPPConnection connection=connection();
    Resourcepart defaultNick=connection.getUser().getResourcepart();
    for (    BookmarkedConference bookmarkedConference : bookmarkedConferences) {
      if (!bookmarkedConference.isAutoJoin()) {
        continue;
      }
      Resourcepart nick=bookmarkedConference.getNickname();
      if (nick == null) {
        nick=defaultNick;
      }
      String password=bookmarkedConference.getPassword();
      MultiUserChat muc=multiUserChatManager.getMultiUserChat(bookmarkedConference.getJid());
      try {
        MucCreateConfigFormHandle handle=muc.createOrJoinIfNecessary(nick,password);
        if (handle != null) {
          handle.makeInstant();
        }
      }
 catch (      NotConnectedException|InterruptedException e) {
        LOGGER.log(Level.FINER,"Could not autojoin bookmarked MUC",e);
        break;
      }
catch (      NotAMucServiceException|NoResponseException|XMPPErrorException e) {
        LOGGER.log(Level.WARNING,"Could not autojoin bookmarked MUC",e);
      }
    }
  }
}

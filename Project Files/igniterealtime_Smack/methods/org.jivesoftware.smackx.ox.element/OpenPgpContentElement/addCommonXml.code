protected void addCommonXml(XmlStringBuilder xml){
  for (  Jid toJid : to != null ? to : Collections.<Jid>emptySet()) {
    xml.halfOpenElement(ELEM_TO).attribute(ATTR_JID,toJid).closeEmptyElement();
  }
  ensureTimestampStringSet();
  xml.halfOpenElement(ELEM_TIME).attribute(ATTR_STAMP,timestampString).closeEmptyElement();
  xml.openElement(ELEM_PAYLOAD);
  for (  XmlElement element : payload.values()) {
    xml.append(element.toXML(getNamespace()));
  }
  xml.closeElement(ELEM_PAYLOAD);
}

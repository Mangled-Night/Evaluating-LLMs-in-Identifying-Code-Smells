/** 
 * Ensures that replying to packets is ok.
 */
public void testReplying() throws XMPPException {
  StanzaCollector collector0=getConnection(0).createStanzaCollector(new MessageTypeFilter(Message.Type.normal));
  StanzaCollector collector1=getConnection(1).createStanzaCollector(new MessageTypeFilter(Message.Type.normal));
  StanzaCollector collector2=getConnection(2).createStanzaCollector(new MessageTypeFilter(Message.Type.normal));
  StanzaCollector collector3=getConnection(3).createStanzaCollector(new MessageTypeFilter(Message.Type.normal));
  Message message=new Message();
  message.setBody("Hola");
  List<String> to=Arrays.asList(new String[]{getBareJID(1)});
  List<String> cc=Arrays.asList(new String[]{getBareJID(2)});
  List<String> bcc=Arrays.asList(new String[]{getBareJID(3)});
  MultipleRecipientManager.send(getConnection(0),message,to,cc,bcc);
  Message message1=(Message)collector1.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNotNull("XMPPConnection 1 never received the message",message1);
  MultipleRecipientInfo info=MultipleRecipientManager.getMultipleRecipientInfo(message1);
  assertNotNull("Message 1 does not contain MultipleRecipientInfo",info);
  assertFalse("Message 1 should be 'replyable'",info.shouldNotReply());
  assertEquals("Incorrect number of TO addresses",1,info.getTOAddresses().size());
  assertEquals("Incorrect number of CC addresses",1,info.getCCAddresses().size());
  Message reply1=new Message();
  reply1.setBody("This is my reply");
  MultipleRecipientManager.reply(getConnection(1),message1,reply1);
  reply1=(Message)collector0.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNotNull("XMPPConnection 0 never received the reply",reply1);
  info=MultipleRecipientManager.getMultipleRecipientInfo(reply1);
  assertNotNull("Replied message does not contain MultipleRecipientInfo",info);
  assertFalse("Replied message should be 'replyable'",info.shouldNotReply());
  assertEquals("Incorrect number of TO addresses",1,info.getTOAddresses().size());
  assertEquals("Incorrect number of CC addresses",1,info.getCCAddresses().size());
  Message reply2=new Message();
  reply2.setBody("This is my reply to your reply");
  reply2.setFrom(getBareJID(0));
  MultipleRecipientManager.reply(getConnection(0),reply1,reply2);
  reply2=(Message)collector1.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNotNull("XMPPConnection 1 never received the reply",reply2);
  info=MultipleRecipientManager.getMultipleRecipientInfo(reply2);
  assertNotNull("Replied message does not contain MultipleRecipientInfo",info);
  assertFalse("Replied message should be 'replyable'",info.shouldNotReply());
  assertEquals("Incorrect number of TO addresses",1,info.getTOAddresses().size());
  assertEquals("Incorrect number of CC addresses",1,info.getCCAddresses().size());
  message1=(Message)collector2.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNotNull("XMPPConnection2 didn't receive the 1 message",message1);
  message1=(Message)collector2.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNotNull("XMPPConnection2 didn't receive the 2 message",message1);
  message1=(Message)collector2.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNotNull("XMPPConnection2 didn't receive the 3 message",message1);
  message1=(Message)collector2.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNull("XMPPConnection2 received 4 messages",message1);
  message1=(Message)collector3.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNotNull("XMPPConnection3 didn't receive the 1 message",message1);
  message1=(Message)collector3.nextResult(SmackConfiguration.getPacketReplyTimeout());
  assertNull("XMPPConnection2 received 2 messages",message1);
  collector0.cancel();
  collector1.cancel();
  collector2.cancel();
  collector3.cancel();
}

/** 
 * Low level API test. 1. User_1 will send a message with XHTML to user_2 2. User_2 will receive the message and iterate over the XHTML bodies to check if everything is fine 3. User_1 will wait several seconds for an ACK from user_2, if none is received then something is wrong
 */
public void testSendSimpleXHTMLMessageAndDisplayReceivedXHTMLMessage(){
  Chat chat1=getConnection(0).getChatManager().createChat(getBareJID(1),null);
  final StanzaCollector chat2=getConnection(1).createStanzaCollector(new ThreadFilter(chat1.getThreadID()));
  Message msg=new Message();
  msg.setSubject("Any subject you want");
  msg.setBody("Hey John, this is my new green!!!!");
  XHTMLExtension xhtmlExtension=new XHTMLExtension();
  xhtmlExtension.addBody("<body><p style='font-size:large'>Hey John, this is my new <span style='color:green'>green</span><em>!!!!</em></p></body>");
  msg.addExtension(xhtmlExtension);
  try {
    chat1.sendMessage(msg);
  }
 catch (  Exception e) {
    fail("An error occurred sending the message with XHTML");
  }
  Packet packet=chat2.nextResult(2000);
  Message message=(Message)packet;
  assertNotNull("Body is null",message.getBody());
  try {
    xhtmlExtension=(XHTMLExtension)message.getExtension("html","http://jabber.org/protocol/xhtml-im");
    assertNotNull("Message without extension \"http://jabber.org/protocol/xhtml-im\"",xhtmlExtension);
    assertTrue("Message without XHTML bodies",xhtmlExtension.getBodiesCount() > 0);
    for (Iterator<String> it=xhtmlExtension.getBodies(); it.hasNext(); ) {
      String body=it.next();
      System.out.println(body);
    }
  }
 catch (  ClassCastException e) {
    fail("ClassCastException - Most probable cause is that smack providers is misconfigured");
  }
}

public static Selector rebuildSelector(final Selector oldSelector) throws IOException {
  final Selector newSelector;
  try {
    newSelector=Selector.open();
  }
 catch (  Exception e) {
    logger.warn("Failed to create a new Selector.",e);
    return null;
  }
  int nChannels=0;
  for (; ; ) {
    try {
      for (      SelectionKey key : oldSelector.keys()) {
        Object a=key.attachment();
        try {
          if (!key.isValid() || key.channel().keyFor(newSelector) != null) {
            continue;
          }
          int interestOps=key.interestOps();
          key.cancel();
          key.channel().register(newSelector,interestOps,a);
          nChannels++;
        }
 catch (        Exception e) {
          logger.warn("Failed to re-register a Channel to the new Selector.",e);
        }
      }
    }
 catch (    ConcurrentModificationException e) {
      continue;
    }
    break;
  }
  oldSelector.close();
  return newSelector;
}

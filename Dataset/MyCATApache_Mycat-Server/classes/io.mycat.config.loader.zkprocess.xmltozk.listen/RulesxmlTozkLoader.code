/** 
 * 进行从rule.xml加载到zk中加载 源文件名：SchemasLoader.java 文件版本：1.0.0 创建作者：liujun 创建日期：2016年9月15日 修改作者：liujun 修改日期：2016年9月15日 文件描述：TODO 版权所有：Copyright 2016 zjhz, Inc. All Rights Reserved.
 */
public class RulesxmlTozkLoader extends ZkMultLoader implements NotiflyService {
  /** 
 * 日志
 * @字段说明 LOGGER
 */
  private static final Logger LOGGER=LoggerFactory.getLogger(RulesxmlTozkLoader.class);
  /** 
 * 当前文件中的zkpath信息 
 * @字段说明 currZkPath
 */
  private final String currZkPath;
  /** 
 * Rules文件的路径信息
 * @字段说明 SCHEMA_PATH
 */
  private static final String RULE_PATH=ZookeeperPath.ZK_LOCAL_CFG_PATH.getKey() + "rule.xml";
  /** 
 * Rules的xml的转换信息
 * @字段说明 parseRulesXMl
 */
  private ParseXmlServiceInf<Rules> parseRulesXMl;
  /** 
 * 表的路由信息
 * @字段说明 parseJsonService
 */
  private ParseJsonServiceInf<List<TableRule>> parseJsonTableRuleService=new TableRuleJsonParse();
  /** 
 * 表对应的字段信息
 * @字段说明 parseJsonFunctionService
 */
  private ParseJsonServiceInf<List<Function>> parseJsonFunctionService=new FunctionJsonParse();
  public RulesxmlTozkLoader(  ZookeeperProcessListen zookeeperListen,  CuratorFramework curator,  XmlProcessBase xmlParseBase){
    this.setCurator(curator);
    String schemaPath=zookeeperListen.getBasePath();
    schemaPath=schemaPath + ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_RULE.getKey();
    currZkPath=schemaPath;
    zookeeperListen.addListen(schemaPath,this);
    parseRulesXMl=new RuleParseXmlImpl(xmlParseBase);
  }
  @Override public boolean notiflyProcess() throws Exception {
    Rules Rules=this.parseRulesXMl.parseXmlToBean(RULE_PATH);
    LOGGER.info("RulesxmlTozkLoader notiflyProcessxml to zk Rules Object  :" + Rules);
    this.xmlTozkRulesJson(currZkPath,Rules);
    LOGGER.info("RulesxmlTozkLoader notiflyProcess xml to zk is success");
    return true;
  }
  /** 
 * 将xml文件的信息写入到zk中 方法描述
 * @param basePath 基本路径
 * @param schema schema文件的信息
 * @throws Exception 异常信息
 * @创建日期 2016年9月17日
 */
  private void xmlTozkRulesJson(  String basePath,  Rules Rules) throws Exception {
    String tableRulePath=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_RULE_TABLERULE.getKey();
    String tableRuleJson=this.parseJsonTableRuleService.parseBeanToJson(Rules.getTableRule());
    this.checkAndwriteString(basePath,tableRulePath,tableRuleJson);
    this.readMapFileAddFunction(Rules.getFunction());
    String functionPath=ZookeeperPath.ZK_SEPARATOR.getKey() + ZookeeperPath.FLOW_ZK_PATH_RULE_FUNCTION.getKey();
    String functionJson=this.parseJsonFunctionService.parseBeanToJson(Rules.getFunction());
    this.checkAndwriteString(basePath,functionPath,functionJson);
  }
  /** 
 * 读取序列配制文件便利店   方法描述
 * @param functionList
 * @创建日期 2016年9月18日
 */
  private void readMapFileAddFunction(  List<Function> functionList){
    List<Property> tempData=new ArrayList<>();
    for (    Function function : functionList) {
      List<Property> proList=function.getProperty();
      if (null != proList && !proList.isEmpty()) {
        for (        Property property : proList) {
          if (ParseParamEnum.ZK_PATH_RULE_MAPFILE_NAME.getKey().equals(property.getName())) {
            Property mapFilePro=new Property();
            mapFilePro.setName(property.getValue());
            mapFilePro.setValue(this.readMapFile(property.getValue()));
            tempData.add(mapFilePro);
          }
        }
        proList.addAll(tempData);
        tempData.clear();
      }
    }
  }
  /** 
 * 读取 mapFile文件的信息 方法描述
 * @param name 名称信息
 * @return
 * @创建日期 2016年9月18日
 */
  private String readMapFile(  String name){
    StringBuilder mapFileStr=new StringBuilder();
    String path=ZookeeperPath.ZK_LOCAL_CFG_PATH.getKey() + name;
    InputStream input=RulesxmlTozkLoader.class.getResourceAsStream(path);
    checkNotNull(input,"read Map file curr Path :" + path + " is null! must is not null");
    byte[] buffers=new byte[256];
    try {
      int readIndex=-1;
      while ((readIndex=input.read(buffers)) != -1) {
        mapFileStr.append(new String(buffers,0,readIndex));
      }
    }
 catch (    IOException e) {
      e.printStackTrace();
      LOGGER.error("RulesxmlTozkLoader readMapFile IOException",e);
    }
 finally {
      IOUtils.close(input);
    }
    return mapFileStr.toString();
  }
}

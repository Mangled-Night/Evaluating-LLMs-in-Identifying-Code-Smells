public class RegistrationProvider extends IqProvider<Registration> {
  @Override public Registration parse(  XmlPullParser parser,  int initialDepth,  IqData iqData,  XmlEnvironment xmlEnvironment) throws XmlPullParserException, IOException, SmackParsingException {
    String instruction=null;
    Map<String,String> fields=new HashMap<>();
    List<XmlElement> packetExtensions=new LinkedList<>();
    outerloop:     while (true) {
      XmlPullParser.Event eventType=parser.next();
      if (eventType == XmlPullParser.Event.START_ELEMENT) {
        if (parser.getNamespace().equals(Registration.NAMESPACE)) {
          String name=parser.getName();
          String value="";
          if (parser.next() == XmlPullParser.Event.TEXT_CHARACTERS) {
            value=parser.getText();
          }
          if (!name.equals("instructions")) {
            fields.put(name,value);
          }
 else {
            instruction=value;
          }
        }
 else {
          PacketParserUtils.addExtensionElement(packetExtensions,parser,xmlEnvironment);
        }
      }
 else       if (eventType == XmlPullParser.Event.END_ELEMENT) {
        if (parser.getName().equals(IQ.QUERY_ELEMENT)) {
          break outerloop;
        }
      }
    }
    Registration registration=new Registration(instruction,fields);
    registration.addExtensions(packetExtensions);
    return registration;
  }
}

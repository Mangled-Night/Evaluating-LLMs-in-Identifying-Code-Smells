/** 
 * Registers a listener for User Tune data. This implicitly publishes a CAPS update to include a notification filter for the mood node. This method blocks until the server has indicated that this update has been received.
 * @param moodManager The MoodManager instance for the connection that is expected to receive data.
 * @param discoManager The ServiceDiscoveryManager instance for the connection that is expected to publish data.
 * @param listener A listener instance for Mood data that is to be registered.
 * @throws Exception if the test fails
 */
public void registerListenerAndWait(MoodManager moodManager,ServiceDiscoveryManager discoManager,PepEventListener<MoodElement> listener) throws Exception {
  final SimpleResultSyncPoint notificationFilterReceived=new SimpleResultSyncPoint();
  final EntityCapabilitiesChangedListener notificationFilterReceivedListener=info -> {
    if (info.containsFeature(MoodManager.MOOD_NODE + "+notify")) {
      notificationFilterReceived.signal();
    }
  }
;
  discoManager.addEntityCapabilitiesChangedListener(notificationFilterReceivedListener);
  try {
    moodManager.addMoodListener(listener);
    notificationFilterReceived.waitForResult(timeout);
  }
  finally {
    discoManager.removeEntityCapabilitiesChangedListener(notificationFilterReceivedListener);
  }
}

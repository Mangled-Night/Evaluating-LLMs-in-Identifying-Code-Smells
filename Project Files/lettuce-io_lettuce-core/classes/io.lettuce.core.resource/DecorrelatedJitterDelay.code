/** 
 * Stateful delay that increases using decorrelated jitter strategy. <p> Considering retry attempts start at 1, attempt 0 would be the initial call and will always yield 0 (or the lower). Then, each retry step will by default yield  {@code min(cap, randomBetween(base, prevDelay * 3))}. This strategy is based on <a href="https://www.awsarchitectureblog.com/2015/03/backoff.html">Exponential Backoff and Jitter</a>. </p>
 * @author Jongyeol Choi
 * @author Mark Paluch
 * @since 4.2
 * @see StatefulDelay
 */
class DecorrelatedJitterDelay extends Delay implements StatefulDelay {
  private final Duration lower;
  private final Duration upper;
  private final long base;
  private final TimeUnit targetTimeUnit;
  private volatile long prevDelay;
  DecorrelatedJitterDelay(  Duration lower,  Duration upper,  long base,  TimeUnit targetTimeUnit){
    this.lower=lower;
    this.upper=upper;
    this.base=base;
    this.targetTimeUnit=targetTimeUnit;
    reset();
  }
  @Override public Duration createDelay(  long attempt){
    long value=randomBetween(base,Math.max(base,prevDelay * 3));
    Duration delay=applyBounds(Duration.ofNanos(targetTimeUnit.toNanos(value)),lower,upper);
    prevDelay=targetTimeUnit.convert(delay.toNanos(),TimeUnit.NANOSECONDS);
    return delay;
  }
  @Override public void reset(){
    prevDelay=0L;
  }
}

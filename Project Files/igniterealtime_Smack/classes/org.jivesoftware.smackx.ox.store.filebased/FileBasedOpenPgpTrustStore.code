/** 
 * Implementation of the  {@link OpenPgpTrustStore} which stores information in a directory structure.<pre> {@code <basePath>/ <userjid@server.tld>/ <fingerprint>.trust      // Trust record for a key}</pre>
 */
public class FileBasedOpenPgpTrustStore extends AbstractOpenPgpTrustStore {
  private static final Logger LOGGER=Logger.getLogger(FileBasedOpenPgpTrustStore.class.getName());
  private final File basePath;
  public static String TRUST_RECORD(  OpenPgpV4Fingerprint fingerprint){
    return fingerprint.toString() + ".trust";
  }
  public FileBasedOpenPgpTrustStore(  File basePath){
    this.basePath=basePath;
  }
  @Override protected Trust readTrust(  BareJid owner,  OpenPgpV4Fingerprint fingerprint) throws IOException {
    File file=getTrustPath(owner,fingerprint);
    BufferedReader reader=null;
    try {
      InputStream inputStream=FileUtils.prepareFileInputStream(file);
      InputStreamReader isr=new InputStreamReader(inputStream,Util.UTF8);
      reader=new BufferedReader(isr);
      Trust trust=null;
      String line;
      int lineNr=0;
      while ((line=reader.readLine()) != null) {
        lineNr++;
        try {
          trust=Trust.valueOf(line);
          break;
        }
 catch (        IllegalArgumentException e) {
          LOGGER.log(Level.WARNING,"Skipping invalid trust record in line " + lineNr + " \""+ line+ "\" of file "+ file.getAbsolutePath());
        }
      }
      return trust != null ? trust : Trust.undecided;
    }
 catch (    IOException e) {
      if (e instanceof FileNotFoundException) {
        return Trust.undecided;
      }
      throw e;
    }
 finally {
      CloseableUtil.maybeClose(reader,LOGGER);
    }
  }
  @Override protected void writeTrust(  BareJid owner,  OpenPgpV4Fingerprint fingerprint,  Trust trust) throws IOException {
    File file=getTrustPath(owner,fingerprint);
    if (trust == null || trust == Trust.undecided) {
      FileUtils.maybeDeleteFileOrThrow(file);
    }
    FileUtils.maybeCreateFileWithParentDirectories(file);
    BufferedWriter writer=null;
    try {
      OutputStream outputStream=FileUtils.prepareFileOutputStream(file);
      OutputStreamWriter osw=new OutputStreamWriter(outputStream,Util.UTF8);
      writer=new BufferedWriter(osw);
      writer.write(trust.toString());
    }
  finally {
      CloseableUtil.maybeClose(writer,LOGGER);
    }
  }
  private File getTrustPath(  BareJid owner,  OpenPgpV4Fingerprint fingerprint){
    return new File(FileBasedOpenPgpStore.getContactsPath(basePath,owner),TRUST_RECORD(fingerprint));
  }
}

/** 
 * Test cases for adding the  {@link RosterListener} in different connection states.
 * @author Henning Staib
 */
public class RosterListenerTest extends SmackTestCase {
  public RosterListenerTest(  String arg0){
    super(arg0);
  }
  public void testAddingRosterListenerBeforeConnect() throws Exception {
    int inviterIndex=0;
    int inviteeIndex=1;
    XMPPTCPConnection inviterConnection=getConnection(inviterIndex);
    connectAndLogin(inviterIndex);
    assertTrue("Inviter is not online",inviterConnection.isConnected());
    Roster inviterRoster=inviterConnection.getRoster();
    inviterRoster.createEntry(getBareJID(inviteeIndex),getUsername(inviteeIndex),null);
    XMPPTCPConnection inviteeConnection=getConnection(inviteeIndex);
    assertFalse("Invitee is already online",inviteeConnection.isConnected());
    final List<String> addedEntries=new ArrayList<String>();
    Roster inviteeRoster=inviteeConnection.getRoster();
    inviteeRoster.addRosterListener(new RosterListener(){
      public void presenceChanged(      Presence presence){
      }
      public void entriesUpdated(      Collection<String> addresses){
      }
      public void entriesDeleted(      Collection<String> addresses){
      }
      public void entriesAdded(      Collection<String> addresses){
        addedEntries.addAll(addresses);
      }
    }
);
    connectAndLogin(inviteeIndex);
    Thread.sleep(5000);
    assertNotNull("inviter is not in roster",inviteeRoster.getEntry(getBareJID(inviterIndex)));
    assertTrue("got no event for adding inviter",addedEntries.contains(getBareJID(inviterIndex)));
  }
  public void testAddingRosterListenerAfterConnect() throws Exception {
    int inviterIndex=0;
    int inviteeIndex=1;
    XMPPTCPConnection inviterConnection=getConnection(inviterIndex);
    connectAndLogin(inviterIndex);
    assertTrue("Inviter is not online",inviterConnection.isConnected());
    Roster inviterRoster=inviterConnection.getRoster();
    inviterRoster.createEntry(getBareJID(inviteeIndex),getUsername(inviteeIndex),null);
    Thread.sleep(500);
    XMPPTCPConnection inviteeConnection=getConnection(inviteeIndex);
    connectAndLogin(inviteeIndex);
    assertTrue("Invitee is not online",inviteeConnection.isConnected());
    final List<String> addedEntries=new ArrayList<String>();
    Thread.sleep(200);
    Roster inviteeRoster=inviteeConnection.getRoster();
    inviteeRoster.addRosterListener(new RosterListener(){
      public void presenceChanged(      Presence presence){
      }
      public void entriesUpdated(      Collection<String> addresses){
      }
      public void entriesDeleted(      Collection<String> addresses){
      }
      public void entriesAdded(      Collection<String> addresses){
        addedEntries.addAll(addresses);
      }
    }
);
    Thread.sleep(500);
    assertNotNull("Inviter is not in roster",inviteeRoster.getEntry(getBareJID(inviterIndex)));
    assertFalse("got event for adding inviter",addedEntries.contains(getBareJID(inviterIndex)));
  }
  @Override protected void tearDown() throws Exception {
    cleanUpRoster();
    super.tearDown();
  }
  protected int getMaxConnections(){
    return 2;
  }
  protected boolean createOfflineConnections(){
    return true;
  }
  /** 
 * Clean up all the entries in the roster
 */
  private void cleanUpRoster(){
    for (int i=0; i < getMaxConnections(); i++) {
      Roster roster=getConnection(i).getRoster();
      for (      RosterEntry entry : roster.getEntries()) {
        try {
          roster.removeEntry(entry);
          Thread.sleep(100);
        }
 catch (        XMPPException e) {
          e.printStackTrace();
          fail(e.getMessage());
        }
catch (        InterruptedException e) {
        }
      }
      try {
        Thread.sleep(700);
      }
 catch (      InterruptedException e) {
        fail(e.getMessage());
      }
    }
    long initial=System.currentTimeMillis();
    while (System.currentTimeMillis() - initial < 6000 && (getConnection(0).getRoster().getEntryCount() != 0 || getConnection(1).getRoster().getEntryCount() != 0)) {
      try {
        Thread.sleep(100);
      }
 catch (      InterruptedException e) {
      }
    }
    assertEquals("Wrong number of entries in connection 0",0,getConnection(0).getRoster().getEntryCount());
    assertEquals("Wrong number of groups in connection 0",0,getConnection(0).getRoster().getGroupCount());
    assertEquals("Wrong number of entries in connection 1",0,getConnection(1).getRoster().getEntryCount());
    assertEquals("Wrong number of groups in connection 1",0,getConnection(1).getRoster().getGroupCount());
  }
}

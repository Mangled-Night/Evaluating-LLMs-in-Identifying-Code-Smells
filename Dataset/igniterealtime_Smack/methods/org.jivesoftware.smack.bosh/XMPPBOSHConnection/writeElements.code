private void writeElements(){
  writerThreadRunning=true;
  try {
    while (true) {
      TopLevelStreamElement element;
      try {
        element=outgoingQueue.take();
      }
 catch (      InterruptedException e) {
        LOGGER.log(Level.FINE,"Writer thread exiting: Outgoing queue was shutdown as signalled by interrupted exception",e);
        return;
      }
      String xmlPayload=element.toXML(BOSH_URI).toString();
      ComposableBody.Builder composableBodyBuilder=ComposableBody.builder().setPayloadXML(xmlPayload);
      if (sessionID != null) {
        BodyQName qName=BodyQName.create(BOSH_URI,"sid");
        composableBodyBuilder.setAttribute(qName,sessionID);
      }
      ComposableBody composableBody=composableBodyBuilder.build();
      try {
        client.send(composableBody);
      }
 catch (      BOSHException e) {
        LOGGER.log(Level.WARNING,this + " received BOSHException in writer thread, connection broke!",e);
        return;
      }
      if (element instanceof Stanza) {
        Stanza stanza=(Stanza)element;
        firePacketSendingListeners(stanza);
      }
    }
  }
 catch (  Exception exception) {
    LOGGER.log(Level.WARNING,"BOSH writer thread threw",exception);
  }
 finally {
    writerThreadRunning=false;
    notifyWaitingThreads();
  }
}

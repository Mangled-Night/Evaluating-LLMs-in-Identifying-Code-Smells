public class DNSUtilTest {
  private static final String igniterealtimeDomain="igniterealtime.org";
  private static final String igniterealtimeXMPPServer="xmpp." + igniterealtimeDomain;
  private static final int igniterealtimeClientPort=5222;
  private static final int igniterealtimeServerPort=5269;
  @Test public void xmppClientDomainJavaXTest(){
    DNSResolver resolver=JavaxResolver.getInstance();
    assertNotNull(resolver);
    DNSUtil.setDNSResolver(resolver);
    xmppClientDomainTest();
  }
  @Test public void xmppServerDomainJavaXTest(){
    DNSResolver resolver=JavaxResolver.getInstance();
    assertNotNull(resolver);
    DNSUtil.setDNSResolver(resolver);
    xmppServerDomainTest();
  }
  @Test public void xmppClientDomainDNSJavaTest(){
    DNSResolver resolver=DNSJavaResolver.getInstance();
    assertNotNull(resolver);
    DNSUtil.setDNSResolver(resolver);
    xmppClientDomainTest();
  }
  @Test public void xmppServerDomainDNSJavaTest(){
    DNSResolver resolver=DNSJavaResolver.getInstance();
    assertNotNull(resolver);
    DNSUtil.setDNSResolver(resolver);
    xmppServerDomainTest();
  }
  @Test public void sortSRVlowestPrioFirstTest(){
    List<HostAddress> sortedRecords=DNSUtil.sortSRVRecords(createSRVRecords());
    assertTrue(sortedRecords.get(0).getFQDN().equals("0.20.foo.bar"));
  }
  @Test public void sortSRVdistributeOverWeights(){
    int weight50=0;
    int weight20one=0;
    int weight20two=0;
    int weight10=0;
    for (int i=0; i < 1000; i++) {
      List<HostAddress> sortedRecords=DNSUtil.sortSRVRecords(createSRVRecords());
      String host=sortedRecords.get(1).getFQDN();
      if (host.equals("5.20.one.foo.bar")) {
        weight20one++;
      }
 else       if (host.equals("5.20.two.foo.bar")) {
        weight20two++;
      }
 else       if (host.equals("5.10.foo.bar")) {
        weight10++;
      }
 else       if (host.equals("5.50.foo.bar")) {
        weight50++;
      }
 else {
        fail("Wrong host after SRVRecord sorting");
      }
    }
    assertTrue(weight50 > 400 && weight50 < 600);
    assertTrue(weight20one > 100 && weight20one < 300);
    assertTrue(weight20two > 100 && weight20two < 300);
    assertTrue(weight10 > 0 && weight10 < 200);
  }
  @Test public void sortSRVdistributeZeroWeights(){
    int weightZeroOne=0;
    int weightZeroTwo=0;
    for (int i=0; i < 1000; i++) {
      List<HostAddress> sortedRecords=DNSUtil.sortSRVRecords(createSRVRecords());
      for (int j=0; j < 5; j++) {
        sortedRecords.remove(0);
      }
      String host=sortedRecords.remove(0).getFQDN();
      if (host.equals("10.0.one.foo.bar")) {
        weightZeroOne++;
      }
 else       if (host.endsWith("10.0.two.foo.bar")) {
        weightZeroTwo++;
      }
 else {
        fail("Wrong host after SRVRecord sorting");
      }
    }
    assertTrue(weightZeroOne > 400 && weightZeroOne < 600);
    assertTrue(weightZeroTwo > 400 && weightZeroTwo < 600);
  }
  private void xmppClientDomainTest(){
    List<HostAddress> hostAddresses=DNSUtil.resolveXMPPServiceDomain(igniterealtimeDomain);
    HostAddress ha=hostAddresses.get(0);
    assertEquals(ha.getFQDN(),igniterealtimeXMPPServer);
    assertEquals(ha.getPort(),igniterealtimeClientPort);
  }
  private void xmppServerDomainTest(){
    List<HostAddress> hostAddresses=DNSUtil.resolveXMPPServerDomain(igniterealtimeDomain);
    HostAddress ha=hostAddresses.get(0);
    assertEquals(ha.getFQDN(),igniterealtimeXMPPServer);
    assertEquals(ha.getPort(),igniterealtimeServerPort);
  }
  private static List<SRVRecord> createSRVRecords(){
    List<SRVRecord> records=new ArrayList<SRVRecord>();
    try {
      records.add(new SRVRecord("5.20.one.foo.bar",42,5,20));
      records.add(new SRVRecord("10.0.one.foo.bar",42,10,0));
      records.add(new SRVRecord("5.10.foo.bar",42,5,10));
      records.add(new SRVRecord("10.0.two.foo.bar",42,10,0));
      records.add(new SRVRecord("5.20.two.foo.bar",42,5,20));
      records.add(new SRVRecord("0.20.foo.bar",42,0,20));
      records.add(new SRVRecord("5.50.foo.bar",42,5,50));
    }
 catch (    IllegalArgumentException e) {
    }
    assertTrue(records.size() > 0);
    return records;
  }
}
public class DnsUtilTest {
  @SuppressWarnings("UnnecessaryAnonymousClass") private static final SmackDaneProvider DNS_UTIL_TEST_DANE_PROVIDER=new SmackDaneProvider(){
    @Override public SmackDaneVerifier newInstance(){
      throw new AssertionError();
    }
  }
;
  @Test public void daneProviderTest(){
    DNSUtil.setDaneProvider(DNS_UTIL_TEST_DANE_PROVIDER);
    SmackDaneProvider currentDaneProvider=DNSUtil.getDaneProvider();
    assertEquals(DNS_UTIL_TEST_DANE_PROVIDER,currentDaneProvider);
  }
}

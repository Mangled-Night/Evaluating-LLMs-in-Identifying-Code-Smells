public class ComponentSystemManagerTest {
  private ComponentSystemManager systemUnderTest;
  private Console console;
  @BeforeEach public void setUp(){
    Context context=mock(Context.class);
    EntityManager entityManager=mock(EntityManager.class);
    when(entityManager.getEventSystem()).thenReturn(mock(EventSystem.class));
    when(context.get(EntityManager.class)).thenReturn(entityManager);
    console=mock(Console.class);
    when(context.get(Console.class)).thenReturn(console);
    systemUnderTest=new ComponentSystemManager(context);
  }
  @Test public void testRegisterUpdateSubscriberAddsSubscriber(){
    UpdateSubscriberSystem system=mock(UpdateSubscriberSystem.class);
    systemUnderTest.register(system);
    assertEquals(Iterables.size(systemUnderTest.iterateUpdateSubscribers()),1);
  }
  @Test public void testShutdownRemovesUpdateSubscribers(){
    UpdateSubscriberSystem system=mock(UpdateSubscriberSystem.class);
    systemUnderTest.register(system);
    systemUnderTest.shutdown();
    assertEquals(Iterables.size(systemUnderTest.iterateUpdateSubscribers()),0);
  }
  @Test public void testRegisterRenderSystemAddsRenderSubscriber(){
    RenderSystem system=mock(RenderSystem.class);
    systemUnderTest.register(system);
    assertEquals(Iterables.size(systemUnderTest.iterateRenderSubscribers()),1);
  }
  @Test public void testShutdownRemovesRenderSubscribers(){
    RenderSystem system=mock(RenderSystem.class);
    systemUnderTest.register(system);
    systemUnderTest.shutdown();
    assertEquals(Iterables.size(systemUnderTest.iterateRenderSubscribers()),0);
  }
  @Test public void shouldRegisterCommand(){
    systemUnderTest.register(new SystemWithValidCommand());
    systemUnderTest.initialise();
    ArgumentCaptor<MethodCommand> methodCommandArgumentCaptor=ArgumentCaptor.forClass(MethodCommand.class);
    verify(console).registerCommand(methodCommandArgumentCaptor.capture());
    MethodCommand command=methodCommandArgumentCaptor.getValue();
    assertEquals(command.getName().toString(),"validCommandName");
  }
  @Test public void shouldRegisterCommandWithoutSenderAnnotation(){
    systemUnderTest.register(new SystemWithCommandMissingSenderAnnotation());
    systemUnderTest.initialise();
    ArgumentCaptor<MethodCommand> methodCommandArgumentCaptor=ArgumentCaptor.forClass(MethodCommand.class);
    verify(console).registerCommand(methodCommandArgumentCaptor.capture());
    MethodCommand command=methodCommandArgumentCaptor.getValue();
    assertEquals(command.getName().toString(),"commandWithoutSenderAnnotation");
  }
  @Test public void shouldLogErrorWhenRegisterCommandWithoutSenderAnnotation(){
    Appender<ILoggingEvent> appender=mockAppender();
    ((ch.qos.logback.classic.Logger)LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME)).addAppender(appender);
    systemUnderTest.register(new SystemWithCommandMissingSenderAnnotation());
    systemUnderTest.initialise();
    ArgumentCaptor<LoggingEvent> loggingEventArgumentCaptor=ArgumentCaptor.forClass(LoggingEvent.class);
    verify(appender).doAppend(loggingEventArgumentCaptor.capture());
    List<String> allErrorLogMessages=loggingEventArgumentCaptor.getAllValues().stream().filter(e -> e.getLevel().isGreaterOrEqual(Level.ERROR)).map(LoggingEvent::getFormattedMessage).collect(toList());
    String expectedMessage="Command commandWithoutSenderAnnotation provided by " + "SystemWithCommandMissingSenderAnnotation contains a EntityRef without @Sender annotation, " + "may cause a NullPointerException";
    assertTrue(allErrorLogMessages.contains(expectedMessage));
  }
  @SuppressWarnings("unchecked") private static Appender<ILoggingEvent> mockAppender(){
    return mock(Appender.class);
  }
private static class SystemWithValidCommand extends BaseComponentSystem {
    @Command public String validCommandName(    @CommandParam(value="parameter") String value,    @Sender EntityRef sender){
      return value;
    }
  }
private static class SystemWithCommandMissingSenderAnnotation extends BaseComponentSystem {
    @Command public String commandWithoutSenderAnnotation(    @CommandParam(value="parameter") String value,    EntityRef sender){
      return value;
    }
  }
}

/** 
 * 命令结果模型辅助类
 * @author gongdewei 2020/5/18
 */
public class ResultConsumerHelper {
  private static final Logger logger=LoggerFactory.getLogger(ResultConsumerHelper.class);
  private static ConcurrentHashMap<String,List<Field>> modelFieldMap=new ConcurrentHashMap<String,List<Field>>();
  /** 
 * 估算命令执行结果的item数量，目的是提供一个度量值，作为Consumer分发时进行切片的参考依据，避免单次发送大量数据。 注意：此方法调用频繁，避免产生内存碎片
 * @param model
 * @return
 */
  public static int getItemCount(  ResultModel model){
    if (model instanceof Countable) {
      return ((Countable)model).size();
    }
    Class modelClass=model.getClass();
    List<Field> fields=modelFieldMap.get(modelClass.getName());
    if (fields == null) {
      fields=new ArrayList<Field>();
      Field[] declaredFields=modelClass.getDeclaredFields();
      for (int i=0; i < declaredFields.length; i++) {
        Field field=declaredFields[i];
        Class<?> fieldClass=field.getType();
        if (Collection.class.isAssignableFrom(fieldClass) || Map.class.isAssignableFrom(fieldClass) || Countable.class.isAssignableFrom(fieldClass)|| fieldClass.isArray()) {
          field.setAccessible(true);
          fields.add(field);
        }
      }
      List<Field> old_fields=modelFieldMap.putIfAbsent(modelClass.getName(),fields);
      if (old_fields != null) {
        fields=old_fields;
      }
    }
    int count=0;
    try {
      for (int i=0; i < fields.size(); i++) {
        Field field=fields.get(i);
        if (!field.isAccessible()) {
          field.setAccessible(true);
        }
        Object value=field.get(model);
        if (value != null) {
          if (value instanceof Collection) {
            count+=((Collection)value).size();
          }
 else           if (value.getClass().isArray()) {
            count+=Array.getLength(value);
          }
 else           if (value instanceof Map) {
            count+=((Map)value).size();
          }
 else           if (value instanceof Countable) {
            count+=((Countable)value).size();
          }
        }
      }
    }
 catch (    Exception e) {
      logger.error("get item count of result model failed, model: {}",JSON.toJSONString(model),e);
    }
    return count > 0 ? count : 1;
  }
}

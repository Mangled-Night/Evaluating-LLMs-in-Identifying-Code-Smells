public class ZKUtils {
  private static final Logger LOGGER=LoggerFactory.getLogger(ZKUtils.class);
  static CuratorFramework curatorFramework=null;
  static ConcurrentMap<String,PathChildrenCache> watchMap=new ConcurrentHashMap<>();
static {
    curatorFramework=createConnection();
    Runtime.getRuntime().addShutdownHook(new Thread(new Runnable(){
      @Override public void run(){
        if (curatorFramework != null)         curatorFramework.close();
        watchMap.clear();
      }
    }
));
  }
  public static String getZKBasePath(){
    String clasterID=ZkConfig.getInstance().getValue(ZkParamCfg.ZK_CFG_CLUSTERID);
    return "/mycat/" + clasterID + "/";
  }
  public static CuratorFramework getConnection(){
    return curatorFramework;
  }
  private static CuratorFramework createConnection(){
    String url=ZkConfig.getInstance().getZkURL();
    CuratorFramework curatorFramework=CuratorFrameworkFactory.newClient(url,new ExponentialBackoffRetry(100,6));
    curatorFramework.start();
    try {
      curatorFramework.blockUntilConnected(3,TimeUnit.SECONDS);
      if (curatorFramework.getZookeeperClient().isConnected()) {
        return curatorFramework;
      }
    }
 catch (    InterruptedException ignored) {
      Thread.currentThread().interrupt();
    }
    curatorFramework.close();
    throw new RuntimeException("failed to connect to zookeeper service : " + url);
  }
  public static void closeWatch(  List<String> watchs){
    for (    String watch : watchs) {
      closeWatch(watch);
    }
  }
  public static void closeWatch(  String path){
    PathChildrenCache childrenCache=watchMap.get(path);
    if (childrenCache != null) {
      try {
        childrenCache.close();
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
    }
  }
  public static void addChildPathCache(  String path,  PathChildrenCacheListener listener){
    NameableExecutor businessExecutor=MycatServer.getInstance().getBusinessExecutor();
    ExecutorService executor=businessExecutor == null ? Executors.newFixedThreadPool(5) : businessExecutor;
    try {
      final PathChildrenCache childrenCache=new PathChildrenCache(getConnection(),path,true);
      childrenCache.start(PathChildrenCache.StartMode.POST_INITIALIZED_EVENT);
      childrenCache.getListenable().addListener(listener,executor);
      watchMap.put(path,childrenCache);
    }
 catch (    Exception e) {
      throw new RuntimeException(e);
    }
  }
  public static boolean writeProperty(  String path,  Map<String,String> propertyMap) throws Exception {
    CuratorFramework client=ZKUtils.getConnection();
    Properties properties=new Properties();
    ByteArrayOutputStream out=new ByteArrayOutputStream();
    if (client.checkExists().forPath(path) == null) {
      for (      String key : propertyMap.keySet()) {
        properties.setProperty(key,propertyMap.get(key));
      }
      properties.store(out,"add");
      client.create().creatingParentsIfNeeded().forPath(path,out.toByteArray());
      return true;
    }
 else {
      byte[] data=client.getData().forPath(path);
      properties.load(new ByteArrayInputStream(data));
      boolean isUpdate=false;
      for (      String key : propertyMap.keySet()) {
        String value=propertyMap.get(key);
        if (!String.valueOf(value).equals(properties.getProperty(key))) {
          properties.setProperty(key,String.valueOf(value));
          isUpdate=true;
        }
      }
      properties.store(out,"update");
      if (isUpdate) {
        client.setData().forPath(path,out.toByteArray());
        return true;
      }
      return false;
    }
  }
  public static void createPath(  String path,  String data){
    CuratorFramework client=ZKUtils.getConnection();
    try {
      if (client.checkExists().forPath(path) == null) {
        client.create().creatingParentsIfNeeded().forPath(path,data.getBytes());
      }
 else {
        client.setData().forPath(path,data.getBytes());
      }
    }
 catch (    Exception e) {
      System.out.println("放置数据失败");
      e.printStackTrace();
    }
  }
  public static String getDnIndexPath(){
    return ZKUtils.getZKBasePath() + "bindata/dnindex.properties";
  }
}

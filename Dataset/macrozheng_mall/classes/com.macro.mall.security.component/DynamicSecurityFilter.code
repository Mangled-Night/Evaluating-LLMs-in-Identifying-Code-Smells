/** 
 * 动态权限过滤器，用于实现基于路径的动态权限过滤 Created by macro on 2020/2/7.
 */
public class DynamicSecurityFilter extends AbstractSecurityInterceptor implements Filter {
  @Autowired private DynamicSecurityMetadataSource dynamicSecurityMetadataSource;
  @Autowired private IgnoreUrlsConfig ignoreUrlsConfig;
  @Autowired public void setMyAccessDecisionManager(  DynamicAccessDecisionManager dynamicAccessDecisionManager){
    super.setAccessDecisionManager(dynamicAccessDecisionManager);
  }
  @Override public void init(  FilterConfig filterConfig) throws ServletException {
  }
  @Override public void doFilter(  ServletRequest servletRequest,  ServletResponse servletResponse,  FilterChain filterChain) throws IOException, ServletException {
    HttpServletRequest request=(HttpServletRequest)servletRequest;
    FilterInvocation fi=new FilterInvocation(servletRequest,servletResponse,filterChain);
    if (request.getMethod().equals(HttpMethod.OPTIONS.toString())) {
      fi.getChain().doFilter(fi.getRequest(),fi.getResponse());
      return;
    }
    PathMatcher pathMatcher=new AntPathMatcher();
    for (    String path : ignoreUrlsConfig.getUrls()) {
      if (pathMatcher.match(path,request.getRequestURI())) {
        fi.getChain().doFilter(fi.getRequest(),fi.getResponse());
        return;
      }
    }
    InterceptorStatusToken token=super.beforeInvocation(fi);
    try {
      fi.getChain().doFilter(fi.getRequest(),fi.getResponse());
    }
  finally {
      super.afterInvocation(token,null);
    }
  }
  @Override public void destroy(){
  }
  @Override public Class<?> getSecureObjectClass(){
    return FilterInvocation.class;
  }
  @Override public SecurityMetadataSource obtainSecurityMetadataSource(){
    return dynamicSecurityMetadataSource;
  }
}

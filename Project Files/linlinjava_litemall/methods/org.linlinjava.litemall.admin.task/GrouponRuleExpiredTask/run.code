@Override public void run(){
  logger.info("系统开始处理延时任务---团购规则过期---" + this.grouponRuleId);
  LitemallOrderService orderService=BeanUtil.getBean(LitemallOrderService.class);
  LitemallGrouponService grouponService=BeanUtil.getBean(LitemallGrouponService.class);
  LitemallGrouponRulesService grouponRulesService=BeanUtil.getBean(LitemallGrouponRulesService.class);
  LitemallGrouponRules grouponRules=grouponRulesService.findById(grouponRuleId);
  if (grouponRules == null) {
    return;
  }
  if (!grouponRules.getStatus().equals(GrouponConstant.RULE_STATUS_ON)) {
    return;
  }
  grouponRules.setStatus(GrouponConstant.RULE_STATUS_DOWN_EXPIRE);
  grouponRulesService.updateById(grouponRules);
  List<LitemallGroupon> grouponList=grouponService.queryByRuleId(grouponRuleId);
  for (  LitemallGroupon groupon : grouponList) {
    Short status=groupon.getStatus();
    LitemallOrder order=orderService.findById(groupon.getOrderId());
    if (status.equals(GrouponConstant.STATUS_NONE)) {
      groupon.setStatus(GrouponConstant.STATUS_FAIL);
      grouponService.updateById(groupon);
    }
 else     if (status.equals(GrouponConstant.STATUS_ON)) {
      groupon.setStatus(GrouponConstant.STATUS_FAIL);
      grouponService.updateById(groupon);
      if (OrderUtil.isPayStatus(order)) {
        order.setOrderStatus(OrderUtil.STATUS_REFUND);
        orderService.updateWithOptimisticLocker(order);
      }
    }
  }
  logger.info("系统结束处理延时任务---团购规则过期---" + this.grouponRuleId);
}

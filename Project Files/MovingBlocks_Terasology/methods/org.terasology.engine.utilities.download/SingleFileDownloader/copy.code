/** 
 * Reads all bytes from an input stream and writes them to an output stream. Copied and adapted from Files.copy().
 */
private static long copy(InputStream source,OutputStream sink,long max,SingleFileTransferProgressListener listener) throws IOException {
  long nread=0L;
  int bufferSize=0x10000;
  byte[] buf=new byte[bufferSize];
  int n;
  while ((n=source.read(buf)) > 0) {
    sink.write(buf,0,n);
    nread+=n;
    if (max <= 0) {
      listener.onProgress(0,max);
    }
 else {
      listener.onProgress(nread,max);
    }
  }
  return nread;
}

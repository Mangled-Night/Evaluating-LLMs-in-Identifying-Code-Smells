public class DDLRouteTest {
  protected Map<String,SchemaConfig> schemaMap;
  protected LayerCachePool cachePool=new SimpleCachePool();
  protected RouteStrategy routeStrategy;
  public DDLRouteTest(){
    String schemaFile="/route/schema.xml";
    String ruleFile="/route/rule.xml";
    SchemaLoader schemaLoader=new XMLSchemaLoader(schemaFile,ruleFile);
    schemaMap=schemaLoader.getSchemas();
    MycatServer.getInstance().getConfig().getSchemas().putAll(schemaMap);
    MycatServer.getInstance().getConfig().getSystem().setUseGlobleTableCheck(0);
    RouteStrategyFactory.init();
    routeStrategy=RouteStrategyFactory.getRouteStrategy("druidparser");
  }
  @Test public void testSpecialCharDDL() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    CacheService cacheService=new CacheService();
    RouteService routerService=new RouteService(cacheService);
    String sql=" ALTER TABLE COMPANY\r\nADD COLUMN TEST  VARCHAR(255) NULL AFTER CREATE_DATE,\r\n CHARACTER SET = UTF8";
    sql=RouterUtil.getFixedSql(sql);
    List<String> dataNodes=new ArrayList<>();
    String tablename=RouterUtil.getTableName(sql,RouterUtil.getAlterTablePos(sql,0));
    Map<String,TableConfig> tables=schema.getTables();
    TableConfig tc;
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    int nodeSize=dataNodes.size();
    int rs=ServerParse.parse(sql);
    int sqlType=rs & 0xff;
    RouteResultset rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
  }
  /** 
 * ddl deal test
 * @throws Exception
 */
  @Test public void testDDL() throws Exception {
    SchemaConfig schema=schemaMap.get("TESTDB");
    CacheService cacheService=new CacheService();
    RouteService routerService=new RouteService(cacheService);
    String sql=" create table company(idd int)";
    sql=RouterUtil.getFixedSql(sql);
    String upsql=sql.toUpperCase();
    String tablename=RouterUtil.getTableName(sql,RouterUtil.getCreateTablePos(upsql,0));
    tablename=tablename.toUpperCase();
    List<String> dataNodes=new ArrayList<>();
    Map<String,TableConfig> tables=schema.getTables();
    TableConfig tc;
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    int nodeSize=dataNodes.size();
    int rs=ServerParse.parse(sql);
    int sqlType=rs & 0xff;
    RouteResultset rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
    sql=" drop table COMPANY";
    sql=RouterUtil.getFixedSql(sql);
    upsql=sql.toUpperCase();
    tablename=RouterUtil.getTableName(sql,RouterUtil.getDropTablePos(upsql,0));
    tables=schema.getTables();
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    nodeSize=dataNodes.size();
    rs=ServerParse.parse(sql);
    sqlType=rs & 0xff;
    rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
    sql="   alter table COMPANY add COLUMN name int ;";
    sql=RouterUtil.getFixedSql(sql);
    upsql=sql.toUpperCase();
    tablename=RouterUtil.getTableName(sql,RouterUtil.getAlterTablePos(upsql,0));
    tables=schema.getTables();
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    nodeSize=dataNodes.size();
    rs=ServerParse.parse(sql);
    sqlType=rs & 0xff;
    rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
    sql=" truncate table COMPANY";
    sql=RouterUtil.getFixedSql(sql);
    upsql=sql.toUpperCase();
    tablename=RouterUtil.getTableName(sql,RouterUtil.getTruncateTablePos(upsql,0));
    tables=schema.getTables();
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    nodeSize=dataNodes.size();
    rs=ServerParse.parse(sql);
    sqlType=rs & 0xff;
    rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
  }
  @Test public void testDDLDefaultNode() throws Exception {
    SchemaConfig schema=schemaMap.get("solo1");
    CacheService cacheService=new CacheService();
    RouteService routerService=new RouteService(cacheService);
    String sql=" create table company(idd int)";
    sql=RouterUtil.getFixedSql(sql);
    String upsql=sql.toUpperCase();
    String tablename=RouterUtil.getTableName(sql,RouterUtil.getCreateTablePos(upsql,0));
    tablename=tablename.toUpperCase();
    List<String> dataNodes=new ArrayList<>();
    Map<String,TableConfig> tables=schema.getTables();
    TableConfig tc;
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    int nodeSize=dataNodes.size();
    if (nodeSize == 0 && schema.getDataNode() != null) {
      nodeSize=1;
    }
    int rs=ServerParse.parse(sql);
    int sqlType=rs & 0xff;
    RouteResultset rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
    sql=" drop table COMPANY";
    sql=RouterUtil.getFixedSql(sql);
    upsql=sql.toUpperCase();
    tablename=RouterUtil.getTableName(sql,RouterUtil.getDropTablePos(upsql,0));
    tables=schema.getTables();
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    nodeSize=dataNodes.size();
    if (nodeSize == 0 && schema.getDataNode() != null) {
      nodeSize=1;
    }
    rs=ServerParse.parse(sql);
    sqlType=rs & 0xff;
    rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
    sql=" drop table if exists COMPANY";
    sql=RouterUtil.getFixedSql(sql);
    upsql=sql.toUpperCase();
    tablename=RouterUtil.getTableName(sql,RouterUtil.getDropTablePos(upsql,0));
    tables=schema.getTables();
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    nodeSize=dataNodes.size();
    if (nodeSize == 0 && schema.getDataNode() != null) {
      nodeSize=1;
    }
    rs=ServerParse.parse(sql);
    sqlType=rs & 0xff;
    rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
    sql="   alter table COMPANY add COLUMN name int ;";
    sql=RouterUtil.getFixedSql(sql);
    upsql=sql.toUpperCase();
    tablename=RouterUtil.getTableName(sql,RouterUtil.getAlterTablePos(upsql,0));
    tables=schema.getTables();
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    nodeSize=dataNodes.size();
    if (nodeSize == 0 && schema.getDataNode() != null) {
      nodeSize=1;
    }
    rs=ServerParse.parse(sql);
    sqlType=rs & 0xff;
    rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
    sql=" truncate table COMPANY";
    sql=RouterUtil.getFixedSql(sql);
    upsql=sql.toUpperCase();
    tablename=RouterUtil.getTableName(sql,RouterUtil.getTruncateTablePos(upsql,0));
    tables=schema.getTables();
    if (tables != null && (tc=tables.get(tablename)) != null) {
      dataNodes=tc.getDataNodes();
    }
    nodeSize=dataNodes.size();
    if (nodeSize == 0 && schema.getDataNode() != null) {
      nodeSize=1;
    }
    rs=ServerParse.parse(sql);
    sqlType=rs & 0xff;
    rrs=routerService.route(new SystemConfig(),schema,sqlType,sql,"UTF-8",null);
    Assert.assertTrue("COMPANY".equals(tablename));
    Assert.assertTrue(rrs.getNodes().length == nodeSize);
  }
}

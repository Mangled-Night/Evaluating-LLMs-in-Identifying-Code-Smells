/** 
 * 立即购买 <p> 和add方法的区别在于： 1. 如果购物车内已经存在购物车货品，前者的逻辑是数量添加，这里的逻辑是数量覆盖 2. 添加成功以后，前者的逻辑是返回当前购物车商品数量，这里的逻辑是返回对应购物车项的ID
 * @param userId 用户ID
 * @param cart   购物车商品信息， { goodsId: xxx, productId: xxx, number: xxx }
 * @return 立即购买操作结果
 */
@PostMapping("fastadd") public Object fastadd(@LoginUser Integer userId,@RequestBody LitemallCart cart){
  if (userId == null) {
    return ResponseUtil.unlogin();
  }
  if (cart == null) {
    return ResponseUtil.badArgument();
  }
  Integer productId=cart.getProductId();
  Integer number=cart.getNumber().intValue();
  Integer goodsId=cart.getGoodsId();
  if (!ObjectUtils.allNotNull(productId,number,goodsId)) {
    return ResponseUtil.badArgument();
  }
  if (number <= 0) {
    return ResponseUtil.badArgument();
  }
  LitemallGoods goods=goodsService.findById(goodsId);
  if (goods == null || !goods.getIsOnSale()) {
    return ResponseUtil.fail(GOODS_UNSHELVE,"商品已下架");
  }
  LitemallGoodsProduct product=productService.findById(productId);
  LitemallCart existCart=cartService.queryExist(goodsId,productId,userId);
  if (existCart == null) {
    if (product == null || number > product.getNumber()) {
      return ResponseUtil.fail(GOODS_NO_STOCK,"库存不足");
    }
    cart.setId(null);
    cart.setGoodsSn(goods.getGoodsSn());
    cart.setGoodsName((goods.getName()));
    if (StringUtils.isEmpty(product.getUrl())) {
      cart.setPicUrl(goods.getPicUrl());
    }
 else {
      cart.setPicUrl(product.getUrl());
    }
    cart.setPrice(product.getPrice());
    cart.setSpecifications(product.getSpecifications());
    cart.setUserId(userId);
    cart.setChecked(true);
    cartService.add(cart);
  }
 else {
    int num=number;
    if (num > product.getNumber()) {
      return ResponseUtil.fail(GOODS_NO_STOCK,"库存不足");
    }
    existCart.setNumber((short)num);
    if (cartService.updateById(existCart) == 0) {
      return ResponseUtil.updatedDataFailed();
    }
  }
  return ResponseUtil.ok(existCart != null ? existCart.getId() : cart.getId());
}

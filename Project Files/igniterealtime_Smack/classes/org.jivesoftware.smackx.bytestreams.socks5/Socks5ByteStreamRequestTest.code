/** 
 * Tests for the Socks5BytestreamRequest class.
 * @author Henning Staib
 */
public class Socks5ByteStreamRequestTest {
  private static final EntityFullJid initiatorJID=JidTestUtil.DUMMY_AT_EXAMPLE_ORG_SLASH_DUMMYRESOURCE;
  private static final EntityFullJid targetJID=JidTestUtil.FULL_JID_1_RESOURCE_1;
  private static final DomainBareJid proxyJID=JidTestUtil.MUC_EXAMPLE_ORG;
  private static final String proxyAddress="127.0.0.1";
  private static final String sessionID="session_id";
  /** 
 * Accepting a SOCKS5 Bytestream request should fail if the request doesn't contain any Socks5 proxies.
 * @throws Exception should not happen
 */
  @Test public void shouldFailIfRequestHasNoStreamHosts() throws Exception {
    final Protocol protocol=new Protocol();
    final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,targetJID);
    assertThrows(Socks5Exception.NoSocks5StreamHostsProvided.class,() -> {
      Bytestream bytestreamInitialization=Socks5PacketUtils.createBytestreamInitiation(initiatorJID,targetJID,sessionID);
      Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
      Socks5BytestreamRequest byteStreamRequest=new Socks5BytestreamRequest(byteStreamManager,bytestreamInitialization);
      byteStreamRequest.accept();
    }
);
    assertEquals(1,protocol.getRequests().size());
    Stanza targetResponse=protocol.getRequests().remove(0);
    assertTrue(IQ.class.isInstance(targetResponse));
    assertEquals(initiatorJID,targetResponse.getTo());
    assertEquals(IQ.Type.error,((IQ)targetResponse).getType());
    assertEquals(StanzaError.Condition.item_not_found,targetResponse.getError().getCondition());
  }
  /** 
 * Accepting a SOCKS5 Bytestream request should fail if target is not able to connect to any of the provided SOCKS5 proxies.
 * @throws Exception if an exception occurs.
 */
  @Test public void shouldFailIfRequestHasInvalidStreamHosts() throws Exception {
    final Protocol protocol=new Protocol();
    final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,targetJID);
    assertThrows(Socks5Exception.CouldNotConnectToAnyProvidedSocks5Host.class,() -> {
      Bytestream bytestreamInitialization=Socks5PacketUtils.createBytestreamInitiation(initiatorJID,targetJID,sessionID);
      bytestreamInitialization.addStreamHost(proxyJID,proxyAddress,7778);
      Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
      Socks5BytestreamRequest byteStreamRequest=new Socks5BytestreamRequest(byteStreamManager,bytestreamInitialization);
      byteStreamRequest.accept();
    }
);
    assertEquals(1,protocol.getRequests().size());
    Stanza targetResponse=protocol.getRequests().remove(0);
    assertTrue(IQ.class.isInstance(targetResponse));
    assertEquals(initiatorJID,targetResponse.getTo());
    assertEquals(IQ.Type.error,((IQ)targetResponse).getType());
    assertEquals(StanzaError.Condition.item_not_found,targetResponse.getError().getCondition());
  }
  /** 
 * Target should not try to connect to SOCKS5 proxies that already failed twice.
 * @throws Exception should not happen
 */
  @Test public void shouldBlacklistInvalidProxyAfter2Failures() throws Exception {
    final Protocol protocol=new Protocol();
    final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,targetJID);
    Bytestream bytestreamInitialization=Socks5PacketUtils.createBytestreamInitiation(initiatorJID,targetJID,sessionID);
    bytestreamInitialization.addStreamHost(JidCreate.from("invalid." + proxyJID),"127.0.0.2",7778);
    Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
    for (int i=0; i < 2; i++) {
      assertThrows(Socks5Exception.CouldNotConnectToAnyProvidedSocks5Host.class,() -> {
        Socks5BytestreamRequest byteStreamRequest=new Socks5BytestreamRequest(byteStreamManager,bytestreamInitialization);
        byteStreamRequest.setTotalConnectTimeout(600);
        byteStreamRequest.setMinimumConnectTimeout(300);
        byteStreamRequest.accept();
      }
);
      assertEquals(1,protocol.getRequests().size());
      Stanza targetResponse=protocol.getRequests().remove(0);
      assertTrue(IQ.class.isInstance(targetResponse));
      assertEquals(initiatorJID,targetResponse.getTo());
      assertEquals(IQ.Type.error,((IQ)targetResponse).getType());
      assertEquals(StanzaError.Condition.item_not_found,targetResponse.getError().getCondition());
    }
    byte[] data=new byte[]{1,2,3};
    try (Socks5TestProxy socks5Proxy=new Socks5TestProxy()){
      assertTrue(socks5Proxy.isRunning());
      bytestreamInitialization.addStreamHost(proxyJID,proxyAddress,socks5Proxy.getPort());
      Socks5BytestreamRequest byteStreamRequest=new Socks5BytestreamRequest(byteStreamManager,bytestreamInitialization);
      byteStreamRequest.setTotalConnectTimeout(600);
      byteStreamRequest.setMinimumConnectTimeout(300);
      InputStream inputStream=byteStreamRequest.accept().getInputStream();
      String digest=Socks5Utils.createDigest(sessionID,initiatorJID,targetJID);
      OutputStream outputStream=socks5Proxy.getSocket(digest).getOutputStream();
      outputStream.write(data);
      byte[] result=new byte[3];
      inputStream.read(result);
      assertArrayEquals(data,result);
      assertEquals(1,protocol.getRequests().size());
      Stanza targetResponse=protocol.getRequests().remove(0);
      assertEquals(Bytestream.class,targetResponse.getClass());
      assertEquals(initiatorJID,targetResponse.getTo());
      assertEquals(IQ.Type.result,((Bytestream)targetResponse).getType());
      assertEquals(proxyJID,((Bytestream)targetResponse).getUsedHost().getJID());
    }
   }
  /** 
 * Target should not not blacklist any SOCKS5 proxies regardless of failing connections.
 * @throws Exception should not happen
 */
  @Test public void shouldNotBlacklistInvalidProxy() throws Exception {
    final Protocol protocol=new Protocol();
    final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,targetJID);
    Bytestream bytestreamInitialization=Socks5PacketUtils.createBytestreamInitiation(initiatorJID,targetJID,sessionID);
    bytestreamInitialization.addStreamHost(JidCreate.from("invalid." + proxyJID),"127.0.0.2",7778);
    Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
    for (int i=0; i < 10; i++) {
      assertThrows(Socks5Exception.CouldNotConnectToAnyProvidedSocks5Host.class,() -> {
        Socks5BytestreamRequest byteStreamRequest=new Socks5BytestreamRequest(byteStreamManager,bytestreamInitialization);
        byteStreamRequest.setTotalConnectTimeout(600);
        byteStreamRequest.setMinimumConnectTimeout(300);
        byteStreamRequest.setConnectFailureThreshold(0);
        byteStreamRequest.accept();
      }
);
      assertEquals(1,protocol.getRequests().size());
      Stanza targetResponse=protocol.getRequests().remove(0);
      assertTrue(IQ.class.isInstance(targetResponse));
      assertEquals(initiatorJID,targetResponse.getTo());
      assertEquals(IQ.Type.error,((IQ)targetResponse).getType());
      assertEquals(StanzaError.Condition.item_not_found,targetResponse.getError().getCondition());
    }
  }
  /** 
 * If the SOCKS5 Bytestream request contains multiple SOCKS5 proxies and the first one doesn't respond, the connection attempt to this proxy should not consume the whole timeout for connecting to the proxies.
 * @throws Exception should not happen
 */
  @Test public void shouldNotTimeoutIfFirstSocks5ProxyDoesNotRespond() throws Exception {
    final Protocol protocol=new Protocol();
    final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,targetJID);
    try (Socks5TestProxy socks5Proxy=new Socks5TestProxy()){
      ServerSocket unresponsiveSocks5Socket=NetworkUtil.getSocketOnLoopback();
      try {
        Bytestream bytestreamInitialization=Socks5PacketUtils.createBytestreamInitiation(initiatorJID,targetJID,sessionID);
        bytestreamInitialization.addStreamHost(proxyJID,proxyAddress,unresponsiveSocks5Socket.getLocalPort());
        bytestreamInitialization.addStreamHost(proxyJID,proxyAddress,socks5Proxy.getPort());
        byte[] data=new byte[]{1,2,3};
        Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
        Socks5BytestreamRequest byteStreamRequest=new Socks5BytestreamRequest(byteStreamManager,bytestreamInitialization);
        byteStreamRequest.setTotalConnectTimeout(2000);
        byteStreamRequest.setMinimumConnectTimeout(1000);
        InputStream inputStream=byteStreamRequest.accept().getInputStream();
        Socket socket=unresponsiveSocks5Socket.accept();
        assertNotNull(socket);
        String digest=Socks5Utils.createDigest(sessionID,initiatorJID,targetJID);
        OutputStream outputStream=socks5Proxy.getSocket(digest).getOutputStream();
        outputStream.write(data);
        byte[] result=new byte[3];
        inputStream.read(result);
        assertArrayEquals(data,result);
        assertEquals(1,protocol.getRequests().size());
        Stanza targetResponse=protocol.getRequests().remove(0);
        assertEquals(Bytestream.class,targetResponse.getClass());
        assertEquals(initiatorJID,targetResponse.getTo());
        assertEquals(IQ.Type.result,((Bytestream)targetResponse).getType());
        assertEquals(proxyJID,((Bytestream)targetResponse).getUsedHost().getJID());
      }
  finally {
        unresponsiveSocks5Socket.close();
      }
    }
   }
  /** 
 * Accepting the SOCKS5 Bytestream request should be successfully.
 * @throws Exception should not happen
 */
  @Test public void shouldAcceptSocks5BytestreamRequestAndReceiveData() throws Exception {
    final Protocol protocol=new Protocol();
    final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,targetJID);
    try (Socks5TestProxy socks5Proxy=new Socks5TestProxy()){
      Bytestream bytestreamInitialization=Socks5PacketUtils.createBytestreamInitiation(initiatorJID,targetJID,sessionID);
      bytestreamInitialization.addStreamHost(proxyJID,proxyAddress,socks5Proxy.getPort());
      byte[] data=new byte[]{1,2,3};
      Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
      Socks5BytestreamRequest byteStreamRequest=new Socks5BytestreamRequest(byteStreamManager,bytestreamInitialization);
      InputStream inputStream=byteStreamRequest.accept().getInputStream();
      String digest=Socks5Utils.createDigest(sessionID,initiatorJID,targetJID);
      OutputStream outputStream=socks5Proxy.getSocket(digest).getOutputStream();
      outputStream.write(data);
      byte[] result=new byte[3];
      inputStream.read(result);
      assertArrayEquals(data,result);
      assertEquals(1,protocol.getRequests().size());
      Stanza targetResponse=protocol.getRequests().remove(0);
      assertEquals(Bytestream.class,targetResponse.getClass());
      assertEquals(initiatorJID,targetResponse.getTo());
      assertEquals(IQ.Type.result,((Bytestream)targetResponse).getType());
      assertEquals(proxyJID,((Bytestream)targetResponse).getUsedHost().getJID());
    }
   }
}

/** 
 * Created by zagnix on 2016/6/19.
 */
public class UnsafeExternalRowSorterTest {
  private static final int TEST_SIZE=100000;
  public static final Logger LOGGER=LoggerFactory.getLogger(UnsafeExternalRowSorterTest.class);
  /** 
 * 测试类型 LONG，INT，SHORT,Float，Double，String，Binary 经测试基数排序可以适用上述数据类型，大大提高排序速度
 */
  @Test public void testUnsafeExternalRowSorter() throws NoSuchFieldException, IllegalAccessException, IOException {
    MyCatMemory myCatMemory=new MyCatMemory();
    MemoryManager memoryManager=myCatMemory.getResultMergeMemoryManager();
    DataNodeDiskManager blockManager=myCatMemory.getBlockManager();
    SerializerManager serializerManager=myCatMemory.getSerializerManager();
    MycatPropertyConf conf=myCatMemory.getConf();
    DataNodeMemoryManager dataNodeMemoryManager=new DataNodeMemoryManager(memoryManager,Thread.currentThread().getId());
    int fieldCount=3;
    ColMeta colMeta=null;
    Map<String,ColMeta> colMetaMap=new HashMap<String,ColMeta>(fieldCount);
    colMeta=new ColMeta(0,ColMeta.COL_TYPE_STRING);
    colMetaMap.put("id",colMeta);
    colMeta=new ColMeta(1,ColMeta.COL_TYPE_STRING);
    colMetaMap.put("name",colMeta);
    colMeta=new ColMeta(2,ColMeta.COL_TYPE_STRING);
    colMetaMap.put("age",colMeta);
    OrderCol[] orderCols=new OrderCol[1];
    OrderCol orderCol=new OrderCol(colMetaMap.get("id"),OrderCol.COL_ORDER_TYPE_ASC);
    orderCols[0]=orderCol;
    StructType schema=new StructType(colMetaMap,fieldCount);
    schema.setOrderCols(orderCols);
    UnsafeExternalRowSorter.PrefixComputer prefixComputer=new RowPrefixComputer(schema);
    final PrefixComparator prefixComparator=PrefixComparators.LONG;
    UnsafeExternalRowSorter sorter=new UnsafeExternalRowSorter(dataNodeMemoryManager,myCatMemory,schema,prefixComparator,prefixComputer,conf.getSizeAsBytes("mycat.buffer.pageSize","1m"),true,true);
    UnsafeRow unsafeRow;
    BufferHolder bufferHolder;
    UnsafeRowWriter unsafeRowWriter;
    String line="testUnsafeRow";
    List<Long> longs=new ArrayList<Long>();
    final Random rand=new Random(42);
    for (int i=0; i < TEST_SIZE; i++) {
      unsafeRow=new UnsafeRow(3);
      bufferHolder=new BufferHolder(unsafeRow);
      unsafeRowWriter=new UnsafeRowWriter(bufferHolder,3);
      bufferHolder.reset();
      String key=getRandomString(rand.nextInt(300) + 100);
      unsafeRowWriter.write(0,key.getBytes());
      unsafeRowWriter.write(1,line.getBytes());
      unsafeRowWriter.write(2,("35" + 1).getBytes());
      unsafeRow.setTotalSize(bufferHolder.totalSize());
      sorter.insertRow(unsafeRow);
    }
    Iterator<UnsafeRow> iter=sorter.sort();
    UnsafeRow row=null;
    int indexprint=0;
    while (iter.hasNext()) {
      row=iter.next();
      indexprint++;
    }
    Assert.assertEquals(TEST_SIZE,indexprint);
  }
  public static String getRandomString(  int length){
    String base="abcdefghijklmnopqrstuvwxyz0123456789";
    Random random=new Random();
    StringBuffer sb=new StringBuffer();
    for (int i=0; i < length; i++) {
      int number=random.nextInt(base.length());
      sb.append(base.charAt(number));
    }
    return sb.toString();
  }
}

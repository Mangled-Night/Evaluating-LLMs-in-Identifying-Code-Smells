public class QueryArchiveTest extends MamTest {
  private static final String mamSimpleQueryIQ="<iq id='sarasa' type='set'>" + "<query xmlns='urn:xmpp:mam:2' queryid='testid'>" + "<x xmlns='jabber:x:data' type='submit'>"+ "<field var='FORM_TYPE'>"+ "<value>" + MamVersion.MAM2.getNamespace() + "</value>"+ "</field>"+ "</x>"+ "</query>"+ "</iq>";
  private static final String mamQueryResultExample="<message to='hag66@shakespeare.lit/pda' from='coven@chat.shakespeare.lit' id='iasd207'>" + "<result xmlns='urn:xmpp:mam:2' queryid='g27' id='34482-21985-73620'>" + "<forwarded xmlns='urn:xmpp:forward:0'>"+ "<delay xmlns='urn:xmpp:delay' stamp='2002-10-13T23:58:37.000+00:00'/>"+ "<message "+ "xmlns='jabber:client' from='coven@chat.shakespeare.lit/firstwitch' "+ "id='162BEBB1-F6DB-4D9A-9BD8-CFDCC801A0B2' "+ "type='chat'>"+ "<body>Thrice the brinded cat hath mew.</body>"+ "</message>"+ "</forwarded>"+ "</result>"+ "</message>";
  @Test public void checkMamQueryIQ() throws Exception {
    DataForm dataForm=getNewMamForm();
    MamQueryIQ mamQueryIQ=new MamQueryIQ(MamVersion.MAM2,queryId,dataForm);
    mamQueryIQ.setType(IQ.Type.set);
    mamQueryIQ.setStanzaId("sarasa");
    assertEquals(mamQueryIQ.toXML(StreamOpen.CLIENT_NAMESPACE).toString(),mamSimpleQueryIQ);
  }
  @Test public void checkMamQueryResults() throws Exception {
    Message message=StanzaBuilder.buildMessage("iasd207").from("coven@chat.shakespeare.lit").to("hag66@shakespeare.lit/pda").build();
    GregorianCalendar calendar=new GregorianCalendar(2002,10 - 1,13,23,58,37);
    calendar.setTimeZone(TimeZone.getTimeZone("UTC"));
    Date date=calendar.getTime();
    DelayInformation delay=new DelayInformation(date);
    Message forwardedMessage=StanzaBuilder.buildMessage("162BEBB1-F6DB-4D9A-9BD8-CFDCC801A0B2").from(JidCreate.from("coven@chat.shakespeare.lit/firstwitch")).ofType(Message.Type.chat).setBody("Thrice the brinded cat hath mew.").build();
    Forwarded<Message> forwarded=new Forwarded<>(forwardedMessage,delay);
    message.addExtension(MamVersion.MAM2.newElementFactory().newResultExtension("g27","34482-21985-73620",forwarded));
    assertEquals(mamQueryResultExample,message.toXML(StreamOpen.CLIENT_NAMESPACE).toString());
    MamResultExtension mamResultExtension=MamResultExtension.from(message);
    assertEquals(mamResultExtension.getId(),"34482-21985-73620");
    assertEquals(mamResultExtension.getForwarded().getDelayInformation().getStamp(),date);
    Message resultMessage=mamResultExtension.getForwarded().getForwardedStanza();
    assertEquals(resultMessage.getFrom(),JidCreate.from("coven@chat.shakespeare.lit/firstwitch"));
    assertEquals(resultMessage.getStanzaId(),"162BEBB1-F6DB-4D9A-9BD8-CFDCC801A0B2");
    assertEquals(resultMessage.getType(),Message.Type.chat);
    assertEquals(resultMessage.getBody(),"Thrice the brinded cat hath mew.");
  }
}

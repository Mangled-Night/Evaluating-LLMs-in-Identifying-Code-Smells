@Override protected void setupModuleManager(Set<Name> moduleNames) throws Exception {
  TypeRegistry.WHITELISTED_CLASSES=ExternalApiWhitelist.CLASSES.stream().map(Class::getName).collect(Collectors.toSet());
  ModuleManager moduleManager=ModuleManagerFactory.create();
  ModuleTypeRegistry typeRegistry=new ModuleTypeRegistry(moduleManager.getEnvironment());
  context.put(TypeRegistry.class,typeRegistry);
  context.put(ModuleTypeRegistry.class,typeRegistry);
  moduleManager.resolveAndLoadEnvironment(moduleNames);
  context.put(ModuleManager.class,moduleManager);
  EntitySystemSetupUtil.addReflectionBasedLibraries(context);
}

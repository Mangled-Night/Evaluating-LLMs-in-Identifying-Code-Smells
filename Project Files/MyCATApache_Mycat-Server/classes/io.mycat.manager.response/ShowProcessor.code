/** 
 * 查看处理器状态
 * @author mycat
 * @author mycat
 */
public final class ShowProcessor {
  private static final int FIELD_COUNT=12;
  private static final ResultSetHeaderPacket header=PacketUtil.getHeader(FIELD_COUNT);
  private static final FieldPacket[] fields=new FieldPacket[FIELD_COUNT];
  private static final EOFPacket eof=new EOFPacket();
static {
    int i=0;
    byte packetId=0;
    header.packetId=++packetId;
    fields[i]=PacketUtil.getField("NAME",Fields.FIELD_TYPE_VAR_STRING);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("NET_IN",Fields.FIELD_TYPE_LONGLONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("NET_OUT",Fields.FIELD_TYPE_LONGLONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("REACT_COUNT",Fields.FIELD_TYPE_LONGLONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("R_QUEUE",Fields.FIELD_TYPE_LONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("W_QUEUE",Fields.FIELD_TYPE_LONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("FREE_BUFFER",Fields.FIELD_TYPE_LONGLONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("TOTAL_BUFFER",Fields.FIELD_TYPE_LONGLONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("BU_PERCENT",Fields.FIELD_TYPE_TINY);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("BU_WARNS",Fields.FIELD_TYPE_LONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("FC_COUNT",Fields.FIELD_TYPE_LONG);
    fields[i++].packetId=++packetId;
    fields[i]=PacketUtil.getField("BC_COUNT",Fields.FIELD_TYPE_LONG);
    fields[i++].packetId=++packetId;
    eof.packetId=++packetId;
  }
  public static void execute(  ManagerConnection c){
    ByteBuffer buffer=c.allocate();
    buffer=header.write(buffer,c,true);
    for (    FieldPacket field : fields) {
      buffer=field.write(buffer,c,true);
    }
    buffer=eof.write(buffer,c,true);
    byte packetId=eof.packetId;
    for (    NIOProcessor p : MycatServer.getInstance().getProcessors()) {
      RowDataPacket row=getRow(p,c.getCharset());
      row.packetId=++packetId;
      buffer=row.write(buffer,c,true);
    }
    EOFPacket lastEof=new EOFPacket();
    lastEof.packetId=++packetId;
    buffer=lastEof.write(buffer,c,true);
    c.write(buffer);
  }
  private static RowDataPacket getRow(  NIOProcessor processor,  String charset){
    BufferPool pool=processor.getBufferPool();
    RowDataPacket row=new RowDataPacket(FIELD_COUNT);
    long bufferSize=0;
    long bufferCapacity=0;
    long free=0;
    long bufferUsagePercent=0;
    long bufferSharedOpts=pool.getSharedOptsCount();
    try {
      if (pool instanceof ByteBufferArena) {
        ByteBufferArena bufferPool=(ByteBufferArena)pool;
        bufferSize=bufferPool.size();
        bufferCapacity=bufferPool.capacity();
        free=bufferSize - bufferCapacity;
        bufferUsagePercent=(long)((bufferCapacity) * 100.0 / bufferSize);
      }
 else       if (pool instanceof DirectByteBufferPool) {
        DirectByteBufferPool bufferPool=(DirectByteBufferPool)pool;
        bufferSize=bufferPool.size();
        bufferCapacity=bufferPool.getNetDirectMemoryUsage().values().stream().mapToLong(i -> i).count();
        free=bufferSize - bufferCapacity;
        bufferSharedOpts=bufferPool.getSharedOptsCount();
        bufferUsagePercent=(long)((bufferCapacity) * 100.0 / bufferSize);
      }
 else {
        return row;
      }
      row.add(processor.getName().getBytes());
      row.add(LongUtil.toBytes(processor.getNetInBytes()));
      row.add(LongUtil.toBytes(processor.getNetOutBytes()));
      row.add(LongUtil.toBytes(0));
      row.add(IntegerUtil.toBytes(0));
      row.add(IntegerUtil.toBytes(processor.getWriteQueueSize()));
      row.add(LongUtil.toBytes(free));
      row.add(LongUtil.toBytes(bufferSize));
      row.add(LongUtil.toBytes(bufferUsagePercent));
      row.add(LongUtil.toBytes(bufferSharedOpts));
      row.add(IntegerUtil.toBytes(processor.getFrontends().size()));
      row.add(IntegerUtil.toBytes(processor.getBackends().size()));
    }
  finally {
      return row;
    }
  }
}

/** 
 * Create a clustered pub/sub connection with command distributor.
 * @param codec Use this codec to encode/decode keys and values, must not be {@code null}
 * @param < K > Key type
 * @param < V > Value type
 * @return a new connection
 */
private <K,V>CompletableFuture<StatefulRedisClusterConnection<K,V>> connectClusterAsync(RedisCodec<K,V> codec){
  if (partitions == null) {
    return Futures.failed(new IllegalStateException("Partitions not initialized. Initialize via RedisClusterClient.getPartitions()."));
  }
  topologyRefreshScheduler.activateTopologyRefreshIfNeeded();
  logger.debug("connectCluster(" + initialUris + ")");
  DefaultEndpoint endpoint=new DefaultEndpoint(getClusterClientOptions(),getResources());
  RedisChannelWriter writer=endpoint;
  if (CommandExpiryWriter.isSupported(getClusterClientOptions())) {
    writer=new CommandExpiryWriter(writer,getClusterClientOptions(),getResources());
  }
  if (CommandListenerWriter.isSupported(getCommandListeners())) {
    writer=new CommandListenerWriter(writer,getCommandListeners());
  }
  ClusterDistributionChannelWriter clusterWriter=new ClusterDistributionChannelWriter(writer,getClusterClientOptions(),topologyRefreshScheduler);
  PooledClusterConnectionProvider<K,V> pooledClusterConnectionProvider=new PooledClusterConnectionProvider<>(this,clusterWriter,codec,topologyRefreshScheduler);
  clusterWriter.setClusterConnectionProvider(pooledClusterConnectionProvider);
  StatefulRedisClusterConnectionImpl<K,V> connection=newStatefulRedisClusterConnection(clusterWriter,pooledClusterConnectionProvider,codec,getFirstUri().getTimeout());
  connection.setReadFrom(ReadFrom.UPSTREAM);
  connection.setPartitions(partitions);
  Supplier<CommandHandler> commandHandlerSupplier=() -> new CommandHandler(getClusterClientOptions(),getResources(),endpoint);
  Mono<SocketAddress> socketAddressSupplier=getSocketAddressSupplier(connection::getPartitions,TopologyComparators::sortByClientCount);
  Mono<StatefulRedisClusterConnectionImpl<K,V>> connectionMono=Mono.defer(() -> connect(socketAddressSupplier,endpoint,connection,commandHandlerSupplier));
  for (int i=1; i < getConnectionAttempts(); i++) {
    connectionMono=connectionMono.onErrorResume(t -> connect(socketAddressSupplier,endpoint,connection,commandHandlerSupplier));
  }
  return connectionMono.doOnNext(c -> connection.registerCloseables(closeableResources,clusterWriter,pooledClusterConnectionProvider)).map(it -> (StatefulRedisClusterConnection<K,V>)it).toFuture();
}

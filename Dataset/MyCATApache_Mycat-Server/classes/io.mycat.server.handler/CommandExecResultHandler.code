class CommandExecResultHandler extends SingleNodeHandler {
  private static final Logger logger=LoggerFactory.getLogger(CommandExecResultHandler.class);
  private String table;
  public CommandExecResultHandler(  RouteResultset rrs,  NonBlockingSession session,  String table){
    super(rrs,session);
    this.table=table;
  }
  private void rowEofResponse0(  byte[] eof,  BackendConnection conn){
    logger.debug("CommandExecResultHandler.rowEofResponse eof: {}",SimpleLogHandler.bytesToHex(eof));
    ServerConnection source=getSession().getSource();
    conn.recordSql(source.getHost(),source.getSchema(),getRouteResultsetNode().getStatement());
    if (!getRouteResultset().isCallStatement() || (getRouteResultset().isCallStatement() && getRouteResultset().getProcedure().isResultSimpleValue())) {
      getSession().releaseConnectionIfSafe(conn,logger.isDebugEnabled(),false);
      endRunning();
    }
    int resultSize=source.getWriteQueue().size() * MycatServer.getInstance().getConfig().getSystem().getBufferPoolPageSize();
    resultSize=resultSize + getBuffer().position();
    if (!errorRepsponsed.get() && !getSession().closed() && source.canResponse()) {
      source.write(getBuffer());
    }
    source.setExecuteSql(null);
    QueryResult queryResult=new QueryResult(getSession().getSource().getSchema(),getSession().getSource().getUser(),getRouteResultset().getSqlType(),getRouteResultset().getStatement(),affectedRows,netInBytes,netOutBytes,startTime,System.currentTimeMillis(),resultSize,source.getHost());
    QueryResultDispatcher.dispatchQuery(queryResult);
  }
  @Override public void fieldEofResponse(  byte[] header,  List<byte[]> fields,  byte[] eof,  BackendConnection conn){
    logger.debug("CommandExecResultHandler.fieldEofResponse header: {}",SimpleLogHandler.bytesToHex(header));
    for (    byte[] field : fields) {
      logger.debug("CommandExecResultHandler.fieldEofResponse fields: {}",SimpleLogHandler.bytesToHex(field));
    }
    logger.debug("CommandExecResultHandler.fieldEofResponse eof: {}",SimpleLogHandler.bytesToHex(eof));
    fieldEofResponse0(header,fields,eof,conn);
    rowEofResponse0(eof,conn);
  }
  private void fieldEofResponse0(  byte[] header,  List<byte[]> fields,  byte[] eof,  BackendConnection conn){
    byte packetId=0;
    this.netOutBytes+=header.length;
    for (int i=0, len=fields.size(); i < len; ++i) {
      byte[] field=fields.get(i);
      this.netOutBytes+=field.length;
    }
    header[3]=++packetId;
    ServerConnection source=getSession().getSource();
    buffer=source.writeToBuffer(header,allocBuffer());
    for (int i=0, len=fields.size(); i < len; ++i) {
      byte[] field=fields.get(i);
      field[3]=++packetId;
      FieldPacket fieldPk=new FieldPacket();
      fieldPk.read(field);
      fieldPackets.add(fieldPk);
      buffer=source.writeToBuffer(field,buffer);
    }
    fieldCount=fieldPackets.size();
    eof[3]=++packetId;
    this.netOutBytes+=eof.length;
    buffer=source.writeToBuffer(eof,buffer);
  }
  @Override public String toString(){
    return "CommandExecResultHandler [node=" + getRouteResultsetNode() + ", table="+ table+ "]";
  }
}

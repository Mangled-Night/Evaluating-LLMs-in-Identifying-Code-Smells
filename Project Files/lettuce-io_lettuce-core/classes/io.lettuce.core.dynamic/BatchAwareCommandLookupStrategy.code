@SuppressWarnings({"rawtypes","unchecked"}) class BatchAwareCommandLookupStrategy implements ExecutableCommandLookupStrategy {
  private final ExecutableCommandLookupStrategy fallbackStrategy;
  private final boolean globalBatching;
  private final CommandMethodVerifier verifier;
  private final long batchSize;
  private Batcher batcher=Batcher.NONE;
  private BatchExecutableCommandLookupStrategy batchingStrategy;
  public BatchAwareCommandLookupStrategy(  ExecutableCommandLookupStrategy fallbackStrategy,  RedisCommandsMetadata metadata){
    this.fallbackStrategy=fallbackStrategy;
    this.verifier=verifyCommandMethods ? commandMethodVerifier : CommandMethodVerifier.NONE;
    if (metadata.hasAnnotation(BatchSize.class)) {
      BatchSize batchSize=metadata.getAnnotation(BatchSize.class);
      this.globalBatching=true;
      this.batchSize=batchSize.value();
    }
 else {
      this.globalBatching=false;
      this.batchSize=-1;
    }
  }
  @Override public ExecutableCommand resolveCommandMethod(  CommandMethod method,  RedisCommandsMetadata metadata){
    if (BatchExecutableCommandLookupStrategy.supports(method) || globalBatching) {
      if (batcher == Batcher.NONE) {
        batcher=new SimpleBatcher((StatefulConnection)connection,Math.toIntExact(batchSize));
        batchingStrategy=new BatchExecutableCommandLookupStrategy(redisCodecs,commandOutputFactoryResolver,verifier,batcher,(StatefulConnection)connection);
      }
      return batchingStrategy.resolveCommandMethod(method,metadata);
    }
    return fallbackStrategy.resolveCommandMethod(method,metadata);
  }
}

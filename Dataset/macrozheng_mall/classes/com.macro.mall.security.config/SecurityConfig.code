/** 
 * SpringSecurity相关配置，仅用于配置SecurityFilterChain Created by macro on 2019/11/5.
 */
@Configuration @EnableWebSecurity public class SecurityConfig {
  @Autowired private IgnoreUrlsConfig ignoreUrlsConfig;
  @Autowired private RestfulAccessDeniedHandler restfulAccessDeniedHandler;
  @Autowired private RestAuthenticationEntryPoint restAuthenticationEntryPoint;
  @Autowired private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;
  @Autowired(required=false) private DynamicSecurityService dynamicSecurityService;
  @Autowired(required=false) private DynamicSecurityFilter dynamicSecurityFilter;
  @Bean SecurityFilterChain filterChain(  HttpSecurity httpSecurity) throws Exception {
    ExpressionUrlAuthorizationConfigurer<HttpSecurity>.ExpressionInterceptUrlRegistry registry=httpSecurity.authorizeRequests();
    for (    String url : ignoreUrlsConfig.getUrls()) {
      registry.antMatchers(url).permitAll();
    }
    registry.antMatchers(HttpMethod.OPTIONS).permitAll();
    registry.and().authorizeRequests().anyRequest().authenticated().and().csrf().disable().sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and().exceptionHandling().accessDeniedHandler(restfulAccessDeniedHandler).authenticationEntryPoint(restAuthenticationEntryPoint).and().addFilterBefore(jwtAuthenticationTokenFilter,UsernamePasswordAuthenticationFilter.class);
    if (dynamicSecurityService != null) {
      registry.and().addFilterBefore(dynamicSecurityFilter,FilterSecurityInterceptor.class);
    }
    return httpSecurity.build();
  }
}

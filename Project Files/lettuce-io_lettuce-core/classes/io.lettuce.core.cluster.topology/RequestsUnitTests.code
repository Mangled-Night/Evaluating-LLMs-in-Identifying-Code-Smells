/** 
 * @author Mark Paluch
 * @author Xujs
 */
class RequestsUnitTests {
  @Test void shouldCreateTopologyView() throws Exception {
    RedisURI redisURI=RedisURI.create("localhost",6379);
    Requests clusterNodesRequests=new Requests();
    String clusterNodesOutput="1 127.0.0.1:7380 master,myself - 0 1401258245007 2 disconnected 8000-11999\n";
    clusterNodesRequests.addRequest(redisURI,getCommand(clusterNodesOutput));
    Requests infoClientRequests=new Requests();
    String infoClientOutput="# Clients\r\nconnected_clients:100\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:0\r\nblocked_clients:0";
    infoClientRequests.addRequest(redisURI,getCommand(infoClientOutput));
    NodeTopologyView nodeTopologyView=NodeTopologyView.from(redisURI,clusterNodesRequests,infoClientRequests);
    assertThat(nodeTopologyView.isAvailable()).isTrue();
    assertThat(nodeTopologyView.getConnectedClients()).isEqualTo(100);
    assertThat(nodeTopologyView.getPartitions()).hasSize(1);
    assertThat(nodeTopologyView.getClusterNodes()).isEqualTo(clusterNodesOutput);
    assertThat(nodeTopologyView.getInfo()).isEqualTo(infoClientOutput);
  }
  @Test void shouldCreateTopologyViewWithoutClientCount() throws Exception {
    RedisURI redisURI=RedisURI.create("localhost",6379);
    Requests clusterNodesRequests=new Requests();
    String clusterNodesOutput="1 127.0.0.1:7380 master,myself - 0 1401258245007 2 disconnected 8000-11999\n";
    clusterNodesRequests.addRequest(redisURI,getCommand(clusterNodesOutput));
    Requests clientListRequests=new Requests();
    NodeTopologyView nodeTopologyView=NodeTopologyView.from(redisURI,clusterNodesRequests,clientListRequests);
    assertThat(nodeTopologyView.isAvailable()).isFalse();
    assertThat(nodeTopologyView.getConnectedClients()).isEqualTo(0);
    assertThat(nodeTopologyView.getPartitions()).isEmpty();
    assertThat(nodeTopologyView.getClusterNodes()).isNull();
  }
  private TimedAsyncCommand getCommand(  String response){
    Command<String,String,String> command=new Command<>(CommandType.TYPE,new StatusOutput<>(StringCodec.UTF8));
    TimedAsyncCommand timedAsyncCommand=new TimedAsyncCommand(command);
    command.getOutput().set(ByteBuffer.wrap(response.getBytes()));
    timedAsyncCommand.complete();
    return timedAsyncCommand;
  }
}

/** 
 * If multiple network addresses are added to the local SOCKS5 proxy, all of them should be contained in the SOCKS5 Bytestream request.
 * @throws InterruptedException if the calling thread was interrupted.
 * @throws SmackException if Smack detected an exceptional situation.
 * @throws IOException if an I/O error occurred.
 * @throws XMPPException if an XMPP protocol error was received.
 * @throws TimeoutException if there was a timeout.
 */
@Test public void shouldUseMultipleAddressesForLocalSocks5Proxy() throws SmackException, InterruptedException, IOException, TimeoutException, XMPPException {
  final Protocol protocol=new Protocol();
  final XMPPConnection connection=ConnectionUtils.createMockedConnection(protocol,initiatorJID);
  final String sessionID="session_id_shouldUseMultipleAddressesForLocalSocks5Proxy";
  Socks5Proxy socks5Proxy=new Socks5Proxy();
  socks5Proxy.start();
  try {
    assertTrue(socks5Proxy.isRunning());
    Socks5BytestreamManager byteStreamManager=Socks5BytestreamManager.getBytestreamManager(connection);
    DiscoverInfoBuilder discoverInfo=Socks5PacketUtils.createDiscoverInfo(targetJID,initiatorJID);
    discoverInfo.addFeature(Bytestream.NAMESPACE);
    protocol.addResponse(discoverInfo.build(),Verification.correspondingSenderReceiver,Verification.requestTypeGET);
    DiscoverItems discoverItems=Socks5PacketUtils.createDiscoverItems(xmppServer,initiatorJID);
    protocol.addResponse(discoverItems,Verification.correspondingSenderReceiver,Verification.requestTypeGET);
    Bytestream streamHostUsedPacket=Socks5PacketUtils.createBytestreamResponse(targetJID,initiatorJID);
    streamHostUsedPacket.setSessionID(sessionID);
    streamHostUsedPacket.setUsedHost(initiatorJID);
    final String secondStreamHostIp="192.0.0.1";
    protocol.addResponse(streamHostUsedPacket,new Verification<Bytestream,Bytestream>(){
      @Override public void verify(      Bytestream request,      Bytestream response){
        assertEquals(response.getSessionID(),request.getSessionID());
        List<StreamHost> streamHosts=request.getStreamHosts();
        StreamHost streamHost1=streamHosts.get(0);
        assertEquals(response.getUsedHost().getJID(),streamHost1.getJID());
        StreamHost streamHost2=streamHosts.get(streamHosts.size() - 1);
        assertEquals(response.getUsedHost().getJID(),streamHost2.getJID());
        assertEquals(secondStreamHostIp,streamHost2.getAddress().toString());
      }
    }
,Verification.correspondingSenderReceiver,Verification.requestTypeSET);
    String digest=Socks5Utils.createDigest(sessionID,initiatorJID,targetJID);
    socks5Proxy.addTransfer(digest);
    StreamHost streamHost=new StreamHost(targetJID,socks5Proxy.getLocalAddresses().get(0),socks5Proxy.getPort());
    Socks5Client socks5Client=new Socks5Client(streamHost,digest);
    InputStream inputStream=socks5Client.getSocket(10000).getInputStream();
    socks5Proxy.addLocalAddress(InetAddress.getByName(secondStreamHostIp));
    OutputStream outputStream=byteStreamManager.establishSession(targetJID,sessionID).getOutputStream();
    byte[] data=new byte[]{1,2,3};
    outputStream.write(data);
    byte[] result=new byte[3];
    inputStream.read(result);
    assertArrayEquals(data,result);
    protocol.verifyAll();
  }
  finally {
    socks5Proxy.stop();
  }
}

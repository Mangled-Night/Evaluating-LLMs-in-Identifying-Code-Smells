/** 
 * User0 is connected from 2 resources. User0 is available in both resources with same priority presence values and same show values. User1 sends a message to the bare JID of User0. Check that the resource with most recent activity will get the messages.
 * @throws Exception if an error occurs.
 */
public void testMostRecentActive() throws Exception {
  ConnectionConfiguration connectionConfiguration=new ConnectionConfiguration(getHost(),getPort(),getXMPPServiceDomain());
  XMPPTCPConnection conn3=new XMPPConnection(connectionConfiguration);
  conn3.connect();
  conn3.login(getUsername(0),getPassword(0),"Home");
  Presence presence=new Presence(Presence.Type.available);
  presence.setMode(Presence.Mode.available);
  presence.setPriority(10);
  conn3.sendStanza(presence);
  presence=new Presence(Presence.Type.available);
  presence.setMode(Presence.Mode.available);
  presence.setPriority(10);
  getConnection(0).sendStanza(presence);
  connectionConfiguration=new ConnectionConfiguration(getHost(),getPort(),getXMPPServiceDomain());
  XMPPTCPConnection conn4=new XMPPConnection(connectionConfiguration);
  conn4.connect();
  conn4.login(getUsername(0),getPassword(0),"Home2");
  presence=new Presence(Presence.Type.available);
  presence.setMode(Presence.Mode.available);
  presence.setPriority(4);
  getConnection(0).sendStanza(presence);
  Thread.sleep(200);
  StanzaCollector collector=getConnection(0).createStanzaCollector(new MessageTypeFilter(Message.Type.chat));
  StanzaCollector coll3=conn3.createStanzaCollector(new MessageTypeFilter(Message.Type.chat));
  StanzaCollector coll4=conn4.createStanzaCollector(new MessageTypeFilter(Message.Type.chat));
  conn3.sendStanza(new Message("admin@" + getXMPPServiceDomain()));
  Chat chat=getConnection(1).getChatManager().createChat(getBareJID(0),null);
  chat.sendMessage("Test 1");
  chat.sendMessage("Test 2");
  Message message=(Message)collector.nextResult(2000);
  assertNull("Resource with oldest activity got the message",message);
  message=(Message)coll4.nextResult(2000);
  assertNull(message);
  message=(Message)coll3.nextResult(2000);
  assertNotNull(message);
  assertEquals("Test 1",message.getBody());
  message=(Message)coll3.nextResult(1000);
  assertNotNull(message);
  assertEquals("Test 2",message.getBody());
  conn3.disconnect();
  conn4.disconnect();
}

@RequiresApi(api=Build.VERSION_CODES.M) static final class PermissionActivityImpl extends UtilsTransActivity.TransActivityDelegate {
  private static final String TYPE="TYPE";
  private static final int TYPE_RUNTIME=0x01;
  private static final int TYPE_WRITE_SETTINGS=0x02;
  private static final int TYPE_DRAW_OVERLAYS=0x03;
  private static int currentRequestCode=-1;
  private static PermissionActivityImpl INSTANCE=new PermissionActivityImpl();
  public static void start(  final int type){
    UtilsTransActivity.start(new Utils.Consumer<Intent>(){
      @Override public void accept(      Intent data){
        data.putExtra(TYPE,type);
      }
    }
,INSTANCE);
  }
  @Override public void onCreated(  @NonNull final UtilsTransActivity activity,  @Nullable Bundle savedInstanceState){
    activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE | WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH);
    int type=activity.getIntent().getIntExtra(TYPE,-1);
    if (type == TYPE_RUNTIME) {
      if (sInstance == null) {
        Log.e("PermissionUtils","sInstance is null.");
        activity.finish();
        return;
      }
      if (sInstance.mPermissionsRequest == null) {
        Log.e("PermissionUtils","mPermissionsRequest is null.");
        activity.finish();
        return;
      }
      if (sInstance.mPermissionsRequest.size() <= 0) {
        Log.e("PermissionUtils","mPermissionsRequest's size is no more than 0.");
        activity.finish();
        return;
      }
      if (sInstance.mThemeCallback != null) {
        sInstance.mThemeCallback.onActivityCreate(activity);
      }
      if (sInstance.mOnExplainListener != null) {
        sInstance.mOnExplainListener.explain(activity,sInstance.mPermissionsRequest,new OnExplainListener.ShouldRequest(){
          @Override public void start(          boolean start){
            if (!start) {
              activity.finish();
            }
 else {
              requestPermissions(activity);
            }
          }
        }
);
        sInstance.mOnExplainListener=null;
        return;
      }
      requestPermissions(activity);
    }
 else     if (type == TYPE_WRITE_SETTINGS) {
      currentRequestCode=TYPE_WRITE_SETTINGS;
      startWriteSettingsActivity(activity,TYPE_WRITE_SETTINGS);
    }
 else     if (type == TYPE_DRAW_OVERLAYS) {
      currentRequestCode=TYPE_DRAW_OVERLAYS;
      startOverlayPermissionActivity(activity,TYPE_DRAW_OVERLAYS);
    }
 else {
      activity.finish();
      Log.e("PermissionUtils","type is wrong.");
    }
  }
  private void requestPermissions(  final UtilsTransActivity activity){
    if (sInstance.shouldRationale(activity,new Runnable(){
      @Override public void run(){
        activity.requestPermissions(sInstance.mPermissionsRequest.toArray(new String[0]),1);
      }
    }
)) {
      return;
    }
    activity.requestPermissions(sInstance.mPermissionsRequest.toArray(new String[0]),1);
  }
  @Override public void onRequestPermissionsResult(  @NonNull UtilsTransActivity activity,  int requestCode,  @NonNull String[] permissions,  @NonNull int[] grantResults){
    activity.finish();
    if (sInstance != null && sInstance.mPermissionsRequest != null) {
      sInstance.onRequestPermissionsResult(activity);
    }
  }
  @Override public boolean dispatchTouchEvent(  @NonNull UtilsTransActivity activity,  MotionEvent ev){
    activity.finish();
    return true;
  }
  @Override public void onDestroy(  @NonNull final UtilsTransActivity activity){
    if (currentRequestCode != -1) {
      checkRequestCallback(currentRequestCode);
      currentRequestCode=-1;
    }
    super.onDestroy(activity);
  }
  @Override public void onActivityResult(  @NonNull UtilsTransActivity activity,  int requestCode,  int resultCode,  Intent data){
    activity.finish();
  }
  private void checkRequestCallback(  int requestCode){
    if (requestCode == TYPE_WRITE_SETTINGS) {
      if (sSimpleCallback4WriteSettings == null)       return;
      if (isGrantedWriteSettings()) {
        sSimpleCallback4WriteSettings.onGranted();
      }
 else {
        sSimpleCallback4WriteSettings.onDenied();
      }
      sSimpleCallback4WriteSettings=null;
    }
 else     if (requestCode == TYPE_DRAW_OVERLAYS) {
      if (sSimpleCallback4DrawOverlays == null)       return;
      if (isGrantedDrawOverlays()) {
        sSimpleCallback4DrawOverlays.onGranted();
      }
 else {
        sSimpleCallback4DrawOverlays.onDenied();
      }
      sSimpleCallback4DrawOverlays=null;
    }
  }
}

/** 
 * Smack ExtensionProvider that parses OMEMO bundle element into OmemoBundleElement objects.
 * @author Paul Schaub
 */
public class OmemoBundleVAxolotlProvider extends ExtensionElementProvider<OmemoBundleElement_VAxolotl> {
  @Override public OmemoBundleElement_VAxolotl parse(  XmlPullParser parser,  int initialDepth,  XmlEnvironment xmlEnvironment) throws XmlPullParserException, IOException {
    boolean inPreKeys=false;
    int signedPreKeyId=-1;
    String signedPreKey=null;
    String signedPreKeySignature=null;
    String identityKey=null;
    HashMap<Integer,String> preKeys=new HashMap<>();
    outerloop:     while (true) {
      XmlPullParser.Event tag=parser.next();
switch (tag) {
case START_ELEMENT:
        String name=parser.getName();
      final int attributeCount=parser.getAttributeCount();
    if (name.equals(SIGNED_PRE_KEY_PUB)) {
      for (int i=0; i < attributeCount; i++) {
        if (parser.getAttributeName(i).equals(SIGNED_PRE_KEY_ID)) {
          int id=Integer.parseInt(parser.getAttributeValue(i));
          signedPreKey=parser.nextText();
          signedPreKeyId=id;
        }
      }
    }
 else     if (name.equals(SIGNED_PRE_KEY_SIG)) {
      signedPreKeySignature=parser.nextText();
    }
 else     if (name.equals(IDENTITY_KEY)) {
      identityKey=parser.nextText();
    }
 else     if (name.equals(PRE_KEYS)) {
      inPreKeys=true;
    }
 else     if (inPreKeys && name.equals(PRE_KEY_PUB)) {
      for (int i=0; i < attributeCount; i++) {
        if (parser.getAttributeName(i).equals(PRE_KEY_ID)) {
          preKeys.put(Integer.parseInt(parser.getAttributeValue(i)),parser.nextText());
        }
      }
    }
  break;
case END_ELEMENT:
if (parser.getDepth() == initialDepth) {
  break outerloop;
}
break;
default :
break;
}
}
return new OmemoBundleElement_VAxolotl(signedPreKeyId,signedPreKey,signedPreKeySignature,identityKey,preKeys);
}
}

/** 
 * @author mycat
 */
public class CharacterSet {
  private static final Logger logger=LoggerFactory.getLogger(CharacterSet.class);
  public static void response(  String stmt,  ServerConnection c,  int rs){
    if (-1 == stmt.indexOf(',')) {
      oneSetResponse(stmt,c,rs);
    }
 else {
      multiSetResponse(stmt,c,rs);
    }
  }
  private static void oneSetResponse(  String stmt,  ServerConnection c,  int rs){
    if ((rs & 0xff) == CHARACTER_SET_CLIENT) {
      c.write(c.writeToBuffer(OkPacket.OK,c.allocate()));
    }
 else {
      String charset=stmt.substring(rs >>> 8).trim();
      if (charset.endsWith(";")) {
        charset=charset.substring(0,charset.length() - 1);
      }
      if (charset.startsWith("'") || charset.startsWith("`")) {
        charset=charset.substring(1,charset.length() - 1);
      }
      setCharset(charset,c);
    }
  }
  private static void multiSetResponse(  String stmt,  ServerConnection c,  int rs){
    String charResult="null";
    String charConnection="null";
    String[] sqlList=SplitUtil.split(stmt,',',false);
switch (rs & 0xff) {
case CHARACTER_SET_RESULTS:
      charResult=sqlList[0].substring(rs >>> 8).trim();
    break;
case CHARACTER_SET_CONNECTION:
  charConnection=sqlList[0].substring(rs >>> 8).trim();
break;
}
for (int i=1; i < sqlList.length; i++) {
String sql=new StringBuilder("set ").append(sqlList[i]).toString();
if ((i + 1 == sqlList.length) && sql.endsWith(";")) {
sql=sql.substring(0,sql.length() - 1);
}
int rs2=ServerParseSet.parse(sql,"set".length());
switch (rs2 & 0xff) {
case CHARACTER_SET_RESULTS:
charResult=sql.substring(rs2 >>> 8).trim();
break;
case CHARACTER_SET_CONNECTION:
charConnection=sql.substring(rs2 >>> 8).trim();
break;
case CHARACTER_SET_CLIENT:
break;
default :
boolean ignore=SetIgnoreUtil.isIgnoreStmt(sql);
if (!ignore) {
StringBuilder s=new StringBuilder();
logger.warn(s.append(c).append(sql).append(" is not executed").toString());
}
}
}
if (charResult.startsWith("'") || charResult.startsWith("`")) {
charResult=charResult.substring(1,charResult.length() - 1);
}
if (charConnection.startsWith("'") || charConnection.startsWith("`")) {
charConnection=charConnection.substring(1,charConnection.length() - 1);
}
if ("null".equalsIgnoreCase(charResult)) {
setCharset(charConnection,c);
return;
}
if ("null".equalsIgnoreCase(charConnection)) {
setCharset(charResult,c);
return;
}
if (charConnection.equalsIgnoreCase(charResult)) {
setCharset(charConnection,c);
}
 else {
StringBuilder sb=new StringBuilder();
sb.append("charset is not consistent:[connection=").append(charConnection);
sb.append(",results=").append(charResult).append(']');
c.writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET,sb.toString());
}
}
private static void setCharset(String charset,ServerConnection c){
if ("null".equalsIgnoreCase(charset)) {
c.write(c.writeToBuffer(OkPacket.OK,c.allocate()));
}
 else if (c.setCharset(charset)) {
c.write(c.writeToBuffer(OkPacket.OK,c.allocate()));
}
 else {
try {
if (c.setCharsetIndex(Integer.parseInt(charset))) {
c.write(c.writeToBuffer(OkPacket.OK,c.allocate()));
}
 else {
c.writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET,"Unknown charset :" + charset);
}
}
 catch (RuntimeException e) {
c.writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET,"Unknown charset :" + charset);
}
}
}
}
